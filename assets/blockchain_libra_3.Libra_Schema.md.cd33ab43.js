import{_ as n,c as s,o as a,a as p}from"./app.7948a4b5.js";const b='{"title":"3.Libra\u4E2D\u6570\u636E\u5B58\u50A8\u7684Schema","description":"","frontmatter":{"title":"3.Libra\u4E2D\u6570\u636E\u5B58\u50A8\u7684Schema","date":"2019-06-24T03:00:34.000Z","draft":false,"tags":["rust","blockchain","libra"],"series":["libra"],"categories":["\u6280\u672F\u76F8\u5173"]},"headers":[{"level":2,"title":"schemadb","slug":"schemadb"},{"level":3,"title":"\u6570\u636E\u7684\u8BFB\u5199","slug":"\u6570\u636E\u7684\u8BFB\u5199"},{"level":3,"title":"\u6570\u636E\u7684\u6279\u91CF\u5199SchemaBatch","slug":"\u6570\u636E\u7684\u6279\u91CF\u5199schemabatch"},{"level":3,"title":"\u7F16\u7801\u548C\u89E3\u7801","slug":"\u7F16\u7801\u548C\u89E3\u7801"},{"level":3,"title":"\u7F16\u89E3\u7801\u5668\u7684\u4F7F\u7528","slug":"\u7F16\u89E3\u7801\u5668\u7684\u4F7F\u7528"},{"level":3,"title":"\u8BF4\u8BF4define_schema\u8FD9\u4E2A\u5B8F","slug":"\u8BF4\u8BF4define-schema\u8FD9\u4E2A\u5B8F"},{"level":2,"title":"\u6570\u636E\u5728\u6570\u636E\u5E93\u4E2D\u5B58\u50A8","slug":"\u6570\u636E\u5728\u6570\u636E\u5E93\u4E2D\u5B58\u50A8"},{"level":3,"title":"account_state","slug":"account-state"},{"level":3,"title":"event_accumulator (EventAccumulatorSchema)","slug":"event-accumulator-eventaccumulatorschema"},{"level":3,"title":"eventbyaccess_path","slug":"event-by-access-path"},{"level":3,"title":"event","slug":"event"},{"level":3,"title":"signed_transaction","slug":"signed-transaction"},{"level":3,"title":"statemerklenode","slug":"state-merkle-node"},{"level":3,"title":"transaction_accumulator","slug":"transaction-accumulator"},{"level":3,"title":"transaction_info","slug":"transaction-info"},{"level":3,"title":"validator","slug":"validator"},{"level":3,"title":"ledger_info","slug":"ledger-info"},{"level":2,"title":"schema\u7684\u4F7F\u7528","slug":"schema\u7684\u4F7F\u7528"},{"level":3,"title":"state_store","slug":"state-store"},{"level":3,"title":"transaction_store","slug":"transaction-store"},{"level":3,"title":"eventstore\u548Cledgerstore","slug":"event-store\u548Cledger-store"}],"relativePath":"blockchain/libra/3.Libra_Schema.md"}',t={},e=p(`<ul><li><a href="#schemadb"> schemadb</a><ul><li><a href="#%E6%95%B0%E6%8D%AE%E7%9A%84%E8%AF%BB%E5%86%99"> \u6570\u636E\u7684\u8BFB\u5199</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E7%9A%84%E6%89%B9%E9%87%8F%E5%86%99schemabatch"> \u6570\u636E\u7684\u6279\u91CF\u5199<code>SchemaBatch</code></a></li><li><a href="#%E7%BC%96%E7%A0%81%E5%92%8C%E8%A7%A3%E7%A0%81"> \u7F16\u7801\u548C\u89E3\u7801</a></li><li><a href="#%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8"> \u7F16\u89E3\u7801\u5668\u7684\u4F7F\u7528</a></li><li><a href="#%E8%AF%B4%E8%AF%B4define_schema%E8%BF%99%E4%B8%AA%E5%AE%8F"> \u8BF4\u8BF4<code>define_schema</code>\u8FD9\u4E2A\u5B8F</a></li></ul></li><li><a href="#accountstate%E7%9A%84%E5%AD%98%E5%8F%96%E8%BF%87%E7%A8%8B">AccountState\u7684\u5B58\u53D6\u8FC7\u7A0B</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E5%9C%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E5%AD%98%E5%82%A8"> \u6570\u636E\u5728\u6570\u636E\u5E93\u4E2D\u5B58\u50A8</a><ul><li><a href="#account_state"> account_state</a></li><li><a href="#event_accumulator-eventaccumulatorschema"> event_accumulator (EventAccumulatorSchema)</a></li><li><a href="#event_by_access_path"> event_by_access_path</a></li><li><a href="#event"> event</a></li><li><a href="#signed_transaction"> signed_transaction</a></li><li><a href="#state_merkle_node"> state_merkle_node</a></li><li><a href="#transaction_accumulator"> transaction_accumulator</a></li><li><a href="#transaction_info"> transaction_info</a></li><li><a href="#validator"> validator</a></li><li><a href="#ledger_info"> ledger_info</a></li></ul></li><li><a href="#schema%E7%9A%84%E4%BD%BF%E7%94%A8"> schema\u7684\u4F7F\u7528</a><ul><li><a href="#state_store"> state_store</a></li><li><a href="#transaction_store"> transaction_store</a></li><li><a href="#event_store%E5%92%8Cledger_store"> event_store\u548Cledger_store</a></li></ul></li></ul><p>Libra\u6570\u636E\u5B58\u50A8\u4F7F\u7528\u7684RocksDB\u8FD9\u4E2AKV\u6570\u636E\u5E93.\u5E76\u4E14Libra\u5B58\u50A8\u548C\u4EE5\u592A\u574A\u57FA\u672C\u4E0A\u601D\u8DEF\u662F\u4E00\u6837\u7684,\u5C31\u662F\u4E00\u4E2AMPT\u6811\u6765\u4FDD\u5B58Libra\u8FD9\u4E2A\u8D85\u7EA7\u72B6\u6001\u673A.</p><p>\u56E0\u4E3ARocksDB\u4E2D\u9664\u4E86KV\u4EE5\u5916,\u8FD8\u5B58\u5728\u7740ColumnFamilyName\u8FD9\u4E00\u9879,\u8FD9\u4E2A\u7528\u8D77\u6765\u6709\u70B9\u50CFBucket.</p><h2 id="schemadb" tabindex="-1">schemadb <a class="header-anchor" href="#schemadb" aria-hidden="true">#</a></h2><h3 id="\u6570\u636E\u7684\u8BFB\u5199" tabindex="-1">\u6570\u636E\u7684\u8BFB\u5199 <a class="header-anchor" href="#\u6570\u636E\u7684\u8BFB\u5199" aria-hidden="true">#</a></h3><div class="language-rust line-numbers-mode"><pre><code><span class="token comment">/// This DB is a schematized RocksDB wrapper where all data passed in and out are typed according to</span>
<span class="token comment">/// [\`Schema\`]s.</span>
<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">DB</span> <span class="token punctuation">{</span>
    inner<span class="token punctuation">:</span> <span class="token namespace">rocksdb<span class="token punctuation">::</span></span><span class="token constant">DB</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> <span class="token constant">DB</span> <span class="token punctuation">{</span>
        <span class="token comment">/// Reads single record by key.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Schema</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> schema_key<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">S</span><span class="token punctuation">::</span><span class="token class-name">Key</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">::</span><span class="token class-name">Value</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span> <span class="token comment">//\u4ECE\u6570\u636E\u5E93\u4E2D\u8BFB\u53D6KV</span>
        <span class="token keyword">let</span> k <span class="token operator">=</span> schema_key<span class="token punctuation">.</span><span class="token function">encode_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span> <span class="token comment">//\u7528\u7684\u662F\u54EA\u91CC\u7684encode_key?\u5982\u4F55\u5173\u8054\u8D77\u6765\u7684?</span>
        <span class="token keyword">let</span> cf_handle <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">get_cf_handle</span><span class="token punctuation">(</span><span class="token class-name">S</span><span class="token punctuation">::</span><span class="token constant">COLUMN_FAMILY_NAME</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>inner
            <span class="token punctuation">.</span><span class="token function">get_cf</span><span class="token punctuation">(</span>cf_handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>k<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span>convert_rocksdb_err<span class="token punctuation">)</span><span class="token operator">?</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>raw_value<span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">S</span><span class="token punctuation">::</span><span class="token class-name">Value</span><span class="token punctuation">::</span><span class="token function">decode_value</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>raw_value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//\u7528\u7684\u662F\u54EA\u91CC\u7684decode_value?\u5982\u4F55\u5173\u8054\u8D77\u6765\u7684?</span>
            <span class="token punctuation">.</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Writes single record.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">put</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Schema</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">S</span><span class="token punctuation">::</span><span class="token class-name">Key</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">S</span><span class="token punctuation">::</span><span class="token class-name">Value</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token comment">//\u5411\u6570\u636E\u5E93\u4E2D\u5199</span>
        <span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">::</span><span class="token class-name">Key</span> <span class="token keyword">as</span> <span class="token class-name">KeyCodec</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">::</span><span class="token function">encode_key</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>key<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">::</span><span class="token class-name">Value</span> <span class="token keyword">as</span> <span class="token class-name">ValueCodec</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">::</span><span class="token function">encode_value</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> cf_handle <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">get_cf_handle</span><span class="token punctuation">(</span><span class="token class-name">S</span><span class="token punctuation">::</span><span class="token constant">COLUMN_FAMILY_NAME</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>inner
            <span class="token punctuation">.</span><span class="token function">put_cf_opt</span><span class="token punctuation">(</span>cf_handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>k<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token function">default_write_options</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span>convert_rocksdb_err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="\u6570\u636E\u7684\u6279\u91CF\u5199schemabatch" tabindex="-1">\u6570\u636E\u7684\u6279\u91CF\u5199<code>SchemaBatch</code> <a class="header-anchor" href="#\u6570\u636E\u7684\u6279\u91CF\u5199schemabatch" aria-hidden="true">#</a></h3><p>\u4E3A\u4E86\u63D0\u4F9B\u5199\u5165\u7684\u6548\u7387,Libra\u8FD8\u63D0\u4F9B\u4E86<code>SchemaBatch</code>,\u7528\u4E8E\u6279\u91CF\u66F4\u65B0\u6570\u636E.</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">SchemaBatch</span> <span class="token punctuation">{</span>
    rows<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">ColumnFamilyName</span><span class="token punctuation">,</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span> <span class="token comment">/* key */</span><span class="token punctuation">,</span> <span class="token class-name">WriteOp</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>\u4E00\u822C\u7528\u6CD5\u662F:</p><div class="language-rust line-numbers-mode"><pre><code> <span class="token keyword">let</span> db <span class="token operator">=</span> <span class="token class-name">TestDB</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1000</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> db_batch <span class="token operator">=</span> <span class="token class-name">SchemaBatch</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        db_batch
            <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">TestSchema1</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name">TestField</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token class-name">TestField</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        db_batch
            <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">TestSchema2</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name">TestField</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token class-name">TestField</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        db<span class="token punctuation">.</span><span class="token function">write_schemas</span><span class="token punctuation">(</span>db_batch<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u4E00\u6B21\u6027\u63D0\u4EA4\u5230\u6570\u636E\u5E93\u4E2D</span>
    <span class="token punctuation">}</span>

    db<span class="token punctuation">.</span><span class="token function">flush_all</span><span class="token punctuation">(</span><span class="token comment">/* sync = */</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//\u5237\u5230\u786C\u76D8</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>\u6B63\u5982\u6211\u5728\u4EE3\u7801\u6CE8\u91CA\u4E2D\u63D0\u5230\u7684,\u5176\u5B9E\u8FD9\u91CC\u7684\u5173\u952E\u95EE\u9898\u5C31\u662FRust\u4E2D\u7684\u6570\u636E\u7C7B\u578B\u5F88\u4E30\u5BCC,\u4F46\u662FRocksDB\u4E2D\u65E0\u8BBA\u662FKey\u8FD8\u662FValue\u90FD\u53EA\u80FD\u662F\u5B57\u8282\u5E8F\u5217, \u56E0\u6B64\u5728\u5B58\u53D6\u7684\u65F6\u5019\u5FC5\u7136\u6D89\u53CA\u5230\u4E0D\u65AD\u5730\u7F16\u7801\u548C\u89E3\u7801(<code>KeyCodec</code>\u548C<code>ValueCodec</code>). \u5982\u4F55\u66F4\u65B9\u4FBF\u7684\u5B9E\u73B0\u5462?</p><h3 id="\u7F16\u7801\u548C\u89E3\u7801" tabindex="-1">\u7F16\u7801\u548C\u89E3\u7801 <a class="header-anchor" href="#\u7F16\u7801\u548C\u89E3\u7801" aria-hidden="true">#</a></h3><p>\u5728Libra\u4E2D\u9488\u5BF9KV\u4E2D\u7684Key\u548CValue\u4E24\u4E2A\u5B57\u6BB5\u5206\u522B\u8BBE\u8BA1\u4E86\u7F16\u89E3\u7801\u63A5\u53E3. Key\u7684\u7F16\u7801\u89E3\u7801trait\u662F<code>KeyCodec</code>,Value\u7684\u7F16\u89E3\u7801trait\u5219\u662F<code>ValueCodec</code>. \u4E0B\u9762\u662F\u63A5\u53E3,\u5177\u4F53\u7684\u5B9E\u73B0\u5219\u53EF\u4EE5\u53C2\u8003<a href="#AccountState%E7%9A%84%E5%AD%98%E5%8F%96%E8%BF%87%E7%A8%8B">AccountState\u7684\u5B58\u53D6\u8FC7\u7A0B</a></p><div class="language-rust line-numbers-mode"><pre><code><span class="token comment">/// This trait defines a type that can serve as a [\`Schema::Key\`].</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">KeyCodec</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Schema</span> <span class="token operator">+</span> <span class="token operator">?</span><span class="token class-name">Sized</span><span class="token operator">&gt;</span><span class="token punctuation">:</span> <span class="token class-name">Sized</span> <span class="token operator">+</span> <span class="token class-name">PartialEq</span> <span class="token operator">+</span> <span class="token class-name">Debug</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Converts \`self\` to bytes to be stored in DB.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">encode_key</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Converts bytes fetched from DB to \`Self\`.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">decode_key</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/// This trait defines a type that can serve as a [\`Schema::Value\`].</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">ValueCodec</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Schema</span> <span class="token operator">+</span> <span class="token operator">?</span><span class="token class-name">Sized</span><span class="token operator">&gt;</span><span class="token punctuation">:</span> <span class="token class-name">Sized</span> <span class="token operator">+</span> <span class="token class-name">PartialEq</span> <span class="token operator">+</span> <span class="token class-name">Debug</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Converts \`self\` to bytes to be stored in DB.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">encode_value</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Converts bytes fetched from DB to \`Self\`.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">decode_value</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="\u7F16\u89E3\u7801\u5668\u7684\u4F7F\u7528" tabindex="-1">\u7F16\u89E3\u7801\u5668\u7684\u4F7F\u7528 <a class="header-anchor" href="#\u7F16\u89E3\u7801\u5668\u7684\u4F7F\u7528" aria-hidden="true">#</a></h3><p>\u4E3A\u4E86\u964D\u4F4ESchemaBatch\u4E2Dput,get,delete\u8FD9\u4E9B\u51FD\u6570\u7684\u53C2\u6570\u5F62\u5F0F\u7684\u590D\u6742\u5EA6\u4EE5\u53CA\u63D0\u4F9BCOLUMN_FAMILY_NAME,\u56E0\u6B64\u63D0\u4F9B\u4E86<code>Schema</code>\u8FD9\u4E2Atrait.</p><div class="language-rust line-numbers-mode"><pre><code><span class="token comment">/// This trait defines a schema: an association of a column family name, the key type and the value</span>
<span class="token comment">/// type.</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Schema</span> <span class="token punctuation">{</span>
    <span class="token comment">/// The column family name associated with this struct.</span>
    <span class="token comment">/// Note: all schemas within the same SchemaDB must have distinct column family names.</span>
    <span class="token keyword">const</span> <span class="token constant">COLUMN_FAMILY_NAME</span><span class="token punctuation">:</span> <span class="token class-name">ColumnFamilyName</span><span class="token punctuation">;</span>

    <span class="token comment">/// Type of the key.</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">Key</span><span class="token punctuation">:</span> <span class="token class-name">KeyCodec</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/// Type of the value.</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">Value</span><span class="token punctuation">:</span> <span class="token class-name">ValueCodec</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>\u4ED6\u6CA1\u6709\u4EFB\u4F55\u6210\u5458\u51FD\u6570,\u5C31\u662F\u4E3A\u4E86\u63D0\u4F9BKey,Value\u7684\u7C7B\u578B\u4EE5\u53CACOLUMN_FAMILY_NAME. \u901A\u8FC7<code>Schema</code>\u5728<code>SchemaBatch</code>\u548C<code>DB</code>\u4E2D\u4F7F\u7528<code>KeyCodec</code>\u4EE5\u53CA<code>ValueCodec</code>\u5C31\u6BD4\u8F83\u65B9\u4FBF\u4E86.</p><p>\u4E3A\u4E86\u5B9E\u73B0\u65B9\u4FBF,\u8FD8\u63D0\u4F9B\u4E86\u5B8F<code>define_schema</code></p><div class="language-rust line-numbers-mode"><pre><code><span class="token attribute attr-name">#[macro_export]</span>
<span class="token macro property">macro_rules!</span> define_schema <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token variable">$schema_type</span><span class="token punctuation">:</span> ident<span class="token punctuation">,</span> <span class="token variable">$key_type</span><span class="token punctuation">:</span> ty<span class="token punctuation">,</span> <span class="token variable">$value_type</span><span class="token punctuation">:</span> ty<span class="token punctuation">,</span> <span class="token variable">$cf_name</span><span class="token punctuation">:</span> expr<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token variable">$schema_type</span><span class="token punctuation">;</span>

        <span class="token keyword">impl</span> <span class="token variable">$crate</span><span class="token punctuation">::</span><span class="token namespace">schema<span class="token punctuation">::</span></span><span class="token class-name">Schema</span> <span class="token keyword">for</span> <span class="token variable">$schema_type</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token constant">COLUMN_FAMILY_NAME</span><span class="token punctuation">:</span> <span class="token variable">$crate</span><span class="token punctuation">::</span><span class="token class-name">ColumnFamilyName</span> <span class="token operator">=</span> <span class="token variable">$cf_name</span><span class="token punctuation">;</span>
            <span class="token keyword">type</span> <span class="token type-definition class-name">Key</span> <span class="token operator">=</span> <span class="token variable">$key_type</span><span class="token punctuation">;</span>
            <span class="token keyword">type</span> <span class="token type-definition class-name">Value</span> <span class="token operator">=</span> <span class="token variable">$value_type</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="\u8BF4\u8BF4define-schema\u8FD9\u4E2A\u5B8F" tabindex="-1">\u8BF4\u8BF4<code>define_schema</code>\u8FD9\u4E2A\u5B8F <a class="header-anchor" href="#\u8BF4\u8BF4define-schema\u8FD9\u4E2A\u5B8F" aria-hidden="true">#</a></h3><p>\u987A\u4FBF\u4E3A\u4E86\u5B66\u4E60\u5B8F,\u8FD9\u91CC\u628A\u8FD9\u4E2A\u5B8F\u5C55\u5F00\u4E00\u4E0B.</p><div class="language-rust line-numbers-mode"><pre><code><span class="token comment">//\u8F93\u5165:</span>
<span class="token macro property">define_schema!</span><span class="token punctuation">(</span><span class="token class-name">TestSchema</span><span class="token punctuation">,</span> <span class="token class-name">TestKey</span><span class="token punctuation">,</span> <span class="token class-name">TestValue</span><span class="token punctuation">,</span> <span class="token string">&quot;TestCF&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">TestKey</span><span class="token punctuation">(</span><span class="token keyword">u32</span><span class="token punctuation">,</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">TestValue</span><span class="token punctuation">(</span><span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>\u5BF9\u5E94\u7684\u5185\u5BB9\u5B8F\u5C55\u5F00\u540E\u5C31\u662F:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">impl</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>schema<span class="token punctuation">::</span></span><span class="token class-name">Schema</span> <span class="token keyword">for</span> <span class="token class-name">TestSchema</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token constant">COLUMN_FAMILY_NAME</span><span class="token punctuation">:</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">ColumnFamilyName</span> <span class="token operator">=</span> <span class="token string">&quot;TestCF&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">Key</span> <span class="token operator">=</span> <span class="token class-name">TestKey</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">Value</span> <span class="token operator">=</span> <span class="token class-name">TestValue</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>\u662F\u4E0D\u662F\u5B8F\u770B\u8D77\u6765\u4E5F\u5F88\u7B80\u5355\u8FD9\u91CC\u5C31\u662F\u4E3A\u4E86\u907F\u514D\u91CD\u590D\u5199\u8FD9\u79CD\u53EF\u4EE5\u81EA\u52A8\u751F\u6210\u7684\u4EE3\u7801,\u56E0\u6B64\u63D0\u4F9B\u4E86\u5B8F. \u597D\u5904\u662F\u51CF\u5C11\u4E86\u4EE3\u7801\u7684\u91CD\u590D,\u574F\u5904\u662F<em>\u76EE\u524DIDE\u90FD\u4E0D\u80FD\u5F88\u597D\u8BC6\u522B\u5B8F,\u5BFC\u81F4\u4EE3\u7801\u8DF3\u8F6C\u90FD\u6709\u95EE\u9898</em>,</p><p>##AccountState\u7684\u5B58\u53D6\u8FC7\u7A0B \u4E3A\u4E86\u65B9\u4FBF\u5B66\u4E60,\u8FD9\u91CC\u9009\u53D6\u4E00\u4E2A\u771F\u5B9E\u7684\u4F8B\u5B50,\u770B\u770B\u4E0A\u9762\u7684\u5185\u5BB9\u662F\u5982\u4F55\u4F7F\u7528\u7684.</p><div class="language-rust line-numbers-mode"><pre><code><span class="token macro property">define_schema!</span><span class="token punctuation">(</span>
    <span class="token class-name">AccountStateSchema</span><span class="token punctuation">,</span>
    <span class="token class-name">HashValue</span><span class="token punctuation">,</span>
    <span class="token class-name">AccountStateBlob</span><span class="token punctuation">,</span>
    <span class="token constant">ACCOUNT_STATE_CF_NAME</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//\u8FD9\u662F\u5BF9HashValue\u7684\u7F16\u89E3\u7801,\u8FD9\u4E48\u5199\u7684\u597D\u5904\u662F\u5728put\u548Cget\u4E2D\u7528\u8D77\u6765\u6E05\u6670</span>
<span class="token comment">//\u4F46\u662F\u540C\u4E00\u4E2AHashValue\u5728\u4E0D\u540C\u7684Schema\u4E2D\u53CD\u590D\u51FA\u73B0,\u5219\u9700\u8981\u53CD\u590D\u5B9E\u73B0</span>
<span class="token comment">//\u5177\u4F53\u53EF\u4EE5\u53C2\u8003StateMerkleNodeSchema,\u4ED6\u91CC\u9762\u7684Key\u4E5F\u662FHashValue,</span>
<span class="token comment">//\u4F46\u662F\u4E0D\u5F97\u4E0D\u628AHashValue\u7684\u7F16\u89E3\u7801\u91CD\u590D\u4E86\u4E00\u904D</span>
<span class="token keyword">impl</span> <span class="token class-name">KeyCodec</span><span class="token operator">&lt;</span><span class="token class-name">AccountStateSchema</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">HashValue</span> <span class="token punctuation">{</span> 
    <span class="token keyword">fn</span> <span class="token function-definition function">encode_key</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">decode_key</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">HashValue</span><span class="token punctuation">::</span><span class="token function">from_slice</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">ValueCodec</span><span class="token operator">&lt;</span><span class="token class-name">AccountStateSchema</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">AccountStateBlob</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">encode_value</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">decode_value</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>\u4EE5<code>SchemaBatch</code>\u8C03\u7528\u8FC7\u7A0B\u4E3A\u4F8B.</p><ol><li>SchemaBatch.put \u653E\u5165\u7F13\u5B58Vec\u4E2D</li><li><blockquote><blockquote><p>SchemaBatch.put\u4E2D\u8C03\u7528Key\u7684encode_key,Value\u7684encode_value\u7F16\u7801\u6210\u5B57\u8282\u5E8F\u5217</p></blockquote></blockquote></li><li>DB.write_schemas \u5199\u5165\u5230\u78C1\u76D8</li></ol><p>SchemaBatch put\u7684\u5B9E\u73B0</p><div class="language-rust line-numbers-mode"><pre><code><span class="token comment">/// Adds an insert/update operation to the batch.</span>
<span class="token comment">//\u8FD9\u7684S\u53EF\u4EE5\u770B\u505A\u662F\`AccountStateSchema\`,S::Key\u5C31\u662FKeyCodec&lt;AccountStateSchema&gt;,</span>
<span class="token comment">//S::Value\u5219\u662FValueCodec&lt;AccountStateSchema&gt;,\u6CE8\u610F\u4ED6\u4EEC\u90FD\u662Ftrait\u7C7B\u578B</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">put</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Schema</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">S</span><span class="token punctuation">::</span><span class="token class-name">Key</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">S</span><span class="token punctuation">::</span><span class="token class-name">Value</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> key <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">encode_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> value <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">encode_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>rows
        <span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">S</span><span class="token punctuation">::</span><span class="token constant">COLUMN_FAMILY_NAME</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token class-name">WriteOp</span><span class="token punctuation">::</span><span class="token class-name">Value</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>\u524D\u9762\u901A\u8FC7\u5B8F<code>define_schema</code>\u751F\u6210\u7684\u8F85\u52A9\u4EE3\u7801<code>XXSchema</code>\u5C31\u662F\u4E3A\u4E86\u8FD9\u91CC\u4F7F\u7528,\u5426\u5219\u53C2\u6570\u7C7B\u578B\u4F1A\u7279\u522B\u957F,\u5E76\u4E14\u4E4B\u95F4\u6CA1\u6709\u5F3A\u5236\u5173\u8054.</p><h2 id="\u6570\u636E\u5728\u6570\u636E\u5E93\u4E2D\u5B58\u50A8" tabindex="-1">\u6570\u636E\u5728\u6570\u636E\u5E93\u4E2D\u5B58\u50A8 <a class="header-anchor" href="#\u6570\u636E\u5728\u6570\u636E\u5E93\u4E2D\u5B58\u50A8" aria-hidden="true">#</a></h2><p>\u4E3B\u8981\u662F\u4F9D\u636Estorage/libradb/src/schema\u4E2D\u7684\u5B9A\u4E49</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token constant">ACCOUNT_STATE_CF_NAME</span><span class="token punctuation">:</span> <span class="token class-name">ColumnFamilyName</span> <span class="token operator">=</span> <span class="token string">&quot;account_state&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token constant">EVENT_ACCUMULATOR_CF_NAME</span><span class="token punctuation">:</span> <span class="token class-name">ColumnFamilyName</span> <span class="token operator">=</span> <span class="token string">&quot;event_accumulator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token constant">EVENT_BY_ACCESS_PATH_CF_NAME</span><span class="token punctuation">:</span> <span class="token class-name">ColumnFamilyName</span> <span class="token operator">=</span> <span class="token string">&quot;event_by_access_path&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token constant">EVENT_CF_NAME</span><span class="token punctuation">:</span> <span class="token class-name">ColumnFamilyName</span> <span class="token operator">=</span> <span class="token string">&quot;event&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token constant">SIGNATURE_CF_NAME</span><span class="token punctuation">:</span> <span class="token class-name">ColumnFamilyName</span> <span class="token operator">=</span> <span class="token string">&quot;signature&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token constant">SIGNED_TRANSACTION_CF_NAME</span><span class="token punctuation">:</span> <span class="token class-name">ColumnFamilyName</span> <span class="token operator">=</span> <span class="token string">&quot;signed_transaction&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token constant">STATE_MERKLE_NODE_CF_NAME</span><span class="token punctuation">:</span> <span class="token class-name">ColumnFamilyName</span> <span class="token operator">=</span> <span class="token string">&quot;state_merkle_node&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token constant">TRANSACTION_ACCUMULATOR_CF_NAME</span><span class="token punctuation">:</span> <span class="token class-name">ColumnFamilyName</span> <span class="token operator">=</span> <span class="token string">&quot;transaction_accumulator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token constant">TRANSACTION_INFO_CF_NAME</span><span class="token punctuation">:</span> <span class="token class-name">ColumnFamilyName</span> <span class="token operator">=</span> <span class="token string">&quot;transaction_info&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token constant">VALIDATOR_CF_NAME</span><span class="token punctuation">:</span> <span class="token class-name">ColumnFamilyName</span> <span class="token operator">=</span> <span class="token string">&quot;validator&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="account-state" tabindex="-1">account_state <a class="header-anchor" href="#account-state" aria-hidden="true">#</a></h3><p>HashValue=&gt;AccountStateBlob\u7684\u6620\u5C04 HashValue\u5E94\u8BE5\u662F\u8D26\u6237\u5730\u5740</p><h3 id="event-accumulator-eventaccumulatorschema" tabindex="-1">event_accumulator (EventAccumulatorSchema) <a class="header-anchor" href="#event-accumulator-eventaccumulatorschema" aria-hidden="true">#</a></h3><p>(Version,Position)=&gt;HashValue \u4F7F\u7528\u65B9\u6CD5\u89C1<code>libradb/src/event_store</code>\u4E2D\u7684<code>put_events</code></p><h3 id="event-by-access-path" tabindex="-1">event_by_access_path <a class="header-anchor" href="#event-by-access-path" aria-hidden="true">#</a></h3><p>(AccessPath, SeqNum)=&gt; (Version, Index)</p><h3 id="event" tabindex="-1">event <a class="header-anchor" href="#event" aria-hidden="true">#</a></h3><p>(Version, Index)=&gt;ContractEvent</p><h3 id="signed-transaction" tabindex="-1">signed_transaction <a class="header-anchor" href="#signed-transaction" aria-hidden="true">#</a></h3><p>Version=&gt;SignedTransaction</p><h3 id="state-merkle-node" tabindex="-1">state_merkle_node <a class="header-anchor" href="#state-merkle-node" aria-hidden="true">#</a></h3><p>HashValue=&gt;sparse_merkle::node_type::Node</p><h3 id="transaction-accumulator" tabindex="-1">transaction_accumulator <a class="header-anchor" href="#transaction-accumulator" aria-hidden="true">#</a></h3><p>types::proof::position::Position=&gt;HashValue</p><h3 id="transaction-info" tabindex="-1">transaction_info <a class="header-anchor" href="#transaction-info" aria-hidden="true">#</a></h3><p>Version=&gt;TransactionInfo</p><h3 id="validator" tabindex="-1">validator <a class="header-anchor" href="#validator" aria-hidden="true">#</a></h3><p>(Version,PublicKey)=&gt;()\u7A7A \u8FD9\u4E2A\u4E3A\u4EC0\u4E48\u8FD9\u6837\u5B9A\u4E49\u5462?</p><h3 id="ledger-info" tabindex="-1">ledger_info <a class="header-anchor" href="#ledger-info" aria-hidden="true">#</a></h3><p>Version=&gt;LedgerInfoWithSignatures \u6CE8\u610F\u8FD9\u4E2A\u662F\u653E\u5728<code>DEFAULT_CF_NAME</code>\u4E2D\u7684</p><h2 id="schema\u7684\u4F7F\u7528" tabindex="-1">schema\u7684\u4F7F\u7528 <a class="header-anchor" href="#schema\u7684\u4F7F\u7528" aria-hidden="true">#</a></h2><h3 id="state-store" tabindex="-1">state_store <a class="header-anchor" href="#state-store" aria-hidden="true">#</a></h3><p>\u4F4D\u4E8Estorage/libradb/src/state_store:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">StateStore</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token constant">DB</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">StateStore</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token constant">DB</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">Self</span> <span class="token punctuation">{</span> db <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Get the account state blob given account address and root hash of state Merkle tree</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_account_state_with_proof_by_state_root</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span>
        address<span class="token punctuation">:</span> <span class="token class-name">AccountAddress</span><span class="token punctuation">,</span>
        root_hash<span class="token punctuation">:</span> <span class="token class-name">HashValue</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">AccountStateBlob</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">SparseMerkleProof</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>blob<span class="token punctuation">,</span> proof<span class="token punctuation">)</span> <span class="token operator">=</span>
            <span class="token class-name">SparseMerkleTree</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get_with_proof</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root_hash<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span> <span class="token comment">//\u53BB\u6570\u636E\u5E93\u4E2D\u8BFB\u53D6\u5728\u6307\u5B9Aroothash\u60C5\u51B5\u4E0B\u7684\u8FD9\u4E2A\u5730\u5740\u7684\u72B6\u6001</span>
        <span class="token macro property">debug_assert!</span><span class="token punctuation">(</span>
            <span class="token function">verify_sparse_merkle_element</span><span class="token punctuation">(</span>root_hash<span class="token punctuation">,</span> address<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>blob<span class="token punctuation">,</span> <span class="token operator">&amp;</span>proof<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;Invalid proof.&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> proof<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Put the results generated by \`keyed_blob_sets\` to \`batch\` and return the result root hashes</span>
    <span class="token comment">/// for each write set.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">put_account_state_sets</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span>
        account_state_sets<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">AccountAddress</span><span class="token punctuation">,</span> <span class="token class-name">AccountStateBlob</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
        root_hash<span class="token punctuation">:</span> <span class="token class-name">HashValue</span><span class="token punctuation">,</span>
        batch<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">SchemaBatch</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">HashValue</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
       <span class="token punctuation">...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">TreeReader</span> <span class="token keyword">for</span> <span class="token class-name">StateStore</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">get_node</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> node_hash<span class="token punctuation">:</span> <span class="token class-name">HashValue</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span>
            <span class="token punctuation">.</span>db
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">StateMerkleNodeSchema</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>node_hash<span class="token punctuation">)</span><span class="token operator">?</span> <span class="token comment">//\u4F7F\u7528\u4E0A\u9762\u7684\u7F16\u89E3\u7801\u5668\u8FDB\u884C\u81EA\u52A8\u89E3\u7801</span>
            <span class="token punctuation">.</span><span class="token function">ok_or_else</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">format_err!</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to find node with hash {:?}&quot;</span><span class="token punctuation">,</span> node_hash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">get_blob</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> blob_hash<span class="token punctuation">:</span> <span class="token class-name">HashValue</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">AccountStateBlob</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span>
            <span class="token punctuation">.</span>db
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">AccountStateSchema</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>blob_hash<span class="token punctuation">)</span><span class="token operator">?</span><span class="token comment">//\u4F7F\u7528\u4E0A\u9762\u7684\u7F16\u89E3\u7801\u5668\u8FDB\u884C\u81EA\u52A8\u89E3\u7801</span>
            <span class="token punctuation">.</span><span class="token function">ok_or_else</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token macro property">format_err!</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;Failed to find account state blob with hash {:?}&quot;</span><span class="token punctuation">,</span>
                    blob_hash
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>\u5C24\u5176\u662F\u4E0B\u9762\u7684get_node\u548Cget_blob\u5C31\u975E\u5E38\u6E05\u6670\u7684\u770B\u51FA\u6765,\u76F4\u63A5\u4F7F\u7528\u4E86StateMerkleNodeSchema\u548CAccountStateSchema\u8FDB\u884Cdecode.</p><h3 id="transaction-store" tabindex="-1">transaction_store <a class="header-anchor" href="#transaction-store" aria-hidden="true">#</a></h3><p>\u4E0A\u4E00\u4E2Astate_store\u53EF\u80FD\u770B\u8D77\u6765\u7A0D\u663E\u590D\u6742,\u4E0B\u9762\u7684\u5219\u66F4\u6E05\u6670\u76F4\u63A5.</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">TransactionStore</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token constant">DB</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">TransactionStore</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token constant">DB</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">Self</span> <span class="token punctuation">{</span> db <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Get signed transaction given \`version\`</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_transaction</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> version<span class="token punctuation">:</span> <span class="token class-name">Version</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">SignedTransaction</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>db
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">SignedTransactionSchema</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>version<span class="token punctuation">)</span><span class="token operator">?</span> <span class="token comment">//get\u662F\u76F4\u63A5\u4ECEdb\u8BFB\u53D6</span>
            <span class="token punctuation">.</span><span class="token function">ok_or_else</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">LibraDbError</span><span class="token punctuation">::</span><span class="token class-name">NotFound</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Txn {}&quot;</span><span class="token punctuation">,</span> version<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Save signed transaction at \`version\`</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">put_transaction</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span>
        version<span class="token punctuation">:</span> <span class="token class-name">Version</span><span class="token punctuation">,</span>
        signed_transaction<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">SignedTransaction</span><span class="token punctuation">,</span>
        batch<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">SchemaBatch</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        batch<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">SignedTransactionSchema</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>version<span class="token punctuation">,</span> signed_transaction<span class="token punctuation">)</span> <span class="token comment">//put\u5219\u4F7F\u7528\u7684\u662Fbatch\u64CD\u4F5C</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="event-store\u548Cledger-store" tabindex="-1">event_store\u548Cledger_store <a class="header-anchor" href="#event-store\u548Cledger-store" aria-hidden="true">#</a></h3><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">EventStore</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token constant">DB</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">LedgerStore</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token constant">DB</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>\u4E24\u8005\u7A0D\u5FAE\u590D\u6742\u4E00\u70B9,\u8FD9\u5C31\u4E0D\u4E00\u4E00\u5217\u4E3E\u4E86,\u4F46\u662F\u601D\u8DEF\u662F\u5B8C\u5168\u4E00\u6837\u7684.</p>`,68),o=[e];function c(l,u,r,i,k,m){return a(),s("div",null,o)}var h=n(t,[["render",c]]);export{b as __pageData,h as default};
