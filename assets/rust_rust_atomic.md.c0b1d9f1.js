import{o as n,c as s,e as a}from"./app.d382aac0.js";const p='{"title":"我对rust atomic的理解","description":"","frontmatter":{"title":"我对rust atomic的理解","date":"2022-01-04T13:57:03.000Z","draft":false,"tags":["rust"],"categories":["技术相关"]},"headers":[{"level":2,"title":"atomic 介绍","slug":"atomic-介绍"},{"level":3,"title":"atomic的执行顺序","slug":"atomic的执行顺序"},{"level":2,"title":"代码的理解","slug":"代码的理解"}],"relativePath":"rust/rust_atomic.md","lastUpdated":1641604782000}',e={},t=[a('<p>最近rust 日报公众号发了一篇文章,有一个哥们做了<a href="https://github.com/blasrodri/atomic-story" target="_blank" rel="noopener noreferrer">rust atomic的测试</a>,主要是帮助大家理解atomic的工作机制. 我顺道来解释一下atomic是怎么工作的以及为什么会是这样.</p><h2 id="atomic-介绍"><a class="header-anchor" href="#atomic-介绍" aria-hidden="true">#</a> atomic 介绍</h2><p>atomic的话题比较复杂, 涉及的内容较多,说一下,我的理解,主要从两个方面.</p><ol><li>操作的原子性,也就是CAS,主要解决a+=1这种操作的原子性问题.</li><li>执行顺序问题,这个才是atomic比较难理解的地方.</li></ol><h3 id="atomic的执行顺序"><a class="header-anchor" href="#atomic的执行顺序" aria-hidden="true">#</a> atomic的执行顺序</h3><p>Order主要有五种模式:</p><ul><li>Relaxed load,store都能用</li><li>Release 仅能用于store</li><li>Acquire 仅能用于load</li><li>AcqRel load,store都能用,实际上可以认为是Release和Acquire的合体,有点类似于语法糖.</li><li>SeqCst load,store都能用</li></ul><p>如何理解这五种模式呢?</p><h4 id="relaxed模式"><a class="header-anchor" href="#relaxed模式" aria-hidden="true">#</a> Relaxed模式</h4><p>实现了CAS功能,也就是只保证原子的操作性,不保证执行顺序.</p><h4 id="acquire-release-acqrel"><a class="header-anchor" href="#acquire-release-acqrel" aria-hidden="true">#</a> Acquire,Release,AcqRel</h4><p>如何理解执行顺序呢? 这个的关键地方是性能,为了让程序更快的执行,我们的编译器和CPU可以做很多优化. 比如优化指令的执行顺序,这不仅涉及到编译器,也涉及到CPU,都可能会对执行令进行重排. 但是有时候我们想阻止这种重排行为,该怎么告诉编译器和cpu呢?</p><p><strong>这就是atomic的Order.</strong></p><p><strong>Release 告诉cpu不要把我这条指令前面的指令放到我后面执行,而Acquire则是告诉CPU,不要把我后面的执行放到我前面执行.</strong></p><p>这个很难记,但是其实很容易理解,我们对比lock来理解,lock主要用来保护一个临界区域,主要是保护从lock到unlock的一段指令的执行. 而<strong>lock类似于Acquire,unlock类似于Release</strong>,就是为了保证这段指令的执行.</p><h4 id="seqcst"><a class="header-anchor" href="#seqcst" aria-hidden="true">#</a> SeqCst</h4><p>指令前的不能挪到后面执行,指令后面的不能挪到前面执行. 所以如果你<strong>搞不清楚的时候就用这个</strong>,但是它的问题也很明显:</p><p><strong>因为顺序不能自由调整,性能上不如Release/Acquire配合</strong></p><h2 id="代码的理解"><a class="header-anchor" href="#代码的理解" aria-hidden="true">#</a> 代码的理解</h2><p>这里把代码粘贴在这里,方便大家阅读:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token attribute attr-name">#[cfg(test)]</span>\n<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>\n    <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>atomic<span class="token punctuation">::</span></span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token punctuation">{</span><span class="token class-name">Acquire</span><span class="token punctuation">,</span> <span class="token class-name">Relaxed</span><span class="token punctuation">,</span> <span class="token class-name">Release</span><span class="token punctuation">,</span> <span class="token class-name">SeqCst</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>atomic<span class="token punctuation">::</span></span><span class="token class-name">Ordering</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">use</span> <span class="token namespace">loom<span class="token punctuation">::</span></span><span class="token punctuation">{</span>\n        <span class="token namespace">sync<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">atomic<span class="token punctuation">::</span></span><span class="token class-name">AtomicUsize</span><span class="token punctuation">,</span> <span class="token class-name">Arc</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n        thread<span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">fn</span> <span class="token function-definition function">two_numbers_with_a_dependency</span><span class="token punctuation">(</span>\n        read_ordering_a<span class="token punctuation">:</span> <span class="token class-name">Ordering</span><span class="token punctuation">,</span>\n        read_ordering_b<span class="token punctuation">:</span> <span class="token class-name">Ordering</span><span class="token punctuation">,</span>\n        write_ordering_a<span class="token punctuation">:</span> <span class="token class-name">Ordering</span><span class="token punctuation">,</span>\n        write_ordering_b<span class="token punctuation">:</span> <span class="token class-name">Ordering</span><span class="token punctuation">,</span>\n    <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token namespace">loom<span class="token punctuation">::</span></span><span class="token function">model</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>\n            <span class="token keyword">let</span> num_a <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">AtomicUsize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">let</span> num_b <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">AtomicUsize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token keyword">let</span> num_a2 <span class="token operator">=</span> num_a<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">let</span> num_b2 <span class="token operator">=</span> num_b<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">let</span> tb <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>\n                <span class="token keyword">for</span> idx <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span><span class="token number">4</span> <span class="token punctuation">{</span>\n                    num_a2<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> read_ordering_a<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    num_b2<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> read_ordering_b<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>\n                <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span><span class="token number">4</span> <span class="token punctuation">{</span>\n                    <span class="token keyword">let</span> nb <span class="token operator">=</span> num_b<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>write_ordering_b<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    <span class="token keyword">let</span> na <span class="token operator">=</span> num_a<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>write_ordering_a<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    <span class="token macro property">assert!</span><span class="token punctuation">(</span>na <span class="token operator">&gt;=</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            tb<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token attribute attr-name">#[test]</span>\n    <span class="token attribute attr-name">#[should_panic]</span>\n    <span class="token keyword">fn</span> <span class="token function-definition function">atomics_relaxed_failing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">two_numbers_with_a_dependency</span><span class="token punctuation">(</span><span class="token class-name">Relaxed</span><span class="token punctuation">,</span> <span class="token class-name">Relaxed</span><span class="token punctuation">,</span> <span class="token class-name">Relaxed</span><span class="token punctuation">,</span> <span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token attribute attr-name">#[test]</span>\n    <span class="token attribute attr-name">#[should_panic]</span>\n    <span class="token keyword">fn</span> <span class="token function-definition function">atomics_writer_release_reader_relaxed_failing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">two_numbers_with_a_dependency</span><span class="token punctuation">(</span><span class="token class-name">Release</span><span class="token punctuation">,</span> <span class="token class-name">Release</span><span class="token punctuation">,</span> <span class="token class-name">Relaxed</span><span class="token punctuation">,</span> <span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token attribute attr-name">#[test]</span>\n    <span class="token keyword">fn</span> <span class="token function-definition function">atomics_writer_release_reader_seqcst_and_relaxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">two_numbers_with_a_dependency</span><span class="token punctuation">(</span><span class="token class-name">Release</span><span class="token punctuation">,</span> <span class="token class-name">Release</span><span class="token punctuation">,</span> <span class="token class-name">Relaxed</span><span class="token punctuation">,</span> <span class="token class-name">SeqCst</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token attribute attr-name">#[test]</span>\n    <span class="token keyword">fn</span> <span class="token function-definition function">atomics_seq_cst_does_not_fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">two_numbers_with_a_dependency</span><span class="token punctuation">(</span><span class="token class-name">SeqCst</span><span class="token punctuation">,</span> <span class="token class-name">SeqCst</span><span class="token punctuation">,</span> <span class="token class-name">SeqCst</span><span class="token punctuation">,</span> <span class="token class-name">SeqCst</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token attribute attr-name">#[test]</span>\n    <span class="token keyword">fn</span> <span class="token function-definition function">atomics_acquire_release_does_not_fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">two_numbers_with_a_dependency</span><span class="token punctuation">(</span><span class="token class-name">Release</span><span class="token punctuation">,</span> <span class="token class-name">Release</span><span class="token punctuation">,</span> <span class="token class-name">Acquire</span><span class="token punctuation">,</span> <span class="token class-name">Acquire</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><p>顺便说一下loom,这个一个帮助并发测试的工具,方便发现潜在的竞争冲突问题.</p><h4 id="atomics-relaxed-failing"><a class="header-anchor" href="#atomics-relaxed-failing" aria-hidden="true">#</a> atomics_relaxed_failing</h4><p>这个失败,很自然,他不能保证顺序的执行,所以不能保证读到数据之间的逻辑性.</p><h4 id="two-numbers-with-a-dependency"><a class="header-anchor" href="#two-numbers-with-a-dependency" aria-hidden="true">#</a> two_numbers_with_a_dependency</h4><p>这个失败的原因是,保证store的顺序,但是load的顺序不能保证.</p><h4 id="atomics-writer-release-reader-seqcst-and-relaxed"><a class="header-anchor" href="#atomics-writer-release-reader-seqcst-and-relaxed" aria-hidden="true">#</a> atomics_writer_release_reader_seqcst_and_relaxed</h4><p>这个可以成功的原因是<code>write_ordering_b</code>是seqCst,他保证了load的顺序,而Release保证了store的顺序.</p><h4 id="atomics-seq-cst-does-not-fail"><a class="header-anchor" href="#atomics-seq-cst-does-not-fail" aria-hidden="true">#</a> atomics_seq_cst_does_not_fail</h4><p>这个是最严苛的模式,所以性能也是最低的.</p><h4 id="atomics-acquire-release-does-not-fail"><a class="header-anchor" href="#atomics-acquire-release-does-not-fail" aria-hidden="true">#</a> atomics_acquire_release_does_not_fail</h4><p>这个不仅保证了正确性,同时也是性能最优.</p>',32)];e.render=function(a,p,e,c,o,l){return n(),s("div",null,t)};export{p as __pageData,e as default};
