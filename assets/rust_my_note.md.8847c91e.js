import{o as n,c as s,e as a}from"./app.8bf2a359.js";const e='{"title":"rustå­¦ä¹ ç¬”è®°","description":"","frontmatter":{"title":"rustå­¦ä¹ ç¬”è®°","date":"2019-04-03T03:57:03.000Z","draft":false,"tags":["rust"],"categories":["æŠ€æœ¯ç›¸å…³"]},"headers":[{"level":2,"title":"å†…å­˜å®‰å…¨","slug":"å†…å­˜å®‰å…¨"},{"level":3,"title":"æ®µé”™è¯¯","slug":"æ®µé”™è¯¯"},{"level":2,"title":"æ‰€æœ‰æƒ","slug":"æ‰€æœ‰æƒ"},{"level":2,"title":"å€Ÿç”¨äºæ‰€æœ‰æƒ","slug":"å€Ÿç”¨äºæ‰€æœ‰æƒ"},{"level":3,"title":"Copy Trait","slug":"copy-trait"},{"level":3,"title":"Copyå’ŒCloneçš„åŒºåˆ«","slug":"copyå’Œcloneçš„åŒºåˆ«"},{"level":3,"title":"å¼•ç”¨ä¸è§£å¼•ç”¨(dereferencing)","slug":"å¼•ç”¨ä¸è§£å¼•ç”¨-dereferencing"},{"level":3,"title":"Sliceç±»å‹","slug":"sliceç±»å‹"},{"level":2,"title":"ç»“æ„ä½“","slug":"ç»“æ„ä½“"},{"level":3,"title":"struct","slug":"struct"},{"level":2,"title":"æšä¸¾","slug":"æšä¸¾"},{"level":2,"title":"crate,mod","slug":"crate-mod"},{"level":2,"title":"rusté«˜çº§éƒ¨åˆ†","slug":"rusté«˜çº§éƒ¨åˆ†"},{"level":3,"title":"unsafe","slug":"unsafe"},{"level":2,"title":"Cell ç”¨æ³•","slug":"cell-ç”¨æ³•"},{"level":3,"title":"å€Ÿç”¨è§„åˆ™","slug":"å€Ÿç”¨è§„åˆ™"},{"level":3,"title":"è§£å¼•ç”¨","slug":"è§£å¼•ç”¨"},{"level":3,"title":"å®","slug":"å®"},{"level":3,"title":"ä¸´æ—¶å˜é‡çš„ç”Ÿå‘½å‘¨æœŸ","slug":"ä¸´æ—¶å˜é‡çš„ç”Ÿå‘½å‘¨æœŸ"},{"level":3,"title":"\'static æ³›å‹","slug":"static-æ³›å‹"},{"level":3,"title":"å‡½æ•°ç”Ÿå‘½å‘¨æœŸçš„æ¨å¯¼è§„åˆ™","slug":"å‡½æ•°ç”Ÿå‘½å‘¨æœŸçš„æ¨å¯¼è§„åˆ™"},{"level":3,"title":"é«˜é˜¶ç”Ÿå‘½å‘¨æœŸ","slug":"é«˜é˜¶ç”Ÿå‘½å‘¨æœŸ"},{"level":2,"title":"å®","slug":"å®-1"},{"level":3,"title":"å®è°ƒè¯•","slug":"å®è°ƒè¯•"},{"level":3,"title":"å…³äºçº¿ç¨‹å®‰å…¨","slug":"å…³äºçº¿ç¨‹å®‰å…¨"},{"level":2,"title":"å…³äºasyncå’Œawait","slug":"å…³äºasyncå’Œawait"},{"level":3,"title":"await","slug":"await"},{"level":3,"title":"Pinning","slug":"pinning"},{"level":3,"title":"Stream","slug":"stream"},{"level":2,"title":"atmoic","slug":"atmoic"},{"level":3,"title":"Release-Acquire ordering","slug":"release-acquire-ordering"},{"level":3,"title":"Sizedå’Œ?Sized","slug":"sizedå’Œ-sized"},{"level":3,"title":"Borrow å’ŒAsRefä¸¤ä¸ªTraitçš„å…³ç³»","slug":"borrow-å’Œasrefä¸¤ä¸ªtraitçš„å…³ç³»"},{"level":2,"title":"PhantomDataçš„ä¸€äº›ç”¨æ³•","slug":"phantomdataçš„ä¸€äº›ç”¨æ³•"}],"relativePath":"rust/my_note.md","lastUpdated":1641139108747}',p={},t=[a('<h2 id="å†…å­˜å®‰å…¨"><a class="header-anchor" href="#å†…å­˜å®‰å…¨" aria-hidden="true">#</a> å†…å­˜å®‰å…¨</h2><h3 id="æ®µé”™è¯¯"><a class="header-anchor" href="#æ®µé”™è¯¯" aria-hidden="true">#</a> æ®µé”™è¯¯</h3><p>Rust is a systems programming language that runs blazingly fastï¼Œprevents segfaultsï¼Œand guarantees thread safety.</p><p>å†…å­˜ä¸å®‰å…¨çš„è¡Œä¸º:</p><ul><li>ç©ºæŒ‡é’ˆ</li><li>é‡æŒ‡é’ˆ</li><li>æ‚¬ç©ºæŒ‡é’ˆ</li><li>ä½¿ç”¨æœªåˆå§‹åŒ–çš„æŒ‡é’ˆ</li><li>éæ³•é‡Šæ”¾</li><li>ç¼“å†²åŒºæº¢å‡º</li><li>æ‰§è¡Œéæ³•å‡½æ•°æŒ‡é’ˆ</li><li>æ•°æ®ç«äº‰</li></ul><p>ä¸è®¤ä¸ºæ˜¯å†…å­˜å®‰å…¨çš„è¡Œä¸º:</p><ul><li>å†…å­˜æ³„æ¼</li></ul><h2 id="æ‰€æœ‰æƒ"><a class="header-anchor" href="#æ‰€æœ‰æƒ" aria-hidden="true">#</a> æ‰€æœ‰æƒ</h2><ol><li>Rust ä¸­çš„æ¯ä¸€ä¸ªå€¼æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ‰€æœ‰è€…ã€‚</li><li>å½“æ‰€æœ‰è€…ï¼ˆå˜é‡ï¼‰ç¦»å¼€ä½œç”¨åŸŸï¼Œè¿™ä¸ªå€¼å°†è¢«ä¸¢å¼ƒã€‚</li></ol><h2 id="å€Ÿç”¨äºæ‰€æœ‰æƒ"><a class="header-anchor" href="#å€Ÿç”¨äºæ‰€æœ‰æƒ" aria-hidden="true">#</a> å€Ÿç”¨äºæ‰€æœ‰æƒ</h2><ol><li>ä¸€ä¸ªå˜é‡å¯ä»¥å­˜åœ¨å¤šä¸ªåªè¯»å€Ÿç”¨(shared reference),ä½†æ˜¯å®é™…ä¸Šåˆå¯ä»¥æœ‰å…¶ä»–æ‰‹æ®µæ¥ä¿®æ”¹</li><li>ä¸€ä¸ªå˜é‡åªèƒ½å­˜åœ¨ä¸€ä¸ªå¯å†™å€Ÿç”¨,å¯å†™å€Ÿç”¨å¯ä»¥ä¿®æ”¹å˜é‡çš„å†…å®¹,ä½†æ˜¯ä¸èƒ½è½¬ç§»æ‰€æœ‰æƒ</li></ol><h3 id="copy-trait"><a class="header-anchor" href="#copy-trait" aria-hidden="true">#</a> Copy Trait</h3><p>ç¼–è¯‘æ—¶å¤§å°å·²çŸ¥,å¹¶ä¸”å­˜å‚¨åœ¨æ ˆä¸Š(å€¼ç±»å‹)ä¸€èˆ¬éƒ½æœ‰copy trait,ç§°ä¹‹ä¸ºæµ…æ‹·è´.</p><ul><li>å…ƒç»„ï¼Œå½“ä¸”ä»…å½“å…¶åŒ…å«çš„ç±»å‹ä¹Ÿéƒ½æ˜¯ Copy çš„æ—¶å€™ã€‚æ¯”å¦‚ï¼Œ(i32, i32) æ˜¯ Copy çš„ï¼Œä½† (i32, String) å°±ä¸æ˜¯ã€‚</li></ul><h3 id="copyå’Œcloneçš„åŒºåˆ«"><a class="header-anchor" href="#copyå’Œcloneçš„åŒºåˆ«" aria-hidden="true">#</a> Copyå’ŒCloneçš„åŒºåˆ«</h3><p>Copyæ˜¯æµ…æ‹·è´,æ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨è°ƒç”¨,Cloneæ˜¯æ·±æ‹·è´,ç¨‹åºå‘˜æ‰‹å·¥è°ƒç”¨.</p><h3 id="å¼•ç”¨ä¸è§£å¼•ç”¨-dereferencing"><a class="header-anchor" href="#å¼•ç”¨ä¸è§£å¼•ç”¨-dereferencing" aria-hidden="true">#</a> å¼•ç”¨ä¸è§£å¼•ç”¨(dereferencing)</h3><p>&amp; å¼•ç”¨å®é™…ä¸Šå¯ä»¥è®¤ä¸ºæ˜¯æ‰€æœ‰æƒçš„ä¸´æ—¶å€Ÿç”¨ (ä¸å…¨æ˜¯cè¯­è¨€ä¸­çš„æŒ‡é’ˆ,åªä¸è¿‡ç”¨èµ·æ¥åƒè€Œå·²)</p><ul><li>è§£å¼•ç”¨</li></ul><p>å¼•ç”¨æœ‰ä¸¤ç§ <strong>ä¸å¯å˜å¼•ç”¨ä¸å¯å˜å¼•ç”¨</strong>.</p><ul><li>åœ¨ä»»æ„ç»™å®šæ—¶é—´ï¼Œè¦ä¹ˆ åªèƒ½æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼Œè¦ä¹ˆ åªèƒ½æœ‰å¤šä¸ªä¸å¯å˜å¼•ç”¨ã€‚</li><li>å¼•ç”¨å¿…é¡»æ€»æ˜¯æœ‰æ•ˆã€‚</li></ul><h3 id="sliceç±»å‹"><a class="header-anchor" href="#sliceç±»å‹" aria-hidden="true">#</a> Sliceç±»å‹</h3><ul><li>ä»–æ²¡æœ‰æ•°æ®æ‰€æœ‰æƒ</li><li>ä»–åªæ˜¯å¯¹å †ä¸Šæ•°æ®çš„å¼•ç”¨</li></ul><h2 id="ç»“æ„ä½“"><a class="header-anchor" href="#ç»“æ„ä½“" aria-hidden="true">#</a> ç»“æ„ä½“</h2><h3 id="struct"><a class="header-anchor" href="#struct" aria-hidden="true">#</a> struct</h3><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">struct</span> <span class="token type-definition class-name">User</span> <span class="token punctuation">{</span>\n    username<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>\n    email<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>\n    sign_in_count<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>\n    active<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol><li>#[drive(Debug)] å¯ä»¥æ–¹ä¾¿æ‰“å°è°ƒè¯•ä¿¡æ¯ {:?}</li><li>å®šä¹‰åœ¨ç»“æ„ä½“ä¸Šçš„å‡½æ•°ç§°ä¹‹ä¸ºæ–¹æ³• (ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯&amp;selfæˆ–è€…&amp;mut self)</li><li>&amp;self(&amp; mut self) ç±»ä¼¼äºthisæŒ‡é’ˆ</li><li>å…³è”å‡½æ•°,å®šä¹‰åœ¨structä¸Š,ä½†æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯&amp;self(ç±»ä¼¼äºc++ç±»çš„é™æ€å‡½æ•°)</li></ol><p>###å…ƒç»„(tuple) å…ƒç»„æ˜¯æ²¡æœ‰å­—æ®µåçš„ç»“æ„ä½“</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">struct</span> <span class="token type-definition class-name">Color</span><span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="æšä¸¾"><a class="header-anchor" href="#æšä¸¾" aria-hidden="true">#</a> æšä¸¾</h2><p>æšä¸¾æ˜¯ä¸€ä¸ªå¾ˆå¤šè¯­è¨€éƒ½æœ‰çš„åŠŸèƒ½ï¼Œä¸è¿‡ä¸åŒè¯­è¨€ä¸­å…¶åŠŸèƒ½å„ä¸ç›¸åŒã€‚Rust çš„æšä¸¾ä¸ F#ã€OCaml å’Œ Haskell è¿™æ ·çš„å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ä¸­çš„ ä»£æ•°æ•°æ®ç±»å‹ï¼ˆalgebraic data typesï¼‰æœ€ä¸ºç›¸ä¼¼ã€‚</p><p><strong>ä¸C/goè¯­è¨€ä¸­çš„æšä¸¾å®Œå…¨ä¸åŒ,æ²¡æœ‰å¯¹åº”çš„æ•´æ•°å€¼.</strong></p><p>ä¸€ä¸ªå…¸å‹çš„ä¾‹å­:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">enum</span> <span class="token type-definition class-name">Message</span> <span class="token punctuation">{</span>\n    <span class="token class-name">Quit</span><span class="token punctuation">,</span>\n    <span class="token class-name">Move</span> <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token keyword">i32</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token class-name">Write</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token class-name">ChangeColor</span><span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="option"><a class="header-anchor" href="#option" aria-hidden="true">#</a> Option</h4><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">enum</span> <span class="token type-definition class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n    <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token class-name">None</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>matchå¿…é¡»æ˜¯ç©·å°½çš„</strong></p><p><strong>if letæ˜¯ä¸€ç§ä¸“é—¨çš„ç”¨æ³•</strong></p><h2 id="crate-mod"><a class="header-anchor" href="#crate-mod" aria-hidden="true">#</a> crate,mod</h2><ul><li>æ¨¡å—ï¼Œä¸€ä¸ªç»„ç»‡ä»£ç å’Œæ§åˆ¶è·¯å¾„ç§æœ‰æ€§çš„æ–¹å¼</li><li>è·¯å¾„ï¼Œä¸€ä¸ªå‘½åé¡¹ï¼ˆitemï¼‰çš„æ–¹å¼</li><li>use å…³é”®å­—ç”¨æ¥å°†è·¯å¾„å¼•å…¥ä½œç”¨åŸŸ,superå…³é”®å­—è¡¨ç¤ºçˆ¶æ¨¡å—</li><li>pub å…³é”®å­—ä½¿é¡¹å˜ä¸ºå…¬æœ‰</li><li>as å…³é”®å­—ç”¨äºå°†é¡¹å¼•å…¥ä½œç”¨åŸŸæ—¶è¿›è¡Œé‡å‘½å</li><li>ä½¿ç”¨å¤–éƒ¨åŒ…</li><li>åµŒå¥—è·¯å¾„ç”¨æ¥æ¶ˆé™¤å¤§é‡çš„ use è¯­å¥</li><li>ä½¿ç”¨ glob è¿ç®—ç¬¦å°†æ¨¡å—çš„æ‰€æœ‰å†…å®¹å¼•å…¥ä½œç”¨åŸŸ</li><li>å¦‚ä½•å°†ä¸åŒæ¨¡å—åˆ†å‰²åˆ°å•ç‹¬çš„æ–‡ä»¶ä¸­</li></ul><ul><li>é€šè¿‡pub useé‡å¯¼å‡º</li><li>é€šè¿‡cargo.tomlä¸­[dependencies]æ¥ä½¿ç”¨å¤–éƒ¨åŒ…</li></ul><h2 id="rusté«˜çº§éƒ¨åˆ†"><a class="header-anchor" href="#rusté«˜çº§éƒ¨åˆ†" aria-hidden="true">#</a> rusté«˜çº§éƒ¨åˆ†</h2><h3 id="unsafe"><a class="header-anchor" href="#unsafe" aria-hidden="true">#</a> unsafe</h3><ul><li>è§£å¼•ç”¨è£¸æŒ‡é’ˆ</li><li>è°ƒç”¨ä¸å®‰å…¨çš„å‡½æ•°æˆ–æ–¹æ³•</li><li>è®¿é—®æˆ–ä¿®æ”¹å¯å˜é™æ€å˜é‡</li><li>å®ç°ä¸å®‰å…¨ trait å¦‚æœä¸å¿…è¦ä½¿ç”¨unsafeçš„æ—¶å€™ç”¨äº†unsfaeå…³é”®å­—ä¹Ÿä¼šé”™è¯¯,ä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰å‡ºç°ä¸Šè¿°å››ç§æƒ…å†µ,ä½†æ˜¯ç”¨äº†unsafe.</li></ul><h2 id="cell-ç”¨æ³•"><a class="header-anchor" href="#cell-ç”¨æ³•" aria-hidden="true">#</a> Cell ç”¨æ³•</h2><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">Cell</span><span class="token punctuation">;</span>\n\n<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n<span class="token keyword">let</span> data <span class="token punctuation">:</span> <span class="token class-name">Cell</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">Cell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token operator">&amp;</span>data<span class="token punctuation">;</span> vdata<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\np<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>æ‰€è°“çš„å†…éƒ¨å¯å˜æ€§,å°±æ˜¯ä¸ç”¨mut,ä¸€æ ·å¯ä»¥ä¿®æ”¹CellåŒ…æ‹¬çš„å†…å®¹. cellå¯¼å‡ºæ¥å£</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">Cell</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n    <span class="token comment">//è¿™ä¸ªè¦æ±‚æ˜¯å¯å†™å€Ÿç”¨,å…¶ä»–éƒ½æ˜¯åªè¯»å€Ÿç”¨,ä½†æ˜¯è¿˜æ˜¯å¯ä»¥ä¿®æ”¹å…¶å†…å®¹</span>\n<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">T</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> val<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> \n<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">swap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> other<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">Self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>\n<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">replace</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> val<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">T</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>\n<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">into_inner</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">T</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>\n<span class="token comment">//Copyå®é™…ä¸Šå°±æ˜¯get</span>\n<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span><span class="token class-name">Copy</span><span class="token operator">&gt;</span> <span class="token class-name">Cell</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> \n    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">T</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>RefCellæ¥å£çš„å®šä¹‰</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token class-name">Sized</span><span class="token operator">&gt;</span> <span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n\n<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">borrow</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Ref</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> \n<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">try_borrow</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Ref</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token class-name">BorrowError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">borrow_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">RefMut</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> \n <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">try_borrow_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">RefMut</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">BorrowMutError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>\n     <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">T</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>\n\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>ä»–å’Œcellä¸ä¸€æ ·çš„æ˜¯,ä»–å¹¶ä¸èƒ½ç›´æ¥ä¿®æ”¹æˆ–è€…è¯»å–å…¶åŒ…å«çš„å†…å®¹,è€Œæ˜¯é€šè¿‡borrowä»¥åŠborrow_mutæ¥è·å–å…¶å¯¹åº”çš„<code>Ref&lt;T&gt;</code>å’Œ<code>RefMut&lt;T&gt;</code></p><p>å¦‚ä½•é€‰æ‹©Cellå’ŒRefCell? å¦‚æœä½ åªéœ€è¦æ•´ä½“æ€§åœ°å­˜â¼Šã€å–å‡ºTï¼Œé‚£ä¹ˆå°±é€‰ Cellã€‚å¦‚æœä½ éœ€è¦æœ‰ä¸ªå¯è¯»å†™æŒ‡é’ˆæŒ‡å‘è¿™ä¸ªTä¿®æ”¹å®ƒï¼Œé‚£ä¹ˆå°±é€‰RefCellã€‚</p><h3 id="å€Ÿç”¨è§„åˆ™"><a class="header-anchor" href="#å€Ÿç”¨è§„åˆ™" aria-hidden="true">#</a> å€Ÿç”¨è§„åˆ™</h3><ol><li>å€Ÿç”¨æŒ‡é’ˆä¸èƒ½æ¯”å®ƒæŒ‡å‘çš„å˜é‡å­˜åœ¨æ›´é•¿çš„æ—¶é—´</li><li>&amp;mutå‹å€Ÿç”¨åªèƒ½æŒ‡å‘æœ¬èº«å…·æœ‰mutä¿®é¥°çš„å˜é‡</li><li>&amp;mutå‹å€Ÿç”¨æŒ‡é’ˆå­˜åœ¨çš„æ—¶å€™,è¢«å€Ÿç”¨å˜é‡å‡ºäºå†»ç»“çŠ¶æ€.</li><li>&amp;å‹å€Ÿç”¨å’Œ&amp;mutå‹å€Ÿç”¨äº’æ–¥,ä¸å¯åŒæ—¶å­˜åœ¨.</li><li>æœ€å¤šåŒæ—¶å­˜åœ¨ä¸€ä¸ª&amp;mutå‹å€Ÿç”¨</li><li>å¯ä»¥å­˜åœ¨åœ¨æ²¡æœ‰&amp;mutå‹å€Ÿç”¨çš„æƒ…å†µä¸‹,å­˜åœ¨å¤šä¸ª&amp;å‹å€Ÿç”¨.</li></ol><h3 id="è§£å¼•ç”¨"><a class="header-anchor" href="#è§£å¼•ç”¨" aria-hidden="true">#</a> è§£å¼•ç”¨</h3><p>Rustä¼šè‡ªåŠ¨è§£å¼•ç”¨,è¿™çœ‹èµ·æ¥å°±åƒç±»å‹è‡ªåŠ¨è½¬æ¢ä¸€æ ·. æ¯”å¦‚<code>Vec&lt;T&gt;</code>å®ç°äº†deref å› æ­¤<code>&amp;Vec&lt;T&gt;</code>å³å¯ä»¥å½“åš&amp;[T]æ¥ç”¨,å½“ç„¶ä¹Ÿå¯ä»¥å½“åš</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span></span><span class="token class-name">Rc</span><span class="token punctuation">;</span>\n\n<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>è¿™ä¸ªä¾‹å­ä¸­sç±»å‹ä¸º<code>Rc&lt;T&gt;</code>å¹¶æ²¡æœ‰byteså‡½æ•°,Rustä¼šè‡ªåŠ¨è§£å¼•ç”¨,å¾—åˆ°strç±»å‹,ç„¶åè°ƒç”¨ä¸Šé¢çš„byteså‡½æ•°. è¿™ä¸ªè¿‡ç¨‹æ˜¯è¿™æ ·çš„</p><ol><li>å°è¯•Rc::bytes(&amp;s),ä¸å¯è¡Œç»§ç»­2</li><li>å°è¯•String::bytes(Rc::deref(&amp;s)),ä¸å¯è¡Œ,ç»§ç»­3</li><li>å°è¯•str::bytes(String::deref(Rc::deref(&amp;s))),okç»“æŸ å®é™…æ‰§è¡Œçš„æ˜¯<code>s.deref().deref().bytes()</code></li></ol><p>ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æ— é™derefå°è¯•,ç›´åˆ°ä¸èƒ½derefä¸‹å». <strong>å¦‚æœä¸èƒ½è‡ªåŠ¨åˆ¤æ–­,éœ€è¦æ‰‹å·¥ä»‹å…¥</strong></p><p>**&amp;***å’Œ&amp; * æ˜¯ä¸ä¸€æ ·çš„</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">let</span> s<span class="token operator">=</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>&amp;*sä¼šè¢«ç›´æ¥å½“æˆs.deref(),è€Œä¸æ˜¯*så…ˆæŠŠå†…éƒ¨æ•°æ®ç§»èµ°ç„¶åå»å€Ÿç”¨</p><h3 id="å®"><a class="header-anchor" href="#å®" aria-hidden="true">#</a> å®</h3><h4 id="å®å±•å¼€æ–¹æ³•"><a class="header-anchor" href="#å®å±•å¼€æ–¹æ³•" aria-hidden="true">#</a> å®å±•å¼€æ–¹æ³•</h4><div class="language-"><pre><code>cargo rustc -- -Z unstable-options --pretty=expanded\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="ä¸´æ—¶å˜é‡çš„ç”Ÿå‘½å‘¨æœŸ"><a class="header-anchor" href="#ä¸´æ—¶å˜é‡çš„ç”Ÿå‘½å‘¨æœŸ" aria-hidden="true">#</a> ä¸´æ—¶å˜é‡çš„ç”Ÿå‘½å‘¨æœŸ</h3><p>æ¥è‡ªäºè¿™ç¯‡è®¨è®º<a href="https://stackoverflow.com/questions/47662253/why-is-it-legal-to-borrow-a-temporary" target="_blank" rel="noopener noreferrer">å€Ÿç”¨ä¸€ä¸ªä¸´æ—¶å˜é‡æ˜¯æœ‰æ•ˆçš„</a></p><div class="language-"><pre><code>Temporary lifetimes\n\nWhen using a value expression in most place expression contexts, a temporary unnamed memory location is created initialized to that value and the expression evaluates to that location instead\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>This applies, because String::new() is a value expression and being just below &amp;mut it is in a place expression context. Now the reference operator only has to pass through this temporary memory location, so it becomes the value of the whole right side (including the &amp;mut).</p><div class="language-"><pre><code>When a temporary value expression is being created that is assigned into a let declaration, however, the temporary is created with the lifetime of the enclosing block instead\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Since it is assigned to the variable it gets a lifetime until the end of the enclosing block.</p><p>This also answers this question about the difference between</p><div class="language-"><pre><code>let a = &amp;String::from(&quot;abcdefg&quot;); // ok!\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>and</p><div class="language-"><pre><code>let a = String::from(&quot;abcdefg&quot;).as_str(); // compile error è¿™æ ·ä¹‹æ‰€ä»¥ä¸è¡Œæ˜¯å› ä¸ºas_str()å€Ÿç”¨çš„ç”Ÿå‘½å‘¨æœŸå’Œaç›¸åŒ,ä½†æ˜¯è¢«å€Ÿç”¨å¯¹è±¡string::from()è¿”å›çš„ä¸´æ—¶å˜é‡çš„ç”Ÿå‘½å‘¨æœŸä¾ç„¶æ˜¯è¿™ä¸€è¡Œ\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>In the second variant the temporary is passed into as_str(), so its lifetime ends at the end of the statement.</p><p>é€šä¿—æ¥è¯´,å°±æ˜¯ä¸´æ—¶å˜é‡çš„ç”Ÿå‘½å‘¨æœŸå°±æ˜¯è¿™ä¸€è¡Œè¯­å¥,ä½†æ˜¯å¦‚æœè¿”å›çš„å˜é‡ä½¿ç”¨letç»‘å®šçš„è¯,é‚£ä¹ˆå…¶ç”Ÿå‘½å‘¨æœŸå°±å˜æˆäº†æœ€è¿‘çš„é‚£ä¸ª{}</p><h3 id="static-æ³›å‹"><a class="header-anchor" href="#static-æ³›å‹" aria-hidden="true">#</a> &#39;static æ³›å‹</h3><p>è‹¥æ˜¯æœ‰where Tï¼š&#39;static çš„çº¦æŸï¼Œæ„æ€åˆ™æ˜¯ï¼Œç±»å‹Tâ¾¥â¾¯ä¸åŒ…å«ä»»ä½•æŒ‡å‘çŸ­â½£å‘½å‘¨æœŸçš„å€Ÿâ½¤æŒ‡é’ˆï¼Œ æ„æ€æ˜¯è¦ä¹ˆå®Œå…¨ä¸åŒ…å«ä»»ä½•å€Ÿâ½¤ï¼Œè¦ä¹ˆå¯ä»¥æœ‰æŒ‡å‘&#39;staticçš„å€Ÿâ½¤æŒ‡é’ˆã€‚</p><h3 id="å‡½æ•°ç”Ÿå‘½å‘¨æœŸçš„æ¨å¯¼è§„åˆ™"><a class="header-anchor" href="#å‡½æ•°ç”Ÿå‘½å‘¨æœŸçš„æ¨å¯¼è§„åˆ™" aria-hidden="true">#</a> å‡½æ•°ç”Ÿå‘½å‘¨æœŸçš„æ¨å¯¼è§„åˆ™</h3><ul><li>æ¯ä¸ªå¸¦â½£å‘½å‘¨æœŸå‚æ•°çš„è¾“â¼Šå‚æ•°ï¼Œæ¯ä¸ªå¯¹åº”ä¸åŒçš„â½£å‘½å‘¨æœŸå‚æ•°ï¼›</li><li>å¦‚æœåªæœ‰â¼€ä¸ªè¾“â¼Šå‚æ•°å¸¦â½£å‘½å‘¨æœŸå‚æ•°ï¼Œé‚£ä¹ˆè¿”å›å€¼çš„â½£å‘½å‘¨æœŸè¢«æŒ‡ å®šä¸ºè¿™ä¸ªå‚æ•°ï¼›</li><li>å¦‚æœæœ‰å¤šä¸ªè¾“â¼Šå‚æ•°å¸¦â½£å‘½å‘¨æœŸå‚æ•°ï¼Œä½†å…¶ä¸­æœ‰&amp;selfã€&amp;mut selfï¼Œ é‚£ä¹ˆè¿”å›å€¼çš„â½£å‘½å‘¨æœŸè¢«æŒ‡å®šä¸ºè¿™ä¸ªå‚æ•°ï¼›</li><li>ä»¥ä¸Šéƒ½ä¸æ»¡â¾œï¼Œå°±ä¸èƒ½â¾ƒåŠ¨è¡¥å…¨è¿”å›å€¼çš„â½£å‘½å‘¨æœŸå‚æ•°</li></ul><h3 id="é«˜é˜¶ç”Ÿå‘½å‘¨æœŸ"><a class="header-anchor" href="#é«˜é˜¶ç”Ÿå‘½å‘¨æœŸ" aria-hidden="true">#</a> é«˜é˜¶ç”Ÿå‘½å‘¨æœŸ</h3><p>åˆ°â½¬å‰ä¸º â½Œï¼Œ<code>for&lt;&#39;a&gt;Fnï¼ˆ&amp;&#39;a Argï¼‰-&gt;&amp;&#39;a Ret</code>è¿™æ ·çš„è¯­æ³•ï¼Œåªèƒ½â½¤äºâ½£å‘½å‘¨æœŸå‚æ•°ï¼Œ ä¸èƒ½â½¤äºä»»æ„æ³›å‹ç±»å‹ã€‚</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">fn</span> <span class="token function-definition function">calc_by</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>var<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">i32</span> <span class="token keyword">where</span> <span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token keyword">for</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;f</span><span class="token operator">&gt;</span> <span class="token class-name">Fn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;f</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">i32</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> local <span class="token operator">=</span> <span class="token operator">*</span>var<span class="token punctuation">;</span>\n    <span class="token function">f</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>local<span class="token punctuation">)</span> \n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="å®-1"><a class="header-anchor" href="#å®-1" aria-hidden="true">#</a> å®</h2><p>Captures are written as a dollar ($) followed by an identifier, a colon (ğŸ˜ƒ, and finally the kind of capture, which must be one of the following:</p><ul><li><p>item: an item, like a function, struct, module, etc.</p></li><li><p>block: a block (i.e. a block of statements and/or an expression, surrounded by braces)</p></li><li><p>stmt: a statement</p></li><li><p>pat: a pattern</p></li><li><p>expr: an expression</p></li><li><p>ty: a type</p></li><li><p>ident: an identifier</p></li><li><p>path: a path (e.g. foo, ::std::mem::replace, <code>transmute::&lt;_, int&gt;</code>, â€¦)</p></li><li><p>meta: a meta item; the things that go inside #[...] and #![...] attributes</p></li><li><p>tt: a single token tree</p></li><li><p>item: anything.</p></li><li><p>block: anything.</p></li><li><p>stmt: =&gt; , ;</p></li><li><p>pat: =&gt; , = if in</p></li><li><p>expr: =&gt; , ;</p></li><li><p>ty: , =&gt; : = &gt; ; as</p></li><li><p>ident: anything.</p></li><li><p>path: , =&gt; : = &gt; ; as</p></li><li><p>meta: anything.</p></li><li><p>tt: anything.</p></li></ul><h3 id="å®è°ƒè¯•"><a class="header-anchor" href="#å®è°ƒè¯•" aria-hidden="true">#</a> å®è°ƒè¯•</h3><h4 id="_1-trace-macros"><a class="header-anchor" href="#_1-trace-macros" aria-hidden="true">#</a> 1. trace_macros</h4><p>trace_macros!(true); è®¾ç½®ä»¥åèƒ½å¤Ÿå°†å®å±•å¼€, æ‰“å°æ¯ä¸€ä¸ªæ­¥éª¤. trace_macros!(false); åœæ­¢æ‰“å°</p><h4 id="_2-log-syntax"><a class="header-anchor" href="#_2-log-syntax" aria-hidden="true">#</a> 2. log_syntax!</h4><p>æ­¤å®èƒ½å¤Ÿåœ¨ç»ˆç«¯æ‰“å°ä¼ é€’ç»™ä»–çš„æ¯ä¸€ä¸ªtoken,æ–¹ä¾¿è°ƒè¯•</p><h4 id="_3-å®å±•å¼€"><a class="header-anchor" href="#_3-å®å±•å¼€" aria-hidden="true">#</a> 3. å®å±•å¼€</h4><p>rustc -Z unstable-options --pretty expanded <a href="http://hello.rs" target="_blank" rel="noopener noreferrer">hello.rs</a></p><h3 id="å…³äºçº¿ç¨‹å®‰å…¨"><a class="header-anchor" href="#å…³äºçº¿ç¨‹å®‰å…¨" aria-hidden="true">#</a> å…³äºçº¿ç¨‹å®‰å…¨</h3><h4 id="send-sync"><a class="header-anchor" href="#send-sync" aria-hidden="true">#</a> send &amp;&amp; Sync</h4><p>Rustæä¾›äº†Sendå’ŒSyncä¸¤ä¸ªæ ‡ç­¾traitï¼Œå®ƒä»¬æ˜¯Rustâ½†æ•°æ®ç«äº‰å¹¶å‘çš„åŸºâ½¯ã€‚</p><ul><li>å®ç°äº†Sendçš„ç±»å‹ï¼Œå¯ä»¥å®‰å…¨åœ°åœ¨çº¿ç¨‹é—´ä¼ é€’å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥è·¨çº¿ç¨‹ä¼ é€’æ‰€æœ‰æƒã€‚</li><li>å®ç°äº†Syncçš„ç±»å‹ï¼Œå¯ä»¥è·¨çº¿ç¨‹å®‰å…¨åœ°ä¼ é€’å…±äº«ï¼ˆä¸å¯å˜ï¼‰å¼•â½¤(&amp;T)ã€‚ å…¸å‹çš„æ²¡æœ‰å®ç°Syncçš„ä¾‹å­: Cellå’ŒRefCell (å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»ä¼šæœ‰é—®é¢˜) å…¸å‹çš„æ²¡æœ‰å®ç°Sendçš„ä¾‹å­: Rc</li></ul><h2 id="å…³äºasyncå’Œawait"><a class="header-anchor" href="#å…³äºasyncå’Œawait" aria-hidden="true">#</a> å…³äºasyncå’Œawait</h2><h3 id="await"><a class="header-anchor" href="#await" aria-hidden="true">#</a> await</h3><p>å¦‚æœExecutoræ˜¯å¤šçº¿ç¨‹çš„,é‚£ä¹ˆæ¯ä¸€ä¸ª.awaitéƒ½å¯èƒ½å¼•å‘ä»»åŠ¡åœ¨ä¸åŒçº¿ç¨‹ä¹‹é—´å‘é€ å› æ­¤ä»»åŠ¡å¿…é¡»å®ç°Send+Sync</p><p>Similarly, it isn&#39;t a good idea to hold a traditional non-futures-aware lock across an .await, as it can cause the threadpool to lock up: one task could take out a lock, .await and yield to the executor, allowing another task to attempt to take the lock and cause a deadlock. To avoid this, use the Mutex in futures::lock rather than the one from std::sync.</p><p>åœ¨Excutorä¸­ä¹Ÿæ˜¯ä¸é€‚å®œä½¿ç”¨æ™®é€šçš„lock,è¦ä½¿ç”¨futuresæä¾›çš„é”</p><h4 id="awaitå’Œawaitä»£ç çš„ç¿»è¯‘"><a class="header-anchor" href="#awaitå’Œawaitä»£ç çš„ç¿»è¯‘" aria-hidden="true">#</a> awaitå’Œawaitä»£ç çš„ç¿»è¯‘</h4><p>ä¸€ä¸ªç®€å•çš„ä¾‹å­,ä¸è€ƒè™‘å¤æ‚çš„</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">let</span> fut_one <span class="token operator">=</span> <span class="token punctuation">...</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> fut_two <span class="token operator">=</span> <span class="token punctuation">...</span><span class="token punctuation">;</span>\n<span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>\n    fut_one<span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>\n    fut_two<span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>è¿™æ®µä»£ç æœ€ç»ˆä¼šè¢«ç¿»è¯‘æˆå¦‚ä¸‹:</p><div class="language-rust line-numbers-mode"><pre><code>\n<span class="token comment">// The `Future` type generated by our `async { ... }` block</span>\n<span class="token keyword">struct</span> <span class="token type-definition class-name">AsyncFuture</span> <span class="token punctuation">{</span>\n    fut_one<span class="token punctuation">:</span> <span class="token class-name">FutOne</span><span class="token punctuation">,</span>\n    fut_two<span class="token punctuation">:</span> <span class="token class-name">FutTwo</span><span class="token punctuation">,</span>\n    state<span class="token punctuation">:</span> <span class="token class-name">State</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// List of states our `async` block can be in</span>\n<span class="token keyword">enum</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">{</span>\n    <span class="token class-name">AwaitingFutOne</span><span class="token punctuation">,</span>\n    <span class="token class-name">AwaitingFutTwo</span><span class="token punctuation">,</span>\n    <span class="token class-name">Done</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">impl</span> <span class="token class-name">Future</span> <span class="token keyword">for</span> <span class="token class-name">AsyncFuture</span> <span class="token punctuation">{</span>\n    <span class="token keyword">type</span> <span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">fn</span> <span class="token function-definition function">poll</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">:</span> <span class="token class-name">Pin</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> cx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;_</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Poll</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n        <span class="token keyword">loop</span> <span class="token punctuation">{</span>\n            <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>state <span class="token punctuation">{</span>\n                <span class="token class-name">State</span><span class="token punctuation">::</span><span class="token class-name">AwaitingFutOne</span> <span class="token operator">=&gt;</span> <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>fut_one<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Ready</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">State</span><span class="token punctuation">::</span><span class="token class-name">AwaitingFutTwo</span><span class="token punctuation">,</span>\n                    <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Pending</span> <span class="token operator">=&gt;</span> <span class="token keyword">return</span> <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Pending</span><span class="token punctuation">,</span>\n                <span class="token punctuation">}</span>\n                <span class="token class-name">State</span><span class="token punctuation">::</span><span class="token class-name">AwaitingFutTwo</span> <span class="token operator">=&gt;</span> <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>fut_two<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Ready</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">State</span><span class="token punctuation">::</span><span class="token class-name">Done</span><span class="token punctuation">,</span>\n                    <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Pending</span> <span class="token operator">=&gt;</span> <span class="token keyword">return</span> <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Pending</span><span class="token punctuation">,</span>\n                <span class="token punctuation">}</span>\n                <span class="token class-name">State</span><span class="token punctuation">::</span><span class="token class-name">Done</span> <span class="token operator">=&gt;</span> <span class="token keyword">return</span> <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Ready</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="pinning"><a class="header-anchor" href="#pinning" aria-hidden="true">#</a> Pinning</h3><p>Pinä¸»è¦æ˜¯ç»™å€Ÿç”¨æœåŠ¡çš„&amp;Tå’Œ&amp;mut T,ç¡®ä¿è¢«å€Ÿç”¨çš„å¯¹è±¡ä¸è¢«ç§»åŠ¨.</p><p>å€Ÿç”¨çš„ä½¿ç”¨ä¾‹å­</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">async</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> <span class="token keyword">mut</span> x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> read_into_buf_fut <span class="token operator">=</span> <span class="token function">read_into_buf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    read_into_buf_fut<span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>\n    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>è¿™éƒ¨åˆ†ä»£ç å¦‚ä½•ç¿»è¯‘å‘¢?</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">struct</span> <span class="token type-definition class-name">ReadIntoBuf</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n    buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// points to `x` below</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">struct</span> <span class="token type-definition class-name">AsyncFuture</span> <span class="token punctuation">{</span>\n    x<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">;</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    read_into_buf_fut<span class="token punctuation">:</span> <span class="token class-name">ReadIntoBuf</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;what_lifetime</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>å…³é”®é—®é¢˜æ˜¯&amp;Tæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæŒ‡é’ˆ,é‚£ä¹ˆAsyncFutureéšæ—¶å¯èƒ½è¢«ç§»åŠ¨,é‚£ä¹ˆReadIntoBufä¸­çš„è¿™ä¸ª&amp;TæŒ‡é’ˆè‚¯å®šä¼šå¤±æ•ˆ å› æ­¤éœ€è¦ä½¿ç”¨Pinæ¥ä¿å­˜. Pinæœ‰å‡ ç§<code>Pin&lt;&amp;mut T&gt;, Pin&lt;&amp;T&gt;, Pin&lt;Box&lt;T&gt;&gt;</code>,ä¸»è¦æ˜¯ç¡®ä¿å¯¹åº”çš„Tä¸ä¼šè¢«ç§»åŠ¨.</p><h3 id="stream"><a class="header-anchor" href="#stream" aria-hidden="true">#</a> Stream</h3><p>ç†è§£Streamçš„ä¸€ä¸ªå…³é”®å°±æ˜¯,è¿”å›Ready,é‡Œé¢å¯èƒ½æ˜¯Some,ä¹Ÿå¯èƒ½æ˜¯None,å¦‚æœæ˜¯None,è¡¨ç¤ºStreamå…³é—­äº†.</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">trait</span> <span class="token class-name">Stream</span> <span class="token punctuation">{</span>\n    <span class="token comment">/// The type of the value yielded by the stream.</span>\n    <span class="token keyword">type</span> <span class="token class-name">Item</span><span class="token punctuation">;</span>\n\n    <span class="token comment">/// Attempt to resolve the next item in the stream.</span>\n    <span class="token comment">/// Retuns `Poll::Pending` if not ready, `Poll::Ready(Some(x))` if a value</span>\n    <span class="token comment">/// is ready, and `Poll::Ready(None)` if the stream has completed.</span>\n    <span class="token keyword">fn</span> <span class="token function-definition function">poll_next</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> <span class="token class-name">Pin</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> cx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;_</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>\n        <span class="token punctuation">-&gt;</span> <span class="token class-name">Poll</span><span class="token operator">&lt;</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Item</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">send_recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token constant">BUFFER_SIZE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> tx<span class="token punctuation">,</span> <span class="token keyword">mut</span> rx<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">mpsc<span class="token punctuation">::</span></span><span class="token function">channel</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token constant">BUFFER_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    tx<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    tx<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">drop</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// `StreamExt::next` is similar to `Iterator::next`, but returns a</span>\n    <span class="token comment">// type that implements `Future&lt;Output = Option&lt;T&gt;&gt;`.</span>\n    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rx<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rx<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token class-name">None</span><span class="token punctuation">,</span> rx<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h2 id="atmoic"><a class="header-anchor" href="#atmoic" aria-hidden="true">#</a> atmoic</h2><p>atomic Orderingæ€»å…±æœ‰äº”ç§é¡ºåº</p><ol><li>æ’åºä¸€è‡´æ€§é¡ºåº: SeqCstã€‚</li><li>è‡ªç”±é¡ºåº: Relaxed (æ„Ÿè§‰ç±»ä¼¼cè¯­è¨€ä¸­çš„volatile)</li><li>å…¶ä»–: Release,Acquire,AcqRel Rustæ”¯æŒçš„5ç§å†…å­˜é¡ºåºä¸å…¶åº•å±‚çš„LLVMæ”¯æŒçš„å†…å­˜é¡ºåºæ˜¯ä¸€è‡´çš„</li></ol><h3 id="release-acquire-ordering"><a class="header-anchor" href="#release-acquire-ordering" aria-hidden="true">#</a> Release-Acquire ordering</h3><p>åœ¨è¿™ç§æ¨¡å‹ä¸‹ï¼Œstore()ä½¿ç”¨memory_order_releaseï¼Œè€Œload()ä½¿ç”¨memory_order_acquireã€‚è¿™ç§æ¨¡å‹æœ‰ä¸¤ç§æ•ˆæœï¼Œç¬¬ä¸€ç§æ˜¯å¯ä»¥é™åˆ¶ CPU æŒ‡ä»¤çš„é‡æ’ï¼š</p><p>åœ¨store()ä¹‹å‰çš„æ‰€æœ‰è¯»å†™æ“ä½œï¼Œä¸å…è®¸è¢«ç§»åŠ¨åˆ°è¿™ä¸ªstore()çš„åé¢ã€‚ åœ¨load()ä¹‹åçš„æ‰€æœ‰è¯»å†™æ“ä½œï¼Œä¸å…è®¸è¢«ç§»åŠ¨åˆ°è¿™ä¸ªload()çš„å‰é¢ã€‚ å‚è€ƒ<a href="https://senlinzhan.github.io/2017/12/04/cpp-memory-order/" target="_blank" rel="noopener noreferrer">ç†è§£ C++ çš„ Memory Order</a></p><div class="language-cpp line-numbers-mode"><pre><code>std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span> ready<span class="token punctuation">{</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">int</span> data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token keyword">void</span> <span class="token function">producer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    data <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>                                       <span class="token comment">// A</span>\n    ready<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// B</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">void</span> <span class="token function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>ready<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">// C</span>\n        <span class="token punctuation">;</span>\n    <span class="token function">assert</span><span class="token punctuation">(</span>data <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// never failed              // D</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h5 id="memory-order-relaxed"><a class="header-anchor" href="#memory-order-relaxed" aria-hidden="true">#</a> memory_order_relaxed</h5><p>Relaxed operation: there are no synchronization or ordering constraints imposed on other reads or writes, only this operation&#39;s atomicity is guaranteed (see Relaxed ordering below)</p><h5 id="memory-order-consume"><a class="header-anchor" href="#memory-order-consume" aria-hidden="true">#</a> memory_order_consume</h5><p>A load operation with this memory order performs a consume operation on the affected memory location: no reads or writes in the current thread dependent on the value currently loaded can be reordered before this load. Writes to data-dependent variables in other threads that release the same atomic variable are visible in the current thread. On most platforms, this affects compiler optimizations only (see Release-Consume ordering below)</p><h5 id="memory-order-acquire"><a class="header-anchor" href="#memory-order-acquire" aria-hidden="true">#</a> memory_order_acquire</h5><p>A load operation with this memory order performs the acquire operation on the affected memory location: no reads or writes in the current thread can be reordered before this load. All writes in other threads that release the same atomic variable are visible in the current thread (see Release-Acquire ordering below)</p><h5 id="memory-order-release"><a class="header-anchor" href="#memory-order-release" aria-hidden="true">#</a> memory_order_release</h5><p>A store operation with this memory order performs the release operation: no reads or writes in the current thread can be reordered after this store. All writes in the current thread are visible in other threads that acquire the same atomic variable (see Release-Acquire ordering below) and writes that carry a dependency into the atomic variable become visible in other threads that consume the same atomic (see Release-Consume ordering below).</p><h5 id="memory-order-acq-rel"><a class="header-anchor" href="#memory-order-acq-rel" aria-hidden="true">#</a> memory_order_acq_rel</h5><p>A read-modify-write operation with this memory order is both an acquire operation and a release operation. No memory reads or writes in the current thread can be reordered before or after this store. All writes in other threads that release the same atomic variable are visible before the modification and the modification is visible in other threads that acquire the same atomic variable.</p><h5 id="memory-order-seq-cst"><a class="header-anchor" href="#memory-order-seq-cst" aria-hidden="true">#</a> memory_order_seq_cst</h5><p>A load operation with this memory order performs an acquire operation, a store performs a release operation, and read-modify-write performs both an acquire operation and a release operation, plus a single total order exists in which all threads observe all modifications in the same order (see Sequentially-consistent ordering below)</p><h3 id="sizedå’Œ-sized"><a class="header-anchor" href="#sizedå’Œ-sized" aria-hidden="true">#</a> Sizedå’Œ?Sized</h3><p>?Sizedå¯¹äºTçš„çº¦æŸä¸»è¦æ˜¯æŒ‡å¯ä»¥æ˜¯å›ºå®šå¤§å°ç±»å‹ä¹Ÿå¯ä»¥è¯´DST,å¯¹äºDSTæ¥è¯´,å¯ä»¥å®šä¹‰ ä½†æ˜¯ç”¨çš„æ—¶å€™åªèƒ½æ˜¯æŒ‡é’ˆ,æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­.</p><div class="language-rust line-numbers-mode"><pre><code><span class="token attribute attr-name">#[derive(Debug)]</span>\n<span class="token keyword">struct</span> <span class="token type-definition class-name">FooSized</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token punctuation">,</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token class-name">Sized</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">UnsafeCell</span><span class="token punctuation">;</span>\n\n<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> h_s  <span class="token operator">=</span> <span class="token class-name">FooSized</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> h_s<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> _s<span class="token operator">=</span><span class="token class-name">UnsafeCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>h_s<span class="token number">.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="borrow-å’Œasrefä¸¤ä¸ªtraitçš„å…³ç³»"><a class="header-anchor" href="#borrow-å’Œasrefä¸¤ä¸ªtraitçš„å…³ç³»" aria-hidden="true">#</a> Borrow å’ŒAsRefä¸¤ä¸ªTraitçš„å…³ç³»</h3><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token class-name">AsRef</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token class-name">Sized</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">fn</span> <span class="token function-definition function">as_ref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token class-name">T</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token class-name">Borrow</span><span class="token operator">&lt;</span><span class="token class-name">Borrowed</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token class-name">Sized</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">fn</span> <span class="token function-definition function">borrow</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token class-name">Borrowed</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>ä»å½¢å¼ä¸Šçœ‹,ä»–ä»¬æ˜¯å®Œå…¨ä¸€æ ·çš„,åªæ˜¯å‡ºäºè®¾è®¡çš„ç›®çš„ä¸ä¸€æ ·,ä¸åŒçš„åå­—æ˜¯è®©ä½¿ç”¨è€…åœ¨ä¸åŒçš„åœºæ™¯ä¸‹ä½¿ç”¨.</p><p>Choose Borrow when you want to abstract over different kinds of borrowing, or when youâ€™re building a data structure that treats owned and borrowed values in equivalent ways, such as hashing and comparison.</p><p>Choose AsRef when you want to convert something to a reference directly, and youâ€™re writing generic code.</p><h2 id="phantomdataçš„ä¸€äº›ç”¨æ³•"><a class="header-anchor" href="#phantomdataçš„ä¸€äº›ç”¨æ³•" aria-hidden="true">#</a> PhantomDataçš„ä¸€äº›ç”¨æ³•</h2><p>åœ¨çœ‹tokioçš„ä»£ç ä¸­å‘ç°çš„,</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CachedParkThread</span> <span class="token punctuation">{</span>\n    _anchor<span class="token punctuation">:</span> <span class="token class-name">PhantomData</span><span class="token operator">&lt;</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n<span class="token comment">/// Used to ensure the invariants are respected</span>\n<span class="token keyword">struct</span> <span class="token type-definition class-name">GenerationGuard</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n    <span class="token comment">/// Worker reference</span>\n    worker<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token class-name">Worker</span><span class="token punctuation">,</span>\n\n    <span class="token comment">/// Prevent `Sync` access</span>\n    _p<span class="token punctuation">:</span> <span class="token class-name">PhantomData</span><span class="token operator">&lt;</span><span class="token class-name">Cell</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Enter</span> <span class="token punctuation">{</span>\n    _p<span class="token punctuation">:</span> <span class="token class-name">PhantomData</span><span class="token operator">&lt;</span><span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>è¿™é‡Œçš„ç”¨æ³•ç›®çš„æ˜¯é˜»æ­¢Send,Syncçš„è‡ªåŠ¨å®ç°,é˜²æ­¢è¿™äº›ç»“æ„ä½“è·¨çº¿ç¨‹ä¼ é€’.</p>',150)];p.render=function(a,e,p,o,l,c){return n(),s("div",null,t)};export{e as __pageData,p as default};
