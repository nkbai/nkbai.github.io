import{_ as n,c as s,o as a,a as p}from"./app.577f36ad.js";const m='{"title":"\u4ECE\u4E00\u6B21\u76D7\u5E01\u4E8B\u4EF6\u518D\u8C08\u5408\u7EA6\u5B89\u5168\u95EE\u9898","description":"","frontmatter":{"title":"\u4ECE\u4E00\u6B21\u76D7\u5E01\u4E8B\u4EF6\u518D\u8C08\u5408\u7EA6\u5B89\u5168\u95EE\u9898","date":"2018-11-15T08:55:51.000Z","draft":false,"markup":"mmark"},"headers":[{"level":2,"title":"\u4E00. \u8D77\u56E0","slug":"\u4E00-\u8D77\u56E0"},{"level":2,"title":"\u4E8C. solidity\u590D\u6742\u53D8\u91CF\u7684\u5730\u5740\u8BA1\u7B97\u95EE\u9898","slug":"\u4E8C-solidity\u590D\u6742\u53D8\u91CF\u7684\u5730\u5740\u8BA1\u7B97\u95EE\u9898"},{"level":3,"title":"\u4E00\u4E2A\u793A\u4F8B","slug":"\u4E00\u4E2A\u793A\u4F8B"},{"level":3,"title":"\u7B80\u5355\u53D8\u91CF\u7684\u5730\u5740","slug":"\u7B80\u5355\u53D8\u91CF\u7684\u5730\u5740"},{"level":3,"title":"\u52A8\u6001\u6570\u7EC4\u4EE5\u53CAMap\u7684\u5730\u5740","slug":"\u52A8\u6001\u6570\u7EC4\u4EE5\u53CAmap\u7684\u5730\u5740"},{"level":2,"title":"\u4E09. \u5148\u6765\u73A9demo","slug":"\u4E09-\u5148\u6765\u73A9demo"},{"level":3,"title":"\u90E8\u7F72\u5408\u7EA6","slug":"\u90E8\u7F72\u5408\u7EA6"},{"level":3,"title":"\u521D\u6B21\u8C03\u7528newRecords","slug":"\u521D\u6B21\u8C03\u7528newrecords"},{"level":3,"title":"\u4ECE\u5931\u8D25\u4E2D\u627E\u5230\u6B63\u786E\u65B9\u6CD5","slug":"\u4ECE\u5931\u8D25\u4E2D\u627E\u5230\u6B63\u786E\u65B9\u6CD5"},{"level":3,"title":"\u6784\u9020\u6210\u529F\u7684\u8C03\u7528","slug":"\u6784\u9020\u6210\u529F\u7684\u8C03\u7528"},{"level":2,"title":"\u56DB. \u518D\u4E00\u8D77\u6765\u73A9DVPgame","slug":"\u56DB-\u518D\u4E00\u8D77\u6765\u73A9dvpgame"},{"level":3,"title":"\u8986\u76D6token","slug":"\u8986\u76D6token"},{"level":3,"title":"\u968F\u4FBF\u8F6C\u70B9\u4EE5\u592A\u574A\u7ED9DVPgame","slug":"\u968F\u4FBF\u8F6C\u70B9\u4EE5\u592A\u574A\u7ED9dvpgame"},{"level":3,"title":"\u770B\u770B\u522B\u4EBA\u600E\u4E48\u73A9\u7684","slug":"\u770B\u770B\u522B\u4EBA\u600E\u4E48\u73A9\u7684"},{"level":2,"title":"\u4E94. \u5269\u4E0B\u7684\u95EE\u9898","slug":"\u4E94-\u5269\u4E0B\u7684\u95EE\u9898"},{"level":2,"title":"\u516D. hash\u78B0\u649E\u95EE\u9898","slug":"\u516D-hash\u78B0\u649E\u95EE\u9898"},{"level":2,"title":"\u516D. \u5C0F\u6D4B\u8BD5\u5DE5\u5177","slug":"\u516D-\u5C0F\u6D4B\u8BD5\u5DE5\u5177"}],"relativePath":"blockchain/ethereum/\u4ECE\u4E00\u6B21\u76D7\u5E01\u4E8B\u4EF6\u518D\u8C08\u5408\u7EA6\u5B89\u5168\u95EE\u9898.md"}',t={},e=p(`<h1 id="\u4ECE\u4E00\u8D77\u201C\u76D7\u5E01\u201D\u4E8B\u4EF6\u518D\u8C08\u5408\u7EA6\u5B89\u5168\u95EE\u9898" tabindex="-1">\u4ECE\u4E00\u8D77\u201C\u76D7\u5E01\u201D\u4E8B\u4EF6\u518D\u8C08\u5408\u7EA6\u5B89\u5168\u95EE\u9898 <a class="header-anchor" href="#\u4ECE\u4E00\u8D77\u201C\u76D7\u5E01\u201D\u4E8B\u4EF6\u518D\u8C08\u5408\u7EA6\u5B89\u5168\u95EE\u9898" aria-hidden="true">#</a></h1><p>\u672C\u6765\u662F\u53D7\u5230<a href="https://xlab.tencent.com/cn/2018/11/09/pay-attention-to-the-ethereum-hash-collision-problem-from-the-stealing-coins-incident/#more-404" target="_blank" rel="noopener noreferrer">\u4ECE\u4E00\u8D77\u201C\u76D7\u5E01\u201D\u4E8B\u4EF6\u770B\u4EE5\u592A\u574A\u5B58\u50A8 hash \u78B0\u649E\u95EE\u9898</a>\u4E00\u6587\u542F\u53D1,\u4F46\u662F\u6211\u5E76\u4E0D\u592A\u8BA4\u540C\u6587\u4E2D\u7684\u89C2\u70B9.\u5E76\u4E14\u6587\u4E2D\u6709\u4E00\u4E9B\u6280\u672F\u6027\u9519\u8BEF.</p><h2 id="\u4E00-\u8D77\u56E0" tabindex="-1">\u4E00. \u8D77\u56E0 <a class="header-anchor" href="#\u4E00-\u8D77\u56E0" aria-hidden="true">#</a></h2><p>\u4ECA\u65E5\u67D0\u5B89\u5168\u5382\u5546\u5728\u4EE5\u592A\u574A\u4E0A\u53D1\u5E03\u4E00\u4EFD\u8BA9\u5927\u5BB6\u6765&quot;\u76D7\u5E01&quot;\u7684<a href="https://etherscan.io/address/0x5170a14aa36245a8a9698f23444045bdc4522e0a#code" target="_blank" rel="noopener noreferrer">\u5408\u7EA6</a>,\u5C31\u662F\u5E0C\u671B\u5927\u5BB6\u80FD\u591F\u610F\u8BC6\u5230\u4E0D\u597D\u7684\u5408\u7EA6\u8BBE\u8BA1\u4F1A\u5B58\u5728\u4E25\u91CD\u5B89\u5168\u9690\u60A3.\u4E0B\u9762\u662F\u8FD9\u4EFD\u5408\u7EA6\u6E90\u7801.</p><div class="language-sol line-numbers-mode"><pre><code><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.4.21</span><span class="token punctuation">;</span>
<span class="token keyword">contract</span> <span class="token class-name">DVPgame</span> <span class="token punctuation">{</span>
    ERC20 <span class="token keyword">public</span> token<span class="token punctuation">;</span>
    <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> map<span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token class-name">SafeERC20</span> <span class="token keyword">for</span> ERC20<span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token class-name">SafeMath</span> <span class="token keyword">for</span> <span class="token builtin">uint256</span><span class="token punctuation">;</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> addr<span class="token punctuation">)</span> <span class="token keyword">payable</span><span class="token punctuation">{</span>
        token <span class="token operator">=</span> <span class="token function">ERC20</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span>length<span class="token operator">&gt;=</span><span class="token builtin">uint256</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>map<span class="token punctuation">[</span><span class="token builtin">uint256</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//airdrop is over</span>
            <span class="token keyword">selfdestruct</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            token<span class="token punctuation">.</span><span class="token function">safeTransfer</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token builtin">uint256</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                map<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token builtin">uint256</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            map<span class="token punctuation">[</span><span class="token builtin">uint256</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//Guess the value(param:x) of the keccak256 value modulo 10000 of the future block (param:blockNum)</span>
    <span class="token keyword">function</span> <span class="token function">guess</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> x<span class="token punctuation">,</span><span class="token builtin">uint256</span> blockNum<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">payable</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">0.001</span> ether <span class="token operator">||</span> token<span class="token punctuation">.</span><span class="token function">allowance</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">1</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">**</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>blockNum<span class="token operator">&gt;</span>block<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">allowance</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            token<span class="token punctuation">.</span><span class="token function">safeTransferFrom</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">**</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token builtin">uint256</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token operator">+</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            map<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token builtin">uint256</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token operator">+</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        map<span class="token punctuation">[</span><span class="token builtin">uint256</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token operator">+</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> blockNum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//Run a lottery</span>
    <span class="token keyword">function</span> <span class="token function">lottery</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> x<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>map<span class="token punctuation">[</span><span class="token builtin">uint256</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token operator">+</span>x<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>number <span class="token operator">&gt;</span> map<span class="token punctuation">[</span><span class="token builtin">uint256</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token operator">+</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">blockhash</span><span class="token punctuation">(</span>map<span class="token punctuation">[</span><span class="token builtin">uint256</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token operator">+</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> answer <span class="token operator">=</span> <span class="token builtin">uint256</span><span class="token punctuation">(</span><span class="token function">keccak256</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">blockhash</span><span class="token punctuation">(</span>map<span class="token punctuation">[</span><span class="token builtin">uint256</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token operator">+</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">10000</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> answer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            token<span class="token punctuation">.</span><span class="token function">safeTransfer</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span>token<span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">selfdestruct</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>\u4E0A\u8FF0\u6587\u4E2D\u63D0\u5230\u8FD9\u91CC\u9762\u5B89\u5168\u95EE\u9898\u662F\u56E0\u4E3Asolidity\u5728\u5B58\u50A8map\u65F6\u5019\u7684\u5730\u5740\u8BA1\u7B97\u65B9\u5F0F,\u5B58\u5728hash\u78B0\u649E\u95EE\u9898,\u6240\u4EE5\u5BFC\u81F4\u5E01\u88AB\u76D7\u8D70. \u4F46\u662F\u663E\u7136\u5E76\u4E0D\u662F\u56E0\u4E3Ahash\u78B0\u649E\u95EE\u9898. \u786E\u5B9E\u4E0D\u597D\u7684\u8BBE\u8BA1\u4F1A\u5BFC\u81F4hash\u78B0\u649E\u95EE\u9898,\u4F46\u662F\u8FD9\u91CC\u786E\u5B9E\u4E0D\u662Fhash\u78B0\u649E\u5F15\u8D77\u7684\u95EE\u9898.</p><h2 id="\u4E8C-solidity\u590D\u6742\u53D8\u91CF\u7684\u5730\u5740\u8BA1\u7B97\u95EE\u9898" tabindex="-1">\u4E8C. solidity\u590D\u6742\u53D8\u91CF\u7684\u5730\u5740\u8BA1\u7B97\u95EE\u9898 <a class="header-anchor" href="#\u4E8C-solidity\u590D\u6742\u53D8\u91CF\u7684\u5730\u5740\u8BA1\u7B97\u95EE\u9898" aria-hidden="true">#</a></h2><h3 id="\u4E00\u4E2A\u793A\u4F8B" tabindex="-1">\u4E00\u4E2A\u793A\u4F8B <a class="header-anchor" href="#\u4E00\u4E2A\u793A\u4F8B" aria-hidden="true">#</a></h3><p>\u5F00\u59CB\u4E4B\u524D,\u6211\u4EEC\u5148\u627E\u4E00\u4E2A\u517C\u5177\u5404\u79CD\u5143\u7D20</p><div class="language-solidity line-numbers-mode"><pre><code><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.4.23</span><span class="token punctuation">;</span> 
<span class="token keyword">contract</span> <span class="token class-name">Locked</span> <span class="token punctuation">{</span>
    <span class="token builtin">bool</span> <span class="token keyword">public</span> unlocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    
    <span class="token keyword">struct</span> <span class="token class-name">NameRecord</span> <span class="token punctuation">{</span> 
        <span class="token builtin">bytes32</span> name<span class="token punctuation">;</span>
        <span class="token builtin">address</span> mappedAddress<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=&gt;</span> NameRecord<span class="token punctuation">)</span> <span class="token keyword">public</span> registeredNameRecord<span class="token punctuation">;</span> 
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> <span class="token operator">=&gt;</span> <span class="token builtin">address</span><span class="token punctuation">)</span> <span class="token keyword">public</span> resolve<span class="token punctuation">;</span>
    NameRecord <span class="token punctuation">[</span><span class="token punctuation">]</span>records<span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _name<span class="token punctuation">,</span> <span class="token builtin">address</span> _mappedAddress<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        NameRecord newRecord<span class="token punctuation">;</span>
        newRecord<span class="token punctuation">.</span>name <span class="token operator">=</span> _name<span class="token punctuation">;</span>
        newRecord<span class="token punctuation">.</span>mappedAddress <span class="token operator">=</span> _mappedAddress<span class="token punctuation">;</span> 
        resolve<span class="token punctuation">[</span>_name<span class="token punctuation">]</span> <span class="token operator">=</span> _mappedAddress<span class="token punctuation">;</span>
        registeredNameRecord<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> newRecord<span class="token punctuation">;</span> 
        <span class="token keyword">require</span><span class="token punctuation">(</span>unlocked<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">newRecords</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> index<span class="token punctuation">,</span><span class="token builtin">bytes32</span> _name<span class="token punctuation">,</span> <span class="token builtin">address</span> _mappedAddress<span class="token punctuation">)</span> <span class="token keyword">public</span><span class="token punctuation">{</span>
        NameRecord <span class="token keyword">memory</span> newRecord<span class="token punctuation">;</span>
        newRecord<span class="token punctuation">.</span>name <span class="token operator">=</span> _name<span class="token punctuation">;</span>
        newRecord<span class="token punctuation">.</span>mappedAddress <span class="token operator">=</span> _mappedAddress<span class="token punctuation">;</span> 
        <span class="token keyword">if</span><span class="token punctuation">(</span>recor<span class="token punctuation">)</span>
        records<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token operator">=</span>newRecord<span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>unlocked<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="\u7B80\u5355\u53D8\u91CF\u7684\u5730\u5740" tabindex="-1">\u7B80\u5355\u53D8\u91CF\u7684\u5730\u5740 <a class="header-anchor" href="#\u7B80\u5355\u53D8\u91CF\u7684\u5730\u5740" aria-hidden="true">#</a></h3><p>\u6BCF\u4E2A\u5408\u7EA6\u90FD\u4F1A\u6709\u81EA\u5DF1\u72EC\u7ACB\u7684\u5B58\u50A8\u7A7A\u95F4(storage),\u8FD0\u884C\u65F6\u7684Memory\u7A7A\u95F4.storage\u548Cmemory\u7A7A\u95F4\u90FD\u662F\u4ECE0\u5F00\u59CB. \u56E0\u4E3AEVM\u662F\u4E00\u4E2A256\u4F4D\u7684\u865A\u62DF\u673A,\u56E0\u6B64Storage\u7A7A\u95F4\u67092**256*256\u4F4D\u8FD9\u4E48\u5927. \u4F5C\u4E3ALocked\u8FD9\u4EFD\u5408\u7EA6\u4E2D\u7B2C\u4E00\u4E2A\u7B80\u5355\u53D8\u91CFunlcoked\u7684\u5730\u5740\u5C31\u662F0. \u57FA\u672C\u7C7B\u578Bint,string,bytes32,\u56FA\u5B9A\u5927\u5C0F\u7684\u6570\u7EC4\u7B49\u90FD\u662F\u7B80\u5355\u7C7B\u578B,\u4ED6\u4EEC\u6709\u56FA\u5B9A\u7684\u957F\u5EA6. \u5F88\u5BB9\u6613\u7B97\u51FA\u6765\u5360\u7528\u591A\u5C11\u5B57\u8282\u7A7A\u95F4,\u56E0\u6B64\u53EA\u9700\u4F9D\u6B21\u7D2F\u52A0\u5373\u53EF. \u6BD4\u5982registeredNameRecord\u7684\u5730\u5740\u662F1,resolve\u7684\u5730\u5740\u662F2,records\u5730\u5740\u5C31\u662F3 <strong>\u53E6\u5916\u5C31\u662F\u8981\u6CE8\u610F\u7A7A\u95F4\u5BF9\u9F50\u95EE\u9898</strong></p><h3 id="\u52A8\u6001\u6570\u7EC4\u4EE5\u53CAmap\u7684\u5730\u5740" tabindex="-1">\u52A8\u6001\u6570\u7EC4\u4EE5\u53CAMap\u7684\u5730\u5740 <a class="header-anchor" href="#\u52A8\u6001\u6570\u7EC4\u4EE5\u53CAmap\u7684\u5730\u5740" aria-hidden="true">#</a></h3><h4 id="array\u8BA1\u7B97\u95EE\u9898" tabindex="-1">Array\u8BA1\u7B97\u95EE\u9898 <a class="header-anchor" href="#array\u8BA1\u7B97\u95EE\u9898" aria-hidden="true">#</a></h4><p>\u56E0\u4E3A\u52A8\u6001\u6570\u7EC4,\u6BD4\u5982\u8FD9\u91CC\u7684records\u4E8B\u5148\u65E0\u6CD5\u9884\u77E5\u5927\u5C0F,\u4ED6\u7684\u5730\u5740\u8BA1\u7B97\u5C31\u4F1A\u7528\u5230hash. \u7B80\u5355\u6765\u8BF4,\u8FD9\u91CCrecords\u4E2D\u5143\u7D20\u7684\u8D77\u59CB\u5730\u5740\u5C31\u662Fhash(slot),\u8FD9\u91CC\u7684slot\u662F3,\u56E0\u4E3Arecords\u662F\u7B2C\u56DB\u4E2A\u53D8\u91CF. \u8FD9\u4E2Ahash(slot)\u5C31\u662F\u8FD9\u4E2A\u6570\u7EC4\u7684\u8D77\u59CB\u5730\u5740,\u771F\u6B63\u5B58\u50A8\u7684\u53D8\u91CF\u5730\u5740\u5219\u662Fhash(slot)+offset,offset\u7684\u8BA1\u7B97\u65B9\u5F0F\u5C31\u548C\u5176\u4ED6\u6240\u6709\u8BED\u8A00\u7684offset\u8BA1\u7B97\u65B9\u5F0F\u90FD\u4E00\u6837i*sizeof(NameRecord).</p><p>\u8FD9\u79CD\u65B9\u5F0F\u7684\u597D\u5904\u5C31\u5728\u4E8E<strong>\u8282\u7701Gas</strong>,\u867D\u7136\u5B9A\u4E49\u4E86records\u5BF9\u8C61,\u4F46\u662F\u5728\u4F60\u6CA1\u5B58\u50A8\u4EFB\u4F55\u5BF9\u8C61\u4E4B\u524D,\u4E0D\u4F1A\u6D6A\u8D39\u4E00\u70B9Gas,\u8981\u77E5\u9053\u5B58\u50A8\u4E00\u4E2A\u5B57\u5C31\u662F20000Gas,\u6210\u672C\u6602\u8D35.</p><p><strong>\u800Cslot3,\u4E5F\u5C31\u662F3\u8FD9\u4E2A\u5730\u5740\u5B58\u7684\u662F\u6570\u7EC4\u7684\u957F\u5EA6</strong>.</p><h4 id="map\u5730\u5740\u8BA1\u7B97\u95EE\u9898" tabindex="-1">Map\u5730\u5740\u8BA1\u7B97\u95EE\u9898 <a class="header-anchor" href="#map\u5730\u5740\u8BA1\u7B97\u95EE\u9898" aria-hidden="true">#</a></h4><p>Map\u7684\u5B58\u50A8\u8BBE\u8BA1\u65B9\u5F0F\u7C7B\u4F3C\u4E8EArray,\u4E00\u6837\u4E3A\u4E86\u8282\u7701Gas,\u91C7\u7528hash\u8BA1\u7B97\u5730\u5740.\u548CArray\u4E0D\u4E00\u6837\u7684\u662F,\u4ED6\u662FHash(key,slot)\u800C\u4E0D\u662F\u7B80\u5355\u7684slot. \u4EE5resolve\u8FD9\u4E2Amap\u4E3A\u4F8B,&quot;arandname&quot;\u5B58\u50A8\u5730\u5740\u5C31\u662Fhash(bytes32(&quot;arandnme&quot;),uint256(2).</p><p>\u5982\u679C\u5B58\u50A8\u5BF9\u8C61\u6BD4\u8F83\u590D\u6742,\u4E0D\u6B62\u5360\u7528\u4E00\u4E2A\u5B57\u7684\u5B58\u50A8\u7A7A\u95F4,\u6309\u7167\u987A\u5E8F\u9012\u589E\u5373\u53EF.</p><h2 id="\u4E09-\u5148\u6765\u73A9demo" tabindex="-1">\u4E09. \u5148\u6765\u73A9demo <a class="header-anchor" href="#\u4E09-\u5148\u6765\u73A9demo" aria-hidden="true">#</a></h2><p>newRecords\u51FD\u6570\u6210\u529F\u8C03\u7528,\u5FC5\u987B\u8981\u6C42unlocked\u4E3Atrue,\u4F46\u662Funlocked\u5E76\u6CA1\u6709\u53EF\u4EE5\u4FEE\u6539\u7684\u5730\u65B9. \u8FD9\u662F\u4E00\u4E2A\u68D8\u624B\u7684\u95EE\u9898,\u5B9E\u9645\u4E0A\u8FD9\u4E2A\u662F\u6700\u524D\u9762\u5408\u7EA6\u95EE\u9898\u7684\u7B80\u5316.</p><p>\u9996\u5148\u6211\u4EEC\u77E5\u9053unlocked\u7684\u5B58\u50A8\u5730\u5740\u4E3A0 \u5176\u6B21\u6211\u4EEC\u5DF2\u7ECF\u77E5\u9053\u4E86\u52A8\u6001\u6570\u7EC4\u7684\u5730\u5740\u8BA1\u7B97\u89C4\u5219,\u90A3\u4E48\u662F\u5426\u53EF\u4EE5\u8BA9records[index]\u8BA1\u7B97\u7ED3\u679C\u662F0\u5462?</p><p>\u8FD9\u4E2A\u5730\u5740\u6211\u4EEC\u5DF2\u7ECF\u77E5\u9053\u662Fhash(records_slot)+index*sizeof(NameRecord). \u6709\u4E86\u8FD9\u4E2A\u516C\u5F0F\u5176\u5B9E\u5DF2\u7ECF\u6BD4\u8F83\u5BB9\u6613\u7B97\u51FA\u6765\u4E86.</p><p>\u8BA9\u6211\u4EEC\u6765\u4E00\u6B65\u4E00\u6B65\u8BA1\u7B97\u8FD9\u4E2A\u5730\u5740\u5427.</p><h3 id="\u90E8\u7F72\u5408\u7EA6" tabindex="-1">\u90E8\u7F72\u5408\u7EA6 <a class="header-anchor" href="#\u90E8\u7F72\u5408\u7EA6" aria-hidden="true">#</a></h3><p>\u8FD9\u4E00\u6B65\u6BD4\u8F83\u5BB9\u6613\u5728Remix\u4E2D\u9009\u62E9Javascript VM\u65B9\u5F0F\u76F4\u63A5\u90E8\u7F72\u5373\u53EF.</p><p><img alt="" data-src="https://img2018.cnblogs.com/blog/124391/201811/124391-20181115120143310-712169367.png" loading="lazy" class="lazy"></p><h3 id="\u521D\u6B21\u8C03\u7528newrecords" tabindex="-1">\u521D\u6B21\u8C03\u7528newRecords <a class="header-anchor" href="#\u521D\u6B21\u8C03\u7528newrecords" aria-hidden="true">#</a></h3><p>\u5E94\u8BE5\u8BF4\u7EDD\u5927\u591A\u6570\u65F6\u5019newRecords\u80AF\u5B9A\u662F\u65E0\u6CD5\u76F4\u63A5\u8C03\u7528\u6210\u529F,\u90A3\u5C31\u5148\u6765\u4E00\u6B21\u5931\u8D25\u8C03\u7528\u5427. \u6211\u4EEC\u5C31\u4F20\u5165\u53C2\u6570 <code>0,&quot;0x3131313131313131313131313131313131313131313131313131313131313131&quot;,&quot;0x692a70d2e424a56d2c6c27aa97d1a86395877b3a&quot;</code> \u53EF\u4EE5\u770B\u5230\u8C03\u7528\u5931\u8D25\u4E86,\u5931\u8D25\u7ED3\u679C\u5982\u4E0B: <img alt="" data-src="https://img2018.cnblogs.com/blog/124391/201811/124391-20181115120213763-736021450.png" loading="lazy" class="lazy"></p><h3 id="\u4ECE\u5931\u8D25\u4E2D\u627E\u5230\u6B63\u786E\u65B9\u6CD5" tabindex="-1">\u4ECE\u5931\u8D25\u4E2D\u627E\u5230\u6B63\u786E\u65B9\u6CD5 <a class="header-anchor" href="#\u4ECE\u5931\u8D25\u4E2D\u627E\u5230\u6B63\u786E\u65B9\u6CD5" aria-hidden="true">#</a></h3><p>\u5E38\u8A00\u8BF4,\u5931\u8D25\u4E43\u6210\u529F\u4E4B\u6BCD,\u6211\u4EEC\u5C31\u4ECE\u5931\u8D25\u4E2D\u5BFB\u627E\u6210\u529F\u5427.</p><h4 id="debug\u53BB\u627E\u5BFB\u5B58\u50A8\u5730\u5740hash-records-slot" tabindex="-1">Debug\u53BB\u627E\u5BFB\u5B58\u50A8\u5730\u5740hash(records_slot) <a class="header-anchor" href="#debug\u53BB\u627E\u5BFB\u5B58\u50A8\u5730\u5740hash-records-slot" aria-hidden="true">#</a></h4><p>\u5355\u51FBDebug\u5F00\u59CB\u627E\u5BFB\u5730\u5740\u7684\u65C5\u7A0B\u5427.</p><p>\u8FD9\u6574\u4E2A\u8FC7\u7A0B\u53EA\u6709\u6700\u540E\u7684<code>records[index]=newRecord</code>\u4F1A\u5728storage\u7A7A\u95F4\u5B58\u50A8\u5185\u5BB9,\u56E0\u6B64\u6211\u4EEC\u53EA\u9700\u5FEB\u8FDB\u5230sstore\u6307\u4EE4\u5373\u53EF.</p><p><img alt="" data-src="https://img2018.cnblogs.com/blog/124391/201811/124391-20181115120232917-246700780.png" loading="lazy" class="lazy"> \u4ECEStack\u4E2D\u53EF\u4EE5\u770B\u52300\u5143\u7D20\u7684\u8D77\u59CB\u5730\u5740\u662F<code>0xc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b</code>,\u8981\u5728\u8FD9\u4E2A\u5730\u5740\u4E0A\u5B58\u50A8\u7684\u5BF9\u8C61\u662F\u5C31\u662F<code>0x3131313131313131313131313131313131313131313131313131313131313131</code>,\u6070\u597D\u5C31\u662Fname\u7684\u503C.</p><p><code>0xc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b</code>\u5C31\u662FSha3(3).</p><h3 id="\u6784\u9020\u6210\u529F\u7684\u8C03\u7528" tabindex="-1">\u6784\u9020\u6210\u529F\u7684\u8C03\u7528 <a class="header-anchor" href="#\u6784\u9020\u6210\u529F\u7684\u8C03\u7528" aria-hidden="true">#</a></h3><p>\u9996\u5148\u8D77\u59CB\u5730\u5740\u662F0xc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b,\u800Csizeof(NameRecord)\u662F2,<strong>\u6CE8\u610F\u4E0D\u662F64,\u56E0\u4E3AEVM\u5355\u4F4D\u662F32\u5B57\u8282\u800C\u4E0D\u662F\u5B57\u8282</strong> \u5C31\u5F88\u5BB9\u6613\u63A8\u7B97\u51FA\u6765Index\u662F</p><div class="language-"><pre><code>(0x10000000000000000000000000000000000000000000000000000000000000000-
0xc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b)/2
=0x1ed452f8b0d361ff8353039b6876926bcb1e6352e27d7e97d0ed74ddc84703d2
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>\u90A3\u4E48\u6211\u4EEC\u7684\u8C03\u7528\u53C2\u6570\u5C31\u662F</p><div class="language-"><pre><code>0x1ed452f8b0d361ff8353039b6876926bcb1e6352e27d7e97d0ed74ddc84703d2,&quot;0x3131313131313131313131313131313131313131313131313131313131313131&quot;,&quot;0x692a70d2e424a56d2c6c27aa97d1a86395877b3a&quot;
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>\u4E0B\u56FE\u53EF\u4EE5\u770B\u5230\u6210\u529F\u8C03\u7528. ![\u8C03\u7528\u7ED3\u679C]<img alt="" data-src="https://img2018.cnblogs.com/blog/124391/201811/124391-20181115120256869-1835023047.png" loading="lazy" class="lazy"></p><h2 id="\u56DB-\u518D\u4E00\u8D77\u6765\u73A9dvpgame" tabindex="-1">\u56DB. \u518D\u4E00\u8D77\u6765\u73A9DVPgame <a class="header-anchor" href="#\u56DB-\u518D\u4E00\u8D77\u6765\u73A9dvpgame" aria-hidden="true">#</a></h2><p>\u6709\u4E86\u4E0A\u9762\u7684\u601D\u8DEF\u76F8\u4FE1\u5927\u5BB6\u5C31\u4E0D\u4F1A\u60F3\u7740\u60F3\u6CD5\u8BBE\u6CD5\u731C\u6D4Blottery\u7684x\u662F\u591A\u5C11\u4E86,\u76F4\u5954\u6211\u4EEC\u7684fallback\u51FD\u6570\u5373\u53EF.</p><h3 id="\u8986\u76D6token" tabindex="-1">\u8986\u76D6token <a class="header-anchor" href="#\u8986\u76D6token" aria-hidden="true">#</a></h3><p>\u5148\u901A\u8FC7guess\u51FD\u6570\u628Atoken\u8BBE\u7F6E\u4E3A\u4F60\u81EA\u5DF1\u4E8B\u5148\u90E8\u7F72\u7684\u4E00\u4EFDERC20 Token,\u5F53\u7136DVPgame\u5C31\u4E0D\u4F1A\u6709\u4EFB\u4F55\u8FD9\u79CD\u65B0Token.</p><p>\u8BA9hash(1)+msg.sender+x\u5927\u4E8E2**256,\u8FD9\u4E2A\u5F88\u5BB9\u6613\u6EE1\u8DB3\u5427. \u7136\u540E\u628AblockNum\u6307\u5B9A\u4E3A\u4F60\u7684token\u5730\u5740,\u76F8\u4FE1\u4ED6\u80AF\u5B9A\u4F1A\u6BD4\u5F53\u524D\u7684block.number\u5927\u7684.</p><p>\u6084\u6084\u544A\u8BC9\u4F60hash(1)\u5C31\u662F<code>0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6</code>,\u65B9\u4FBF\u60A8\u8BD5\u8BD5.</p><h3 id="\u968F\u4FBF\u8F6C\u70B9\u4EE5\u592A\u574A\u7ED9dvpgame" tabindex="-1">\u968F\u4FBF\u8F6C\u70B9\u4EE5\u592A\u574A\u7ED9DVPgame <a class="header-anchor" href="#\u968F\u4FBF\u8F6C\u70B9\u4EE5\u592A\u574A\u7ED9dvpgame" aria-hidden="true">#</a></h3><p>\u6B63\u5E38\u8F6C\u8D26\u7ED9DVPgame\u8FD9\u4E2A\u5408\u7EA6\u5730\u5740,\u65E0\u8BBA\u591A\u5C11\u90FD\u65E0\u6240\u8C13,\u53CD\u6B63\u6700\u540E\u90FD\u662F\u4F1A\u56DE\u5230\u6211\u4EEC\u81EA\u5DF1\u7684\u8D26\u6237\u4E0A. \u4E0D\u8FC7\u8FD8\u662F\u4E0D\u8981\u592A\u591A,\u4E07\u4E00\u6709\u4EBA\u6377\u8DB3\u5148\u767B\u4E86\u5462.</p><h3 id="\u770B\u770B\u522B\u4EBA\u600E\u4E48\u73A9\u7684" tabindex="-1">\u770B\u770B\u522B\u4EBA\u600E\u4E48\u73A9\u7684 <a class="header-anchor" href="#\u770B\u770B\u522B\u4EBA\u600E\u4E48\u73A9\u7684" aria-hidden="true">#</a></h3><p>\u5230\u5E95\u600E\u4E48\u73A9\u6211\u5C31\u4E0D\u505A\u4E86,\u56E0\u4E3A\u5DF2\u7ECF\u6709\u4EBA\u73A9\u8FC7\u4E86,\u6211\u4E5F\u662F\u4E8B\u540E\u8BF8\u845B\u4EAE. <a href="https://etherscan.io/tx/0x4c15cbadc1743503464c7d8e5ad67eeb3247c2b728b846765122722f5635690a#internal" target="_blank" rel="noopener noreferrer">\u94FE\u4E0A\u76F4\u64AD\u770B\u8FD9\u91CC</a></p><h2 id="\u4E94-\u5269\u4E0B\u7684\u95EE\u9898" tabindex="-1">\u4E94. \u5269\u4E0B\u7684\u95EE\u9898 <a class="header-anchor" href="#\u4E94-\u5269\u4E0B\u7684\u95EE\u9898" aria-hidden="true">#</a></h2><p>\u5982\u679C\u4F60\u7EC6\u5FC3,\u5C31\u4F1A\u53D1\u73B0\u6211\u7684\u4F8B\u5B50\u4E2D\u8FD8\u6709\u4E00\u4E2Aregister\u51FD\u6570\u6CA1\u8BF4.\u5982\u679C\u4F60\u81EA\u5DF1\u5C1D\u8BD5\u8C03\u7528\u4E86,\u5C31\u4F1A\u53D1\u73B0\u65E0\u8BBA\u600E\u4E48\u8C03\u7528\u90FD\u4F1A\u6210\u529F,\u662F\u4E0D\u662F\u98A0\u8986\u4E86\u4E09\u89C2\u554A. \u5176\u5B9E\u539F\u56E0\u5F88\u7B80\u5355,solidity\u4E2D\u7ED3\u6784\u4F53\u9ED8\u8BA4\u662F\u5206\u914D\u5728storage\u7A7A\u95F4\u4E2D\u7684(\u6211\u4E5F\u4E0D\u77E5\u9053\u4E3A\u4EC0\u4E48\u8FD9\u4E48\u505A,\u786E\u5B9E\u6709\u70B9\u5751),\u800C\u4E14\u8FD9\u65F6\u5019\u7ED3\u6784\u4F53\u7684\u5730\u5740\u7684\u8D77\u59CB\u5730\u5740\u5C31\u662F0. \u4E5F\u5C31\u662F\u8BF4<code>newRecord.name = _name;</code>\u8FD9\u53E5\u8BDD\u5728\u4F60\u4E0D\u77E5\u4E0D\u89C9\u4E2D\u5C31\u8986\u76D6\u4E86unlocked. \u8BF4\u5230\u8FD9\u91CC,\u6211\u8FD8\u60F3\u8BF4\u7684\u662F\uFF1A \u5982\u679C\u4F60\u5728\u5199\u5408\u7EA6,\u8BF7\u628Asolidity\u600E\u4E48\u5DE5\u4F5C\u7684,\u641E\u6E05\u695A\u518D\u52A8\u624B</p><p>\u5982\u679C\u4F60\u591F\u7EC6\u5FC3,\u81F3\u5C11register\u4E2D\u7684\u8FD9\u4E2Abug\u662F\u53EF\u4EE5\u907F\u514D\u7684,\u56E0\u4E3Asolidity\u90FD\u8B66\u793A\u4F60\u4E86. ![\u6765\u81EAsolidity\u7684warn] (<a href="https://img2018.cnblogs.com/blog/124391/201811/124391-20181115120330641-1178298347.png" target="_blank" rel="noopener noreferrer">https://img2018.cnblogs.com/blog/124391/201811/124391-20181115120330641-1178298347.png</a>)</p><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>solidity\u7684\u4EFB\u4F55warning\u90FD\u8BF7\u4E0D\u8981\u5FFD\u7565</p></div><h2 id="\u516D-hash\u78B0\u649E\u95EE\u9898" tabindex="-1">\u516D. hash\u78B0\u649E\u95EE\u9898 <a class="header-anchor" href="#\u516D-hash\u78B0\u649E\u95EE\u9898" aria-hidden="true">#</a></h2><p>\u7ECF\u8FC7\u4E0A\u9762\u7684</p><h2 id="\u516D-\u5C0F\u6D4B\u8BD5\u5DE5\u5177" tabindex="-1">\u516D. \u5C0F\u6D4B\u8BD5\u5DE5\u5177 <a class="header-anchor" href="#\u516D-\u5C0F\u6D4B\u8BD5\u5DE5\u5177" aria-hidden="true">#</a></h2><p>\u8BA1\u7B97hash\u503C\u7684\u5C0F\u5DE5\u5177</p><div class="language-go line-numbers-mode"><pre><code><span class="token comment">//Sha3 is short for Keccak256Hash</span>
<span class="token keyword">func</span> <span class="token function">Sha3</span><span class="token punctuation">(</span>data <span class="token operator">...</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> common<span class="token punctuation">.</span>Hash <span class="token punctuation">{</span>
	<span class="token keyword">return</span> crypto<span class="token punctuation">.</span><span class="token function">Keccak256Hash</span><span class="token punctuation">(</span>data<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//BigIntTo32Bytes convert a big int to bytes</span>
<span class="token keyword">func</span> <span class="token function">BigIntTo32Bytes</span><span class="token punctuation">(</span>i <span class="token operator">*</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">{</span>
	data <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	buf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token operator">-</span><span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">32</span> <span class="token operator">-</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">32</span><span class="token operator">+</span><span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> buf
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestCalcHashSlot</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	i <span class="token operator">:=</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
	hash <span class="token operator">:=</span> <span class="token function">Sha3</span><span class="token punctuation">(</span><span class="token function">BigIntTo32Bytes</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Logf</span><span class="token punctuation">(</span><span class="token string">&quot;hash=%s&quot;</span><span class="token punctuation">,</span> hash<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//0xc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b</span>
	addr <span class="token operator">:=</span> common<span class="token punctuation">.</span>Address<span class="token punctuation">{</span><span class="token punctuation">}</span>
	fix <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token function">copy</span><span class="token punctuation">(</span>fix<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> addr<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	hash <span class="token operator">=</span> <span class="token function">Sha3</span><span class="token punctuation">(</span>addr<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token comment">//addr=0x0000000000000000000000000000000000000000,it&#39;s hash=0x5380c7b7ae81a58eb98d9c78de4a1fd7fd9535fc953ed2be602daaa41767312a</span>
	t<span class="token punctuation">.</span><span class="token function">Logf</span><span class="token punctuation">(</span><span class="token string">&quot;addr=%s,it&#39;s hash=%s&quot;</span><span class="token punctuation">,</span> addr<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hash<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div>`,62),o=[e];function c(l,u,i,r,k,d){return a(),s("div",null,o)}var h=n(t,[["render",c]]);export{m as __pageData,h as default};
