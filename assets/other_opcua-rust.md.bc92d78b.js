import{_ as e,c as a,o as s,a as n}from"./app.7948a4b5.js";const _='{"title":"opcua Rust\u7248\u672C\u5B66\u4E60-client","description":"","frontmatter":{"title":"opcua Rust\u7248\u672C\u5B66\u4E60-client","date":"2020-10-20T09:48:12.000Z","draft":false,"markup":"mmark"},"headers":[{"level":2,"title":"\u4E00\u4E2Aclient\u5BF9\u5E94\u591A\u5C11\u7EBF\u7A0B/\u4EFB\u52A1","slug":"\u4E00\u4E2Aclient\u5BF9\u5E94\u591A\u5C11\u7EBF\u7A0B-\u4EFB\u52A1"},{"level":3,"title":"session \u4E2D\u7684\u4EFB\u52A1","slug":"session-\u4E2D\u7684\u4EFB\u52A1"},{"level":3,"title":"tcp transport","slug":"tcp-transport"},{"level":3,"title":"subscription\u76F8\u5173","slug":"subscription\u76F8\u5173"},{"level":3,"title":"\u4E3B\u7EBF\u7A0B","slug":"\u4E3B\u7EBF\u7A0B"},{"level":2,"title":"Server \u7AEF\u7EDF\u8BA1","slug":"server-\u7AEF\u7EDF\u8BA1"},{"level":3,"title":"http server","slug":"http-server"},{"level":3,"title":"PollingAction","slug":"pollingaction"},{"level":3,"title":"tcp_transport","slug":"tcp-transport-1"},{"level":3,"title":"Server \u5C42\u7684task","slug":"server-\u5C42\u7684task"},{"level":2,"title":"\u4EA4\u53C9\u7F16\u8BD1","slug":"\u4EA4\u53C9\u7F16\u8BD1"},{"level":3,"title":"openssl \u4F9D\u8D56\u95EE\u9898","slug":"openssl-\u4F9D\u8D56\u95EE\u9898"}],"relativePath":"other/opcua-rust.md"}',r={},i=n(`<h2 id="\u4E00\u4E2Aclient\u5BF9\u5E94\u591A\u5C11\u7EBF\u7A0B-\u4EFB\u52A1" tabindex="-1">\u4E00\u4E2Aclient\u5BF9\u5E94\u591A\u5C11\u7EBF\u7A0B/\u4EFB\u52A1 <a class="header-anchor" href="#\u4E00\u4E2Aclient\u5BF9\u5E94\u591A\u5C11\u7EBF\u7A0B-\u4EFB\u52A1" aria-hidden="true">#</a></h2><p>\u8FD9\u91CC\u9762\u6709tokio \u5F02\u6B65\u4EFB\u52A1,\u6240\u4EE5\u53EA\u8981\u662F\u5F02\u6B65\u6267\u884C\u7684,\u90FD\u4EFB\u52A1\u662F\u72EC\u7ACB\u7684. \u4E00\u4E2Aclient\u81F3\u5C11\u4F1A\u5BF9\u5E94\u4E24\u4E2A\u72EC\u7ACB\u7EBF\u7A0B(\u4E0D\u5305\u542Btokio\u521B\u5EFA\u7684\u7EBF\u7A0B).</p><h3 id="session-\u4E2D\u7684\u4EFB\u52A1" tabindex="-1">session \u4E2D\u7684\u4EFB\u52A1 <a class="header-anchor" href="#session-\u4E2D\u7684\u4EFB\u52A1" aria-hidden="true">#</a></h3><h4 id="async-responses" tabindex="-1">async responses <a class="header-anchor" href="#async-responses" aria-hidden="true">#</a></h4><p>\u4E00\u4E2Aclient\u5BF9\u5E94\u4E00\u4E2Asession,\u4E00\u4E2Asession \u6709\u4E00\u4E2A\u540E\u53F0\u7EBF\u7A0B <code> thread::spawn(move || Self::run_loop(session, Self::POLL_SLEEP_INTERVAL, rx));</code> \u5468\u671F\u6027\u7684\u53BB\u4ECEmessage_queue\u4E2D\u8BFB\u53D6async_responses.</p><ol><li>ServiceFault \u9519\u8BEF\u901A\u77E5</li><li>PublishResponse \u8BA2\u9605\u62C9\u7684\u7ED3\u679C,\u8FD9\u4E9B\u7ED3\u679C\u4F1A\u901A\u8FC7<code>OnSubscriptionNotification</code> \u544A\u8BC9\u5BA2\u6237\u7AEF\u4F7F\u7528\u8005.</li></ol><p>\u8FD9\u4E2A\u7EBF\u7A0B\u7684\u8F6E\u8BE2\u5468\u671F\u662F10ms.</p><h4 id="session-activity-task" tabindex="-1">session_activity_task <a class="header-anchor" href="#session-activity-task" aria-hidden="true">#</a></h4><p>\u901A\u8FC7\u53D1\u9001\u4E00\u4E2A\u7A7A\u7684ReadRequest\u6765\u6A21\u62DFping\u6D88\u606F,\u4FDD\u6301\u548C\u670D\u52A1\u5668\u7684\u8FDE\u63A5. \u8FD9\u662F\u4E00\u4E2Atokio\u4EFB\u52A1,\u5468\u671F\u662F1\u79D2\u949F.</p><h3 id="tcp-transport" tabindex="-1">tcp transport <a class="header-anchor" href="#tcp-transport" aria-hidden="true">#</a></h3><p>tcp\u8FDE\u63A5\u5904\u7406\u76F8\u5173.</p><h4 id="_1-\u603B\u4EFB\u52A1" tabindex="-1">1. \u603B\u4EFB\u52A1 <a class="header-anchor" href="#_1-\u603B\u4EFB\u52A1" aria-hidden="true">#</a></h4><p>\u5EFA\u7ACB\u8FDE\u63A5,send hello\u4EE5\u540E\u5C31\u8001\u7B49\u4E0B\u9762\u4E09\u4E2A\u4EFB\u52A1(\u90FD\u5728<code>connection_task</code>\u4E2D)\u5B8C\u6210\u540E\u7ED3\u675F. \u6CE8\u610F\u8FD9\u662F\u4E00\u4E2A\u72EC\u7ACB\u7684\u7EBF\u7A0B.</p><h4 id="_2-spawn-finished-monitor-task" tabindex="-1">2. spawn_finished_monitor_task <a class="header-anchor" href="#_2-spawn-finished-monitor-task" aria-hidden="true">#</a></h4><p>\u76D1\u63A7\u8FDE\u63A5\u662F\u5426\u7ED3\u675F,\u8FD9\u4E2A\u5F88\u5947\u602A,\u6CA1\u6709\u4F7F\u7528\u901A\u77E5,\u5C45\u7136\u662F\u8F6E\u8BAD\u6A21\u5F0F \u8F6E\u8BE2\u5468\u671F\u662F200ms</p><h4 id="_3-spawn-reading-task" tabindex="-1">3. spawn_reading_task <a class="header-anchor" href="#_3-spawn-reading-task" aria-hidden="true">#</a></h4><p>\u4ECEtcp\u8FDE\u63A5\u4E0A\u8BFB\u53D6\u670D\u52A1\u5668\u53D1\u9001\u8FC7\u6765\u7684\u6D88\u606F,\u6D88\u606F\u4E3B\u8981\u6709\u4E09\u79CD\u7C7B\u578B:</p><ol><li>Ack \u5BF9Hello\u6D88\u606F\u7684\u786E\u8BA4,\u5176\u4ED6\u6D88\u606F\u90FD\u662FRequest/Reponse?</li><li>Error</li><li>Response</li></ol><p>Server\u4ECE\u4E0D\u4E3B\u52A8\u7ED9client\u53D1\u6D88\u606F,\u9664\u4E86Error\u4EE5\u5916.</p><p>\u6536\u5230Response\u4EE5\u540E,\u653E\u5230message_queue\u7684<code>responses</code>\u4E2D.\u7B49\u5F85\u5176\u4ED6\u4EFB\u52A1\u6765\u53D6.</p><h4 id="_4-spawn-writing-task" tabindex="-1">4. spawn_writing_task <a class="header-anchor" href="#_4-spawn-writing-task" aria-hidden="true">#</a></h4><p>\u901A\u8FC7message_queue\u4E2D\u7684request_channel\u63A5\u53D7\u8BF7\u6C42,\u7136\u540E\u53D1\u9001\u7ED9\u670D\u52A1\u5668.</p><h3 id="subscription\u76F8\u5173" tabindex="-1">subscription\u76F8\u5173 <a class="header-anchor" href="#subscription\u76F8\u5173" aria-hidden="true">#</a></h3><p>\u4E00\u4E2Aclient\u53EA\u6709\u4E00\u4E2Asession,\u4F46\u662F\u4E00\u4E2Asession\u53EF\u4EE5\u6709\u591A\u4E2Asubscription,\u6BCF\u4E2Asubscription\u6709\u4E00\u4E2A\u552F\u4E00\u7684\u6574\u6570id.</p><h4 id="_1-timer-task" tabindex="-1">1. timer_task <a class="header-anchor" href="#_1-timer-task" aria-hidden="true">#</a></h4><p>\u5468\u671F\u6027\u7684\u5411\u670D\u52A1\u5668\u53D1\u9001<code>PublishRequest</code>,\u4E0D\u7BA1\u670D\u52A1\u5668\u6709\u6CA1\u6709\u54CD\u5E94. \u9664\u975E\u6536\u5230\u4E86\u670D\u52A1\u5668\u7684ServiceFault(BadTooManyPublishRequests).</p><h3 id="\u4E3B\u7EBF\u7A0B" tabindex="-1">\u4E3B\u7EBF\u7A0B <a class="header-anchor" href="#\u4E3B\u7EBF\u7A0B" aria-hidden="true">#</a></h3><p>send_request\u662F\u4E00\u4E2A\u540C\u6B65\u7684\u64CD\u4F5C.</p><ol><li>\u901A\u8FC7async\u65B9\u5F0F\u5C06request\u653E\u5165message_queue\u7684\u961F\u5217\u4E2D</li><li>\u4E0D\u505C\u7684\u8F6E\u8BE2message_queue\u7684response\u4E2D\u662F\u5426\u6709\u60F3\u8981\u7684\u54CD\u5E94</li><li>\u62FF\u5230\u54CD\u5E94\u540E\u8FD4\u56DE.</li></ol><p>\u8FD9\u91CC\u6709\u4E00\u4E2A\u95EE\u9898,\u5C31\u662F\u5C06request\u653E\u5165message_queue\u4E2D\u4F1A\u9501\u4F4Fsession_state,\u4F46\u662F\u8FD9\u4E2A\u6570\u636E\u7ED3\u6784\u975E\u5E38\u5173\u952E. \u5230\u5904\u90FD\u5728\u7528,\u662F\u5426\u4F1A\u9020\u6210\u6B7B\u9501? \u5982\u679C\u4E00\u4E2A\u8BF7\u6C42\u8FDF\u8FDF\u53D1\u9001\u4E0D\u51FA\u53BB\u5462? \u5373\u4F7F\u8FD9\u65F6\u5019\u6536\u5230\u4E86\u670D\u52A1\u5668\u7AEF\u7684\u5176\u4ED6publish Response\u6D88\u606F,\u4E5F\u662F\u65E0\u6CD5\u5904\u7406\u7684,\u56E0\u4E3A\u5904\u7406\u7684\u8FC7\u7A0B\u8981\u9501\u4F4Fsession_state.</p><h2 id="server-\u7AEF\u7EDF\u8BA1" tabindex="-1">Server \u7AEF\u7EDF\u8BA1 <a class="header-anchor" href="#server-\u7AEF\u7EDF\u8BA1" aria-hidden="true">#</a></h2><h3 id="http-server" tabindex="-1">http server <a class="header-anchor" href="#http-server" aria-hidden="true">#</a></h3><p>\u8FD9\u662F\u4E00\u4E2A\u901A\u8FC7http\u63A5\u53E3\u5C55\u793Aserver\u5185\u90E8\u7EDF\u8BA1\u4FE1\u606F\u7684\u5DE5\u5177. \u6BD4\u8F83\u72EC\u7ACB,\u53EF\u4EE5\u4E0D\u7528\u7BA1,\u9700\u8981\u7684\u65F6\u5019\u624D\u4F1A\u542F\u52A8.</p><h3 id="pollingaction" tabindex="-1">PollingAction <a class="header-anchor" href="#pollingaction" aria-hidden="true">#</a></h3><p>\u4E00\u4E2A\u5B9A\u65F6\u6267\u884C\u51FD\u6570\u7684\u5DE5\u5177,\u53EA\u4E0D\u8FC7\u4ED6\u4F1A\u68C0\u67E5server\u662F\u5426\u5728\u8FD0\u884C.</p><h3 id="tcp-transport-1" tabindex="-1">tcp_transport <a class="header-anchor" href="#tcp-transport-1" aria-hidden="true">#</a></h3><p>\u548C\u5BA2\u6237\u7AEF\u901A\u8FC7tcp\u8FDB\u884C\u901A\u4FE1\u7684\u5730\u65B9, \u4EE5\u4E0B\u4EFB\u52A1\u662F\u6BCF\u4E00\u4E2A\u8FDE\u63A5\u90FD\u8981\u521B\u5EFA\u7684.</p><h4 id="spawn-hello-timeout-task" tabindex="-1">spawn_hello_timeout_task <a class="header-anchor" href="#spawn-hello-timeout-task" aria-hidden="true">#</a></h4><p>\u68C0\u67E5\u8FDE\u63A5\u5EFA\u7ACB\u540E,\u662F\u5426\u6536\u5230hello,\u5982\u679C\u6536\u5230\u5462\u5C31\u7ED3\u675F\u8FD9\u4E2Atask,\u5426\u5219\u540E\u53F0\u4E00\u76F4\u5468\u671F\u6027\u7684\u68C0\u67E5.</p><ol><li>\u8D85\u65F6, \u53D1\u9001Message::Quit,\u65AD\u5F00\u8FDE\u63A5</li><li>\u6536\u5230,\u7ED3\u675F.</li></ol><h4 id="spawn-subscriptions-task" tabindex="-1">spawn_subscriptions_task <a class="header-anchor" href="#spawn-subscriptions-task" aria-hidden="true">#</a></h4><p>\u5468\u671F\u6027\u7684,\u8FD9\u4E2A\u5468\u671F\u53D6\u51B3\u4E8E\u91C7\u6837\u5468\u671F\u548C\u8BA2\u9605\u5468\u671F. \u4E24\u4E2A\u4EFB\u52A1:</p><h5 id="\u6536\u96C6pulish-responses" tabindex="-1">\u6536\u96C6pulish responses <a class="header-anchor" href="#\u6536\u96C6pulish-responses" aria-hidden="true">#</a></h5><ol><li>\u6E05\u7406\u8FC7\u671F\u7684publish requests</li><li>\u6536\u96C6publish responses,\u5E76\u901A\u8FC7channel \u53D1\u9001.</li></ol><h5 id="\u63A5\u6536publish-reponses" tabindex="-1">\u63A5\u6536publish reponses <a class="header-anchor" href="#\u63A5\u6536publish-reponses" aria-hidden="true">#</a></h5><p>\u6536\u5230\u4EE5\u540E\u901A\u8FC7sender\u53D1\u9001\u51FA\u53BB</p><p>\u6211\u7684\u95EE\u9898: *<strong>\u4E3A\u4EC0\u4E48\u8FD9\u662F\u4E24\u4E2A\u72EC\u7ACB\u7684\u4EFB\u52A1? \u5408\u6210\u4E00\u4E2A\u4E0D\u66F4\u597D\u4E48?</strong></p><h4 id="spawn-finished-monitor-task" tabindex="-1">spawn_finished_monitor_task <a class="header-anchor" href="#spawn-finished-monitor-task" aria-hidden="true">#</a></h4><p>\u4E00\u4E2A\u72EC\u7ACB\u7684\u4EFB\u52A1,\u5468\u671F\u6027\u68C0\u67E5server\u662F\u5426\u9000\u51FA. \u601D\u8DEF\u548Cclient\u662F\u5B8C\u5168\u4E00\u6837\u7684. \u611F\u89C9\u8FD9\u79CD\u5468\u671F\u6027\u7684\u4EFB\u52A1\u5F88\u5947\u602A,\u4E5F\u4E0D\u5408\u7406.</p><h4 id="spawn-reading-loop-task" tabindex="-1">spawn_reading_loop_task <a class="header-anchor" href="#spawn-reading-loop-task" aria-hidden="true">#</a></h4><p>\u8BFB\u53D6\u6765\u81EA\u5BA2\u6237\u7AEF\u7684\u6D88\u606F,\u8FD9\u91CC\u9762\u4E3B\u8981\u6709\u4E24\u4E2A\u72B6\u6001:</p><ol><li><p>WaitingHello \u8FD9\u4E2A\u65F6\u5019\u4EC0\u4E48\u6D88\u606F\u90FD\u4E0D\u5904\u7406,\u53EA\u5904\u7406Hello,\u5904\u7406\u4EE5\u540E,\u624D\u80FD\u6B63\u5E38\u5904\u7406\u5176\u4ED6\u6D88\u606F.</p></li><li><p>ProcessMessages \u5904\u7406\u4EFB\u4F55\u6D88\u606F.\u6838\u5FC3\u5728process_chunk\u4E2D.</p></li></ol><p>\u5176\u4ED6\u7684\u5C31\u662F\u5982\u4F55\u5904\u7406\u9519\u8BEF\u4EE5\u53CA\u7ED3\u675F.</p><h4 id="spawn-writing-loop-task" tabindex="-1">spawn_writing_loop_task <a class="header-anchor" href="#spawn-writing-loop-task" aria-hidden="true">#</a></h4><p>\u5411\u5BA2\u6237\u7AEF\u53D1\u9001\u6D88\u606F,\u53D1\u9001\u6D88\u606F\u7684\u8BF7\u6C42\u6765\u81EA\u4EE5\u4E0A\u4E09\u4E2Atask:</p><ul><li>spawn_hello_timeout_task</li><li>spawn_subscriptions_task</li><li>spawn_reading_loop_task</li></ul><ol><li>\u53D1\u9001\u4E4B\u524D\u68C0\u67E5\u8FDE\u63A5\u7684\u53EF\u7528\u6027</li><li>\u53D1\u9001\u4E4B\u524D\u68C0\u67E5\u6D88\u606F\u7684\u6B63\u786E\u6027</li><li>\u5C06\u8981\u53D1\u9001\u6D88\u606F\u653E\u5165buffer\u4E2D.</li><li>\u901A\u8FC7write_bytes_task\u53D1\u9001\u51FA\u53BB</li><li>\u53D1\u9001\u540E\u518D\u6B21\u68C0\u67E5\u662F\u5426\u9700\u8981\u5173\u95ED.</li></ol><p>** shutdown\u6CA1\u6709await,\u9700\u8981\u52A0\u4E0A.</p><h3 id="server-\u5C42\u7684task" tabindex="-1">Server \u5C42\u7684task <a class="header-anchor" href="#server-\u5C42\u7684task" aria-hidden="true">#</a></h3><h4 id="discovery-server\u76F8\u5173" tabindex="-1">discovery server\u76F8\u5173 <a class="header-anchor" href="#discovery-server\u76F8\u5173" aria-hidden="true">#</a></h4><p>\u53EF\u4EE5\u4E0D\u7528,\u6682\u65F6\u5FFD\u7565.</p><h4 id="add-polling-action" tabindex="-1">add_polling_action <a class="header-anchor" href="#add-polling-action" aria-hidden="true">#</a></h4><p>\u8FD9\u662F\u4E00\u4E2Apub api,\u8BA9\u8C03\u7528\u8005\u53EF\u4EE5\u5468\u671F\u6027\u7684\u5728server\u5185\u90E8\u505A\u4E00\u4E9B\u4E8B\u60C5.</p><p>\u4F46\u662F\u8FD9\u4E2A\u53EA\u80FD\u6DFB\u52A0,\u4E0D\u80FD\u5220\u9664.</p><h2 id="\u4EA4\u53C9\u7F16\u8BD1" tabindex="-1">\u4EA4\u53C9\u7F16\u8BD1 <a class="header-anchor" href="#\u4EA4\u53C9\u7F16\u8BD1" aria-hidden="true">#</a></h2><p>\u9488\u5BF9raspberry\u8FDB\u884C\u4EA4\u53C9\u7F16\u8BD1</p><div class="language-"><pre><code>sudo apt-get install gcc-arm-linux-gnueabihf
rustup target add armv7-unknown-linux-gnueabihf     # armv7
cargo build --target armv7-unknown-linux-gnueabihf --release 
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="cargo-config" tabindex="-1">.cargo/config <a class="header-anchor" href="#cargo-config" aria-hidden="true">#</a></h4><div class="language-"><pre><code>[target.arm-unknown-linux-musleabihf]
linker = &quot;arm-linux-musleabihf-ld&quot;

[target.armv7-unknown-linux-musleabihf]
linker = &quot;arm-linux-musleabihf-ld&quot;

[target.arm-unknown-linux-gnueabihf]
linker = &quot;arm-linux-gnueabihf-gcc&quot;

[target.armv7-unknown-linux-gnueabihf]
linker = &quot;arm-linux-gnueabihf-gcc&quot;
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="openssl-\u4F9D\u8D56\u95EE\u9898" tabindex="-1">openssl \u4F9D\u8D56\u95EE\u9898 <a class="header-anchor" href="#openssl-\u4F9D\u8D56\u95EE\u9898" aria-hidden="true">#</a></h3><div class="language-"><pre><code>cd /tmp

wget https://www.openssl.org/source/openssl-1.0.1t.tar.gz
tar xzf openssl-1.0.1t.tar.gz
export MACHINE=armv7
export ARCH=arm
export CC=arm-linux-musleabi-gcc
cd openssl-1.0.1t &amp;&amp; ./config shared &amp;&amp; make &amp;&amp; cd -

export OPENSSL_LIB_DIR=~/openssl-1.0.1t/
export OPENSSL_INCLUDE_DIR=~/openssl-1.0.1t/include
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>\u5982\u679C\u60F3\u9759\u6001\u7F16\u8BD1\u5C31\u8981\u4F7F\u7528arm-linux-musleabi-gcc, \u7528arm-linux-musleabihf-gcc\u7684\u8BDD,\u4F1A\u51FA\u73B0<code>-mfloat-abi=hard</code>\u4E0D\u652F\u6301\u9519\u8BEF.</p>`,72),t=[i];function l(p,o,d,h,c,u){return s(),a("div",null,t)}var m=e(r,[["render",l]]);export{_ as __pageData,m as default};
