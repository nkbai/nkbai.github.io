import{_ as n,c as e,o as t,a}from"./app.634a8744.js";const m='{"title":"wtxmgr\u6A21\u5757","description":"","frontmatter":{"title":"wtxmgr\u6A21\u5757","date":"2019-05-20T03:44:14.946Z","draft":false,"markup":"mmark"},"headers":[{"level":2,"title":"\u529F\u80FD","slug":"\u529F\u80FD"},{"level":2,"title":"db \u8BBE\u8BA1","slug":"db-\u8BBE\u8BA1"},{"level":2,"title":"store\u6A21\u5757","slug":"store\u6A21\u5757"},{"level":3,"title":"InsertTx","slug":"inserttx"},{"level":3,"title":"AddCredit \u6DFB\u52A0\u53EF\u6D88\u8D39\u7684UTXO","slug":"addcredit-\u6DFB\u52A0\u53EF\u6D88\u8D39\u7684utxo"},{"level":3,"title":"Rollback\u51FD\u6570","slug":"rollback\u51FD\u6570"}],"relativePath":"blockchain/btcwallet/wtxmgr\u6A21\u5757.md"}',s={},o=a(`<h1 id="wtxmgr\u6A21\u5757" tabindex="-1">wtxmgr\u6A21\u5757 <a class="header-anchor" href="#wtxmgr\u6A21\u5757" aria-hidden="true">#</a></h1><h2 id="\u529F\u80FD" tabindex="-1">\u529F\u80FD <a class="header-anchor" href="#\u529F\u80FD" aria-hidden="true">#</a></h2><ul><li>Storage for relevant wallet transactions</li><li>Ability to mark outputs as controlled by wallet</li><li>Unspent transaction output index</li><li>Balance tracking</li><li>Automatic spend tracking for transaction inserts and removals</li><li>Double spend detection and correction after blockchain reorgs</li><li>Scalable design: <ul><li>Utilizes similar prefixes to allow cursor iteration over relevant transaction inputs and outputs</li><li>Programmatically detectable errors, including encapsulation of errors from packages it relies on</li><li>Operates under its own walletdb namespace</li></ul></li></ul><h2 id="db-\u8BBE\u8BA1" tabindex="-1">db \u8BBE\u8BA1 <a class="header-anchor" href="#db-\u8BBE\u8BA1" aria-hidden="true">#</a></h2><pre><code>bucketBlocks         = []byte(&quot;b&quot;)
bucketTxRecords      = []byte(&quot;t&quot;)
bucketCredits        = []byte(&quot;c&quot;)
bucketUnspent        = []byte(&quot;u&quot;)
bucketDebits         = []byte(&quot;d&quot;)
bucketUnmined        = []byte(&quot;m&quot;)
bucketUnminedCredits = []byte(&quot;mc&quot;)
bucketUnminedInputs  = []byte(&quot;mi&quot;)
</code></pre><ol><li><p>bucketBlocks \u5B58\u50A8\u67D0\u4E2A\u5757\u6709\u54EA\u4E9BTx,\u6CA1\u6709\u8003\u8651\u5206\u53C9 bucketBlocks: blockNumber=&gt;blockHash+blockTime+TxCount+[ TxHash1,TxHash2...]</p></li><li><p>bucketTxRecords \u5B58\u50A8\u5E8F\u5217\u5316\u7684Tx,\u5DF2\u7ECF\u88AB\u6253\u5305\u4E0A\u94FE\u7684, TxHash+blockNumber+blockHash=&gt;SerializedTx</p></li><li><p>bucketCredits \u5B58\u50A8\u672A\u82B1\u8D39\u7684UTXO,\u6216\u8005\u5DF2\u82B1\u8D39,\u4F46\u662F\u8FD8\u6CA1\u6709\u786E\u8BA4\u7684,\u8FD9\u4E9B\u90FD\u662F\u6211\u5173\u6CE8\u7684 Txhash+blockNumber+blockHash+Index(outpoint\u4E2D)=&gt;UTXO Amount[8\u4E2A\u5B57\u8282]+\u5176\u4ED6\u4FE1\u606F \u5176\u4ED6\u4FE1\u606F: v[8]\u7B2C0\u4F4D\u8868\u793A\u662F\u5426\u5DF2\u6D88\u8D39 1 \u8868\u793A\u5DF2\u6D88\u8D39 v[8]\u7B2C1\u4F4D\u8868\u793A\u662F\u5426\u662F\u627E\u96F6 1 \u4E3A\u627E\u96F6 \u5982\u679C\u5DF2\u7ECF\u6D88\u8D39,\u90A3\u4E48\u7B2C9\u4E2A\u5B57\u8282\u540E\u8FD8\u4F1A\u6709TxHash+blockNumber+blockHash+Index \u8868\u793A\u8FD9\u4E2AUTXO\u5728\u54EA\u91CC\u88AB\u6D88\u8D39\u4E86.</p></li><li><p>bucketUnspent \u5B58\u50A8\u9700\u8981\u6211\u5173\u6CE8\u7684\u672A\u6D88\u8D39\u7684UTXO,\u4E00\u65E6\u8BE5UTXO\u88AB\u6D88\u8D39,\u5C31\u4F1A\u5220\u9664\u76F8\u5173\u8BB0\u5F55 \u5B58\u50A8outPoint=&gt;blockNumer+blocHash \u8BE5outpoint\u4EA7\u751F\u7684block</p></li><li><p>bucketDebits <strong>\u8FD9\u4E2A\u9700\u8981\u89E3\u91CA\u6E05\u695A</strong> \u8BB0\u5F55\u94B1\u5305\u4E2D\u4E00\u7B14\u88AB\u6D88\u8D39\u7684UTXO, debit\u5565\u610F\u601D\u5462 Txhash+blockNumber+blockHash+Index(outpoint\u4E2D)=&gt;Amount[8\u5B57\u8282]+Txhash+blockNumber+blockHash+Index</p></li><li><p>bucketUnmined \u5B58\u50A8\u8FDB\u5165memPool,\u4F46\u662F\u8FD8\u672A\u88AB\u6253\u5305\u7684\u4EA4\u6613 TxHash=&gt;ReceivedTime(8\u5B57\u8282)+SeralizedTx</p></li><li><p>bucketUnminedCredits \u5B58\u50A8\u90A3\u4E9BTx\u8F93\u51FA\u662F\u5230\u6211\u7684\u94B1\u5305\u5730\u5740\u7684OutPoint,\u5E76\u4E14\u8FD9\u4E9BTx\u8FD8\u672A\u88AB\u6253\u5305 outpoint=&gt;UTXO Amount+change \u53C2\u8003bucketCredits</p></li><li><p>bucketUnminedInputs \u4FDD\u5B58\u5DF2\u7ECF\u6D88\u8D39\u7684UTXO,\u4F46\u662F\u8FD8\u672A\u88AB\u6253\u5305\u6216\u8005\u6B63\u5728\u88AB\u6253\u5305 \u8FD9\u4E9BUTXO\u5DF2\u7ECF\u88AB\u8FDB\u5165mempool\u7684Tx\u6D88\u8D39\u4E86. outpoint=&gt;[TxHash1,TxHash2] TxHash1,TxHash2\u53EF\u80FD\u4F1A\u6D88\u8D39\u8FD9\u4E2Aoutpoint</p></li></ol><h2 id="store\u6A21\u5757" tabindex="-1">store\u6A21\u5757 <a class="header-anchor" href="#store\u6A21\u5757" aria-hidden="true">#</a></h2><p>store\u662Fwallet\u4E0E\u6570\u636E\u5E93\u6253\u4EA4\u9053\u7684\u63A5\u53E3,\u901A\u8FC7store\u6765\u7BA1\u7406Tx\u4EE5\u53CABalance.</p><h3 id="inserttx" tabindex="-1">InsertTx <a class="header-anchor" href="#inserttx" aria-hidden="true">#</a></h3><p>rec\u8868\u793A\u5F53\u524D\u65B0\u6536\u5230\u7684Tx, block\u4E0D\u4E3A\u7A7A\u5219\u662FTx\u6240\u5728\u5757,\u7A7A\u8868\u793A\u6765\u81EAmempool\u7684tx</p><div class="language-go line-numbers-mode"><pre><code><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Store<span class="token punctuation">)</span> <span class="token function">InsertTx</span><span class="token punctuation">(</span>ns walletdb<span class="token punctuation">.</span>ReadWriteBucket<span class="token punctuation">,</span> rec <span class="token operator">*</span>TxRecord<span class="token punctuation">,</span> block <span class="token operator">*</span>BlockMeta<span class="token punctuation">)</span> <span class="token builtin">error</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="\u6765\u81EAmempool\u7684tx" tabindex="-1">\u6765\u81EAmemPool\u7684Tx <a class="header-anchor" href="#\u6765\u81EAmempool\u7684tx" aria-hidden="true">#</a></h4><p>\u5BF9\u4E8E\u6765\u81EAMemPool\u4E2D\u7684Tx,\u5219block\u4E3A\u7A7A,</p><ol><li>\u9996\u5148\u5C06Tx\u653E\u5165bucketUnmined TxHash=&gt;ReceivedTime(8\u5B57\u8282)+SeralizedTx</li><li>\u7136\u540E\u5C06Tx\u4E2D\u7684\u6BCF\u4E00\u4E2ATxIn\u653E\u5165bucketUnminedInputs outpoint=&gt;[TxHash1,TxHash2]</li></ol><h4 id="\u6765\u81EA\u94FE\u4E0A\u7684tx" tabindex="-1">\u6765\u81EA\u94FE\u4E0A\u7684Tx <a class="header-anchor" href="#\u6765\u81EA\u94FE\u4E0A\u7684tx" aria-hidden="true">#</a></h4><p>\u5BF9\u4E8E\u6765\u81EA\u4E8E\u94FE\u4E0A\u7684Tx,\u6709block\u4FE1\u606F</p><ol><li>\u5C06Tx\u653E\u5165 bucketBlocks</li><li>\u653E\u5165bucketTxRecords,3-4\u6B65\u9AA4\u4E3AupdateMinedBalance</li><li>\u5982\u679C\u8BE5Tx\u7684output\u5728bucketUnminedCredits\u4E2D\u6709\u8BB0\u5F55,\u90A3\u4E48\u5C06\u5176\u653E\u5165bucketCredits\u548CbucketUnspent</li><li>\u66F4\u65B0Balance,\u56E0\u4E3A\u5728\u6B65\u9AA4\u4E09\u79CD\u589E\u52A0\u4E86Balance.</li><li>\u5982\u679CbucketUnmined\u6709\u8FD9\u4E2ATx\u7684\u8BB0\u5F55,\u8C03\u7528removeConflict\u5220\u9664</li><li>\u6839\u636EbucketUnminedInputs,\u641C\u7D22\u54EA\u4E9BbucketUnmined\u4E2D\u7684Tx(doubleSpendTx)\u548C\u5F53\u524DTx\u4EA7\u751F\u4E86\u53CC\u82B1\u7684,\u4ECEbucketUnmined\u548CbucketUnminedInputs\u5220\u9664\u8FD9\u4E9B\u8BB0\u5F55</li><li>\u5982\u679C\u6709\u5176\u4ED6\u5728bucketUnminedInputs\u5F15\u7528\u4E86\u8BE5doubleSpendTx\u4E2D\u7684\u8F93\u51FA,\u5219\u8FDB\u884C\u7EA7\u8054\u5220\u9664,\u56E0\u6B64removeConflict\u662F\u9012\u5F52\u8C03\u7528.</li></ol><h3 id="addcredit-\u6DFB\u52A0\u53EF\u6D88\u8D39\u7684utxo" tabindex="-1">AddCredit \u6DFB\u52A0\u53EF\u6D88\u8D39\u7684UTXO <a class="header-anchor" href="#addcredit-\u6DFB\u52A0\u53EF\u6D88\u8D39\u7684utxo" aria-hidden="true">#</a></h3><p>\u6536\u5230\u4E86\u4E00\u4E2A\u6211\u5173\u6CE8\u7684Tx,\u5176\u4E2D\u67D0\u4E2AOutput\u7684\u5730\u5740\u5728\u6211\u7684\u94B1\u5305\u4E4B\u4E2D,\u8FD9\u65F6\u5019\u624D\u8C03\u7528AddCredit rec: \u5176\u4E2D\u67D0\u4E2A\u8F93\u51FA\u662F\u7ED9\u6211\u7684\u90A3\u4E2ATx index:\u7B2C\u51E0\u4E2A\u8F93\u51FA\u662F\u7ED9\u6211\u7684 block:\u5305\u542B\u8FD9\u4E2Arec\u7684\u5757 change: Internal returns true if the backing address was created for internal use such as a change output of a transaction. \u6211\u7684\u7406\u89E3\u5C31\u662F\u627E\u96F6\u5730\u5740 \u8FD4\u56DE\u503C</p><div class="language-go line-numbers-mode"><pre><code><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Store<span class="token punctuation">)</span> <span class="token function">AddCredit</span><span class="token punctuation">(</span>ns walletdb<span class="token punctuation">.</span>ReadWriteBucket<span class="token punctuation">,</span> rec <span class="token operator">*</span>TxRecord<span class="token punctuation">,</span> block <span class="token operator">*</span>BlockMeta<span class="token punctuation">,</span> index <span class="token builtin">uint32</span><span class="token punctuation">,</span> change <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> 
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="\u6765\u81EAmempool\u7684tx-1" tabindex="-1">\u6765\u81EAmempool\u7684Tx <a class="header-anchor" href="#\u6765\u81EAmempool\u7684tx-1" aria-hidden="true">#</a></h4><p>block \u662Fnil\u8868\u793A\u6765\u81EAmempool</p><ol><li>\u5982\u679Coutpoint\u5DF2\u7ECF\u5728bucketUnminedCredits\u4E2D\u4E86,\u76F4\u63A5\u7ED3\u675F</li><li>\u5982\u679Coutpoint\u5DF2\u7ECF\u5728bucketUnspent,\u76F4\u63A5\u7ED3\u675F</li><li>\u5C06\u8FD9\u4E2Aoutpoint\u653E\u5165bucketUnminedCredits</li></ol><h4 id="\u6765\u81EA\u94FE\u4E0A\u7684tx-1" tabindex="-1">\u6765\u81EA\u94FE\u4E0A\u7684Tx <a class="header-anchor" href="#\u6765\u81EA\u94FE\u4E0A\u7684tx-1" aria-hidden="true">#</a></h4><p>block \u8868\u793A\u5305\u542B\u8BE5Tx\u7684\u5757\u4FE1\u606F</p><ol><li>\u5982\u679CbucketCredits\u5305\u542B\u8BE5outpoint,\u7ED3\u675F</li><li>\u5728bucketCredits\u8BB0\u5F55\u8BE5outpoint</li><li>\u8C03\u7528putMinedBalance\u589E\u52A0\u8BE5outpoint\u7684Amount\u5230Balance</li><li>\u5C06\u8BE5outpoint\u653E\u5165bucketUnspent</li></ol><p>InsertTx\u548CAddCredit\u7684\u8C03\u7528\u5173\u7CFB \u4E00\u822C\u662FInsertTx(memPool),addCredit(mempool),InsertTx(block!=nil),addCredit(block!=nil)</p><h3 id="rollback\u51FD\u6570" tabindex="-1">Rollback\u51FD\u6570 <a class="header-anchor" href="#rollback\u51FD\u6570" aria-hidden="true">#</a></h3><p>\u5F53\u53D1\u751F\u5757\u91CD\u7EC4\u7684\u65F6\u5019\u9700\u8981rollback</p><div class="language-go line-numbers-mode"><pre><code><span class="token comment">// Rollback removes all blocks at height onwards, moving any transactions within</span>
<span class="token comment">// each block to the unconfirmed pool.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Store<span class="token punctuation">)</span> <span class="token function">Rollback</span><span class="token punctuation">(</span>ns walletdb<span class="token punctuation">.</span>ReadWriteBucket<span class="token punctuation">,</span> height <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>\u8FD9\u4E2A\u51FD\u6570\u975E\u5E38\u590D\u6742, \u6DF1\u5165\u6B64\u51FD\u6570\u4E5F\u53EF\u4EE5\u770B\u51FA\u94FE\u91CD\u7EC4\u7684\u65F6\u5019\u76F8\u5173\u7684\u6570\u636E\u5E94\u8BE5\u5982\u4F55\u5904\u7406. \u76F8\u6BD4\u4E0E\u4EE5\u592A\u574A\u7684StateTransition\u6A21\u578B,\u8FD9\u91CC\u8981\u590D\u6742\u5F88\u591A.</p><ol><li>\u9996\u5148\u6309\u7167\u5757\u9AD8\u5EA6\u5012\u7740\u904D\u5386\u6BCF\u4E00\u5757</li><li>\u9488\u5BF9\u5F53\u524D\u5757\u4E2D\u7684\u6BCF\u4E00\u4E2ATx\u8FDB\u884C\u64CD\u4F5C</li><li>\u4ECEbucketTxRecords\u4E2D\u5220\u9664\u8BE5Tx</li><li>\u5982\u679C\u662FcoinbaseTx,\u4ECEbucketUnspent\u548CbucketCredits\u5220\u9664\u76F8\u5173\u8BB0\u5F55,\u7136\u540E\u56DE\u52302. \u5982\u679Ccoinbase\u5DF2\u7ECF\u88AB\u6D88\u8D39,\u5219\u53C2\u80039</li><li>\u628ATx\u8FD4\u56DEbucketUnmined</li><li>\u904D\u5386Tx\u7684\u6BCF\u4E00\u4E2ATxIn,\u5728bucketUnminedInputs\u91CD\u65B0\u8BB0\u5F55\u4F9D\u8D56\u5173\u7CFB 6.1 \u5982\u679CbucketDebits\u4E2D\u6709\u8BB0\u5F55,\u5219\u8868\u793A\u662F\u6211\u7684\u4E00\u4E2AUTXO\u88AB\u6D88\u8D39\u4E86,\u9700\u8981\u64A4\u9500 6.2 \u91CD\u65B0\u5C06\u8BE5UTXO\u4ECEbucketDebits\u5220\u9664, 6.3 \u5C06\u8BE5UTXO\u91CD\u65B0\u653E\u56DEbucketUnspent, <strong>\u6211\u7684\u95EE\u9898,bucketCredits\u7684\u8BB0\u5F55\u600E\u4E48\u529E?</strong> 6.4 minedBalance\u91CD\u65B0\u52A0\u56DE\u53BB</li><li>\u904D\u5386Tx\u7684\u6BCF\u4E00\u4E2ATxOut 7.1 \u5982\u679CTxout\u662F\u6211\u7684\u94B1\u5305\u5730\u5740,\u5219\u5C06\u8BE5TxOut\u653E\u56DEbucketUnminedCredits 7.2 \u5220\u9664bucketCredits\u4E2D\u7684\u8BB0\u5F55 7.3 \u5220\u9664bucketUnspent\u7684\u8BB0\u5F55 7.4 minedBalance\u91CD\u65B0\u51CF\u56DE\u53BB</li><li>1-7\u5FAA\u73AF\u7ED3\u675F\u4EE5\u540E,\u4ECEbucketBlocks\u5220\u9664Block\u8BB0\u5F55</li><li>\u904D\u5386coinBaseCredits(\u6765\u81EA\u4E8E\u6B65\u9AA44) \u5C06\u6240\u6709\u4F9D\u8D56\u8BE5Tx\u7684bucketUnminedInputs\u548CbucketUnminedCredits\u4E2D\u7684\u8BB0\u5F55\u5168\u5220\u9664 \u8C03\u7528removeConflict\u9012\u5F52\u5220\u9664\u4F9D\u8D56 <strong>\u4E0D\u660E\u767D\u7684\u662F\u5BF9\u4E8E\u90A3\u4E9B\u5DF2\u7ECF\u4E0A\u94FE\u7684\u4EA4\u6613\u7684\u4EA4\u6613\u600E\u4E48\u5904\u7406? \u4E5F\u5C31\u662FCoinBase-&gt;Tx1-&gt;Tx2,Tx2\u5DF2\u7ECF\u4E0A\u94FE\u4E86</strong></li></ol>`,32),i=[o];function l(c,r,p,u,d,b){return t(),e("div",null,i)}var x=n(s,[["render",l]]);export{m as __pageData,x as default};
