import{_ as s,c as n,o as a,N as l}from"./chunks/framework.3a9190c5.js";const A=JSON.parse('{"title":"Rust异步编程中我们应该用那种锁?","description":"","frontmatter":{"title":"Rust异步编程中我们应该用那种锁?","date":"2020-12-31T03:57:03.000Z","draft":false,"tags":["rust"],"categories":["技术相关"]},"headers":[],"relativePath":"rust/rust_async_lock.md"}'),p={name:"rust/rust_async_lock.md"},o=l(`<p>在rust异步编程中,我们有两种锁可以选择,一种是标准库里提供的锁(<code>std::sync::Mutex</code>),下称标准锁; 另一种可以是异步库提供的锁,比如<code>async_std::sync::Mutex</code>,简称异步锁, 那么两种锁有何异同,我们该如何选择呢? 本文将会给出答案.</p><p>按照我的习惯,先说结论:</p><ol><li>如果标准锁满足要求,尽量使用标准锁</li><li>标准锁不能用时,再用异步锁</li></ol><h2 id="两种锁的异同" tabindex="-1">两种锁的异同 <a class="header-anchor" href="#两种锁的异同" aria-label="Permalink to &quot;两种锁的异同&quot;">​</a></h2><p>相同点:</p><ul><li>都能起到同步互斥的效果</li></ul><p>不同点:</p><ul><li>标准锁不能跨await</li><li>异步锁可以跨await</li></ul><p>如果你的代码中需要跨await持有锁,那么你就只能用异步库锁. 比如下面这种情况:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">SomeSharedStructure</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    v</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">i32</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">SomeSharedStructure</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">do1</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">test_mutex_guard_await</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> s </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Mutex</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">SomeSharedStructure</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> v</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}));</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">async_std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">task</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">spawn</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">move</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> s </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> s</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">().</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        s</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">do1</span><span style="color:#89DDFF;">().</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">test_mutex_guard_cannot_compile</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> s </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">sync</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Mutex</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">SomeSharedStructure</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> v</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}));</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // let s2=s.clone();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">async_std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">task</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">spawn</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">move</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> s </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> s</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        s</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">do1</span><span style="color:#89DDFF;">().</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>test_mutex_guard_cannot_compile 无法编译通过,因为<code>future cannot be sent between threads safely</code> ,准确来说就是<code>std::sync::MutexGuard</code>不能在线程之间共享. 这个其实很容易理解,Mutex就是为了解决线程同步问题的,已经解锁的数据如果可以在线程之间传递,那么Rust保证的线程安全岂不成了笑话.</p><p>而<code>async_std::sync::MutexGuard</code>却是可以在线程之间传递的,具体可以看async-mutex这个crate的代码:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/// A guard that releases the mutex when dropped.</span></span>
<span class="line"><span style="color:#F78C6C;">pub</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MutexGuard</span><span style="color:#89DDFF;">&lt;&#39;</span><span style="color:#FFCB6B;">a</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#FFCB6B;">Sized</span><span style="color:#89DDFF;">&gt;(&amp;&#39;</span><span style="color:#FFCB6B;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Mutex</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">impl</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Send</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#FFCB6B;">Sized</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Send</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MutexGuard</span><span style="color:#89DDFF;">&lt;&#39;</span><span style="color:#FFCB6B;">_</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">impl</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sync</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#FFCB6B;">Sized</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sync</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MutexGuard</span><span style="color:#89DDFF;">&lt;&#39;</span><span style="color:#FFCB6B;">_</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>至于<code>async_std::sync::MutexGuard</code>是如何保证既可以在线程之间传递,还能保证线程安全,我会在其他文章中专门解释.</p><h2 id="两种锁的选用" tabindex="-1">两种锁的选用 <a class="header-anchor" href="#两种锁的选用" aria-label="Permalink to &quot;两种锁的选用&quot;">​</a></h2><p>那么问题来了,这两种锁我们适合在什么场景下使用呢?</p><ol><li>如果需要跨await,只能用异步锁</li><li>其他情况,两种锁随便用哪个都可以?</li></ol><h3 id="tokio中关于异步锁的解释" tabindex="-1">tokio中关于异步锁的解释 <a class="header-anchor" href="#tokio中关于异步锁的解释" aria-label="Permalink to &quot;tokio中关于异步锁的解释&quot;">​</a></h3><p>可以先看看<a href="https://tokio-rs.github.io/tokio/doc/tokio/sync/struct.Mutex.html" target="_blank" rel="noreferrer">tokio关于异步锁的解释</a>.</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">Which kind of mutex should you use?</span></span>
<span class="line"><span style="color:#A6ACCD;">Contrary to popular belief, it is ok and often preferred to use the ordinary Mutex from the standard library in asynchronous code. This section will help you decide on which kind of mutex you should use.</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>简单来说就是,如果可以用标准锁就用标准锁. 那么为什么呢?</p><h3 id="标准库中锁的代价高么" tabindex="-1">标准库中锁的代价高么? <a class="header-anchor" href="#标准库中锁的代价高么" aria-label="Permalink to &quot;标准库中锁的代价高么?&quot;">​</a></h3><p>在没认真阅读代码之前,我以为异步锁的代价要低一些,因为他们是基于atomic的,加锁不会触发系统调用,而标准锁会触发系统调用,代价昂贵. 但是真的是这样的么? 让我们来跟一下标准锁的实现.</p><h4 id="_1-lock" tabindex="-1">1. lock <a class="header-anchor" href="#_1-lock" aria-label="Permalink to &quot;1. lock&quot;">​</a></h4><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">stable</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">feature </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">rust1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> since </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">1.0.0</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">pub</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">LockResult</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">MutexGuard</span><span style="color:#89DDFF;">&lt;&#39;</span><span style="color:#FFCB6B;">_</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">inner</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">raw_lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">MutexGuard</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>标准锁执行的是inner的raw_lock</p><h4 id="_2-raw-lock" tabindex="-1">2. raw_lock <a class="header-anchor" href="#_2-raw-lock" aria-label="Permalink to &quot;2. raw_lock&quot;">​</a></h4><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">pub</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MovableMutex</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Box</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">imp</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Mutex</span><span style="color:#89DDFF;">&gt;);</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /// Locks the mutex blocking the current thread until it is available.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">inline</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">pub</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">raw_lock</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>self.0实际上是imp::Mutex,跟下去就是标准库代码中的:<code>src/sys/unix/mutex.rs</code></p><h4 id="_3-平台相关的lock" tabindex="-1">3. 平台相关的lock <a class="header-anchor" href="#_3-平台相关的lock" aria-label="Permalink to &quot;3. 平台相关的lock&quot;">​</a></h4><p>这里以linux平台上的实现为例,来跟踪:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">inline</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">pub</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> r </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">libc</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">pthread_mutex_lock</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">inner</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">debug_assert_eq!</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">r</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>可以看到最终调用的是libc::pthread_mutex_lock.</p><h4 id="_4-glibc中的pthread-mutex-lock" tabindex="-1">4. glibc中的pthread_mutex_lock <a class="header-anchor" href="#_4-glibc中的pthread-mutex-lock" aria-label="Permalink to &quot;4. glibc中的pthread_mutex_lock&quot;">​</a></h4><p>这里以我手头的glibc 2.23代码为例来进行跟踪. x86平台下的pthread_mutex_lock.c实际上用得是:<code>#include &quot;nptl/pthread_mutex_lock.c&quot;</code></p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">nt</span></span>
<span class="line"><span style="color:#82AAFF;">__pthread_mutex_lock</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">pthread_mutex_t</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">mutex</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">assert</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(sizeof</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__size</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">sizeof</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">unsigned</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> type </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">PTHREAD_MUTEX_TYPE_ELISION</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">LIBC_PROBE</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex_entry</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> mutex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">__builtin_expect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">type </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">~(</span><span style="color:#F07178;">PTHREAD_MUTEX_KIND_MASK_NP</span></span>
<span class="line"><span style="color:#F07178;">				 </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> PTHREAD_MUTEX_ELISION_FLAGS_NP</span><span style="color:#89DDFF;">),</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">__pthread_mutex_lock_full</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">LIBC_PROBE</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex_acquired</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> mutex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>这里我们看最简单的情况,没有其他人持有锁,直接就得到锁的情况,简单读一下就可以看到,它实现用得也是atomic的CAS,也就是说根本没有什么系统调用. 显然相比async_std/tokio中的代码,libc中的代码更加久经考验,也更清楚各个平台的优势和缺点.</p><p>具体的代码太长了,我就附在下面,感兴趣的自行阅读就行了.</p><p>真的是**<code>Talk is cheap. Show me the code</code>**, 作为码农还是尽量少去猜,多去看代码才是关键.</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span></span>
<span class="line"><span style="color:#82AAFF;">__pthread_mutex_lock_full</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">pthread_mutex_t</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">mutex</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> oldval</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">pid_t</span><span style="color:#F07178;"> id </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">THREAD_GETMEM</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">THREAD_SELF</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> tid</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">switch</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">PTHREAD_MUTEX_TYPE</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> PTHREAD_MUTEX_ROBUST_RECURSIVE_NP</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> PTHREAD_MUTEX_ROBUST_ERRORCHECK_NP</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> PTHREAD_MUTEX_ROBUST_NORMAL_NP</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> PTHREAD_MUTEX_ROBUST_ADAPTIVE_NP</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">THREAD_SETMEM</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">THREAD_SELF</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> robust_head.list_op_pending</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">		     </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#F07178;">__data.__list.__next</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">      oldval </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__lock</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">do</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	again:</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">((</span><span style="color:#F07178;">oldval </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> FUTEX_OWNER_DIED</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	      /* The previous owner died.  Try locking the mutex.  */</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> newval </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> id</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#ifdef</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">NO_INCR</span></span>
<span class="line"><span style="color:#F07178;">	      newval </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> FUTEX_WAITERS</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#else</span></span>
<span class="line"><span style="color:#F07178;">	      newval </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">oldval </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> FUTEX_WAITERS</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	      newval</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">atomic_compare_and_exchange_val_acq</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__lock</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">						       newval</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> oldval</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">newval </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> oldval</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		  oldval </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> newval</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">		  </span><span style="color:#89DDFF;font-style:italic;">goto</span><span style="color:#F07178;"> again</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	      /* We got the mutex.  */</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__count</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	      /* But it is inconsistent unless marked otherwise.  */</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__owner</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> PTHREAD_MUTEX_INCONSISTENT</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#82AAFF;">ENQUEUE_MUTEX</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#82AAFF;">THREAD_SETMEM</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">THREAD_SELF</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">robust_head</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">list_op_pending</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	      /* Note that we deliberately exit here.  If we fall</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		 through to the end of the function __nusers would be</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		 incremented which is not correct because the old</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		 owner has to be discounted.  If we are not supposed</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		 to increment __nusers we actually have to decrement</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		 it here.  */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#ifdef</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">NO_INCR</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__nusers</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> EOWNERDEAD</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	  /* Check whether we already hold the mutex.  */</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">__glibc_unlikely</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">((</span><span style="color:#F07178;">oldval </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> FUTEX_TID_MASK</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> id</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> kind </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">PTHREAD_MUTEX_TYPE</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">kind </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> PTHREAD_MUTEX_ROBUST_ERRORCHECK_NP</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		  </span><span style="color:#82AAFF;">THREAD_SETMEM</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">THREAD_SELF</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">robust_head</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">list_op_pending</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">				 </span><span style="color:#89DDFF;">NULL);</span></span>
<span class="line"><span style="color:#F07178;">		  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> EDEADLK</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">kind </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> PTHREAD_MUTEX_ROBUST_RECURSIVE_NP</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		  </span><span style="color:#82AAFF;">THREAD_SETMEM</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">THREAD_SELF</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">robust_head</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">list_op_pending</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">				 </span><span style="color:#89DDFF;">NULL);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		  /* Just bump the counter.  */</span></span>
<span class="line"><span style="color:#F07178;">		  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">__glibc_unlikely</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__count</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		    /* Overflow of the counter.  */</span></span>
<span class="line"><span style="color:#F07178;">		    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> EAGAIN</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">		  </span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__count</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">		  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	  oldval </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">LLL_ROBUST_MUTEX_LOCK</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> id</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">__builtin_expect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__owner</span></span>
<span class="line"><span style="color:#F07178;">				</span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> PTHREAD_MUTEX_NOTRECOVERABLE</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	      /* This mutex is now not recoverable.  */</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__count</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#82AAFF;">lll_unlock</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__lock</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">			  </span><span style="color:#82AAFF;">PTHREAD_ROBUST_MUTEX_PSHARED</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#82AAFF;">THREAD_SETMEM</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">THREAD_SELF</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">robust_head</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">list_op_pending</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL);</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> ENOTRECOVERABLE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">((</span><span style="color:#F07178;">oldval </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> FUTEX_OWNER_DIED</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__count</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">ENQUEUE_MUTEX</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">THREAD_SETMEM</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">THREAD_SELF</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> robust_head.list_op_pending</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL);</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /* The PI support requires the Linux futex system call.  If that&#39;s not</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">       available, pthread_mutex_init should never have allowed the type to</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">       be set.  So it will get the default case for an invalid type.  */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#ifdef</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">__NR_futex</span></span>
<span class="line"><span style="color:#F07178;">    case PTHREAD_MUTEX_PI_RECURSIVE_NP:</span></span>
<span class="line"><span style="color:#F07178;">    case PTHREAD_MUTEX_PI_ERRORCHECK_NP:</span></span>
<span class="line"><span style="color:#F07178;">    case PTHREAD_MUTEX_PI_NORMAL_NP:</span></span>
<span class="line"><span style="color:#F07178;">    case PTHREAD_MUTEX_PI_ADAPTIVE_NP:</span></span>
<span class="line"><span style="color:#F07178;">    case PTHREAD_MUTEX_PI_ROBUST_RECURSIVE_NP:</span></span>
<span class="line"><span style="color:#F07178;">    case PTHREAD_MUTEX_PI_ROBUST_ERRORCHECK_NP:</span></span>
<span class="line"><span style="color:#F07178;">    case PTHREAD_MUTEX_PI_ROBUST_NORMAL_NP:</span></span>
<span class="line"><span style="color:#F07178;">    case PTHREAD_MUTEX_PI_ROBUST_ADAPTIVE_NP:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> kind </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__kind</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> PTHREAD_MUTEX_KIND_MASK_NP</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> robust </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__kind</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> PTHREAD_MUTEX_ROBUST_NORMAL_NP</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">robust</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	  /* Note: robust PI futexes are signaled by setting bit 0.  */</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#82AAFF;">THREAD_SETMEM</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">THREAD_SELF</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">robust_head</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">list_op_pending</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">			 </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(((</span><span style="color:#C792EA;">uintptr_t</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__list</span><span style="color:#F07178;">.</span><span style="color:#A6ACCD;">__next</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">				   </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	oldval </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__lock</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/* Check whether we already hold the mutex.  */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">__glibc_unlikely</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">((</span><span style="color:#F07178;">oldval </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> FUTEX_TID_MASK</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> id</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">kind </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> PTHREAD_MUTEX_ERRORCHECK_NP</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#82AAFF;">THREAD_SETMEM</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">THREAD_SELF</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">robust_head</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">list_op_pending</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL);</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> EDEADLK</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">kind </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> PTHREAD_MUTEX_RECURSIVE_NP</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#82AAFF;">THREAD_SETMEM</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">THREAD_SELF</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">robust_head</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">list_op_pending</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		/* Just bump the counter.  */</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">__glibc_unlikely</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__count</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		  /* Overflow of the counter.  */</span></span>
<span class="line"><span style="color:#F07178;">		  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> EAGAIN</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__count</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> newval </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> id</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;"># ifdef</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">NO_INCR</span></span>
<span class="line"><span style="color:#F07178;">	newval </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> FUTEX_WAITERS</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;"># endif</span></span>
<span class="line"><span style="color:#F07178;">	oldval </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">atomic_compare_and_exchange_val_acq</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__lock</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">						      newval</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">oldval </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	    /* The mutex is locked.  The kernel will now take care of</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	       everything.  */</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> private </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">robust</span></span>
<span class="line"><span style="color:#F07178;">			   </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">PTHREAD_ROBUST_MUTEX_PSHARED</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">			   </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">PTHREAD_MUTEX_PSHARED</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#82AAFF;">INTERNAL_SYSCALL_DECL</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">__err</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> e </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">INTERNAL_SYSCALL</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">futex</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> __err</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__lock</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">				      </span><span style="color:#82AAFF;">__lll_private_flag</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">FUTEX_LOCK_PI</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">							  private</span><span style="color:#89DDFF;">),</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">INTERNAL_SYSCALL_ERROR_P</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">e</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> __err</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">INTERNAL_SYSCALL_ERRNO</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">e</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> __err</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> ESRCH</span></span>
<span class="line"><span style="color:#F07178;">		    </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">INTERNAL_SYSCALL_ERRNO</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">e</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> __err</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> EDEADLK</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#82AAFF;">assert</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">INTERNAL_SYSCALL_ERRNO</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">e</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> __err</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> EDEADLK</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">kind </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> PTHREAD_MUTEX_ERRORCHECK_NP</span></span>
<span class="line"><span style="color:#F07178;">			    </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> kind </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> PTHREAD_MUTEX_RECURSIVE_NP</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		/* ESRCH can happen only for non-robust PI mutexes where</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		   the owner of the lock died.  */</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#82AAFF;">assert</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">INTERNAL_SYSCALL_ERRNO</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">e</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> __err</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> ESRCH </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#F07178;">robust</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		/* Delay the thread indefinitely.  */</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">		  </span><span style="color:#82AAFF;">pause_not_cancel</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	    oldval </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__lock</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#82AAFF;">assert</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">robust </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">oldval </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> FUTEX_OWNER_DIED</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">__glibc_unlikely</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">oldval </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> FUTEX_OWNER_DIED</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#82AAFF;">atomic_and</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__lock</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">~</span><span style="color:#F07178;">FUTEX_OWNER_DIED</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	    /* We got the mutex.  */</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__count</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	    /* But it is inconsistent unless marked otherwise.  */</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__owner</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> PTHREAD_MUTEX_INCONSISTENT</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#82AAFF;">ENQUEUE_MUTEX_PI</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#82AAFF;">THREAD_SETMEM</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">THREAD_SELF</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">robust_head</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">list_op_pending</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	    /* Note that we deliberately exit here.  If we fall</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	       through to the end of the function __nusers would be</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	       incremented which is not correct because the old owner</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	       has to be discounted.  If we are not supposed to</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	       increment __nusers we actually have to decrement it here.  */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;"># ifdef</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">NO_INCR</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__nusers</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;"># endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> EOWNERDEAD</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">robust</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">__builtin_expect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__owner</span></span>
<span class="line"><span style="color:#F07178;">				 </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> PTHREAD_MUTEX_NOTRECOVERABLE</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	    /* This mutex is now not recoverable.  */</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__count</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#82AAFF;">INTERNAL_SYSCALL_DECL</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">__err</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#82AAFF;">INTERNAL_SYSCALL</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">futex</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> __err</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__lock</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">			      </span><span style="color:#82AAFF;">__lll_private_flag</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">FUTEX_UNLOCK_PI</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">						  </span><span style="color:#82AAFF;">PTHREAD_ROBUST_MUTEX_PSHARED</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">)),</span></span>
<span class="line"><span style="color:#F07178;">			      </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#82AAFF;">THREAD_SETMEM</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">THREAD_SELF</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">robust_head</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">list_op_pending</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL);</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> ENOTRECOVERABLE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__count</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">robust</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#82AAFF;">ENQUEUE_MUTEX_PI</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#82AAFF;">THREAD_SETMEM</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">THREAD_SELF</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">robust_head</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">list_op_pending</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL);</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span><span style="color:#676E95;font-style:italic;">  /* __NR_futex.  */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> PTHREAD_MUTEX_PP_RECURSIVE_NP</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> PTHREAD_MUTEX_PP_ERRORCHECK_NP</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> PTHREAD_MUTEX_PP_NORMAL_NP</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> PTHREAD_MUTEX_PP_ADAPTIVE_NP</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> kind </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__kind</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> PTHREAD_MUTEX_KIND_MASK_NP</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	oldval </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__lock</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/* Check whether we already hold the mutex.  */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__owner</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> id</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">kind </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> PTHREAD_MUTEX_ERRORCHECK_NP</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> EDEADLK</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">kind </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> PTHREAD_MUTEX_RECURSIVE_NP</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		/* Just bump the counter.  */</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">__glibc_unlikely</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__count</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		  /* Overflow of the counter.  */</span></span>
<span class="line"><span style="color:#F07178;">		  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> EAGAIN</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__count</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> oldprio </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> ceilval</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">do</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> ceiling </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">oldval </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> PTHREAD_MUTEX_PRIO_CEILING_MASK</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">			  </span><span style="color:#89DDFF;">&gt;&gt;</span><span style="color:#F07178;"> PTHREAD_MUTEX_PRIO_CEILING_SHIFT</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">__pthread_current_priority</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;"> ceiling</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">oldprio </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">		  </span><span style="color:#82AAFF;">__pthread_tpp_change_priority</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">oldprio</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> EINVAL</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> retval </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">__pthread_tpp_change_priority</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">oldprio</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> ceiling</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">retval</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> retval</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	    ceilval </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> ceiling </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#F07178;"> PTHREAD_MUTEX_PRIO_CEILING_SHIFT</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	    oldprio </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> ceiling</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	    oldval</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">atomic_compare_and_exchange_val_acq</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__lock</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#ifdef</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">NO_INCR</span></span>
<span class="line"><span style="color:#F07178;">						     ceilval </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#else</span></span>
<span class="line"><span style="color:#F07178;">						     ceilval </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span></span>
<span class="line"><span style="color:#F07178;">						     ceilval</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">oldval </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> ceilval</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;font-style:italic;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;font-style:italic;">do</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		oldval</span></span>
<span class="line"><span style="color:#F07178;">		  </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">atomic_compare_and_exchange_val_acq</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__lock</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">							 ceilval </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">							 ceilval </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">((</span><span style="color:#F07178;">oldval </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> PTHREAD_MUTEX_PRIO_CEILING_MASK</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> ceilval</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">		  </span><span style="color:#89DDFF;font-style:italic;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">oldval </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> ceilval</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">		  </span><span style="color:#82AAFF;">lll_futex_wait</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__lock</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> ceilval </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">				  </span><span style="color:#82AAFF;">PTHREAD_MUTEX_PSHARED</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">atomic_compare_and_exchange_val_acq</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__lock</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">							ceilval </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> ceilval</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">		   </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> ceilval</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">((</span><span style="color:#F07178;">oldval </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> PTHREAD_MUTEX_PRIO_CEILING_MASK</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> ceilval</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">assert</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__owner</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__count</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">      /* Correct code cannot set any other type.  */</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> EINVAL</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  /* Record the ownership.  */</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__owner</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> id</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#ifndef</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">NO_INCR</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;">mutex</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">__data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__nusers</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">LIBC_PROBE</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex_acquired</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> mutex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br></div></div>`,40),e=[o];function t(c,r,F,y,D,i){return a(),n("div",null,e)}const C=s(p,[["render",t]]);export{A as __pageData,C as default};
