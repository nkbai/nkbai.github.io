import{_ as n,c as s,o as a,a as p}from"./app.634a8744.js";const d='{"title":"6.libra\u7684mempool\u6A21\u5757\u89E3\u8BFB-1","description":"","frontmatter":{"title":"6.libra\u7684mempool\u6A21\u5757\u89E3\u8BFB-1","date":"2019-07-02T03:00:34.000Z","draft":false,"tags":["rust","blockchain","libra"],"series":["libra"],"categories":["\u6280\u672F\u76F8\u5173"]},"headers":[{"level":2,"title":"\u57FA\u672C\u529F\u80FD","slug":"\u57FA\u672C\u529F\u80FD"},{"level":2,"title":"mempool\u7684\u5BF9\u5916\u63A5\u53E3","slug":"mempool\u7684\u5BF9\u5916\u63A5\u53E3"},{"level":3,"title":"\u63A5\u53D7\u65B0\u7684Tx","slug":"\u63A5\u53D7\u65B0\u7684tx"},{"level":3,"title":"remove_transaction \u79FB\u9664\u5DF2\u6253\u5305\u4EA4\u6613","slug":"remove-transaction-\u79FB\u9664\u5DF2\u6253\u5305\u4EA4\u6613"},{"level":3,"title":"\u4E3Aconsensus\u6A21\u5757\u63D0\u4F9B\u4E0B\u4E00\u5757\u4EA4\u6613\u6570\u636E","slug":"\u4E3Aconsensus\u6A21\u5757\u63D0\u4F9B\u4E0B\u4E00\u5757\u4EA4\u6613\u6570\u636E"},{"level":3,"title":"\u5176\u4ED6\u51E0\u4E2A\u51FD\u6570","slug":"\u5176\u4ED6\u51E0\u4E2A\u51FD\u6570"}],"relativePath":"blockchain/libra/6.libria_mempool_1.md"}',e={},t=p(`<ul><li><a href="#%E5%9F%BA%E6%9C%AC%E5%8A%9F%E8%83%BD"> \u57FA\u672C\u529F\u80FD</a></li><li><a href="#mempool%E7%9A%84%E5%AF%B9%E5%A4%96%E6%8E%A5%E5%8F%A3"> mempool\u7684\u5BF9\u5916\u63A5\u53E3</a><ul><li><a href="#%E6%8E%A5%E5%8F%97%E6%96%B0%E7%9A%84tx"> \u63A5\u53D7\u65B0\u7684Tx</a></li><li><a href="#remove_transaction-%E7%A7%BB%E9%99%A4%E5%B7%B2%E6%89%93%E5%8C%85%E4%BA%A4%E6%98%93"> remove_transaction \u79FB\u9664\u5DF2\u6253\u5305\u4EA4\u6613</a></li><li><a href="#%E4%B8%BAconsensus%E6%A8%A1%E5%9D%97%E6%8F%90%E4%BE%9B%E4%B8%8B%E4%B8%80%E5%9D%97%E4%BA%A4%E6%98%93%E6%95%B0%E6%8D%AE"> \u4E3Aconsensus\u6A21\u5757\u63D0\u4F9B\u4E0B\u4E00\u5757\u4EA4\u6613\u6570\u636E</a></li><li><a href="#%E5%85%B6%E4%BB%96%E5%87%A0%E4%B8%AA%E5%87%BD%E6%95%B0"> \u5176\u4ED6\u51E0\u4E2A\u51FD\u6570</a></li></ul></li></ul><p>Mempool\u6A21\u5757\u4E3B\u8981\u7528\u4E8E\u7F13\u5B58\u672A\u6253\u5305\u7684\u5408\u6CD5\u4EA4\u6613,\u8BE5\u6A21\u5757\u548C\u6BD4\u7279\u5E01,\u4EE5\u592A\u574A\u6E90\u7801\u4E2D\u7684TxPool\u529F\u80FD\u7B49\u4EF7,\u53EA\u8981\u5305\u542B\u4E24\u4E2A\u529F\u80FD:</p><ol><li>\u63A5\u6536\u672C\u5730\u6536\u5230\u7684Tx\u5E76\u9A8C\u8BC1</li><li>\u548C\u5176\u4ED6\u8282\u70B9\u4E4B\u95F4\u4E92\u76F8\u540C\u6B65Tx. \u56E0\u4E3ALibra\u4F7F\u7528\u7684\u662F\u4E0D\u4F1A\u5206\u53C9\u7684PBFT\u5171\u8BC6,\u6240\u4EE5\u7F13\u51B2\u6C60\u7684\u5B9E\u73B0\u4EE5\u53CA\u7BA1\u7406\u8981\u7B80\u5355\u8BB8\u591A.</li></ol><h2 id="\u57FA\u672C\u529F\u80FD" tabindex="-1">\u57FA\u672C\u529F\u80FD <a class="header-anchor" href="#\u57FA\u672C\u529F\u80FD" aria-hidden="true">#</a></h2><p>mempool\u7684\u529F\u80FD\u4E3B\u8981\u662F\u63A5\u6536\u6765\u81EAAC\u6A21\u5757\u7684\u4EA4\u6613,\u540C\u65F6\u548C\u5176\u4ED6\u8282\u70B9\u4E4B\u95F4\u901A\u8FC7\u7F51\u7EDC\u540C\u6B65\u4EA4\u6613. mempool\u4E3B\u8981\u7528\u4E8E\u4FDD\u5B58\u53EF\u80FD\u6253\u5305\u7684\u4EA4\u6613,\u4E3B\u8981\u662F\u6307\u9A8C\u8BC1\u5408\u6CD5\u7684\u4EA4\u6613(\u5305\u62EC\u7B7E\u540D\u5408\u6CD5,\u8D26\u6237\u91D1\u989D\u8DB3\u591F). \u53EF\u4EE5\u7B80\u5355\u5206\u7C7B:</p><ol><li>\u5404\u65B9\u9762\u90FD\u9F50\u5907,\u53EF\u4EE5\u8FDB\u5165\u4E0B\u4E00\u5757\u7684\u4EA4\u6613. \u4E3B\u8981\u662Fseq_number\u8FDE\u8D77\u6765\u7684.</li><li>\u56E0\u4E3Aseq_number\u6CA1\u6709\u8FDE\u7EED\u4E0D\u80FD\u88AB\u6253\u5305\u7684\u4EA4\u6613 (\u6BD4\u5982\u5F53\u524DAccountA\u7684Tx\u4E2D\u5305\u542B\u4E86[2,3,4,7,8]\u4EA4\u6613,\u4F46\u662F5\u6CA1\u6709,\u6240\u4EE5[7,8]\u662F\u4E0D\u53EF\u80FD\u88AB\u6253\u5305\u7684)</li></ol><p>\u540C\u65F6libra\u4E2D\u4E5F\u6709\u548C\u4EE5\u592A\u574A\u4E00\u6837\u7684GasPrice\u6982\u5FF5(\u529F\u80FD\u4E5F\u4E00\u6837),\u56E0\u6B64\u5982\u679C\u5BF9\u4E8E\u540C\u4E00\u8D26\u53F7,seq_number\u76F8\u540C\u7684\u60C5\u51B5\u4E0B,\u4F1A\u9009\u62E9GasPrice\u9AD8\u7684\u90A3\u4E2ATx. \u6839\u636E\u4EE5\u4E0A\u8BA8\u8BBA,\u53EF\u4EE5\u770B\u51FA\u5B9E\u9645\u4E0ALibra\u552F\u4E00\u7684ID\u53EF\u4EE5\u4E0D\u8BA4\u4E3A\u662F\u4EA4\u6613\u6570\u636E\u7684\u54C8\u5E0C\u503C,\u53EF\u4EE5\u628A(Address,seq_number)\u4F5C\u4E3A\u552F\u4E00\u7684ID,\u5F53\u7136\u8FD9\u4E2A\u5728\u6BD4\u7279\u5E01\u4EE5\u592A\u574A\u7B49\u516C\u94FE\u4E2D\u4E5F\u884C\u7684\u901A. \u56E0\u4E3A\u5728Libra\u4E2D\u628A(Address,seq_number)\u4E8C\u5143\u7EC4\u4F5C\u4E3ATx\u552F\u4E00\u7684ID,\u6240\u4EE5\u5176\u4EE3\u7801\u8BBE\u8BA1\u4E2D\u5BF9\u4E8ETx\u7684\u7BA1\u7406\u548C\u4EE5\u592A\u574A\u4E5F\u4E0D\u592A\u4E00\u6837.</p><p>\u90A3\u4E48\u4EC0\u4E48\u662Fmempool\u5462? \u53EF\u4EE5\u901A\u4FD7\u7684\u8BA4\u4E3A\u5C31\u662F\u4E00\u4E2A<code>HashMap&lt;AccountAddress, BTreeMap&lt;u64, MempoolTransaction&gt;&gt;</code>, \u5176\u4E2D\u8FD9\u91CC\u7684u64\u5C31\u662F\u5BF9\u5E94\u8D26\u6237\u7684seq_number. \u5176\u6240\u6709\u529F\u80FD\u90FD\u662F\u56F4\u7ED5\u7740\u8FD9\u4E2A\u6570\u636E\u7ED3\u6784\u5C55\u5F00.</p><h2 id="mempool\u7684\u5BF9\u5916\u63A5\u53E3" tabindex="-1">mempool\u7684\u5BF9\u5916\u63A5\u53E3 <a class="header-anchor" href="#mempool\u7684\u5BF9\u5916\u63A5\u53E3" aria-hidden="true">#</a></h2><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Mempool</span> <span class="token punctuation">{</span>
    <span class="token comment">//\u4E3B\u8981\u7528\u4E8E\u63A5\u53D7\u6765\u81EAAC\u7684\u65B0\u589ETx</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">add_transaction_with_validation</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> ctx<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">grpcio<span class="token punctuation">::</span></span><span class="token class-name">RpcContext</span><span class="token punctuation">,</span> req<span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>mempool<span class="token punctuation">::</span></span><span class="token class-name">AddTransactionWithValidationRequest</span><span class="token punctuation">,</span> sink<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">grpcio<span class="token punctuation">::</span></span><span class="token class-name">UnarySink</span><span class="token operator">&lt;</span><span class="token keyword">super</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>mempool<span class="token punctuation">::</span></span><span class="token class-name">AddTransactionWithValidationResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//\u670D\u52A1\u4E8Econsensus\u6A21\u5757,\u4ECEmempool\u4E2D\u83B7\u53D6\u4E0B\u4E00\u5757\u53EF\u4EE5\u6253\u5305\u7684\u4EA4\u6613</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">get_block</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> ctx<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">grpcio<span class="token punctuation">::</span></span><span class="token class-name">RpcContext</span><span class="token punctuation">,</span> req<span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>mempool<span class="token punctuation">::</span></span><span class="token class-name">GetBlockRequest</span><span class="token punctuation">,</span> sink<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">grpcio<span class="token punctuation">::</span></span><span class="token class-name">UnarySink</span><span class="token operator">&lt;</span><span class="token keyword">super</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>mempool<span class="token punctuation">::</span></span><span class="token class-name">GetBlockResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//\u670D\u52A1\u4E8Econsensus\u6A21\u5757,\u5F53\u4EA4\u6613\u88AB\u6253\u5305\u4EE5\u540E,\u7F13\u5B58\u7684\u76F8\u5173Tx\u5C31\u53EF\u4EE5\u79FB\u9664\u4E86.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">commit_transactions</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> ctx<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">grpcio<span class="token punctuation">::</span></span><span class="token class-name">RpcContext</span><span class="token punctuation">,</span> req<span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>mempool<span class="token punctuation">::</span></span><span class="token class-name">CommitTransactionsRequest</span><span class="token punctuation">,</span> sink<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">grpcio<span class="token punctuation">::</span></span><span class="token class-name">UnarySink</span><span class="token operator">&lt;</span><span class="token keyword">super</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>mempool<span class="token punctuation">::</span></span><span class="token class-name">CommitTransactionsResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//\u5065\u5EB7\u68C0\u67E5,\u4E3B\u8981\u662F\u68C0\u67E5\u7F13\u51B2\u533A\u662F\u5426\u653E\u5F97\u4E0B\u66F4\u591ATx</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">health_check</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> ctx<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">grpcio<span class="token punctuation">::</span></span><span class="token class-name">RpcContext</span><span class="token punctuation">,</span> req<span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>mempool<span class="token punctuation">::</span></span><span class="token class-name">HealthCheckRequest</span><span class="token punctuation">,</span> sink<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">grpcio<span class="token punctuation">::</span></span><span class="token class-name">UnarySink</span><span class="token operator">&lt;</span><span class="token keyword">super</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>mempool<span class="token punctuation">::</span></span><span class="token class-name">HealthCheckResponse</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>MempoolService\u7684\u5B9E\u73B0\u4F4D\u4E8E<code>mempool/src/mempool_service.rs</code>,\u8FD9\u91CC\u7684\u5B9E\u73B0\u5C31\u662F\u5BF9\u4E8Egrpc\u63A5\u53E3\u6570\u636E\u7684\u5904\u7406,\u771F\u6B63\u7684\u5904\u7406\u903B\u8F91\u4F4D\u4E8E<code>CoreMempool</code></p><div class="language-rust line-numbers-mode"><pre><code><span class="token attribute attr-name">#[derive(Clone)]</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">MempoolService</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> core_mempool<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">CoreMempool</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Mempool</span> <span class="token punctuation">{</span>
    <span class="token comment">// stores metadata of all transactions in mempool (of all states)</span>
    transactions<span class="token punctuation">:</span> <span class="token class-name">TransactionStore</span><span class="token punctuation">,</span> <span class="token comment">//\u8FD9\u662F\u7CFB\u7EDF\u7684\u6838\u5FC3</span>

    sequence_number_cache<span class="token punctuation">:</span> <span class="token class-name">LruCache</span><span class="token operator">&lt;</span><span class="token class-name">AccountAddress</span><span class="token punctuation">,</span> <span class="token keyword">u64</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">//\u8FD9\u91CC\u4FDD\u5B58\u7684\u662FAccountAddress\u5BF9\u5E94\u7684\u4E0B\u4E00\u4E2A\u53EF\u4EE5\u6253\u5305\u7684Tx\u5BF9\u5E94\u7684seq_number</span>
    <span class="token comment">// temporary DS. TODO: eventually retire it</span>
    <span class="token comment">// for each transaction, entry with timestamp is added when transaction enters mempool</span>
    <span class="token comment">// used to measure e2e latency of transaction in system, as well as time it takes to pick it up</span>
    <span class="token comment">// by consensus</span>
    metrics_cache<span class="token punctuation">:</span> <span class="token class-name">TtlCache</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">AccountAddress</span><span class="token punctuation">,</span> <span class="token keyword">u64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">i64</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">//\u8FD9\u4E2A\u662F\u4E3A\u4E86</span>
    <span class="token comment">//\u4E00\u4E2A\u4EA4\u6613\u5728\u7F13\u51B2\u6C60\u4E2D\u4E0D\u80FD\u5446\u7684\u592A\u4E45,\u5982\u679C\u8FDF\u8FDF\u4E0D\u80FD\u88AB\u6253\u5305\u4F1A\u88AB\u5B9A\u671F\u6E05\u7406\u6389.\u8FD9\u4E2A\u65F6\u95F4\u5C31\u662F\u5176\u5728\u7F13\u51B2\u6C60\u4E2D\u5446\u7684\u6700\u957F\u65F6\u95F4</span>
    <span class="token keyword">pub</span> system_transaction_timeout<span class="token punctuation">:</span> <span class="token class-name">Duration</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token comment">/// TransactionStore is in-memory storage for all transactions in mempool</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">TransactionStore</span> <span class="token punctuation">{</span>
    <span class="token comment">// main DS</span>
    transactions<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">AccountAddress</span><span class="token punctuation">,</span> <span class="token class-name">AccountTransactions</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">/* \u5730\u5740=&gt;{seq=&gt;Tx} \u4E8C\u91CDmap,\u6240\u6709\u6536\u96C6\u5230\u7684\u5408\u6CD5\u7684Tx */</span>

    <span class="token comment">// indexes</span>
    priority_index<span class="token punctuation">:</span> <span class="token class-name">PriorityIndex</span><span class="token punctuation">,</span> <span class="token comment">/* \u6309\u7167gas_price,expiration_time,address,
                                    * sequence_number\u987A\u5E8F\u6392\u5E8F\u7684\u6240\u6709\u53EF\u4EE5\u6253\u5305\u7684Tx */</span>
    <span class="token comment">// TTLIndex based on client-specified expiration time</span>
    expiration_time_index<span class="token punctuation">:</span> <span class="token class-name">TTLIndex</span><span class="token punctuation">,</span> <span class="token comment">/* \u8FD9\u4E2A\u8FC7\u671F\u65F6\u95F4\u662F\u7528\u6237\u63D0\u4EA4\u7684,\u8FD9\u4E2A\u65F6\u95F4\u867D\u7136\u662FDuration,
                                      * \u4F46\u662F\u5176\u5B9E\u4E5F\u662F\u7EDD\u5BF9\u65F6\u95F4,\u4FDD\u5B58\u6240\u6709\u5408\u6CD5\u7684Tx */</span>
    <span class="token comment">// TTLIndex based on system expiration time</span>
    <span class="token comment">// we keep it separate from \`expiration_time_index\` so Mempool can&#39;t be clogged</span>
    <span class="token comment">//  by old transactions even if it hasn&#39;t received commit callbacks for a while</span>
    system_ttl_index<span class="token punctuation">:</span> <span class="token class-name">TTLIndex</span><span class="token punctuation">,</span> <span class="token comment">/* \u8FD9\u4E2A\u65F6\u95F4\u662F\u7531mempool\u63A7\u5236,
                                 * \u5728\u8FDB\u5165\u7F13\u51B2\u6C60\u7684\u65F6\u5019\u4F1A\u8BBE\u7F6E\u6210\u5F53\u65F6\u7684\u65F6\u95F4\u52A0\u4E0A\u8FC7\u671F\u65F6\u95F4,
                                 * \u4FDD\u5B58\u6240\u6709\u7684\u5408\u6CD5Tx */</span>
    timeline_index<span class="token punctuation">:</span> <span class="token class-name">TimelineIndex</span><span class="token punctuation">,</span> <span class="token comment">/* \u91CC\u9762\u4FDD\u5B58\u7684timeline_id,\u7528\u4E8Emempool\u4E4B\u95F4\u7684Tx\u540C\u6B65,
                                    * \u8FD9\u91CC\u9762\u6309\u5E8F\u4FDD\u5B58\u7740\u53EF\u4EE5\u6253\u5305\u7684Tx */</span>
    <span class="token comment">// keeps track of &quot;non-ready&quot; txns (transactions that can&#39;t be included in next block)</span>
    parking_lot_index<span class="token punctuation">:</span> <span class="token class-name">ParkingLotIndex</span><span class="token punctuation">,</span> <span class="token comment">//\u6682\u65F6\u4E0D\u6EE1\u8DB3\u6761\u4EF6,\u4E0D\u80FD\u6253\u5305\u7684Tx</span>

    <span class="token comment">// configuration</span>
    capacity<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    capacity_per_user<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h3 id="\u63A5\u53D7\u65B0\u7684tx" tabindex="-1">\u63A5\u53D7\u65B0\u7684Tx <a class="header-anchor" href="#\u63A5\u53D7\u65B0\u7684tx" aria-hidden="true">#</a></h3><p>\u5728<code>add_transaction_with_validation</code>\u4E2D\u53EA\u662F\u7B80\u5355\u89E3\u6790\u4E00\u4E0B\u53C2\u6570\u5C31\u5F88\u5FEB\u8FDB\u5165\u5230<code>CoreMempool</code>\u7684<code>add_txn</code>\u4E2D,\u6211\u4EEC\u91CD\u70B9\u89E3\u6790\u4E00\u4E0B\u8FD9\u4E2A\u51FD\u6570.</p><div class="language-rust line-numbers-mode"><pre><code>    <span class="token comment">/// Used to add a transaction to the Mempool</span>
    <span class="token comment">/// Performs basic validation: checks account&#39;s balance and sequence number</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">add_txn</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        txn<span class="token punctuation">:</span> <span class="token class-name">SignedTransaction</span><span class="token punctuation">,</span>
        gas_amount<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
        db_sequence_number<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> <span class="token comment">//\u5DF2\u7ECF\u786E\u8BA4\u7684txn&#39;s sender\u7684seq_number</span>
        balance<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span><span class="token comment">//\u8FD9\u4E2A\u8D26\u6237\u7684\u91D1\u989D</span>
        timeline_state<span class="token punctuation">:</span> <span class="token class-name">TimelineState</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">MempoolAddTransactionStatus</span> <span class="token punctuation">{</span>
        <span class="token macro property">debug!</span><span class="token punctuation">(</span>
            <span class="token string">&quot;[Mempool] Adding transaction to mempool: {}:{}&quot;</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>txn<span class="token punctuation">.</span><span class="token function">sender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            db_sequence_number
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;signedTransaction:{:?}&quot;</span><span class="token punctuation">,</span> txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u8D26\u6237\u4F59\u989D\u90FD\u4E0D\u591F\u4ED8gas\u8D39\u4E86,\u76F4\u63A5\u62A4\u989D\u7565</span>
        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">check_balance</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>txn<span class="token punctuation">,</span> balance<span class="token punctuation">,</span> gas_amount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">MempoolAddTransactionStatus</span><span class="token punctuation">::</span><span class="token class-name">InsufficientBalance</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">let</span> cached_value <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>sequence_number_cache<span class="token punctuation">.</span><span class="token function">get_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>txn<span class="token punctuation">.</span><span class="token function">sender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> sequence_number <span class="token operator">=</span> <span class="token keyword">match</span> cached_value <span class="token punctuation">{</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">*</span>value<span class="token punctuation">,</span> db_sequence_number<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">None</span> <span class="token operator">=&gt;</span> db_sequence_number<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>sequence_number_cache
            <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>txn<span class="token punctuation">.</span><span class="token function">sender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sequence_number<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//\u53EF\u80FDsequence_number\u9700\u8981\u66F4\u65B0\u4E86. \u5982\u679C\u53D1\u751F\u4E86expiration\u5462?</span>

        <span class="token comment">// don&#39;t accept old transactions (e.g. seq is less than account&#39;s current seq_number)</span>
        <span class="token keyword">if</span> txn<span class="token punctuation">.</span><span class="token function">sequence_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> sequence_number <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">MempoolAddTransactionStatus</span><span class="token punctuation">::</span><span class="token class-name">InvalidSeqNumber</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//\u4EA4\u6613\u5728\u7F13\u51B2\u6C60\u4E2D\u7684\u8FC7\u671F\u65F6\u95F4</span>
        <span class="token keyword">let</span> expiration_time <span class="token operator">=</span> <span class="token class-name">SystemTime</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">duration_since</span><span class="token punctuation">(</span><span class="token constant">UNIX_EPOCH</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;init timestamp failure&quot;</span><span class="token punctuation">)</span>
            <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>system_transaction_timeout<span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>metrics_cache<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span>txn<span class="token punctuation">.</span><span class="token function">sender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> txn<span class="token punctuation">.</span><span class="token function">sequence_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Utc</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timestamp_millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//MempoolTransaction\u6307\u7684\u5C31\u662F\u5728\u7F13\u51B2\u6C60\u4E2D\u7684Tx,\u4E3A\u4E86\u7F13\u51B2\u6C60\u7BA1\u7406\u65B9\u4FBF,\u589E\u6DFB\u4E86\u8FC7\u671F\u65F6\u95F4\u4EE5\u53CATimelineState,\u8FD8\u6709gasAmount,</span>
        <span class="token comment">//\u4E3B\u8981\u662F\u4E3A\u4E86\u7D22\u5F15</span>
        <span class="token keyword">let</span> txn_info <span class="token operator">=</span> <span class="token class-name">MempoolTransaction</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>txn<span class="token punctuation">,</span> expiration_time<span class="token punctuation">,</span> gas_amount<span class="token punctuation">,</span> timeline_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u771F\u6B63\u7684Tx,\u65E0\u8BBA\u80FD\u5426\u7ACB\u5373\u88AB\u6253\u5305,\u90FD\u5728TransactionStore\u4E2D\u4FDD\u5B58\u7740</span>
        <span class="token keyword">let</span> status <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>transactions<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>txn_info<span class="token punctuation">,</span> sequence_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">OP_COUNTERS</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;insert.{:?}&quot;</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        status
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h3 id="remove-transaction-\u79FB\u9664\u5DF2\u6253\u5305\u4EA4\u6613" tabindex="-1">remove_transaction \u79FB\u9664\u5DF2\u6253\u5305\u4EA4\u6613 <a class="header-anchor" href="#remove-transaction-\u79FB\u9664\u5DF2\u6253\u5305\u4EA4\u6613" aria-hidden="true">#</a></h3><div class="language-rust line-numbers-mode"><pre><code><span class="token comment">/// This function will be called once the transaction has been stored</span>
    <span class="token comment">/// \u5171\u8BC6\u6A21\u5757\u786E\u5B9ATx\u88AB\u6253\u5305\u4E86,\u90A3\u4E48\u7F13\u51B2\u6C60\u4E2D\u7684Tx\u5C31\u53EF\u4EE5\u79FB\u9664\u4E86. is_rejected\u8868\u793A\u6CA1\u6709\u88AB\u6253\u5305</span>
    <span class="token comment">/// \u540C\u65F6is_rejected\u4E3Afalse\u7684\u65F6\u5019,sequence_number\u4E5F\u544A\u8BC9mempool\u76EE\u524Dsender\u4E4B\u524D\u7684Tx\u90FD\u88AB\u6253\u5305\u4E86,</span>
    <span class="token comment">/// \u672C\u5730\u7684seqence_number\u4E5F\u8981\u66F4\u65B0\u5230\u8FD9\u91CC\u4E86</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">remove_transaction</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        sender<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">AccountAddress</span><span class="token punctuation">,</span>
        sequence_number<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
        is_rejected<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">debug!</span><span class="token punctuation">(</span>
            <span class="token string">&quot;[Mempool] Removing transaction from mempool: {}:{}&quot;</span><span class="token punctuation">,</span>
            sender<span class="token punctuation">,</span> sequence_number
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">log_latency</span><span class="token punctuation">(</span>sender<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sequence_number<span class="token punctuation">,</span> <span class="token string">&quot;e2e.latency&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>metrics_cache<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>sender<span class="token punctuation">,</span> sequence_number<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// update current cached sequence number for account</span>
        <span class="token keyword">let</span> cached_value <span class="token operator">=</span> <span class="token keyword">self</span>
            <span class="token punctuation">.</span>sequence_number_cache
            <span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>sender<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">unwrap_or_default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> new_sequence_number <span class="token operator">=</span> <span class="token keyword">if</span> is_rejected <span class="token punctuation">{</span>
            <span class="token function">min</span><span class="token punctuation">(</span>sequence_number<span class="token punctuation">,</span> cached_value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">max</span><span class="token punctuation">(</span>cached_value<span class="token punctuation">,</span> sequence_number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">//sequence_number_cache\u4FDD\u5B58\u7684\u5C31\u662F\u4E0B\u4E00\u4E2A\u6709\u6548\u7684seq_number</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>sequence_number_cache
            <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>sender<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> new_sequence_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u6838\u5FC3\u5904\u7406\u5176\u5B9E\u8FD8\u5728\`TransactionStore\`\u4E2D</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>transactions
            <span class="token punctuation">.</span><span class="token function">commit_transaction</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sender<span class="token punctuation">,</span> sequence_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="\u4E3Aconsensus\u6A21\u5757\u63D0\u4F9B\u4E0B\u4E00\u5757\u4EA4\u6613\u6570\u636E" tabindex="-1">\u4E3Aconsensus\u6A21\u5757\u63D0\u4F9B\u4E0B\u4E00\u5757\u4EA4\u6613\u6570\u636E <a class="header-anchor" href="#\u4E3Aconsensus\u6A21\u5757\u63D0\u4F9B\u4E0B\u4E00\u5757\u4EA4\u6613\u6570\u636E" aria-hidden="true">#</a></h3><p>get_block\u529F\u80FD\u975E\u5E38\u7B80\u5355,\u5C31\u662F\u8DF3\u51FA\u6765\u4E0B\u4E00\u5757\u53EF\u4EE5\u6253\u5305\u7684\u4EA4\u6613,\u4E3B\u8981\u5C31\u662Fseq_number\u8FDE\u8D77\u6765\u7684\u4EA4\u6613.\u56E0\u4E3A\u4E0D\u5408\u6CD5\u7684\u4EA4\u6613\u65E9\u5C31\u5DF2\u7ECF\u88AB\u8E22\u4E86.</p><div class="language-rust line-numbers-mode"><pre><code>    <span class="token comment">/// Fetches next block of transactions for consensus</span>
    <span class="token comment">/// \`batch_size\` - size of requested block</span>
    <span class="token comment">/// \`seen_txns\` - transactions that were sent to Consensus but were not committed yet</span>
    <span class="token comment">///  Mempool should filter out such transactions</span>
    <span class="token comment">/// \u5171\u8BC6\u6A21\u5757\u9700\u8981\u4ECEmempool\u4E2D\u62C9\u53D6\u4E0B\u4E00\u4E2A\u5757\u53EF\u7528\u7684Tx\u96C6\u5408</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_block</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        batch_size<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
        <span class="token keyword">mut</span> seen<span class="token punctuation">:</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token class-name">TxnPointer</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">SignedTransaction</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
           get_block \u5B9E\u9645\u4E0A\u662F\u627E\u5BFB\u53EF\u4EE5\u8FDB\u5165\u4E0B\u4E00\u5757\u7684\u4EA4\u6613:
           1. \u5DF2\u7ECF\u9001\u5230\u5171\u8BC6\u6A21\u5757\u4E2D,\u4F46\u662F\u8FD8\u6CA1\u6709\u786E\u8BA4(\u786E\u8BA4\u540E\u4F1A\u4ECE\u7F13\u51B2\u6C60\u4E2D\u79FB\u9664)
           2.  \u8FD9\u4E2ATx\u7684seq\u521A\u597D\u5C31\u662F\u4E0B\u4E00\u4E2A\u53EF\u4EE5\u6253\u5305\u7684.\u6BD4\u5982\u4E0A\u4E00\u5757\u4E2DAccountA\u7684seq\u662F3,\u90A3\u4E48\u73B0\u5728seq=4\u7684Tx\u5C31\u53EF\u4EE5\u8FDB\u5165block
           3. \u6216\u8005\u5F53\u524D\u5757\u4E2D\u5DF2\u7ECF\u5305\u542B\u4E86seq=4\u7684,\u90A3\u4E48seq=5\u7684\u5C31\u53EF\u4EE5\u8FDB\u5165
        */</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> result <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// Helper DS. Helps to mitigate scenarios where account submits several transactions</span>
        <span class="token comment">// with increasing gas price (e.g. user submits transactions with sequence number 1, 2</span>
        <span class="token comment">// and gas_price 1, 10 respectively)</span>
        <span class="token comment">// Later txn has higher gas price and will be observed first in priority index iterator,</span>
        <span class="token comment">// but can&#39;t be executed before first txn. Once observed, such txn will be saved in</span>
        <span class="token comment">// \`skipped\` DS and rechecked once it&#39;s ancestor becomes available</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> skipped <span class="token operator">=</span> <span class="token class-name">HashSet</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// iterate over the queue of transactions based on gas price</span>
        <span class="token comment">//\u5E26\u6807\u7B7E\u7684break\u7528\u6CD5</span>
        <span class="token lifetime-annotation symbol">&#39;main</span><span class="token punctuation">:</span> <span class="token keyword">for</span> txn <span class="token keyword">in</span> <span class="token keyword">self</span><span class="token punctuation">.</span>transactions<span class="token punctuation">.</span><span class="token function">iter_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> seen<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name">TxnPointer</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>txn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> seq <span class="token operator">=</span> txn<span class="token punctuation">.</span>sequence_number<span class="token punctuation">;</span>
            <span class="token comment">/*
            \u8FD9\u91CC\u6253\u5305\u662F\u6309\u7167\u5730\u5740\u9009,\u5C3D\u53EF\u80FD\u7684\u628A\u540C\u4E00\u4E2A\u5730\u5740\u7684Tx\u90FD\u6253\u5305\u5230\u4E00\u4E2Ablock\u4E2D\u53BB
            */</span>
            <span class="token keyword">let</span> account_sequence_number <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>sequence_number_cache<span class="token punctuation">.</span><span class="token function">get_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>txn<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> seen_previous <span class="token operator">=</span> seq <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> seen<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>txn<span class="token punctuation">.</span>address<span class="token punctuation">,</span> seq <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// include transaction if it&#39;s &quot;next&quot; for given account or</span>
            <span class="token comment">// we&#39;ve already sent its ancestor to Consensus</span>
            <span class="token keyword">if</span> seen_previous <span class="token operator">||</span> account_sequence_number <span class="token operator">==</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> seq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> ptr <span class="token operator">=</span> <span class="token class-name">TxnPointer</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                seen<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token operator">==</span> batch_size <span class="token punctuation">{</span>
                    <span class="token comment">//batch_size\u8868\u793A\u8FD9\u5757\u6700\u591A\u6709\u591A\u5C11\u4E2A\u4EA4\u6613</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// check if we can now include some transactions</span>
                <span class="token comment">// that were skipped before for given account</span>
                <span class="token comment">//\u8FD9\u662F\u56DE\u5934\u904D\u5386,\u6BD4\u5982\u5148\u8D70\u8FC7\u4E86seq=7\u7684,\u90A3\u4E48\u53D1\u73B0seq=6\u5408\u9002\u7684\u65F6\u5019,\u5C31\u8FD8\u53EF\u4EE5\u518D\u628Aseq=7\u52A0\u5165</span>
                <span class="token keyword">let</span> <span class="token keyword">mut</span> skipped_txn <span class="token operator">=</span> <span class="token punctuation">(</span>txn<span class="token punctuation">.</span>address<span class="token punctuation">,</span> seq <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> skipped<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>skipped_txn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    seen<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>skipped_txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>skipped_txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token operator">==</span> batch_size <span class="token punctuation">{</span>
                        <span class="token keyword">break</span> <span class="token lifetime-annotation symbol">&#39;main</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    skipped_txn <span class="token operator">=</span> <span class="token punctuation">(</span>txn<span class="token punctuation">.</span>address<span class="token punctuation">,</span> skipped_txn<span class="token number">.1</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                skipped<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token class-name">TxnPointer</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>txn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// convert transaction pointers to real values</span>
        <span class="token keyword">let</span> block<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> result
            <span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">//filter_map \u884C\u4E3A\u7B49\u4E8Efilter &amp; map</span>
            <span class="token punctuation">.</span><span class="token function">filter_map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> seq<span class="token punctuation">)</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">self</span><span class="token punctuation">.</span>transactions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> seq<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> transaction <span class="token keyword">in</span> <span class="token operator">&amp;</span>block <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">log_latency</span><span class="token punctuation">(</span>
                transaction<span class="token punctuation">.</span><span class="token function">sender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                transaction<span class="token punctuation">.</span><span class="token function">sequence_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;txn_pre_consensus_ms&quot;</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        block <span class="token comment">//\u5C31\u662F\u4E00\u4E2ATx\u7684\u96C6\u5408,\u6CA1\u6709\u4EFB\u4F55\u9644\u52A0\u4FE1\u606F</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><h3 id="\u5176\u4ED6\u51E0\u4E2A\u51FD\u6570" tabindex="-1">\u5176\u4ED6\u51E0\u4E2A\u51FD\u6570 <a class="header-anchor" href="#\u5176\u4ED6\u51E0\u4E2A\u51FD\u6570" aria-hidden="true">#</a></h3><p><code>gc_by_system_ttl</code>: \u5C31\u662F\u4E3A\u4E86\u6E05\u9664\u5728mempool\u4E2D\u5446\u7684\u592A\u4E45\u7684\u4EA4\u6613,\u5426\u5219mempool\u56E0\u4E3A\u7A7A\u95F4\u5DF2\u6EE1\u800C\u65E0\u6CD5\u8FDB\u6765\u6709\u6548\u7684\u4EA4\u6613 <code>gc_by_expiration_time</code>: \u662F\u5728\u65B0\u7684\u4E00\u5757\u6765\u4E34\u7684\u65F6\u5019,\u4F9D\u636E\u65B0\u5757\u65F6\u95F4\u53EF\u4EE5\u975E\u5E38\u786E\u5B9A<strong>\u90A3\u4E9B\u7528\u6237\u6307\u5B9A\u7684\u5728\u8FD9\u4E2A\u4E4B\u524D\u5FC5\u987B\u6253\u5305\u7684\u4EA4\u6613</strong>\u5FC5\u987B\u88AB\u6E05\u7406\u6389,\u56E0\u4E3A\u518D\u4E5F\u4E0D\u53EF\u80FD\u88AB\u6253\u5305\u4E86. <code>read_timeline</code>: \u4E3B\u8981\u7528\u4E8E\u8282\u70B9\u95F4mempool\u4E2D\u7684Tx\u540C\u6B65\u7528,\u5C31\u662F\u4E3A\u6BCF\u4E00\u4E2ATx\u90FD\u7ED9\u4E00\u4E2A\u672C\u5730\u552F\u4E00\u7684\u5355\u589E\u7684\u7F16\u53F7,\u8FD9\u6837\u63A8\u9001\u7684\u65F6\u5019\u5C31\u77E5\u9053\u63A8\u9001\u5230\u54EA\u91CC\u4E86,\u907F\u514D\u91CD\u590D.</p><p>\u4E0B\u4E00\u7BC7\u6211\u4F1A\u8BB2\u89E3<code>TransactionStore</code>,\u4ED6\u662F\u7EF4\u62A4mempool\u4E2DTx\u7684\u6838\u5FC3\u6570\u636E\u7ED3\u6784.</p>`,23),o=[t];function c(l,u,i,r,k,m){return a(),s("div",null,o)}var _=n(e,[["render",c]]);export{d as __pageData,_ as default};
