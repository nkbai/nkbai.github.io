import{_ as s,c as n,o as a,N as l}from"./chunks/framework.3a9190c5.js";const C=JSON.parse('{"title":"mruMap","description":"","frontmatter":{"title":"mruMap","date":"2018-11-21T06:21:40.000Z","draft":false,"markup":"mmark"},"headers":[],"relativePath":"blockchain/btcd/mruMap.md"}'),p={name:"blockchain/btcd/mruMap.md"},e=l(`<h1 id="比特币中mrumap的实现" tabindex="-1">比特币中mruMap的实现 <a class="header-anchor" href="#比特币中mrumap的实现" aria-label="Permalink to &quot;比特币中mruMap的实现&quot;">​</a></h1><p>特性</p><ul><li>带锁,并发访问</li><li>数量有上限</li><li>自动移除最不常用</li></ul><p>主要接口说明:</p><ol><li>Exists 判断某个元素是否存在</li><li>Add 起到添加和标记使用的双重作用</li><li>Delete主动删除</li></ol><p>性能说明: 增删改查都是O(1)</p><ul><li>查用的是Map,接近O(1),</li><li>增删更新,都是用的双向链表List</li></ul><p>其他问题: 要求存储的元素必须能够作为map的key</p><p>参考实现</p><div class="language-go line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// mruNonceMap provides a concurrency safe map that is limited to a maximum</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// number of items with eviction for the oldest entry when the limit is</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// exceeded.</span></span>
<span class="line"><span style="color:#89DDFF;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">mruNonceMap</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	mtx       sync</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Mutex</span></span>
<span class="line"><span style="color:#A6ACCD;">	nonceMap  </span><span style="color:#89DDFF;">map[</span><span style="color:#C792EA;">uint64</span><span style="color:#89DDFF;">]*</span><span style="color:#A6ACCD;">list</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Element </span><span style="color:#676E95;font-style:italic;">// nearly O(1) lookups</span></span>
<span class="line"><span style="color:#A6ACCD;">	nonceList </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">list</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">List               </span><span style="color:#676E95;font-style:italic;">// O(1) insert, update, delete</span></span>
<span class="line"><span style="color:#A6ACCD;">	limit     </span><span style="color:#C792EA;">uint</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// Exists returns whether or not the passed nonce is in the map.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// This function is safe for concurrent access.</span></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">m </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">mruNonceMap</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Exists</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">nonce </span><span style="color:#C792EA;">uint64</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">bool</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">mtx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Lock</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">	_</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> exists </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">nonceMap</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">nonce</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">	m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">mtx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Unlock</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> exists</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// Add adds the passed nonce to the map and handles eviction of the oldest item</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// if adding the new item would exceed the max limit.  Adding an existing item</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// makes it the most recently used item.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// This function is safe for concurrent access.</span></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">m </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">mruNonceMap</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Add</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">nonce </span><span style="color:#C792EA;">uint64</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">mtx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Lock</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">defer</span><span style="color:#A6ACCD;"> m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">mtx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Unlock</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// When the limit is zero, nothing can be added to the map, so just</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// return.</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">limit </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;font-style:italic;">return</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// When the entry already exists move it to the front of the list</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// thereby marking it most recently used.</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> exists </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">nonceMap</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">nonce</span><span style="color:#89DDFF;">];</span><span style="color:#A6ACCD;"> exists </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">nonceList</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">MoveToFront</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;font-style:italic;">return</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// Evict the least recently used entry (back of the list) if the the new</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// entry would exceed the size limit for the map.  Also reuse the list</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// node so a new one doesn&#39;t have to be allocated.</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">uint</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">nonceMap</span><span style="color:#89DDFF;">))+</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">limit </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		node </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">nonceList</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Back</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">		lru </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Value</span><span style="color:#89DDFF;">.(</span><span style="color:#C792EA;">uint64</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#676E95;font-style:italic;">// Evict least recently used item.</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#82AAFF;">delete</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">nonceMap</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> lru</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#676E95;font-style:italic;">// Reuse the list node of the item that was just evicted for the</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#676E95;font-style:italic;">// new item.</span></span>
<span class="line"><span style="color:#A6ACCD;">		node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Value </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> nonce</span></span>
<span class="line"><span style="color:#A6ACCD;">		m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">nonceList</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">MoveToFront</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">		m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">nonceMap</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">nonce</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> node</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;font-style:italic;">return</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// The limit hasn&#39;t been reached yet, so just add the new item.</span></span>
<span class="line"><span style="color:#A6ACCD;">	node </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">nonceList</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">PushFront</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">nonce</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">nonceMap</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">nonce</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> node</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// Delete deletes the passed nonce from the map (if it exists).</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// This function is safe for concurrent access.</span></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">m </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">mruNonceMap</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Delete</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">nonce </span><span style="color:#C792EA;">uint64</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">mtx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Lock</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> exists </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">nonceMap</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">nonce</span><span style="color:#89DDFF;">];</span><span style="color:#A6ACCD;"> exists </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">nonceList</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Remove</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#82AAFF;">delete</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">nonceMap</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> nonce</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">mtx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Unlock</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// newMruNonceMap returns a new nonce map that is limited to the number of</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// entries specified by limit.  When the number of entries exceeds the limit,</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// the oldest (least recently used) entry will be removed to make room for the</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// new entry.</span></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">newMruNonceMap</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">limit </span><span style="color:#C792EA;">uint</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">mruNonceMap </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	m </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> mruNonceMap</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		nonceMap</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#82AAFF;">make</span><span style="color:#89DDFF;">(map[</span><span style="color:#C792EA;">uint64</span><span style="color:#89DDFF;">]*</span><span style="color:#A6ACCD;">list</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Element</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">		nonceList</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> list</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">New</span><span style="color:#89DDFF;">(),</span></span>
<span class="line"><span style="color:#A6ACCD;">		limit</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">     limit</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">m</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br></div></div>`,10),o=[e];function t(c,r,D,i,y,A){return a(),n("div",null,o)}const m=s(p,[["render",t]]);export{C as __pageData,m as default};
