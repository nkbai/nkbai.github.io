<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Rust异步编程中我们应该用那种锁? | Steven's Blog</title>
    <meta name="description" content="steven's Blog">
    <link rel="stylesheet" href="/assets/style.f12b8a37.css">
    <link rel="modulepreload" href="/assets/Home.3d0dc14e.js">
    <link rel="modulepreload" href="/assets/vssue.1b5f3e65.js">
    <link rel="modulepreload" href="/assets/viewer.6bf00c48.js">
    <link rel="modulepreload" href="/assets/echarts.b33419de.js">
    <link rel="modulepreload" href="/assets/flowchart.31c8d424.js">
    <link rel="modulepreload" href="/assets/mermaid.409d2902.js">
    <link rel="modulepreload" href="/assets/runner.7dc2dd49.js">
    <link rel="modulepreload" href="/assets/app.63f3ffeb.js">
    <link rel="modulepreload" href="/assets/rust_rust_async_lock.md.6353ad9f.lean.js">
    <link rel="modulepreload" href="/assets/app.63f3ffeb.js">
    <link rel="icon" href="/logo.png">
    <meta name="twitter:title" content="Rust异步编程中我们应该用那种锁? | Steven&#39;s Blog">
    <meta property="og:title" content="Rust异步编程中我们应该用那种锁? | Steven&#39;s Blog">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="Steven&#39;s Blog, back to home" data-v-675d8756 data-v-4a583abe><img class="logo" src="/logo.png" alt="Logo" data-v-4a583abe> Steven&#39;s Blog</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-15acbf05><!--[--><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/about.html" data-v-b8818f8c>about <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/blockchain/" data-v-b8818f8c>block chain <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/rust-leetcode/" data-v-b8818f8c>leetcode <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/other/" data-v-b8818f8c>other <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item active" href="/rust/" data-v-b8818f8c>rust <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/static_analysis/" data-v-b8818f8c>静态分析 <!----></a></div></div><!--]--><!----><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item isExternal" href="https://github.com/nkbai/Blog" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-15acbf05><!--[--><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/about.html" data-v-b8818f8c>about <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/blockchain/" data-v-b8818f8c>block chain <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/rust-leetcode/" data-v-b8818f8c>leetcode <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/other/" data-v-b8818f8c>other <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item active" href="/rust/" data-v-b8818f8c>rust <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/static_analysis/" data-v-b8818f8c>静态分析 <!----></a></div></div><!--]--><!----><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item isExternal" href="https://github.com/nkbai/Blog" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/Futures_Explained_in_200_lines_of_Rust.html">200行代码讲透Rust Futures</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/Futures_Explained_in_200_lines_of_Rust_with_error_version.html">200行代码讲透Rust Futures-有bug版本</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/Futures_Explained_in_200_lines_of_Rust2.html">200行代码讲透Rust Futures的问题</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/ownership101.html">Ownership 101</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/convert_an_integer_to_an_enum.html">Rust中enum和整数的互相转换</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item active" href="/rust/rust_async_lock.html">Rust异步编程中我们应该用那种锁?</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#两种锁的异同">两种锁的异同</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#两种锁的选用">两种锁的选用</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#tokio中关于异步锁的解释">tokio中关于异步锁的解释</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#标准库中锁的代价高么">标准库中锁的代价高么?</a><!----></li></ul></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/lock-freedom-without-garbage-collection.html">Rust无锁编程</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/my_note.html">rust学习笔记</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rust开发工具.html">rust开发工具 clion</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/tokio_async_await 初探.html">tokio async&amp;await 初探</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/tokio笔记.html">tokio笔记.md</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/build_your_own_block_on.html">从头实现Rust异步block_on</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/build_your_own_executor.html">从头实现Rust异步执行器</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/">从零实现消息中间件</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/ppt/">rnats ppt</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/ppt/从零实现消息中间件-client.html">从零实现消息中间件-client</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/ppt/从零实现消息中间件-server.html">从零实现消息中间件-server</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/ppt/从零实现消息中间件-server.client.html">从零实现消息中间件-server.client</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/1.start.html">从零实现消息中间件</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/6.client.html">从零实现消息中间件-client</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/2.parser.html">从零实现消息中间件-parser</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/4.server.html">从零实现消息中间件-server</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/5.server.client.html">从零实现消息中间件-server.client</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/3.sublist.html">从零实现消息中间件-sublist</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/交叉编译rust.html">在ubuntu 18.04上交叉编译rust 程序</a><!----></li><!--]--></ul><!--[--><!--]--></aside><!-- TODO: make this button accessible --><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><p>在rust异步编程中,我们有两种锁可以选择,一种是标准库里提供的锁(<code>std::sync::Mutex</code>),下称标准锁; 另一种可以是异步库提供的锁,比如<code>async_std::sync::Mutex</code>,简称异步锁, 那么两种锁有何异同,我们该如何选择呢? 本文将会给出答案.</p><p>按照我的习惯,先说结论:</p><ol><li>如果标准锁满足要求,尽量使用标准锁</li><li>标准锁不能用时,再用异步锁</li></ol><h2 id="两种锁的异同"><a class="header-anchor" href="#两种锁的异同" aria-hidden="true">#</a> 两种锁的异同</h2><p>相同点:</p><ul><li>都能起到同步互斥的效果</li></ul><p>不同点:</p><ul><li>标准锁不能跨await</li><li>异步锁可以跨await</li></ul><p>如果你的代码中需要跨await持有锁,那么你就只能用异步库锁. 比如下面这种情况:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">struct</span> <span class="token type-definition class-name">SomeSharedStructure</span> <span class="token punctuation">{</span>
    v<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> <span class="token class-name">SomeSharedStructure</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">do1</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">test_mutex_guard_await</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">SomeSharedStructure</span> <span class="token punctuation">{</span> v<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">async_std<span class="token punctuation">::</span>task<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        s<span class="token punctuation">.</span><span class="token function">do1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">test_mutex_guard_cannot_compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">SomeSharedStructure</span> <span class="token punctuation">{</span> v<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// let s2=s.clone();</span>
    <span class="token namespace">async_std<span class="token punctuation">::</span>task<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        s<span class="token punctuation">.</span><span class="token function">do1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>test_mutex_guard_cannot_compile 无法编译通过,因为<code>future cannot be sent between threads safely</code> ,准确来说就是<code>std::sync::MutexGuard</code>不能在线程之间共享. 这个其实很容易理解,Mutex就是为了解决线程同步问题的,已经解锁的数据如果可以在线程之间传递,那么Rust保证的线程安全岂不成了笑话.</p><p>而<code>async_std::sync::MutexGuard</code>却是可以在线程之间传递的,具体可以看async-mutex这个crate的代码:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token comment">/// A guard that releases the mutex when dropped.</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">MutexGuard</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token class-name">Sized</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">unsafe</span> <span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token operator">?</span><span class="token class-name">Sized</span><span class="token operator">&gt;</span> <span class="token class-name">Send</span> <span class="token keyword">for</span> <span class="token class-name">MutexGuard</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;_</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">unsafe</span> <span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Sync</span> <span class="token operator">+</span> <span class="token operator">?</span><span class="token class-name">Sized</span><span class="token operator">&gt;</span> <span class="token class-name">Sync</span> <span class="token keyword">for</span> <span class="token class-name">MutexGuard</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;_</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>至于<code>async_std::sync::MutexGuard</code>是如何保证既可以在线程之间传递,还能保证线程安全,我会在其他文章中专门解释.</p><h2 id="两种锁的选用"><a class="header-anchor" href="#两种锁的选用" aria-hidden="true">#</a> 两种锁的选用</h2><p>那么问题来了,这两种锁我们适合在什么场景下使用呢?</p><ol><li>如果需要跨await,只能用异步锁</li><li>其他情况,两种锁随便用哪个都可以?</li></ol><h3 id="tokio中关于异步锁的解释"><a class="header-anchor" href="#tokio中关于异步锁的解释" aria-hidden="true">#</a> tokio中关于异步锁的解释</h3><p>可以先看看<a href="https://tokio-rs.github.io/tokio/doc/tokio/sync/struct.Mutex.html" target="_blank" rel="noopener noreferrer">tokio关于异步锁的解释</a>.</p><div class="language-"><pre><code>Which kind of mutex should you use?
Contrary to popular belief, it is ok and often preferred to use the ordinary Mutex from the standard library in asynchronous code. This section will help you decide on which kind of mutex you should use.
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>简单来说就是,如果可以用标准锁就用标准锁. 那么为什么呢?</p><h3 id="标准库中锁的代价高么"><a class="header-anchor" href="#标准库中锁的代价高么" aria-hidden="true">#</a> 标准库中锁的代价高么?</h3><p>在没认真阅读代码之前,我以为异步锁的代价要低一些,因为他们是基于atomic的,加锁不会触发系统调用,而标准锁会触发系统调用,代价昂贵. 但是真的是这样的么? 让我们来跟一下标准锁的实现.</p><h4 id="_1-lock"><a class="header-anchor" href="#_1-lock" aria-hidden="true">#</a> 1. lock</h4><div class="language-rust line-numbers-mode"><pre><code>    <span class="token attribute attr-name">#[stable(feature = <span class="token string">&quot;rust1&quot;</span>, since = <span class="token string">&quot;1.0.0&quot;</span>)]</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">LockResult</span><span class="token operator">&lt;</span><span class="token class-name">MutexGuard</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;_</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token function">raw_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">MutexGuard</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>标准锁执行的是inner的raw_lock</p><h4 id="_2-raw-lock"><a class="header-anchor" href="#_2-raw-lock" aria-hidden="true">#</a> 2. raw_lock</h4><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">MovableMutex</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token namespace">imp<span class="token punctuation">::</span></span><span class="token class-name">Mutex</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/// Locks the mutex blocking the current thread until it is available.</span>
    <span class="token attribute attr-name">#[inline]</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">raw_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>self.0实际上是imp::Mutex,跟下去就是标准库代码中的:<code>src/sys/unix/mutex.rs</code></p><h4 id="_3-平台相关的lock"><a class="header-anchor" href="#_3-平台相关的lock" aria-hidden="true">#</a> 3. 平台相关的lock</h4><p>这里以linux平台上的实现为例,来跟踪:</p><div class="language-rust line-numbers-mode"><pre><code>    <span class="token attribute attr-name">#[inline]</span>
    <span class="token keyword">pub</span> <span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function-definition function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> r <span class="token operator">=</span> <span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">debug_assert_eq!</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>可以看到最终调用的是libc::pthread_mutex_lock.</p><h4 id="_4-glibc中的pthread-mutex-lock"><a class="header-anchor" href="#_4-glibc中的pthread-mutex-lock" aria-hidden="true">#</a> 4. glibc中的pthread_mutex_lock</h4><p>这里以我手头的glibc 2.23代码为例来进行跟踪. x86平台下的pthread_mutex_lock.c实际上用得是:<code>#include &quot;nptl/pthread_mutex_lock.c&quot;</code></p><div class="language-c line-numbers-mode"><pre><code>nt
<span class="token function">__pthread_mutex_lock</span> <span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>mutex<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span> <span class="token punctuation">(</span>mutex<span class="token operator">-&gt;</span>__size<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> type <span class="token operator">=</span> <span class="token function">PTHREAD_MUTEX_TYPE_ELISION</span> <span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">LIBC_PROBE</span> <span class="token punctuation">(</span>mutex_entry<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>type <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>PTHREAD_MUTEX_KIND_MASK_NP
				 <span class="token operator">|</span> PTHREAD_MUTEX_ELISION_FLAGS_NP<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">__pthread_mutex_lock_full</span> <span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token function">LIBC_PROBE</span> <span class="token punctuation">(</span>mutex_acquired<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>这里我们看最简单的情况,没有其他人持有锁,直接就得到锁的情况,简单读一下就可以看到,它实现用得也是atomic的CAS,也就是说根本没有什么系统调用. 显然相比async_std/tokio中的代码,libc中的代码更加久经考验,也更清楚各个平台的优势和缺点.</p><p>具体的代码太长了,我就附在下面,感兴趣的自行阅读就行了.</p><p>真的是**<code>Talk is cheap. Show me the code</code>**, 作为码农还是尽量少去猜,多去看代码才是关键.</p><div class="language-c line-numbers-mode"><pre><code><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">__pthread_mutex_lock_full</span> <span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>mutex<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> oldval<span class="token punctuation">;</span>
  <span class="token class-name">pid_t</span> id <span class="token operator">=</span> <span class="token function">THREAD_GETMEM</span> <span class="token punctuation">(</span>THREAD_SELF<span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">PTHREAD_MUTEX_TYPE</span> <span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token keyword">case</span> PTHREAD_MUTEX_ROBUST_RECURSIVE_NP<span class="token operator">:</span>
    <span class="token keyword">case</span> PTHREAD_MUTEX_ROBUST_ERRORCHECK_NP<span class="token operator">:</span>
    <span class="token keyword">case</span> PTHREAD_MUTEX_ROBUST_NORMAL_NP<span class="token operator">:</span>
    <span class="token keyword">case</span> PTHREAD_MUTEX_ROBUST_ADAPTIVE_NP<span class="token operator">:</span>
      <span class="token function">THREAD_SETMEM</span> <span class="token punctuation">(</span>THREAD_SELF<span class="token punctuation">,</span> robust_head<span class="token punctuation">.</span>list_op_pending<span class="token punctuation">,</span>
		     <span class="token operator">&amp;</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__list<span class="token punctuation">.</span>__next<span class="token punctuation">)</span><span class="token punctuation">;</span>

      oldval <span class="token operator">=</span> mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__lock<span class="token punctuation">;</span>
      <span class="token keyword">do</span>
	<span class="token punctuation">{</span>
	again<span class="token operator">:</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>oldval <span class="token operator">&amp;</span> FUTEX_OWNER_DIED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	    <span class="token punctuation">{</span>
	      <span class="token comment">/* The previous owner died.  Try locking the mutex.  */</span>
	      <span class="token keyword">int</span> newval <span class="token operator">=</span> id<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">NO_INCR</span></span>
	      newval <span class="token operator">|=</span> FUTEX_WAITERS<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
	      newval <span class="token operator">|=</span> <span class="token punctuation">(</span>oldval <span class="token operator">&amp;</span> FUTEX_WAITERS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	      newval
		<span class="token operator">=</span> <span class="token function">atomic_compare_and_exchange_val_acq</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__lock<span class="token punctuation">,</span>
						       newval<span class="token punctuation">,</span> oldval<span class="token punctuation">)</span><span class="token punctuation">;</span>

	      <span class="token keyword">if</span> <span class="token punctuation">(</span>newval <span class="token operator">!=</span> oldval<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
		  oldval <span class="token operator">=</span> newval<span class="token punctuation">;</span>
		  <span class="token keyword">goto</span> again<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	      <span class="token comment">/* We got the mutex.  */</span>
	      mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	      <span class="token comment">/* But it is inconsistent unless marked otherwise.  */</span>
	      mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__owner <span class="token operator">=</span> PTHREAD_MUTEX_INCONSISTENT<span class="token punctuation">;</span>

	      <span class="token function">ENQUEUE_MUTEX</span> <span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	      <span class="token function">THREAD_SETMEM</span> <span class="token punctuation">(</span>THREAD_SELF<span class="token punctuation">,</span> robust_head<span class="token punctuation">.</span>list_op_pending<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	      <span class="token comment">/* Note that we deliberately exit here.  If we fall
		 through to the end of the function __nusers would be
		 incremented which is not correct because the old
		 owner has to be discounted.  If we are not supposed
		 to increment __nusers we actually have to decrement
		 it here.  */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">NO_INCR</span></span>
	      <span class="token operator">--</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__nusers<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	      <span class="token keyword">return</span> EOWNERDEAD<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>

	  <span class="token comment">/* Check whether we already hold the mutex.  */</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>oldval <span class="token operator">&amp;</span> FUTEX_TID_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span>
	    <span class="token punctuation">{</span>
	      <span class="token keyword">int</span> kind <span class="token operator">=</span> <span class="token function">PTHREAD_MUTEX_TYPE</span> <span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	      <span class="token keyword">if</span> <span class="token punctuation">(</span>kind <span class="token operator">==</span> PTHREAD_MUTEX_ROBUST_ERRORCHECK_NP<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
		  <span class="token function">THREAD_SETMEM</span> <span class="token punctuation">(</span>THREAD_SELF<span class="token punctuation">,</span> robust_head<span class="token punctuation">.</span>list_op_pending<span class="token punctuation">,</span>
				 <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		  <span class="token keyword">return</span> EDEADLK<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	      <span class="token keyword">if</span> <span class="token punctuation">(</span>kind <span class="token operator">==</span> PTHREAD_MUTEX_ROBUST_RECURSIVE_NP<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
		  <span class="token function">THREAD_SETMEM</span> <span class="token punctuation">(</span>THREAD_SELF<span class="token punctuation">,</span> robust_head<span class="token punctuation">.</span>list_op_pending<span class="token punctuation">,</span>
				 <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		  <span class="token comment">/* Just bump the counter.  */</span>
		  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__count <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		    <span class="token comment">/* Overflow of the counter.  */</span>
		    <span class="token keyword">return</span> EAGAIN<span class="token punctuation">;</span>

		  <span class="token operator">++</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__count<span class="token punctuation">;</span>

		  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	    <span class="token punctuation">}</span>

	  oldval <span class="token operator">=</span> <span class="token function">LLL_ROBUST_MUTEX_LOCK</span> <span class="token punctuation">(</span>mutex<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

	  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__owner
				<span class="token operator">==</span> PTHREAD_MUTEX_NOTRECOVERABLE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	    <span class="token punctuation">{</span>
	      <span class="token comment">/* This mutex is now not recoverable.  */</span>
	      mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	      <span class="token function">lll_unlock</span> <span class="token punctuation">(</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__lock<span class="token punctuation">,</span>
			  <span class="token function">PTHREAD_ROBUST_MUTEX_PSHARED</span> <span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	      <span class="token function">THREAD_SETMEM</span> <span class="token punctuation">(</span>THREAD_SELF<span class="token punctuation">,</span> robust_head<span class="token punctuation">.</span>list_op_pending<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	      <span class="token keyword">return</span> ENOTRECOVERABLE<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>oldval <span class="token operator">&amp;</span> FUTEX_OWNER_DIED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token function">ENQUEUE_MUTEX</span> <span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">THREAD_SETMEM</span> <span class="token punctuation">(</span>THREAD_SELF<span class="token punctuation">,</span> robust_head<span class="token punctuation">.</span>list_op_pending<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token comment">/* The PI support requires the Linux futex system call.  If that&#39;s not
       available, pthread_mutex_init should never have allowed the type to
       be set.  So it will get the default case for an invalid type.  */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__NR_futex</span></span>
    <span class="token keyword">case</span> PTHREAD_MUTEX_PI_RECURSIVE_NP<span class="token operator">:</span>
    <span class="token keyword">case</span> PTHREAD_MUTEX_PI_ERRORCHECK_NP<span class="token operator">:</span>
    <span class="token keyword">case</span> PTHREAD_MUTEX_PI_NORMAL_NP<span class="token operator">:</span>
    <span class="token keyword">case</span> PTHREAD_MUTEX_PI_ADAPTIVE_NP<span class="token operator">:</span>
    <span class="token keyword">case</span> PTHREAD_MUTEX_PI_ROBUST_RECURSIVE_NP<span class="token operator">:</span>
    <span class="token keyword">case</span> PTHREAD_MUTEX_PI_ROBUST_ERRORCHECK_NP<span class="token operator">:</span>
    <span class="token keyword">case</span> PTHREAD_MUTEX_PI_ROBUST_NORMAL_NP<span class="token operator">:</span>
    <span class="token keyword">case</span> PTHREAD_MUTEX_PI_ROBUST_ADAPTIVE_NP<span class="token operator">:</span>
      <span class="token punctuation">{</span>
	<span class="token keyword">int</span> kind <span class="token operator">=</span> mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__kind <span class="token operator">&amp;</span> PTHREAD_MUTEX_KIND_MASK_NP<span class="token punctuation">;</span>
	<span class="token keyword">int</span> robust <span class="token operator">=</span> mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__kind <span class="token operator">&amp;</span> PTHREAD_MUTEX_ROBUST_NORMAL_NP<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>robust<span class="token punctuation">)</span>
	  <span class="token comment">/* Note: robust PI futexes are signaled by setting bit 0.  */</span>
	  <span class="token function">THREAD_SETMEM</span> <span class="token punctuation">(</span>THREAD_SELF<span class="token punctuation">,</span> robust_head<span class="token punctuation">.</span>list_op_pending<span class="token punctuation">,</span>
			 <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__list<span class="token punctuation">.</span>__next<span class="token punctuation">)</span>
				   <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	oldval <span class="token operator">=</span> mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__lock<span class="token punctuation">;</span>

	<span class="token comment">/* Check whether we already hold the mutex.  */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>oldval <span class="token operator">&amp;</span> FUTEX_TID_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span>
	  <span class="token punctuation">{</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>kind <span class="token operator">==</span> PTHREAD_MUTEX_ERRORCHECK_NP<span class="token punctuation">)</span>
	      <span class="token punctuation">{</span>
		<span class="token function">THREAD_SETMEM</span> <span class="token punctuation">(</span>THREAD_SELF<span class="token punctuation">,</span> robust_head<span class="token punctuation">.</span>list_op_pending<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> EDEADLK<span class="token punctuation">;</span>
	      <span class="token punctuation">}</span>

	    <span class="token keyword">if</span> <span class="token punctuation">(</span>kind <span class="token operator">==</span> PTHREAD_MUTEX_RECURSIVE_NP<span class="token punctuation">)</span>
	      <span class="token punctuation">{</span>
		<span class="token function">THREAD_SETMEM</span> <span class="token punctuation">(</span>THREAD_SELF<span class="token punctuation">,</span> robust_head<span class="token punctuation">.</span>list_op_pending<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">/* Just bump the counter.  */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__count <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		  <span class="token comment">/* Overflow of the counter.  */</span>
		  <span class="token keyword">return</span> EAGAIN<span class="token punctuation">;</span>

		<span class="token operator">++</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__count<span class="token punctuation">;</span>

		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	      <span class="token punctuation">}</span>
	  <span class="token punctuation">}</span>

	<span class="token keyword">int</span> newval <span class="token operator">=</span> id<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">ifdef</span> <span class="token expression">NO_INCR</span></span>
	newval <span class="token operator">|=</span> FUTEX_WAITERS<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">endif</span></span>
	oldval <span class="token operator">=</span> <span class="token function">atomic_compare_and_exchange_val_acq</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__lock<span class="token punctuation">,</span>
						      newval<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>oldval <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	  <span class="token punctuation">{</span>
	    <span class="token comment">/* The mutex is locked.  The kernel will now take care of
	       everything.  */</span>
	    <span class="token keyword">int</span> private <span class="token operator">=</span> <span class="token punctuation">(</span>robust
			   <span class="token operator">?</span> <span class="token function">PTHREAD_ROBUST_MUTEX_PSHARED</span> <span class="token punctuation">(</span>mutex<span class="token punctuation">)</span>
			   <span class="token operator">:</span> <span class="token function">PTHREAD_MUTEX_PSHARED</span> <span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token function">INTERNAL_SYSCALL_DECL</span> <span class="token punctuation">(</span>__err<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">int</span> e <span class="token operator">=</span> <span class="token function">INTERNAL_SYSCALL</span> <span class="token punctuation">(</span>futex<span class="token punctuation">,</span> __err<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__lock<span class="token punctuation">,</span>
				      <span class="token function">__lll_private_flag</span> <span class="token punctuation">(</span>FUTEX_LOCK_PI<span class="token punctuation">,</span>
							  private<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">INTERNAL_SYSCALL_ERROR_P</span> <span class="token punctuation">(</span>e<span class="token punctuation">,</span> __err<span class="token punctuation">)</span>
		<span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">INTERNAL_SYSCALL_ERRNO</span> <span class="token punctuation">(</span>e<span class="token punctuation">,</span> __err<span class="token punctuation">)</span> <span class="token operator">==</span> ESRCH
		    <span class="token operator">||</span> <span class="token function">INTERNAL_SYSCALL_ERRNO</span> <span class="token punctuation">(</span>e<span class="token punctuation">,</span> __err<span class="token punctuation">)</span> <span class="token operator">==</span> EDEADLK<span class="token punctuation">)</span><span class="token punctuation">)</span>
	      <span class="token punctuation">{</span>
		<span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">INTERNAL_SYSCALL_ERRNO</span> <span class="token punctuation">(</span>e<span class="token punctuation">,</span> __err<span class="token punctuation">)</span> <span class="token operator">!=</span> EDEADLK
			<span class="token operator">||</span> <span class="token punctuation">(</span>kind <span class="token operator">!=</span> PTHREAD_MUTEX_ERRORCHECK_NP
			    <span class="token operator">&amp;&amp;</span> kind <span class="token operator">!=</span> PTHREAD_MUTEX_RECURSIVE_NP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">/* ESRCH can happen only for non-robust PI mutexes where
		   the owner of the lock died.  */</span>
		<span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">INTERNAL_SYSCALL_ERRNO</span> <span class="token punctuation">(</span>e<span class="token punctuation">,</span> __err<span class="token punctuation">)</span> <span class="token operator">!=</span> ESRCH <span class="token operator">||</span> <span class="token operator">!</span>robust<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">/* Delay the thread indefinitely.  */</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		  <span class="token function">pause_not_cancel</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	      <span class="token punctuation">}</span>

	    oldval <span class="token operator">=</span> mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__lock<span class="token punctuation">;</span>

	    <span class="token function">assert</span> <span class="token punctuation">(</span>robust <span class="token operator">||</span> <span class="token punctuation">(</span>oldval <span class="token operator">&amp;</span> FUTEX_OWNER_DIED<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>oldval <span class="token operator">&amp;</span> FUTEX_OWNER_DIED<span class="token punctuation">)</span><span class="token punctuation">)</span>
	  <span class="token punctuation">{</span>
	    <span class="token function">atomic_and</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__lock<span class="token punctuation">,</span> <span class="token operator">~</span>FUTEX_OWNER_DIED<span class="token punctuation">)</span><span class="token punctuation">;</span>

	    <span class="token comment">/* We got the mutex.  */</span>
	    mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	    <span class="token comment">/* But it is inconsistent unless marked otherwise.  */</span>
	    mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__owner <span class="token operator">=</span> PTHREAD_MUTEX_INCONSISTENT<span class="token punctuation">;</span>

	    <span class="token function">ENQUEUE_MUTEX_PI</span> <span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token function">THREAD_SETMEM</span> <span class="token punctuation">(</span>THREAD_SELF<span class="token punctuation">,</span> robust_head<span class="token punctuation">.</span>list_op_pending<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	    <span class="token comment">/* Note that we deliberately exit here.  If we fall
	       through to the end of the function __nusers would be
	       incremented which is not correct because the old owner
	       has to be discounted.  If we are not supposed to
	       increment __nusers we actually have to decrement it here.  */</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">ifdef</span> <span class="token expression">NO_INCR</span></span>
	    <span class="token operator">--</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__nusers<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">endif</span></span>

	    <span class="token keyword">return</span> EOWNERDEAD<span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>robust
	    <span class="token operator">&amp;&amp;</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__owner
				 <span class="token operator">==</span> PTHREAD_MUTEX_NOTRECOVERABLE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	  <span class="token punctuation">{</span>
	    <span class="token comment">/* This mutex is now not recoverable.  */</span>
	    mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	    <span class="token function">INTERNAL_SYSCALL_DECL</span> <span class="token punctuation">(</span>__err<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token function">INTERNAL_SYSCALL</span> <span class="token punctuation">(</span>futex<span class="token punctuation">,</span> __err<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__lock<span class="token punctuation">,</span>
			      <span class="token function">__lll_private_flag</span> <span class="token punctuation">(</span>FUTEX_UNLOCK_PI<span class="token punctuation">,</span>
						  <span class="token function">PTHREAD_ROBUST_MUTEX_PSHARED</span> <span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	    <span class="token function">THREAD_SETMEM</span> <span class="token punctuation">(</span>THREAD_SELF<span class="token punctuation">,</span> robust_head<span class="token punctuation">.</span>list_op_pending<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">return</span> ENOTRECOVERABLE<span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>

	mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>robust<span class="token punctuation">)</span>
	  <span class="token punctuation">{</span>
	    <span class="token function">ENQUEUE_MUTEX_PI</span> <span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token function">THREAD_SETMEM</span> <span class="token punctuation">(</span>THREAD_SELF<span class="token punctuation">,</span> robust_head<span class="token punctuation">.</span>list_op_pending<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">/* __NR_futex.  */</span></span>

    <span class="token keyword">case</span> PTHREAD_MUTEX_PP_RECURSIVE_NP<span class="token operator">:</span>
    <span class="token keyword">case</span> PTHREAD_MUTEX_PP_ERRORCHECK_NP<span class="token operator">:</span>
    <span class="token keyword">case</span> PTHREAD_MUTEX_PP_NORMAL_NP<span class="token operator">:</span>
    <span class="token keyword">case</span> PTHREAD_MUTEX_PP_ADAPTIVE_NP<span class="token operator">:</span>
      <span class="token punctuation">{</span>
	<span class="token keyword">int</span> kind <span class="token operator">=</span> mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__kind <span class="token operator">&amp;</span> PTHREAD_MUTEX_KIND_MASK_NP<span class="token punctuation">;</span>

	oldval <span class="token operator">=</span> mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__lock<span class="token punctuation">;</span>

	<span class="token comment">/* Check whether we already hold the mutex.  */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__owner <span class="token operator">==</span> id<span class="token punctuation">)</span>
	  <span class="token punctuation">{</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>kind <span class="token operator">==</span> PTHREAD_MUTEX_ERRORCHECK_NP<span class="token punctuation">)</span>
	      <span class="token keyword">return</span> EDEADLK<span class="token punctuation">;</span>

	    <span class="token keyword">if</span> <span class="token punctuation">(</span>kind <span class="token operator">==</span> PTHREAD_MUTEX_RECURSIVE_NP<span class="token punctuation">)</span>
	      <span class="token punctuation">{</span>
		<span class="token comment">/* Just bump the counter.  */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__count <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		  <span class="token comment">/* Overflow of the counter.  */</span>
		  <span class="token keyword">return</span> EAGAIN<span class="token punctuation">;</span>

		<span class="token operator">++</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__count<span class="token punctuation">;</span>

		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	      <span class="token punctuation">}</span>
	  <span class="token punctuation">}</span>

	<span class="token keyword">int</span> oldprio <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> ceilval<span class="token punctuation">;</span>
	<span class="token keyword">do</span>
	  <span class="token punctuation">{</span>
	    <span class="token keyword">int</span> ceiling <span class="token operator">=</span> <span class="token punctuation">(</span>oldval <span class="token operator">&amp;</span> PTHREAD_MUTEX_PRIO_CEILING_MASK<span class="token punctuation">)</span>
			  <span class="token operator">&gt;&gt;</span> PTHREAD_MUTEX_PRIO_CEILING_SHIFT<span class="token punctuation">;</span>

	    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__pthread_current_priority</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> ceiling<span class="token punctuation">)</span>
	      <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>oldprio <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		  <span class="token function">__pthread_tpp_change_priority</span> <span class="token punctuation">(</span>oldprio<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> EINVAL<span class="token punctuation">;</span>
	      <span class="token punctuation">}</span>

	    <span class="token keyword">int</span> retval <span class="token operator">=</span> <span class="token function">__pthread_tpp_change_priority</span> <span class="token punctuation">(</span>oldprio<span class="token punctuation">,</span> ceiling<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
	      <span class="token keyword">return</span> retval<span class="token punctuation">;</span>

	    ceilval <span class="token operator">=</span> ceiling <span class="token operator">&lt;&lt;</span> PTHREAD_MUTEX_PRIO_CEILING_SHIFT<span class="token punctuation">;</span>
	    oldprio <span class="token operator">=</span> ceiling<span class="token punctuation">;</span>

	    oldval
	      <span class="token operator">=</span> <span class="token function">atomic_compare_and_exchange_val_acq</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__lock<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">NO_INCR</span></span>
						     ceilval <span class="token operator">|</span> <span class="token number">2</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
						     ceilval <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
						     ceilval<span class="token punctuation">)</span><span class="token punctuation">;</span>

	    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldval <span class="token operator">==</span> ceilval<span class="token punctuation">)</span>
	      <span class="token keyword">break</span><span class="token punctuation">;</span>

	    <span class="token keyword">do</span>
	      <span class="token punctuation">{</span>
		oldval
		  <span class="token operator">=</span> <span class="token function">atomic_compare_and_exchange_val_acq</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__lock<span class="token punctuation">,</span>
							 ceilval <span class="token operator">|</span> <span class="token number">2</span><span class="token punctuation">,</span>
							 ceilval <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>oldval <span class="token operator">&amp;</span> PTHREAD_MUTEX_PRIO_CEILING_MASK<span class="token punctuation">)</span> <span class="token operator">!=</span> ceilval<span class="token punctuation">)</span>
		  <span class="token keyword">break</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>oldval <span class="token operator">!=</span> ceilval<span class="token punctuation">)</span>
		  <span class="token function">lll_futex_wait</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__lock<span class="token punctuation">,</span> ceilval <span class="token operator">|</span> <span class="token number">2</span><span class="token punctuation">,</span>
				  <span class="token function">PTHREAD_MUTEX_PSHARED</span> <span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	      <span class="token punctuation">}</span>
	    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">atomic_compare_and_exchange_val_acq</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__lock<span class="token punctuation">,</span>
							ceilval <span class="token operator">|</span> <span class="token number">2</span><span class="token punctuation">,</span> ceilval<span class="token punctuation">)</span>
		   <span class="token operator">!=</span> ceilval<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>oldval <span class="token operator">&amp;</span> PTHREAD_MUTEX_PRIO_CEILING_MASK<span class="token punctuation">)</span> <span class="token operator">!=</span> ceilval<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">assert</span> <span class="token punctuation">(</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__owner <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token comment">/* Correct code cannot set any other type.  */</span>
      <span class="token keyword">return</span> EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token comment">/* Record the ownership.  */</span>
  mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__owner <span class="token operator">=</span> id<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">NO_INCR</span></span>
  <span class="token operator">++</span>mutex<span class="token operator">-&gt;</span>__data<span class="token punctuation">.</span>__nusers<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token function">LIBC_PROBE</span> <span class="token punctuation">(</span>mutex_acquired<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br></div></div></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-fb8d84c6><div class="edit" data-v-fb8d84c6><div class="edit-link" data-v-fb8d84c6 data-v-1ed99556><a class="link" href="https://github.com/nkbai/Blog/edit/master/docs/rust/rust_async_lock.md" target="_blank" rel="noopener noreferrer" data-v-1ed99556>编辑本文 <svg class="icon outbound icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-1ed99556><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="updated" data-v-fb8d84c6><p class="last-updated" data-v-fb8d84c6 data-v-5797b537><span class="prefix" data-v-5797b537>上次更新:</span><span class="datetime" data-v-5797b537></span></p></div></footer><div class="next-and-prev-link" data-v-7eddb2c4 data-v-38ede35f><div class="container" data-v-38ede35f><div class="prev" data-v-38ede35f><a class="link" href="/rust/convert_an_integer_to_an_enum" data-v-38ede35f><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-38ede35f><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-38ede35f>Rust中enum和整数的互相转换</span></a></div><div class="next" data-v-38ede35f><a class="link" href="/rust/lock-freedom-without-garbage-collection" data-v-38ede35f><span class="text" data-v-38ede35f>Rust无锁编程</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-38ede35f><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"404.md\":\"953cd89d\",\"about.md\":\"7e8c2e94\",\"index.md\":\"51f60c0c\",\"blockchain_index.md\":\"4cb5efc3\",\"other_apt安装指定版本软件.md\":\"b0312d63\",\"other_brew安装指定版本boost.md\":\"e4ae33a5\",\"other_capture_with_wireshark_for_android.md\":\"a014a04c\",\"other_clean_mac.md\":\"927d05ea\",\"other_crossover source insight 4.0使用.md\":\"b84f47db\",\"other_git以及github回退.md\":\"ae7efbf8\",\"other_grpcox.md\":\"61cdc4fe\",\"other_hugo博客写作.md\":\"663bf769\",\"other_index.md\":\"8b2d56e4\",\"other_learn_go.md\":\"cdd92d66\",\"other_learningpythonv4.md\":\"8095eabf\",\"other_opc 统一架构学习笔记.md\":\"3689f9fd\",\"other_opcua-rust.md\":\"cb57f50b\",\"other_opcua_cross_compile_for_raspeberry.md\":\"8c50a147\",\"other_read_kerenel_use_clion.md\":\"287ebc03\",\"other_vscode_cnblog_plugin.md\":\"8f58359e\",\"other_windows_hook_thiscall.md\":\"42d18573\",\"other_不用外部插件启用u盘ntfs写功能.md\":\"7a54dde4\",\"other_五个goland进行go开发的小技巧.md\":\"2eb96a27\",\"other_使用clion调试开发比特币源码.md\":\"f22d2811\",\"other_使用ubuntu搭建时间机器备份服务.md\":\"8fea713b\",\"other_工作中常用工具入门.md\":\"9314669f\",\"other_用 go 写 webassembly入门.md\":\"47ad8ac3\",\"other_阈值签名.md\":\"cd7a6840\",\"other_高性能go开发.md\":\"95d42825\",\"rust_futures_explained_in_200_lines_of_rust.md\":\"098f1ad7\",\"rust_futures_explained_in_200_lines_of_rust2.md\":\"cd33fb93\",\"rust_futures_explained_in_200_lines_of_rust_with_error_version.md\":\"cefd75cc\",\"rust_build_your_own_block_on.md\":\"d769d739\",\"rust_build_your_own_executor.md\":\"df24680f\",\"rust_convert_an_integer_to_an_enum.md\":\"02a1e213\",\"rust_index.md\":\"2f6bf80c\",\"rust_lock-freedom-without-garbage-collection.md\":\"956a3bad\",\"rust_my_note.md\":\"ae3d079b\",\"rust_ownership101.md\":\"c85810a0\",\"rust_rust_async_lock.md\":\"6353ad9f\",\"rust_rust开发工具.md\":\"7289169b\",\"rust_tokio_async_await 初探.md\":\"d22f9bd4\",\"rust_tokio笔记.md\":\"633aa10e\",\"rust_交叉编译rust.md\":\"faeccf54\",\"static_analysis_index.md\":\"f7e24fa4\",\"static_analysis_mariana-introduction.md\":\"0d1a47e5\",\"rust-leetcode_2019-06-01.md\":\"c1293cc9\",\"rust-leetcode_2019-06-02.md\":\"81f3698d\",\"rust-leetcode_2019-06-03.md\":\"60b11981\",\"rust-leetcode_2019-06-04.md\":\"dea49601\",\"rust-leetcode_2019-06-05.md\":\"f564ce71\",\"rust-leetcode_2019-06-06.md\":\"7e2ba03e\",\"rust-leetcode_2019-06-07.md\":\"cd8a2ead\",\"rust-leetcode_2019-06-08.md\":\"20b44271\",\"rust-leetcode_2019-06-10.md\":\"f4dd7fa9\",\"rust-leetcode_2019-06-11.md\":\"b1d31309\",\"rust-leetcode_2019-06-14.md\":\"e29ace1c\",\"rust-leetcode_2019-06-15.md\":\"0586747e\",\"rust-leetcode_2019-06-17.md\":\"95af985a\",\"rust-leetcode_2019-06-18.md\":\"9ab7eb3b\",\"rust-leetcode_2019-08-04.md\":\"50cd4842\",\"rust-leetcode_2019-08-10.md\":\"86db2c1f\",\"rust-leetcode_2019-08-11.md\":\"2f46956e\",\"rust-leetcode_2019-08-12.md\":\"15685d78\",\"rust-leetcode_2019-08-13.md\":\"74df4145\",\"rust-leetcode_2019-08-14.md\":\"43e25445\",\"rust-leetcode_2019-08-15.md\":\"70b063ae\",\"rust-leetcode_2019-08-16.md\":\"9789ba72\",\"rust-leetcode_2019-08-17.md\":\"63f1ffd2\",\"rust-leetcode_2019-08-18.md\":\"34e15e90\",\"rust-leetcode_2019-08-19.md\":\"e8ed57c5\",\"rust-leetcode_2019-08-20.md\":\"d658d0b8\",\"rust-leetcode_2019-08-21.md\":\"14674b32\",\"rust-leetcode_2019-08-22.md\":\"06f653c8\",\"rust-leetcode_2019-08-23.md\":\"381308fd\",\"rust-leetcode_2019-08-26.md\":\"d3f77484\",\"rust-leetcode_2019-08-27.md\":\"05242f22\",\"rust-leetcode_2019-08-28.md\":\"f397e4bf\",\"rust-leetcode_2019-08-29.md\":\"9a1cabf4\",\"rust-leetcode_2019-08-30.md\":\"f2d4db1c\",\"rust-leetcode_2019-09-02.md\":\"0c0eae40\",\"rust-leetcode_2019-09-03.md\":\"cede9bbe\",\"rust-leetcode_2019-09-04.md\":\"378f821f\",\"rust-leetcode_2019-09-05.md\":\"d3cb265e\",\"rust-leetcode_2019-09-06.md\":\"de19fb22\",\"rust-leetcode_2019-09-09.md\":\"bb6726d9\",\"rust-leetcode_2019-09-10.md\":\"24a77043\",\"rust-leetcode_2019-09-11.md\":\"8f23c58b\",\"rust-leetcode_2019-09-12.md\":\"09573d74\",\"rust-leetcode_2019-09-13.md\":\"31390a88\",\"rust-leetcode_2019-09-16.md\":\"a14e0f18\",\"rust-leetcode_2019-09-17.md\":\"f5b8cf20\",\"rust-leetcode_2019-09-18.md\":\"9f31117d\",\"rust-leetcode_2019-09-19.md\":\"d7f6bc0e\",\"rust-leetcode_2019-09-20.md\":\"1332500b\",\"rust-leetcode_2019-09-23.md\":\"7f2482b9\",\"rust-leetcode_2019-09-24.md\":\"ee6556e4\",\"rust-leetcode_2019-09-25.md\":\"abfa8c41\",\"rust-leetcode_2019-09-26.md\":\"c3f88e96\",\"rust-leetcode_2019-09-27.md\":\"cc783aee\",\"rust-leetcode_2019-09-28.md\":\"d5760c21\",\"rust-leetcode_2019-10-08.md\":\"66d87167\",\"rust-leetcode_2019-10-09.md\":\"3861c5a5\",\"rust-leetcode_2019-10-10.md\":\"a8e13a36\",\"rust-leetcode_2019-10-11.md\":\"4b8c6e8a\",\"rust-leetcode_2019-10-14.md\":\"4efe6938\",\"rust-leetcode_2019-10-15.md\":\"120f7c71\",\"rust-leetcode_2019-10-16.md\":\"161df297\",\"rust-leetcode_2019-10-17.md\":\"c447eaf8\",\"rust-leetcode_2019-10-18.md\":\"1b40f28f\",\"rust-leetcode_2019-10-19.md\":\"31a1d8e5\",\"rust-leetcode_2019-10-21.md\":\"a45073a2\",\"rust-leetcode_2019-10-22.md\":\"b857d897\",\"rust-leetcode_2019-10-23.md\":\"412c0c7b\",\"rust-leetcode_2019-10-24.md\":\"6f7f8d56\",\"rust-leetcode_2019-10-25.md\":\"7cec1acd\",\"rust-leetcode_2019-10-28.md\":\"777fa05f\",\"rust-leetcode_2019-10-29.md\":\"a544ee95\",\"rust-leetcode_2019-10-30.md\":\"3a1aa3ac\",\"rust-leetcode_2019-10-31.md\":\"82863434\",\"rust-leetcode_2019-11-01.md\":\"9274626d\",\"rust-leetcode_2019-11-04.md\":\"551c6109\",\"rust-leetcode_2019-11-05.md\":\"e2107c4c\",\"rust-leetcode_2019-11-06.md\":\"4c16eb49\",\"rust-leetcode_2019-11-07.md\":\"16aa581d\",\"rust-leetcode_2019-11-08.md\":\"b873dd2f\",\"rust-leetcode_2019-11-11.md\":\"bbf412af\",\"rust-leetcode_2019-11-12.md\":\"0765aade\",\"rust-leetcode_2019-11-13.md\":\"91f41f7c\",\"rust-leetcode_2019-11-14.md\":\"84650eb1\",\"rust-leetcode_2019-11-15.md\":\"a8386378\",\"rust-leetcode_2019-11-18.md\":\"7b082fa3\",\"rust-leetcode_2019-11-19.md\":\"89a37c8e\",\"rust-leetcode_2019-11-20.md\":\"3185e62a\",\"rust-leetcode_2019-11-21.md\":\"a8275656\",\"rust-leetcode_2019-11-22.md\":\"7e4bf15c\",\"rust-leetcode_2019-11-25.md\":\"adf8e607\",\"rust-leetcode_2019-11-26.md\":\"da43fe65\",\"rust-leetcode_2019-11-27.md\":\"8b977fae\",\"rust-leetcode_2019-11-28.md\":\"0253b22a\",\"rust-leetcode_2019-11-29.md\":\"09fddbeb\",\"rust-leetcode_2019-12-02.md\":\"5ce652a9\",\"rust-leetcode_2019-12-03.md\":\"4c41a2de\",\"rust-leetcode_2019-12-04.md\":\"c2d4f1f5\",\"rust-leetcode_2019-12-05.md\":\"3fadc7e3\",\"rust-leetcode_2019-12-06.md\":\"af9e6948\",\"rust-leetcode_2019-12-09.md\":\"747579df\",\"rust-leetcode_2019-12-10.md\":\"29e50dd7\",\"rust-leetcode_2019-12-11.md\":\"0b1b9430\",\"rust-leetcode_2019-12-12.md\":\"d6a500a6\",\"rust-leetcode_2019-12-13.md\":\"87d6ee94\",\"rust-leetcode_2019-12-16.md\":\"13a1e6da\",\"rust-leetcode_2019-12-17.md\":\"0c21b2ba\",\"rust-leetcode_2019-12-18.md\":\"b57c036c\",\"rust-leetcode_2019-12-19.md\":\"557abdfe\",\"rust-leetcode_2019-12-20.md\":\"fbcb131b\",\"rust-leetcode_2019-12-23.md\":\"49835902\",\"rust-leetcode_2019-12-24.md\":\"072d8160\",\"rust-leetcode_2019-12-25.md\":\"160e3f0b\",\"rust-leetcode_2019-12-26.md\":\"b00efcb4\",\"rust-leetcode_2019-12-27.md\":\"2bdcc3e2\",\"rust-leetcode_2019-12-30.md\":\"01dbba67\",\"rust-leetcode_2019-12-31.md\":\"b98aeaf9\",\"rust-leetcode_2020-01-01.md\":\"0f271e5b\",\"rust-leetcode_2020-01-02.md\":\"9c897cb9\",\"rust-leetcode_2020-01-03.md\":\"2f204370\",\"rust-leetcode_2020-01-06.md\":\"d372b075\",\"rust-leetcode_2020-01-07.md\":\"ed422360\",\"rust-leetcode_2020-01-08.md\":\"71cf0a75\",\"rust-leetcode_2020-01-09.md\":\"709b3378\",\"rust-leetcode_2020-01-10.md\":\"992f4829\",\"rust-leetcode_2020-01-13.md\":\"a5da8058\",\"rust-leetcode_2020-01-14.md\":\"b707d766\",\"rust-leetcode_2020-01-15.md\":\"19839a24\",\"rust-leetcode_2020-01-16.md\":\"96da7927\",\"rust-leetcode_2020-01-17.md\":\"2456aa50\",\"rust-leetcode_2020-01-20.md\":\"b5c5e054\",\"rust-leetcode_2020-01-21.md\":\"6d4992af\",\"rust-leetcode_2020-01-22.md\":\"38f521d0\",\"rust-leetcode_2020-01-23.md\":\"3f28dd83\",\"rust-leetcode_2020-01-24.md\":\"cc311278\",\"rust-leetcode_2020-02-03.md\":\"cdf83b9d\",\"rust-leetcode_2020-02-04.md\":\"ba0d0e39\",\"rust-leetcode_2020-02-05.md\":\"7aa5ed7a\",\"rust-leetcode_2020-02-06.md\":\"9aa6f15f\",\"rust-leetcode_2020-02-07.md\":\"3e157adf\",\"rust-leetcode_2020-02-10.md\":\"f0c98946\",\"rust-leetcode_2020-02-11.md\":\"d61e087d\",\"rust-leetcode_2020-02-12.md\":\"601ba341\",\"rust-leetcode_2020-02-13.md\":\"2bb78309\",\"rust-leetcode_2020-02-14.md\":\"004c62d4\",\"rust-leetcode_2020-02-17.md\":\"41885934\",\"rust-leetcode_2020-02-18.md\":\"7e0cc844\",\"rust-leetcode_2020-02-19.md\":\"1a4e32d6\",\"rust-leetcode_2020-02-20.md\":\"78f5c77e\",\"rust-leetcode_2020-02-21.md\":\"15513a57\",\"rust-leetcode_2020-02-24.md\":\"3fda130a\",\"rust-leetcode_2020-02-25.md\":\"9402773a\",\"rust-leetcode_2020-02-26.md\":\"f4772091\",\"rust-leetcode_2020-02-27.md\":\"6afad0a9\",\"rust-leetcode_2020-02-28.md\":\"ab8ca158\",\"rust-leetcode_2020-03-02.md\":\"7cbb59e1\",\"rust-leetcode_2020-03-03.md\":\"2e330bcf\",\"rust-leetcode_2020-03-04.md\":\"0ba86932\",\"rust-leetcode_2020-03-05.md\":\"a855c079\",\"rust-leetcode_2020-03-06.md\":\"84a3c10a\",\"rust-leetcode_2020-03-09.md\":\"922494b4\",\"rust-leetcode_2020-03-10.md\":\"c1d5ad72\",\"rust-leetcode_2020-03-11.md\":\"6f2a138f\",\"rust-leetcode_2020-03-12.md\":\"3dfddedb\",\"rust-leetcode_2020-03-13.md\":\"8bd75d19\",\"rust-leetcode_2020-03-16.md\":\"91338393\",\"rust-leetcode_2020-03-17.md\":\"202ee17c\",\"rust-leetcode_2020-03-18.md\":\"6cc8b355\",\"rust-leetcode_2020-03-19.md\":\"088a8bc6\",\"rust-leetcode_2020-03-20.md\":\"9ec9dba2\",\"rust-leetcode_2020-03-23.md\":\"51a0d2ac\",\"rust-leetcode_2020-03-24.md\":\"6d3a2b16\",\"rust-leetcode_2020-03-25.md\":\"73ffaadf\",\"rust-leetcode_2020-03-26.md\":\"2d899668\",\"rust-leetcode_2020-03-27.md\":\"4130dcbe\",\"rust-leetcode_2020-03-30.md\":\"f6c87d64\",\"rust-leetcode_2020-03-31.md\":\"4aed59ef\",\"rust-leetcode_2020-07-09.md\":\"adf4df70\",\"rust-leetcode_index.md\":\"b9acc8ea\",\"rust-leetcode_模板.md\":\"0c906f01\",\"blockchain_block_chain_core_ecc_signature_random.md\":\"ae867cb6\",\"blockchain_block_chain_core_index.md\":\"5180cc68\",\"blockchain_block_chain_core_vrf.md\":\"1ab948f3\",\"blockchain_btcd_[9476013]比特币指令集说明.md\":\"c5924176\",\"blockchain_btcd_[9476189]一个比特币脚本示例.md\":\"1a9ebae8\",\"blockchain_btcd_[9485733]bitcoin script.md\":\"0e7483d4\",\"blockchain_btcd_[9491455]比特币的地址类型.md\":\"cdac63e5\",\"blockchain_btcd_bloom.md\":\"4035bf11\",\"blockchain_btcd_btcjson.md\":\"afbc6a6c\",\"blockchain_btcd_database.md\":\"7e383468\",\"blockchain_btcd_index.md\":\"bc437a39\",\"blockchain_btcd_indexer模块.md\":\"d480eb5d\",\"blockchain_btcd_mempool.md\":\"34b2f01d\",\"blockchain_btcd_mining.md\":\"8e2c913f\",\"blockchain_btcd_mrumap.md\":\"7351f452\",\"blockchain_btcd_peer.md\":\"5cfaaaec\",\"blockchain_btcd_rpcclient.md\":\"de7727e6\",\"blockchain_btcd_wire_common.md\":\"19e5931c\",\"blockchain_btcd_比特币解锁脚本中的scriptsignature都包含了什么东西.md\":\"5390c337\",\"blockchain_btcd_隔离见证.md\":\"19f5f593\",\"blockchain_btcwallet_btcwallet系列之一-grpc模块.md\":\"464027ad\",\"blockchain_btcwallet_chain模块.md\":\"d29a9e04\",\"blockchain_btcwallet_hdwallet-bip0032.md\":\"d972f7b4\",\"blockchain_btcwallet_index.md\":\"758f114c\",\"blockchain_btcwallet_readme.md\":\"1cf46a36\",\"blockchain_btcwallet_snacl.md\":\"55769a01\",\"blockchain_btcwallet_waddrmgr模块.md\":\"2b2f3284\",\"blockchain_btcwallet_walletdb.md\":\"677ca1bc\",\"blockchain_btcwallet_wallet中的数据库设计.md\":\"058817dd\",\"blockchain_btcwallet_wallet模块.md\":\"b35a3388\",\"blockchain_btcwallet_wtxmgr模块.md\":\"5316d2ad\",\"blockchain_btcwallet_拓扑排序在比特币tx管理中的使用.md\":\"fc00ab80\",\"blockchain_ethereum_crosschainatomicexchange.md\":\"74bdbcb1\",\"blockchain_ethereum_[9232585]合约注意事项.md\":\"ab7c3701\",\"blockchain_ethereum_[9249722]solidity_mapping_implementation.md\":\"d968a19e\",\"blockchain_ethereum_[9420361]raiden_graph.md\":\"20ae6627\",\"blockchain_ethereum_[9619946]如何为 smartraiden 贡献代码.md\":\"9b7d2bc0\",\"blockchain_ethereum_btc跨链设计.md\":\"94a6ffa6\",\"blockchain_ethereum_ethereum_erc20_wrapper.md\":\"1bf7a485\",\"blockchain_ethereum_golang subprocess tests.md\":\"550d9910\",\"blockchain_ethereum_golang_plugin.md\":\"3519c838\",\"blockchain_ethereum_how_to_create_channel.md\":\"5442a997\",\"blockchain_ethereum_how_to_use_channel.md\":\"c2ac6f22\",\"blockchain_ethereum_index.md\":\"1fa864da\",\"blockchain_ethereum_meshbox配置 openwrt.md\":\"0a1d280e\",\"blockchain_ethereum_synapse代码阅读.md\":\"7a9238fb\",\"blockchain_ethereum_thedao.md\":\"729e4ac3\",\"blockchain_ethereum_从一次盗币事件再谈合约安全问题.md\":\"5a29e494\",\"blockchain_ethereum_以太坊evm笔记.md\":\"7be986c4\",\"blockchain_ethereum_区块链计时器.md\":\"8350867c\",\"blockchain_ethereum_区块链问题笔记.md\":\"f39bd379\",\"blockchain_ethereum_君士坦丁堡分叉引起的安全问题.md\":\"f221e7b8\",\"blockchain_ethereum_多链工作问题.md\":\"d1260334\",\"blockchain_ethereum_如何使用 dlv 调试 smartraiden.md\":\"3f308a4d\",\"blockchain_ethereum_如何使用 smartraiden 以及 lnd 进行跨链原子资产交换.md\":\"ca888d41\",\"blockchain_ethereum_安全总结.md\":\"8cf1f204\",\"blockchain_ethereum_并发和并行的区别.md\":\"8f0398d3\",\"blockchain_ethereum_异常退出各种情况.md\":\"22ccfb9b\",\"blockchain_ethereum_我对 smartplasma 的理解.md\":\"0bb06296\",\"blockchain_ethereum_比特币的txhash为什么会发生改变.md\":\"f8687174\",\"blockchain_ethereum_让photon支持go module.md\":\"8ad6d5d8\",\"blockchain_ethereum_闪电网络.md\":\"ce713b94\",\"blockchain_ethereum_闪电网络交易密钥.md\":\"e2cf456c\",\"blockchain_libra_1.start_in_one_minute.md\":\"48d5ec32\",\"blockchain_libra_2.protobuf_in_libria.md\":\"1eb3d531\",\"blockchain_libra_3.libra_schema.md\":\"0bdaaee7\",\"blockchain_libra_4.client_command_and_libriadb.md\":\"2803ed75\",\"blockchain_libra_5.libra_ac.md\":\"4b10a33f\",\"blockchain_libra_6.libria_mempool_1.md\":\"58d18f27\",\"blockchain_libra_7.libra_mempool_2.md\":\"0c341c23\",\"blockchain_libra_8.libria_mempool_3.md\":\"92c0db8b\",\"blockchain_libra_9.libria_vrf.md\":\"11b9f37d\",\"blockchain_libra_index.md\":\"36f14fe2\",\"rust_rnats_1.start.md\":\"21a7b310\",\"rust_rnats_2.parser.md\":\"22dbf8dd\",\"rust_rnats_3.sublist.md\":\"9e2e74db\",\"rust_rnats_4.server.md\":\"a8cbcd7c\",\"rust_rnats_5.server.client.md\":\"7d570940\",\"rust_rnats_6.client.md\":\"41f87a58\",\"rust_rnats_index.md\":\"77aa55c5\",\"rust_rnats_ppt_index.md\":\"96c4e74b\",\"rust_rnats_ppt_从零实现消息中间件-client.md\":\"43060f91\",\"rust_rnats_ppt_从零实现消息中间件-server.client.md\":\"9680c968\",\"rust_rnats_ppt_从零实现消息中间件-server.md\":\"07594643\"}")</script>
    <script type="module" async src="/assets/app.63f3ffeb.js"></script>
  </body>
</html>