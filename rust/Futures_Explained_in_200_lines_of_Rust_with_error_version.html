<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>200行代码讲透Rust Futures-有bug版本 | Steven's Blog</title>
    <meta name="description" content="steven's Blog">
    <link rel="preload stylesheet" href="/assets/style.c1edef64.css" as="style">
    <script type="module" src="/assets/app.d4f5148f.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
  <link rel="modulepreload" href="/assets/chunks/framework.3a9190c5.js">
  <link rel="modulepreload" href="/assets/chunks/theme.ee689be4.js">
  <link rel="modulepreload" href="/assets/chunks/viewer.a15bc08d.js">
  <link rel="modulepreload" href="/assets/chunks/echarts.a422ede2.js">
  <link rel="modulepreload" href="/assets/chunks/flowchart.3da280a8.js">
  <link rel="modulepreload" href="/assets/chunks/mermaid.673c3589.js">
  <link rel="modulepreload" href="/assets/chunks/runner.e522a28f.js">
  <link rel="modulepreload" href="/assets/rust_Futures_Explained_in_200_lines_of_Rust_with_error_version.md.d72871ec.lean.js">
  <link rel="icon" href="/logo.png">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-b2cf3e0b><!--[--><!--]--><!--[--><span tabindex="-1" data-v-c8616af1></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-c8616af1> Skip to content </a><!--]--><!----><header class="VPNav" data-v-b2cf3e0b data-v-7e5bc4a5><div class="VPNavBar has-sidebar" data-v-7e5bc4a5 data-v-1d30fa41><div class="container" data-v-1d30fa41><div class="title" data-v-1d30fa41><div class="VPNavBarTitle has-sidebar" data-v-1d30fa41 data-v-f4ef19a3><a class="title" href="/" data-v-f4ef19a3><!--[--><!--]--><!--[--><img class="VPImage logo" src="/logo.png" alt data-v-6db2186b><!--]--><!--[-->Steven&#39;s Blog<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-1d30fa41><div class="curtain" data-v-1d30fa41></div><div class="content-body" data-v-1d30fa41><!--[--><!--]--><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-1d30fa41 data-v-7f418b0f><span id="main-nav-aria-label" class="visually-hidden" data-v-7f418b0f>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/web-security/" tabindex="0" data-v-7f418b0f data-v-37adc828 data-v-8f4dc553><!--[-->web安全相关<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blockchain/" tabindex="0" data-v-7f418b0f data-v-37adc828 data-v-8f4dc553><!--[-->block chain<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/static_analysis/" tabindex="0" data-v-7f418b0f data-v-37adc828 data-v-8f4dc553><!--[-->静态分析<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/app_security/" tabindex="0" data-v-7f418b0f data-v-37adc828 data-v-8f4dc553><!--[-->泛app安全<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/rust-leetcode/" tabindex="0" data-v-7f418b0f data-v-37adc828 data-v-8f4dc553><!--[-->leetcode<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/rust/" tabindex="0" data-v-7f418b0f data-v-37adc828 data-v-8f4dc553><!--[-->rust<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/other/" tabindex="0" data-v-7f418b0f data-v-37adc828 data-v-8f4dc553><!--[-->other<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-1d30fa41 data-v-f6a63727><label title="toggle dark mode" data-v-f6a63727 data-v-a9c8afb8><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-checked="false" data-v-a9c8afb8 data-v-f3c41672><span class="check" data-v-f3c41672><span class="icon" data-v-f3c41672><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-a9c8afb8><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-a9c8afb8><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></label></div><!----><div class="VPFlyout VPNavBarExtra extra" ref_key="el" data-v-1d30fa41 data-v-40855f84 data-v-764effdf><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-764effdf><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-764effdf><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-764effdf><div class="VPMenu" data-v-764effdf data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-40855f84><div class="item appearance" data-v-40855f84><p class="label" data-v-40855f84>Appearance</p><div class="appearance-action" data-v-40855f84><label title="toggle dark mode" data-v-40855f84 data-v-a9c8afb8><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-checked="false" data-v-a9c8afb8 data-v-f3c41672><span class="check" data-v-f3c41672><span class="icon" data-v-f3c41672><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-a9c8afb8><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-a9c8afb8><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></label></div></div></div><!----><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-1d30fa41 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav" data-v-b2cf3e0b data-v-f5a2ca58><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-f5a2ca58><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-f5a2ca58><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-f5a2ca58>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-f5a2ca58 data-v-079b16a8><button data-v-079b16a8>Return to top</button><!----></div></div><aside class="VPSidebar" ref_key="navEl" data-v-b2cf3e0b data-v-139a1f1d><div class="curtain" data-v-139a1f1d></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-139a1f1d><span class="visually-hidden" id="sidebar-aria-label" data-v-139a1f1d> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-139a1f1d><section class="VPSidebarItem level-0 has-active" data-v-139a1f1d data-v-c4656e6d><!----><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/rust/rust_global_function_pointer.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>rust中函数指针作为全局变量使用</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/rust/rust_atomic.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>我对rust atomic的理解</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/rust/rust_async_lock.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Rust异步编程中我们应该用那种锁?</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/rust/convert_an_integer_to_an_enum.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Rust中enum和整数的互相转换</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/rust/Futures_Explained_in_200_lines_of_Rust2.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>200行代码讲透Rust Futures的问题</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/rust/build_your_own_executor.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>从头实现Rust异步执行器</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/rust/build_your_own_block_on.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>从头实现Rust异步block_on</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/rust/Futures_Explained_in_200_lines_of_Rust.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>200行代码讲透Rust Futures</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link is-active has-active" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/rust/Futures_Explained_in_200_lines_of_Rust_with_error_version.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>200行代码讲透Rust Futures-有bug版本</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/rust/lock-freedom-without-garbage-collection.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Rust无锁编程</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/rust/rust开发工具.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>rust开发工具 clion</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/rust/tokio_async_await 初探.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>tokio async&await 初探</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/rust/交叉编译rust.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>在ubuntu 18.04上交叉编译rust 程序</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/rust/tokio笔记.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>tokio笔记.md</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/rust/ownership101.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Ownership 101</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/rust/my_note.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>rust学习笔记</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/rust/rnats/" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>从零实现消息中间件</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-b2cf3e0b data-v-a494bd1d><div class="VPDoc has-sidebar has-aside" data-v-a494bd1d data-v-c4b0d3cf><!--[--><!--]--><div class="container" data-v-c4b0d3cf><div class="aside" data-v-c4b0d3cf><div class="aside-curtain" data-v-c4b0d3cf></div><div class="aside-container" data-v-c4b0d3cf><div class="aside-content" data-v-c4b0d3cf><div class="VPDocAside" data-v-c4b0d3cf data-v-3f215769><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" ref_key="container" data-v-3f215769 data-v-ff0f39c8><div class="content" data-v-ff0f39c8><div class="outline-marker" data-v-ff0f39c8></div><div class="outline-title" data-v-ff0f39c8>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-ff0f39c8><span class="visually-hidden" id="doc-outline-aria-label" data-v-ff0f39c8> Table of Contents for current page </span><ul class="root" data-v-ff0f39c8 data-v-8f12e865><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-c4b0d3cf><div class="content-container" data-v-c4b0d3cf><!--[--><!--]--><!----><main class="main" data-v-c4b0d3cf><div style="position:relative;" class="vp-doc _rust_Futures_Explained_in_200_lines_of_Rust_with_error_version" data-v-c4b0d3cf><div><p><a href="https://cfsamson.github.io/books-futures-explained/introduction.html" target="_blank" rel="noreferrer">原文地址 Futures Explained in 200 Lines of Rust</a></p><p>该文实现包含了一个bug,如果对实现过程本身感兴趣,可以阅读完毕后,再去对比<a href="./Futures_Explained_in_200_lines_of_Rust.html">修复后版本</a>.</p><h2 id="一-引言" tabindex="-1">一 引言 <a class="header-anchor" href="#一-引言" aria-label="Permalink to &quot;一 引言&quot;">​</a></h2><p>这本书的目的是用一个例子驱动的方法来解释Rust中的Futures，探索为什么他们被设计成这样，以及他们如何工作。 我们还将介绍在编程中处理并发性时的一些替代方案。</p><p>理解这本书中描述的细节， 不需要使用Rust中的 futures或async/await。 这是为那些好奇的人准备的，他们想知道这一切是如何运作的。</p><h3 id="这本书涵盖的内容" tabindex="-1">这本书涵盖的内容 <a class="header-anchor" href="#这本书涵盖的内容" aria-label="Permalink to &quot;这本书涵盖的内容&quot;">​</a></h3><p>这本书将试图解释你可能想知道的一切，包括不同类型的执行器(executor)和运行时(runtime)的主题。 我们将在本书中实现一个非常简单的运行时，介绍一些概念，但这已经足够开始了。</p><p><a href="https://github.com/stjepang" target="_blank" rel="noreferrer">Stjepan Glavina</a> 发表了一系列关于异步运行时和执行器的优秀文章，如果谣言属实，那么在不久的将来他会发表更多的文章。</p><p>你应该做的是先读这本书，然后继续阅读 <a href="https://stjepang.github.io/" target="_blank" rel="noreferrer">stejpang 的文章</a>，了解更多关于运行时以及它们是如何工作的，特别是:</p><ol><li><a href="https://stjepang.github.io/2020/01/25/build-your-own-block-on.html" target="_blank" rel="noreferrer">构建自的block_on</a></li><li><a href="https://stjepang.github.io/2020/01/31/build-your-own-executor.html" target="_blank" rel="noreferrer">构建自己的executor</a></li></ol><p>我将自己限制在一个200行的主示例(因此才有了这个标题)中，以限制范围并介绍一个可以轻松进一步研究的示例。</p><p>然而，有很多东西需要消化，这并不像我所说的那么简单，但是我们会一步一步来，所以喝杯茶，放松一下。</p><blockquote><p>这本书是在开放的，并欢迎贡献。 你可以在<a href="https://github.com/cfsamson/books-futures-explained" target="_blank" rel="noreferrer">这里找到这本书</a>。 最后的例子，你可以<a href="https://github.com/cfsamson/examples-futures" target="_blank" rel="noreferrer">克隆或复制</a>可以在这里找到。 任何建议或改进可以归档为一个公关或在问题追踪的书。 一如既往，我们欢迎各种各样的反馈。</p></blockquote><h3 id="阅读练习和进一步阅读" tabindex="-1">阅读练习和进一步阅读 <a class="header-anchor" href="#阅读练习和进一步阅读" aria-label="Permalink to &quot;阅读练习和进一步阅读&quot;">​</a></h3><p>在<a href="#结论和练习">最后一章</a>)中，我冒昧地提出了一些小练习，如果你想进一步探索的话。</p><p>这本书也是我在 Rust 中写的关于并发编程的第四本书。 如果你喜欢它，你可能也想看看其他的:</p><ul><li><a href="https://cfsamson.gitbook.io/green-threads-explained-in-200-lines-of-rust/" target="_blank" rel="noreferrer">Green Threads Explained in 200 lines of rust</a></li><li><a href="https://cfsamson.github.io/book-exploring-async-basics/" target="_blank" rel="noreferrer">The Node Experiment - Exploring Async Basics with Rust 节点实验——用Rust探索异步基础</a></li><li><a href="https://cfsamsonbooks.gitbook.io/epoll-kqueue-iocp-explained/" target="_blank" rel="noreferrer">Epoll, Kqueue and IOCP Explained with Rust 用 Rust 解释 Epoll，Kqueue 和 IOCP</a></li></ul><h3 id="感谢" tabindex="-1">感谢 <a class="header-anchor" href="#感谢" aria-label="Permalink to &quot;感谢&quot;">​</a></h3><p>我想借此机会感谢 mio，tokio，async std，Futures，libc，crossbeam 背后的人们，他们支撑着这个异步生态系统，却很少在我眼中得到足够的赞扬。</p><p>特别感谢 jonhoo，他对我这本书的初稿给予了一些有价值的反馈。 他还没有读完最终的成品，但是我们应该向他表示感谢。</p><h2 id="二-背景资料" tabindex="-1">二 背景资料 <a class="header-anchor" href="#二-背景资料" aria-label="Permalink to &quot;二 背景资料&quot;">​</a></h2><p>在我们深入研究 Futures in Rust 的细节之前，让我们快速了解一下处理并发编程的各种方法，以及每种方法的优缺点。</p><p>同时当涉及到并发性时,我们也会解释为什么这么做，这将使我们更容易深入理解Futures.</p><blockquote><p>为了好玩，我在大多数示例中添加了一小段可运行代码。 如果你像我一样，事情会变得更有趣，也许你会看到一些你从未见过的东西。</p></blockquote><h3 id="线程" tabindex="-1">线程 <a class="header-anchor" href="#线程" aria-label="Permalink to &quot;线程&quot;">​</a></h3><p>现在，实现这一点的一个方法就是让操作系统为我们处理好一切。 我们只需为每个要完成的任务生成一个新的操作系统线程，并像通常那样编写代码。</p><p>我们用来处理并发性的运行时就是操作系统本身。</p><p>优点:</p><ul><li>简单</li><li>易用</li><li>在任务之间切换相当快</li><li>不需要付出即可得到并行支持</li></ul><p>缺点:</p><ul><li>操作系统级线程的堆栈相当大。 如果同时有许多任务等待(就像在负载很重的 web 服务器中那样) ，那么内存将很快耗尽</li><li>这涉及到很多系统调用。当任务数量很高时，这可能会非常昂贵</li><li>操作系统有很多事情需要处理。 它可能不会像你希望的那样快速地切换回线程</li><li>某些系统可能不支持线程</li></ul><p><strong>在 Rust 中使用操作系统线程看起来像这样:</strong></p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">So we start the program here!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> t1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">spawn</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">move</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">time</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Duration</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from_millis</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">200</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">We create tasks which gets run when they&#39;re finished!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> t2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">spawn</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">move</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">time</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Duration</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from_millis</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">We can even chain callbacks...</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> t3 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">spawn</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">move</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">time</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Duration</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from_millis</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">50</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">...like this!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#A6ACCD;">        t3</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">While our tasks are executing we can do other stuff here.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    t1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    t2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>操作系统线程肯定有一些相当大的优势。 这也是为什么所有这些讨论“异步”和并发性把线程摆在首位？</p><p>首先。 为了使计算机有效率，它们需要多任务处理。 一旦你开始深入研究(比如<a href="https://os.phil-opp.com/async-await/" target="_blank" rel="noreferrer">操作系统是如何工作的</a>) ，你就会发现并发无处不在。 这是我们做任何事情的基础。</p><p>其次，我们有网络。</p><p>Webservers 是关于I/O和处理小任务(请求)的。 当小任务的数量很大时，由于它们所需的内存和创建新线程所涉及的开销，就不适合今天的操作系统线程。</p><p>如果负载是可变的，那么问题就更大了，这意味着程序在任何时间点的当前任务数量都是不可预测的。 这就是为什么今天你会看到如此多的异步web框架和数据库驱动程序。</p><p>然而有大量的问题,标准的线程通常是正确的解决方案。 因此在使用异步库之前，请三思而后行。</p><p>现在，让我们来看看多任务处理的其他选项。 它们都有一个共同点，那就是它们实现了一种多任务处理的方式，即拥有一个“用户界面”运行时:</p><h3 id="绿色线程-green-threads" tabindex="-1">绿色线程(Green threads) <a class="header-anchor" href="#绿色线程-green-threads" aria-label="Permalink to &quot;绿色线程(Green threads)&quot;">​</a></h3><p>绿色线程使用与操作系统相同的机制，为每个任务创建一个线程，设置一个堆栈，保存 CPU 状态，并通过“上下文切换”从一个任务(线程)跳转到另一个任务(线程)。</p><p>我们将控制权交给调度程序(在这样的系统中，调度程序是运行时的核心部分) ，然后调度程序继续运行不同的任务。</p><p>Rust曾经支持绿色线程，但他们它达到1.0之前被删除了， 执行状态存储在每个栈中，因此在这样的解决方案中不需要<code>async</code>,<code>await</code>,<code>Futures</code> 或者<code>Pin</code>。</p><p>典型的流程是这样的:</p><ol><li>运行一些非阻塞代码</li><li>对某些外部资源进行阻塞调用</li><li>跳转到main”线程，该线程调度一个不同的线程来运行，并“跳转”到该栈中</li><li>在新线程上运行一些非阻塞代码，直到新的阻塞调用或任务完成</li><li>“跳转”回到“main&quot;线程 ，调度一个新线程，这个新线程的状态已经是<code>Ready</code>,然后跳转到该线程</li></ol><p>这些“跳转”被称为上下文切换，当你阅读这篇文章的时候，你的操作系统每秒钟都会做很多次。</p><p>优点:</p><ol><li>栈大小可能需要增长,解决这个问题不容易,并且会有成本.<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></li><li>它不是一个零成本抽象(这也是Rust早期有绿色线程,后来删除的原因之一)</li><li>如果您想要支持许多不同的平台，就很难正确实现</li></ol><p>一个绿色线程的例子可以是这样的:</p><blockquote><p>下面的例子是一个改编的例子，来自我之前写的一本<a href="https://cfsamson.gitbook.io/green-threads-explained-in-200-lines-of-rust/" target="_blank" rel="noreferrer">200行Rust说清绿色线程</a>的 gitbook。 如果你想知道发生了什么，你会发现书中详细地解释了一切。 下面的代码非常不安全，只是为了展示一个真实的例子。 这绝不是为了展示“最佳实践”。 这样我们就能达成共识了。</p></blockquote><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#![</span><span style="color:#A6ACCD;">feature</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">asm</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> naked_functions</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">ptr</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> DEFAULT_STACK_SIZE</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1024</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1024</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> MAX_THREADS</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> RUNTIME</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">pub</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Runtime</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    threads</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Vec</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Thread</span><span style="color:#89DDFF;">&gt;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    current</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">derive</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">PartialEq</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Eq</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Debug</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#C792EA;">enum</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">State</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Available</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Running</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Ready</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Thread</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    id</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    stack</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Vec</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">u8</span><span style="color:#89DDFF;">&gt;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    ctx</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ThreadContext</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    state</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">State</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    task</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Option</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Box</span><span style="color:#89DDFF;">&lt;</span><span style="color:#F78C6C;">dyn</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Fn</span><span style="color:#89DDFF;">()&gt;&gt;,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">derive</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Debug</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Default</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">repr</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">C</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ThreadContext</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    rsp</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    r15</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    r14</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    r13</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    r12</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    rbx</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    rbp</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    thread_ptr</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Thread</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> Self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">Thread</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            id</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            stack</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">vec!</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">0_</span><span style="color:#FFCB6B;">u8</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> DEFAULT_STACK_SIZE</span><span style="color:#89DDFF;">],</span></span>
<span class="line"><span style="color:#A6ACCD;">            ctx</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ThreadContext</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">default</span><span style="color:#89DDFF;">(),</span></span>
<span class="line"><span style="color:#A6ACCD;">            state</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">State</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Available</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            task</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">None</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Runtime</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">pub</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> Self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> base_thread </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Thread</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            id</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            stack</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">vec!</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">0_</span><span style="color:#FFCB6B;">u8</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> DEFAULT_STACK_SIZE</span><span style="color:#89DDFF;">],</span></span>
<span class="line"><span style="color:#A6ACCD;">            ctx</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ThreadContext</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">default</span><span style="color:#89DDFF;">(),</span></span>
<span class="line"><span style="color:#A6ACCD;">            state</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">State</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Running</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            task</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">None</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> threads </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">vec!</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">base_thread</span><span style="color:#89DDFF;">];</span></span>
<span class="line"><span style="color:#A6ACCD;">        threads</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">ctx</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">thread_ptr </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">threads</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> Thread </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> available_threads</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Vec</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Thread</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">..</span><span style="color:#A6ACCD;">MAX_THREADS</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">map</span><span style="color:#89DDFF;">(|</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Thread</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">)).</span><span style="color:#82AAFF;">collect</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        threads</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">append</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> available_threads</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">Runtime</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            threads</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            current</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">pub</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">init</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> r_ptr</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> Runtime </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            RUNTIME </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> r_ptr </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">pub</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">run</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">t_yield</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">process</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">exit</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">t_return</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">current </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">threads</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">state </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">State</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Available</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">t_yield</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">t_yield</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">bool</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> pos </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">threads</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">pos</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">state </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">State</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Ready</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            pos </span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> pos </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">threads</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                pos </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> pos </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">current </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">threads</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">state </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">State</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Available</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">threads</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">state </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">State</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Ready</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">threads</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">pos</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">state </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">State</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Running</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> old_pos </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">current </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pos</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">switch</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">threads</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">old_pos</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">ctx</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">threads</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">pos</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">ctx</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">true</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">pub</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">spawn</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">F</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Fn</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#FFCB6B;">static</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#A6ACCD;">f</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">F</span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> rt_ptr </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> RUNTIME </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Runtime</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> available </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(*</span><span style="color:#A6ACCD;">rt_ptr</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">threads</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">iter_mut</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">find</span><span style="color:#89DDFF;">(|</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> t</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">state </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">State</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Available</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">expect</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">no available thread.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> size </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> available</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">stack</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> s_ptr </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> available</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">stack</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_mut_ptr</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            available</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">task </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Some</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Box</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">f</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">            available</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">ctx</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">thread_ptr </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> available </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> Thread </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">ptr</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">write</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s_ptr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">offset</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">size </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">8</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">isize</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> guard </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">ptr</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">write</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s_ptr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">offset</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">size </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">16</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">isize</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> call </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            available</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">ctx</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">rsp </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> s_ptr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">offset</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">size </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">16</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">isize</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            available</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">state </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">State</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Ready</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">call</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">thread</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> thread </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;*(</span><span style="color:#A6ACCD;">thread </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> Thread</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Some</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">f</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">thread</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">task </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">f</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">naked</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">guard</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> rt_ptr </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> RUNTIME </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Runtime</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> rt </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">rt_ptr</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">THREAD </span><span style="color:#89DDFF;">{}</span><span style="color:#C3E88D;"> FINISHED.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> rt</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">threads</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">rt</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        rt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">t_return</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">pub</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">yield_thread</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> rt_ptr </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> RUNTIME </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Runtime</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">(*</span><span style="color:#A6ACCD;">rt_ptr</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">t_yield</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">naked</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">inline</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">never</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">switch</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">old</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ThreadContext</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> new</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ThreadContext</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">asm!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#C3E88D;">        mov     %rsp, 0x00($0)</span></span>
<span class="line"><span style="color:#C3E88D;">        mov     %r15, 0x08($0)</span></span>
<span class="line"><span style="color:#C3E88D;">        mov     %r14, 0x10($0)</span></span>
<span class="line"><span style="color:#C3E88D;">        mov     %r13, 0x18($0)</span></span>
<span class="line"><span style="color:#C3E88D;">        mov     %r12, 0x20($0)</span></span>
<span class="line"><span style="color:#C3E88D;">        mov     %rbx, 0x28($0)</span></span>
<span class="line"><span style="color:#C3E88D;">        mov     %rbp, 0x30($0)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C3E88D;">        mov     0x00($1), %rsp</span></span>
<span class="line"><span style="color:#C3E88D;">        mov     0x08($1), %r15</span></span>
<span class="line"><span style="color:#C3E88D;">        mov     0x10($1), %r14</span></span>
<span class="line"><span style="color:#C3E88D;">        mov     0x18($1), %r13</span></span>
<span class="line"><span style="color:#C3E88D;">        mov     0x20($1), %r12</span></span>
<span class="line"><span style="color:#C3E88D;">        mov     0x28($1), %rbx</span></span>
<span class="line"><span style="color:#C3E88D;">        mov     0x30($1), %rbp</span></span>
<span class="line"><span style="color:#C3E88D;">        mov     0x38($1), %rdi</span></span>
<span class="line"><span style="color:#C3E88D;">        ret</span></span>
<span class="line"><span style="color:#C3E88D;">        </span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">r</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">old</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">r</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">new</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">alignstack</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">cfg</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">not</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">windows</span><span style="color:#89DDFF;">))]</span></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> runtime </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Runtime</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    runtime</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">init</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Runtime</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">spawn</span><span style="color:#89DDFF;">(||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">I haven&#39;t implemented a timer in this example.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">yield_thread</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Finally, notice how the tasks are executed concurrently.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Runtime</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">spawn</span><span style="color:#89DDFF;">(||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">But we can still nest tasks...</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">Runtime</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">spawn</span><span style="color:#89DDFF;">(||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">...like this!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">})</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#A6ACCD;">    runtime</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">cfg</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">windows</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> runtime </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Runtime</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    runtime</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">init</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Runtime</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">spawn</span><span style="color:#89DDFF;">(||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">I haven&#39;t implemented a timer in this example.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">yield_thread</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Finally, notice how the tasks are executed concurrently.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Runtime</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">spawn</span><span style="color:#89DDFF;">(||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">But we can still nest tasks...</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">Runtime</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">spawn</span><span style="color:#89DDFF;">(||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">...like this!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">})</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#A6ACCD;">    runtime</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br></div></div><p>还在坚持阅读本书？ 很好。 如果上面的代码很难理解，不要感到沮丧。 如果不是我自己写的，我可能也会有同样的感觉。 你随时可以回去读,稍后我还会解释。</p><h3 id="基于回调的方法" tabindex="-1">基于回调的方法 <a class="header-anchor" href="#基于回调的方法" aria-label="Permalink to &quot;基于回调的方法&quot;">​</a></h3><p>你可能已经知道我们接下来要谈论Javascript，我想大多数人都知道。</p><blockquote><p>如果你接触过 Javascript 回调会让你更早患上 PTSD，那么现在闭上眼睛，向下滚动2-3秒。 你会在那里找到一个链接，带你到安全的地方。</p></blockquote><p>基于回调的方法背后的整个思想就是保存一个指向一组指令的指针，这些指令我们希望以后在以后需要的时候运行。 针对Rust，这将是一个闭包。 在下面的示例中，我们将此信息保存在<code>HashMap</code>中，但这并不是唯一的选项。</p><p>不涉及线程作为实现并发性的主要方法的基本思想是其余方法的共同点。 包括我们很快就会讲到的 Rust 今天使用的那个。</p><p>优点:</p><ol><li>大多数语言中易于实现</li><li>没有上下文切换</li><li>相对较低的内存开销(在大多数情况下)</li></ol><p>缺点:</p><ol><li>每个任务都必须保存它以后需要的状态，内存使用量将随着一系列计算中回调的数量线性增长</li><li>很难理解，很多人已经知道这就是“回调地狱”</li><li>这是一种非常不同的编写程序的方式，需要大量的重写才能从“正常”的程序流转变为使用“基于回调”的程序流</li><li>在 Rust 使用这种方法时，任务之间的状态共享是一个难题，因为它的所有权模型</li></ol><p>一个极其简单的基于回调方法的例子是:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">program_main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">So we start the program here!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">set_timeout</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">200</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">We create tasks with a callback that runs once the task finished!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">set_timeout</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">We can even chain sub-tasks...</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">set_timeout</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">50</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">...like this!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">})</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">While our tasks are executing we can do other stuff instead of waiting.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    RT</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">with</span><span style="color:#89DDFF;">(|</span><span style="color:#A6ACCD;">rt</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> rt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">program_main</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">sync</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">mpsc</span><span style="color:#89DDFF;">::{</span><span style="color:#FFCB6B;">channel</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> Receiver</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> Sender</span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> std</span><span style="color:#89DDFF;">::{</span><span style="color:#FFCB6B;">cell</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">RefCell</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> collections</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">HashMap</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> thread</span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">thread_local!</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> RT</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Runtime</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Runtime</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Runtime</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    callbacks</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">RefCell</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">HashMap</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Box</span><span style="color:#89DDFF;">&lt;</span><span style="color:#F78C6C;">dyn</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FnOnce</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()&gt;&gt;&gt;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    next_id</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">RefCell</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">&gt;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    evt_sender</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sender</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">&gt;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    evt_reciever</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Receiver</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">&gt;,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">set_timeout</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ms</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> cb</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">FnOnce</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#FFCB6B;">static</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    RT</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">with</span><span style="color:#89DDFF;">(|</span><span style="color:#A6ACCD;">rt</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">rt</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">next_id</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">borrow</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">rt</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">next_id</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">borrow_mut</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        rt</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">callbacks</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">borrow_mut</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">insert</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Box</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">cb</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> evt_sender </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> rt</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">evt_sender</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">clone</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">spawn</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">move</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">time</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Duration</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from_millis</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ms</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">            evt_sender</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">send</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Runtime</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> Self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">evt_sender</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> evt_reciever</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">channel</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">Runtime</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            callbacks</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">RefCell</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">HashMap</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">()),</span></span>
<span class="line"><span style="color:#A6ACCD;">            next_id</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">RefCell</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">            evt_sender</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            evt_reciever</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">run</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> program</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">program</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> evt_id </span><span style="color:#F78C6C;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">evt_reciever </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> cb </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">callbacks</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">borrow_mut</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">remove</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">evt_id</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">cb</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">callbacks</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">borrow</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">is_empty</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><p>我们保持这种超级简单的方法，您可能想知道这种方法和使用 OS 线程直接将回调传递给 OS 线程的方法之间有什么区别。 不同之处在于，回调是在同一个线程上运行的。 这个例子中,我们创建的 OS 线程基本上只是用作计时器，但可以表示任何类型的我们将不得不等待的资源。</p><h3 id="从回调到承诺-promises" tabindex="-1">从回调到承诺 (promises) <a class="header-anchor" href="#从回调到承诺-promises" aria-label="Permalink to &quot;从回调到承诺 (promises)&quot;">​</a></h3><p>你现在可能会想，我们什么时候才能谈论未来？</p><p>好吧，我们就快到了。你看，<code>promises</code>、<code>futures</code>和其他延迟计算的名称经常被交替使用。</p><p>它们之间有形式上的区别，但是我们在这里不会涉及，但是值得解释一下<code>promises</code>，因为它们被广泛使用在 Javascript 中，并且与 Rusts Futures 有很多共同之处。</p><p>首先，许多语言都有<code>promises</code>的概念，但我将在下面的例子中使用来自 Javascript 的概念。</p><p>承诺是解决回调带来的复杂性的一种方法。</p><p>比如,下面的例子:</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#82AAFF;">setTimer</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">200</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">setTimer</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">setTimer</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">50</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">I&#39;m the last one</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>可以替换为promise:</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">timer</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">ms</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">Promise</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">resolve</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">setTimeout</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">resolve</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ms</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">timer</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">200</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">then</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> return </span><span style="color:#82AAFF;">timer</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">))</span></span>
<span class="line"><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">then</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> return </span><span style="color:#82AAFF;">timer</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;">))</span></span>
<span class="line"><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">then</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">I&#39;m the last one));</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>深入原理可以看到变化更为显著。 您可以看到，promises 返回的状态机可以处于以下三种状态之一: <code>pending</code>、 <code>fulfilled</code> 或 <code>rejected</code>。</p><p>当我们在上面的例子中调用<code>timer (200)</code>时，我们得到一个状态<code>pending</code>的承诺。</p><p>由于承诺被重写为状态机，它们还提供了一种更好的语法，允许我们像下面这样编写最后一个示例:</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">run</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">timer</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">200</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">timer</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">100</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">timer</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">50</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">I&#39;m the last one</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>可以将 run 函数视为一个由几个子任务组成的可执行任务。 在每个<code>await</code>点上，它都将控制权交给调度程序(在本例中是众所周知的 Javascript 事件循环)。</p><p>一旦其中一个子任务将状态更改为<code>fulfilled</code>或<code>rejected</code>，则计划继续执行下一步。</p><p>从语法上讲，Rusts Futures 0.1很像上面的承诺示例，Rusts Futures 0.3很像我们上一个示例中的 async / await。</p><p>这也是与 Rusts Futures 相似的地方。 我们这样做的原因是通过上面的介绍,更加深刻的理解Rust的Futures。</p><blockquote><p>为了避免以后的混淆: 有一点你应该知道。 Java script的承诺是立即执行(early evaluated)的。 这意味着一旦它被创建，它就开始运行一个任务。 与此相反,Rust的Futures是延迟执行(lazy evaluated)。 除非轮询(poll)一次,否则什么事都不会发生。</p></blockquote><h2 id="三-rust中的futures" tabindex="-1">三 Rust中的Futures <a class="header-anchor" href="#三-rust中的futures" aria-label="Permalink to &quot;三 Rust中的Futures&quot;">​</a></h2><h3 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h3><ol><li>Rust中并发性的高级介绍</li><li>了解 Rust 在使用异步代码时能提供什么，不能提供什么</li><li>了解为什么我们需要 Rust 的运行时库</li><li>理解“leaf-future”和“non-leaf-future”的区别</li><li>了解如何处理 CPU 密集型任务</li></ol><h3 id="futures" tabindex="-1">Futures <a class="header-anchor" href="#futures" aria-label="Permalink to &quot;Futures&quot;">​</a></h3><p>什么是<code>Future</code>? <code>Future</code>是一些将在未来完成的操作。 Rust中的异步实现基于轮询,每个异步任务分成三个阶段:</p><ol><li>轮询阶段(The Poll phase). 一个<code>Future</code>被轮询后,会开始执行,直到被阻塞. 我们经常把轮询一个Future这部分称之为执行器(executor)</li><li>等待阶段. 事件源(通常称为reactor)注册等待一个事件发生，并确保当该事件准备好时唤醒相应的<code>Future</code></li><li>唤醒阶段. 事件发生,相应的<code>Future</code>被唤醒。 现在轮到执行器(executor),就是第一步中的那个执行器，调度<code>Future</code>再次被轮询，并向前走一步，直到它完成或达到一个阻塞点，不能再向前走, 如此往复,直到最终完成.</li></ol><p>当我们谈论<code>Future</code>的时候，我发现在早期区分<code>non-leaf-future</code>和<code>leaf-future</code>是很有用的，因为实际上它们彼此很不一样。</p><h3 id="leaf-futures" tabindex="-1">Leaf futures <a class="header-anchor" href="#leaf-futures" aria-label="Permalink to &quot;Leaf futures&quot;">​</a></h3><p>由运行时创建<code>leaf futures</code>，它就像套接字一样,代表着一种资源.</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// stream is a **leaf-future**</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> stream </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">tokio</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">net</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">TcpStream</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">connect</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">127.0.0.1:3000</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>对这些资源的操作，比如套接字上的 Read 操作，将是非阻塞的，并返回一个我们称之为<code>leaf-future</code>的Future.之所以称之为<code>leaf-future</code>,是因为这是我们实际上正在等待的Future.</p><p>除非你正在编写一个运行时，否则你不太可能自己实现一个<code>leaf-future</code>，但是我们将在本书中详细介绍它们是如何构造的。</p><p>您也不太可能将 <code>leaf-future</code> 传递给运行时，然后单独运行它直到完成，这一点您可以通过阅读下一段来理解。</p><h3 id="non-leaf-futures" tabindex="-1">Non-leaf-futures <a class="header-anchor" href="#non-leaf-futures" aria-label="Permalink to &quot;Non-leaf-futures&quot;">​</a></h3><p>Non-leaf-futures指的是那些我们用<code>async</code>关键字创建的Future.</p><p>异步程序的大部分是Non-leaf-futures，这是一种可暂停的计算。 这是一个重要的区别，因为这些<code>Future</code>代表一组操作。 通常，这样的任务由<code>await</code> 一系列<code>leaf-future</code>组成.</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// Non-leaf-future</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> non_leaf </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> stream </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">TcpStream</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">connect</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">127.0.0.1:3000</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">).</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span><span style="color:#676E95;font-style:italic;">// &lt;- yield</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">connected!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> result </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> stream</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">write</span><span style="color:#89DDFF;">(</span><span style="color:#C3E88D;">b</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">hello world</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">).</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> // &lt;- yield</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">message sent!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">...</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这些任务的关键是，它们能够将控制权交给运行时的调度程序，然后在稍后停止的地方继续执行。 与<code>leaf-future</code>相比，这些Future本身并不代表I/O资源。 当我们对这些Future进行轮询时, 有可能会运行一段时间或者因为等待相关资源而让度给调度器,然后等待相关资源ready的时候唤醒自己.</p><h3 id="运行时-runtimes" tabindex="-1">运行时(Runtimes) <a class="header-anchor" href="#运行时-runtimes" aria-label="Permalink to &quot;运行时(Runtimes)&quot;">​</a></h3><p>像 c # ，JavaScript，Java，GO 和许多其他语言都有一个处理并发的运行时。 所以如果你来自这些语言中的一种，这对你来说可能会有点奇怪。</p><p>Rust 与这些语言的不同之处在于 Rust 没有处理并发性的运行时，因此您需要使用一个为您提供此功能的库。</p><p>很多复杂性归因于 Futures 实际上是来源于运行时的复杂性，创建一个有效的运行时是困难的。 学习如何正确使用一个也需要相当多的努力，但是你会看到这些类型的运行时之间有几个相似之处，所以学习一个可以使学习下一个更容易。</p><p>Rust 和其他语言的区别在于，在选择运行时时，您必须进行主动选择。大多数情况下，在其他语言中，你只会使用提供给你的那一种。</p><p>异步运行时可以分为两部分:</p><ol><li>执行器(The Executor)</li><li>reactor (The Reactor)</li></ol><p>当 Rusts Futures 被设计出来的时候，有一个愿望，那就是将通知<code>Future</code>它可以做更多工作的工作与<code>Future</code>实际做工作分开。</p><p>你可以认为前者是reactor的工作，后者是执行器的工作。 运行时的这两个部分使用 <code>Waker</code>进行交互。</p><p>写这篇文章的时候，未来最受欢迎的两个运行时是:</p><ol><li><a href="https://github.com/async-rs/async-std" target="_blank" rel="noreferrer">async-std</a></li><li><a href="https://github.com/tokio-rs/tokio" target="_blank" rel="noreferrer">Tokio</a></li></ol><h3 id="rust-的标准库做了什么" tabindex="-1">Rust 的标准库做了什么 <a class="header-anchor" href="#rust-的标准库做了什么" aria-label="Permalink to &quot;Rust 的标准库做了什么&quot;">​</a></h3><ol><li>一个公共接口，<code>Future trait</code></li><li>一个符合人体工程学的方法创建任务, 可以通过async和await关键字进行暂停和恢复<code>Future</code></li><li><code>Waker</code>接口, 可以唤醒暂停的<code>Future</code></li></ol><p>这就是Rust标准库所做的。 正如你所看到的，不包括异步I/O的定义,这些异步任务是如何被创建的,如何运行的。</p><h3 id="i-o密集型-vs-cpu密集型任务" tabindex="-1">I/O密集型 VS CPU密集型任务 <a class="header-anchor" href="#i-o密集型-vs-cpu密集型任务" aria-label="Permalink to &quot;I/O密集型 VS CPU密集型任务&quot;">​</a></h3><p>正如你们现在所知道的，你们通常所写的是<code>Non-leaf-futures</code>。 让我们以 pseudo-rust 为例来看一下这个异步块:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> non_leaf </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> stream </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">TcpStream</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">connect</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">127.0.0.1:3000</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">).</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span><span style="color:#676E95;font-style:italic;"> // &lt;-- yield</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // request a large dataset</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> result </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> stream</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">write</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">get_dataset_request</span><span style="color:#89DDFF;">).</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span><span style="color:#676E95;font-style:italic;"> // &lt;-- yield</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // wait for the dataset</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> response </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">vec!</span><span style="color:#89DDFF;">[];</span></span>
<span class="line"><span style="color:#A6ACCD;">    stream</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">read</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> response</span><span style="color:#89DDFF;">).</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span><span style="color:#676E95;font-style:italic;"> // &lt;-- yield</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // do some CPU-intensive analysis on the dataset</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> report </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">analyzer</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">analyze_data</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">response</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // send the results back</span></span>
<span class="line"><span style="color:#A6ACCD;">    stream</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">write</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">report</span><span style="color:#89DDFF;">).</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span><span style="color:#676E95;font-style:italic;"> // &lt;-- yield</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>现在，正如您将看到的，当我们介绍 Futures 的工作原理时，两个<code>yield</code>之间的代码与我们的执行器在同一个线程上运行。</p><p>这意味着当我们分析器处理数据集时，执行器忙于计算而不是处理新的请求。</p><p>幸运的是，有几种方法可以解决这个问题，这并不困难，但是你必须意识到:</p><ol><li>我们可以创建一个新的<code>leaf future</code>，它将我们的任务发送到另一个线程，并在任务完成时解析。 我们可以像等待其他Future一样等待这个<code>leaf-future</code>。</li><li>运行时可以有某种类型的管理程序来监视不同的任务占用多少时间，并将执行器本身移动到不同的线程，这样即使我们的分析程序任务阻塞了原始的执行程序线程，它也可以继续运行。</li><li>您可以自己创建一个与运行时兼容的<code>reactor</code>，以您认为合适的任何方式进行分析，并返回一个可以等待的未来。</li></ol><p>现在，#1是通常的处理方式，但是一些执行器也实现了#2。 2的问题是，如果你切换运行时，你需要确保它也支持这种监督，否则你最终会阻塞执行者。</p><p>方式#3更多的是理论上的重要性，通常您会很乐意将任务发送到多数运行时提供的线程池。</p><p>大多数执行器都可以使用诸如 spawn blocking 之类的方法来完成#1。</p><p>这些方法将任务发送到运行时创建的线程池，在该线程池中，您可以执行 cpu 密集型任务，也可以执行运行时不支持的“阻塞”任务。</p><p>现在，有了这些知识，你已经在一个很好的方式来理解<code>Future</code>，但我们不会停止，有很多细节需要讨论。</p><p>休息一下或喝杯咖啡，准备好我们进入下一章的深度探索。</p><h3 id="奖励部分" tabindex="-1">奖励部分 <a class="header-anchor" href="#奖励部分" aria-label="Permalink to &quot;奖励部分&quot;">​</a></h3><p>如果你发现并发和异步编程的概念一般来说令人困惑，我知道你是从哪里来的，我已经写了一些资源，试图给出一个高层次的概述，这将使之后更容易学习 Rusts Futures:</p><ul><li><a href="https://cfsamson.github.io/book-exploring-async-basics/1_concurrent_vs_parallel.html" target="_blank" rel="noreferrer">Async Basics - The difference between concurrency and parallelism 异步基础-并发和并行之间的区别</a></li><li><a href="https://cfsamson.github.io/book-exploring-async-basics/2_async_history.html" target="_blank" rel="noreferrer">Async Basics - Async history 异步基础-异步历史</a></li><li><a href="https://cfsamson.github.io/book-exploring-async-basics/5_strategies_for_handling_io.html" target="_blank" rel="noreferrer">Async Basics - Strategies for handling I/O 异步基础-处理 i / o 的策略</a></li><li><a href="https://cfsamson.github.io/book-exploring-async-basics/6_epoll_kqueue_iocp.html" target="_blank" rel="noreferrer">Async Basics - Epoll, Kqueue and IOCP 异步基础-Epoll，Kqueue 和 IOCP</a></li></ul><p>通过研究<code>Future</code>来学习这些概念会让它变得比实际需要难得多，所以如果你有点不确定的话，继续读这些章节。</p><p>你回来的时候我就在这儿。</p><p>如果你觉得你已经掌握了基本知识，那么让我们开始行动吧！</p><h2 id="四-唤醒器和上下文-waker-and-context" tabindex="-1">四 唤醒器和上下文(Waker and Context) <a class="header-anchor" href="#四-唤醒器和上下文-waker-and-context" aria-label="Permalink to &quot;四 唤醒器和上下文(Waker and Context)&quot;">​</a></h2><h3 id="概述-1" tabindex="-1">概述 <a class="header-anchor" href="#概述-1" aria-label="Permalink to &quot;概述&quot;">​</a></h3><ol><li>了解 Waker 对象是如何构造的</li><li>了解运行时如何知道<code>leaf-future</code>何时可以恢复</li><li>了解动态分发的基础知识和trait对象</li></ol><p><code>Waker</code>类型在<a href="https://github.com/rust-lang/rfcs/blob/master/text/2592-futures.md#waking-up" target="_blank" rel="noreferrer">RFC#2592</a>中介绍.</p><h3 id="唤醒器" tabindex="-1">唤醒器 <a class="header-anchor" href="#唤醒器" aria-label="Permalink to &quot;唤醒器&quot;">​</a></h3><p><code>Waker</code>类型允许在运行时的reactor 部分和执行器部分之间进行松散耦合。</p><p>通过使用不与<code>Future</code>执行绑定的唤醒机制，运行时实现者可以提出有趣的新唤醒机制。 例如，可以生成一个线程来执行一些工作，这些工作结束时通知<code>Future</code>，这完全独立于当前的运行时。</p><p>如果没有唤醒程序，执行程序将是通知正在运行的任务的唯一方式，而使用唤醒程序，我们将得到一个松散耦合，其中很容易使用新的<code>leaf-future</code>来扩展生态系统。</p><blockquote><p>如果你想了解更多关于 Waker 类型背后的原因，我可以推荐<a href="https://boats.gitlab.io/blog/post/wakers-i/" target="_blank" rel="noreferrer">Withoutboats articles series about them</a>。</p></blockquote><h3 id="理解唤醒器" tabindex="-1">理解唤醒器 <a class="header-anchor" href="#理解唤醒器" aria-label="Permalink to &quot;理解唤醒器&quot;">​</a></h3><p>在实现我们自己的<code>Future</code>时，我们遇到的最令人困惑的事情之一就是我们如何实现一个唤醒器。 创建一个 Waker 需要创建一个 vtable，这个vtable允许我们使用动态方式调用我们真实的Waker实现.</p><blockquote><p>如果你想知道更多关于Rust中的动态分发，我可以推荐 Adam Schwalm 写的一篇文章 <a href="https://alschwalm.com/blog/static/2017/03/07/exploring-dynamic-dispatch-in-rust/" target="_blank" rel="noreferrer">Exploring Dynamic Dispatch in Rust</a>.</p></blockquote><p>让我们更详细地解释一下。</p><h3 id="rust中的胖指针" tabindex="-1">Rust中的胖指针 <a class="header-anchor" href="#rust中的胖指针" aria-label="Permalink to &quot;Rust中的胖指针&quot;">​</a></h3><p>为了更好地理解我们如何在 Rust 中实现 Waker，我们需要退后一步并讨论一些基本原理。 让我们首先看看 Rust 中一些不同指针类型的大小。</p><p>运行以下代码:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight has-diff"><code><span class="line"><span style="color:#C792EA;">trait</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">SomeTrait</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">======== The size of different pointers in Rust: ========</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">&amp;dyn Trait:-----</span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">size_of</span><span style="color:#89DDFF;">::&lt;&amp;</span><span style="color:#F78C6C;">dyn</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">SomeTrait</span><span style="color:#89DDFF;">&gt;());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">&amp;[&amp;dyn Trait]:--</span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">size_of</span><span style="color:#89DDFF;">::&lt;&amp;[&amp;</span><span style="color:#F78C6C;">dyn</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">SomeTrait</span><span style="color:#89DDFF;">]&gt;());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Box&lt;Trait&gt;:-----</span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">size_of</span><span style="color:#89DDFF;">::&lt;</span><span style="color:#FFCB6B;">Box</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">SomeTrait</span><span style="color:#89DDFF;">&gt;&gt;());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">&amp;i32:-----------</span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">size_of</span><span style="color:#89DDFF;">::&lt;&amp;</span><span style="color:#FFCB6B;">i32</span><span style="color:#89DDFF;">&gt;());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">&amp;[i32]:---------</span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">size_of</span><span style="color:#89DDFF;">::&lt;&amp;[</span><span style="color:#FFCB6B;">i32</span><span style="color:#89DDFF;">]&gt;());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Box&lt;i32&gt;:-------</span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">size_of</span><span style="color:#89DDFF;">::&lt;</span><span style="color:#FFCB6B;">Box</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">i32</span><span style="color:#89DDFF;">&gt;&gt;());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">&amp;Box&lt;i32&gt;:------</span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">size_of</span><span style="color:#89DDFF;">::&lt;&amp;</span><span style="color:#FFCB6B;">Box</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">i32</span><span style="color:#89DDFF;">&gt;&gt;());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">[&amp;dyn Trait;4]:-</span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">size_of</span><span style="color:#89DDFF;">::&lt;[&amp;</span><span style="color:#F78C6C;">dyn</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">SomeTrait</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">]&gt;());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">[i32;4]:--------</span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">size_of</span><span style="color:#89DDFF;">::&lt;[</span><span style="color:#FFCB6B;">i32</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">]&gt;());</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>从运行后的输出中可以看到，引用的大小是不同的。 许多是8字节(在64位系统中是指针大小) ，但有些是16字节。</p><p>16字节大小的指针被称为“胖指针” ，因为它们携带额外的信息。</p><p>例如 <code>&amp;[i32]</code>:</p><ul><li>前8个字节是指向数组中第一个元素的实际指针(或 slice 引用的数组的一部分)</li><li>第二个8字节是切片的长度</li></ul><p>例如 <code>&amp;dyn SomeTrait</code>:</p><p>这就是我们将要关注的胖指针的类型。<code>&amp;dyn SomeTrait</code> 是一个trait的引用，或者 Rust称之为一个trait对象。</p><p>指向 trait 对象的指针布局如下:</p><ul><li>前8个字节指向trait 对象的data</li><li>后八个字节指向trait对象的 vtable</li></ul><p>这样做的好处是，我们可以引用一个对象，除了它实现了 trait 定义的方法之外，我们对这个对象一无所知。 为了达到这个目的，我们使用动态分发。</p><p>让我们用代码而不是文字来解释这一点，通过这些部分来实现我们自己的 trait 对象:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// A reference to a trait object is a fat pointer: (data_ptr, vtable_ptr)</span></span>
<span class="line"><span style="color:#C792EA;">trait</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">i32</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">sub</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">i32</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mul</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">i32</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// This will represent our home brewn fat pointer to a trait object</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">repr</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">C</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FatPointer</span><span style="color:#89DDFF;">&lt;&#39;</span><span style="color:#FFCB6B;">a</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /// A reference is a pointer to an instantiated `Data` instance</span></span>
<span class="line"><span style="color:#A6ACCD;">    data</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&#39;</span><span style="color:#FFCB6B;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Data</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /// Since we need to pass in literal values like length and alignment it&#39;s</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /// easiest for us to convert pointers to usize-integers instead of the other way around.</span></span>
<span class="line"><span style="color:#A6ACCD;">    vtable</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// This is the data in our trait object. It&#39;s just two numbers we want to operate on.</span></span>
<span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Data</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    a</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">i32</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    b</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">i32</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// ====== function definitions ======</span></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#FFCB6B;">Data</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">i32</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">a </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">b</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">sub</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#FFCB6B;">Data</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">i32</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">a </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">b</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mul</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#FFCB6B;">Data</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">i32</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">a </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">b</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> data </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Data</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> b</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // vtable is like special purpose array of pointer-length types with a fixed</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // format where the three first values has a special meaning like the</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // length of the array is encoded in the array itself as the second value.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> vtable </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">vec!</span><span style="color:#89DDFF;">[</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;">            // pointer to `Drop` (which we&#39;re not implementing here)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">6</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;">            // lenght of vtable</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">8</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;">            // alignment</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // we need to make sure we add these in the same order as defined in the Trait.</span></span>
<span class="line"><span style="color:#A6ACCD;">        add </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;"> // function pointer - try changing the order of `add`</span></span>
<span class="line"><span style="color:#A6ACCD;">        sub </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;"> // function pointer - and `sub` to see what happens</span></span>
<span class="line"><span style="color:#A6ACCD;">        mul </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;"> // function pointer</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> fat_pointer </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FatPointer</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> vtable</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> vtable</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_ptr</span><span style="color:#89DDFF;">()};</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> test </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">mem</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">transmute</span><span style="color:#89DDFF;">::&lt;</span><span style="color:#FFCB6B;">FatPointer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F78C6C;">dyn</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#A6ACCD;">fat_pointer</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // And voalá, it&#39;s now a trait object we can call methods on</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Add: 3 + 2 = </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> test</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Sub: 3 - 2 = </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> test</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sub</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Mul: 3 * 2 = </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> test</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">mul</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>稍后，当我们实现我们自己的 Waker 时，我们实际上会像这里一样建立一个 vtable。 我们创造它的方式略有不同，但是现在你知道了规则特征对象是如何工作的，你可能会认识到我们在做什么，这使得它不那么神秘。</p><h3 id="奖励部分-1" tabindex="-1">奖励部分 <a class="header-anchor" href="#奖励部分-1" aria-label="Permalink to &quot;奖励部分&quot;">​</a></h3><p>您可能想知道为什么Waker是这样实现的，而不仅仅是作为一个普通的trait.</p><p>原因在于灵活性。 以这里的方式实现 Waker，可以很灵活地选择要使用的内存管理方案。</p><p>“正常”的方法是使用 Arc 来使用引用计数来跟踪 Waker 对象何时可以被删除。 但是，这不是唯一的方法，您还可以使用纯粹的全局函数和状态，或者任何其他您希望的方法。</p><p>这在表中为运行时实现者留下了许多选项。</p><h2 id="五-生成器和async-await" tabindex="-1">五 生成器和async/await <a class="header-anchor" href="#五-生成器和async-await" aria-label="Permalink to &quot;五 生成器和async/await&quot;">​</a></h2><h3 id="概述-2" tabindex="-1">概述 <a class="header-anchor" href="#概述-2" aria-label="Permalink to &quot;概述&quot;">​</a></h3><ol><li>理解 async / await 语法在底层是如何工作的</li><li>亲眼目睹(See first hand)我们为什么需要Pin</li><li>理解是什么让 Rusts 异步模型的内存效率非常高</li></ol><p>生成器的动机可以在 <a href="https://github.com/rust-lang/rfcs/blob/master/text/2033-experimental-coroutines.md" target="_blank" rel="noreferrer">RFC#2033</a>中找到。 它写得非常好，我建议您通读它(它谈论async/await的内容和谈论生成器的内容一样多)。</p><h3 id="为什么要学习生成器" tabindex="-1">为什么要学习生成器 <a class="header-anchor" href="#为什么要学习生成器" aria-label="Permalink to &quot;为什么要学习生成器&quot;">​</a></h3><p>generators/yield和 async/await 非常相似，一旦理解了其中一个，就应该能够理解另一个。</p><p>对我来说，使用Generators而不是 Futures 来提供可运行的和简短的示例要容易得多，这需要我们现在引入很多概念，稍后我们将介绍这些概念，以便展示示例。</p><p>Async/await 的工作方式类似于生成器，但它不返回生成器，而是返回一个实现 Future trait 的特殊对象。</p><p>一个小小的好处是，在本章的最后，你将有一个很好的关于生成器和 async / await 的介绍。</p><p>基本上，在设计 Rust 如何处理并发时，主要讨论了三个选项:</p><ol><li>Green Thread.</li><li>使用组合符(Using combinators.)</li><li>Generator, 没有专门的栈</li></ol><p>我们在背景信息中覆盖了绿色线程，所以我们不会在这里重复。 我们将集中在各种各样的无堆栈协同程序,这也就是Rust正在使用的.</p><h3 id="组合子-combinators" tabindex="-1">组合子(Combinators) <a class="header-anchor" href="#组合子-combinators" aria-label="Permalink to &quot;组合子(Combinators)&quot;">​</a></h3><p>在<code>Futures 0.1</code>中使用组合子.如果你曾经是用过Javascript中的<code>Promises</code>,那么你已经比较熟悉combinators了. 在Rust中,他们看起来如下:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> future </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Connection</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">connect</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">conn_str</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">and_then</span><span style="color:#89DDFF;">(|</span><span style="color:#A6ACCD;">conn</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    conn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">query</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">somerequest</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">map</span><span style="color:#89DDFF;">(|</span><span style="color:#A6ACCD;">row</span><span style="color:#89DDFF;">|{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">SomeStruct</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">row</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">collect</span><span style="color:#89DDFF;">::&lt;</span><span style="color:#FFCB6B;">Vec</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">SomeStruct</span><span style="color:#89DDFF;">&gt;&gt;()</span></span>
<span class="line"><span style="color:#89DDFF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> rows</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Result</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Vec</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">SomeStruct</span><span style="color:#89DDFF;">&gt;,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">SomeLibraryError</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">block_on</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">future</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>使用这个技巧主要有三个缺点:</p><ol><li>错误消息可能会冗长并且难懂</li><li>不是最佳的内存使用(浪费内存)</li><li>Rust中不允许跨组合子借用.</li></ol><p>其中第三点是这种方式的主要缺点.</p><p>不允许跨组合子借用，结果是非常不符合人体工程学的.为了完成某些任务，需要额外的内存分配或者复制，这很低效。</p><p>内存占用高的原因是，这基本上是一种基于回调的方法，其中每个闭包存储计算所需的所有数据。 这意味着，随着我们将它们链接起来，存储所需状态所需的内存会随着每一步的增加而增加。</p><h3 id="无栈协程-生成器" tabindex="-1">无栈协程/生成器 <a class="header-anchor" href="#无栈协程-生成器" aria-label="Permalink to &quot;无栈协程/生成器&quot;">​</a></h3><p>这就是今天 Rust 使用的模型，它有几个显著的优点:</p><ol><li>使用 async/await 作为关键字，可以很容易地将普通的Rust代码转换为无堆栈的协程(甚至可以使用宏来完成)</li><li>不需要上下文切换与保存恢复CPU状态</li><li>不需要处理的动态栈分配</li><li>内存效率高</li><li>允许我们块暂停点(suspension)借用 <strong>这是啥意思啊</strong></li></ol><p>与Futures 0.1不一样，使用async/ await 我们可以这样做:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">myfn</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> text </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello world</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> borrowed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">text</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">..</span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">];</span></span>
<span class="line"><span style="color:#A6ACCD;">    somefuture</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Rust中的异步使用生成器实现. 因此为了理解异步是如何工作的，我们首先需要理解生成器。 在Rust中，生成器被实现为状态机。</p><p>一个计算链的内存占用是由占用空间最大的那个步骤定义的。</p><p>这意味着在计算链中添加步骤可能根本不需要增加任何内存，这也是为什么Futures和 Async 在 Rust 中的开销很小的原因之一。</p><h3 id="生成器是如何工作的" tabindex="-1">生成器是如何工作的 <a class="header-anchor" href="#生成器是如何工作的" aria-label="Permalink to &quot;生成器是如何工作的&quot;">​</a></h3><p>在今天的 Nightly Rust 中，你可以使用关键词 yield。 在闭包中使用这个关键字，将其转换为生成器。 在介绍Pin之前，闭包是这样的:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#![</span><span style="color:#A6ACCD;">feature</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">generators</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> generator_trait</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">ops</span><span style="color:#89DDFF;">::{</span><span style="color:#FFCB6B;">Generator</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> GeneratorState</span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> a</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">i32</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> gen </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">move</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">yield</span><span style="color:#A6ACCD;"> a </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">world!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">n</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> gen</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Got value </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> n</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Complete</span><span style="color:#89DDFF;">(())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> gen</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>早些时候，在人们对 Pin 的设计达成共识之前，编译完代码看起来类似于这样:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> gen </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">n</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> gen</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Got value </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> n</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Complete</span><span style="color:#89DDFF;">(())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> gen</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// If you&#39;ve ever wondered why the parameters are called Y and R the naming from</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// the original rfc most likely holds the answer</span></span>
<span class="line"><span style="color:#C792EA;">enum</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Y</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">R</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Y</span><span style="color:#89DDFF;">),</span><span style="color:#676E95;font-style:italic;">  // originally called `Yield(Y)`</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">Complete</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">R</span><span style="color:#89DDFF;">),</span><span style="color:#676E95;font-style:italic;"> // originally called `Return(R)`</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">trait</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Generator</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Yield</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Return</span><span style="color:#89DDFF;">&gt;;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">enum</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">Enter</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">i32</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">Yield1</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">i32</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Exit</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">a1</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">i32</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> Self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Enter</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">a1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Generator</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Yield</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">i32</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Return</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // lets us get ownership over current state</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">match</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">mem</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">replace</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Exit</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Enter</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">a1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">/*----code before yield----*/</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> a </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> a1 </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">self </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Yield1</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Yield1</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">_</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">/*-----code after yield-----*/</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">world!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">self </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Exit</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Complete</span><span style="color:#89DDFF;">(())</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Exit</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">panic!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Can&#39;t advance an exited generator!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><p>关键词yield首先在<a href="https://github.com/rust-lang/rfcs/pull/1823" target="_blank" rel="noreferrer">RFC#1823</a>和 <a href="https://github.com/rust-lang/rfcs/pull/1832" target="_blank" rel="noreferrer">RFC#1832</a>中讨论。</p><p>既然您知道了现实中的 yield 关键字会将代码重写为状态机，那么您还将了解await 如何工作的,他们非常相似.</p><p>上述简单的状态机中有一些限制,当跨yield发生借用的时候会发生什么呢?</p><p>我们可以禁止这样做，但async/await 语法的主要设计目标之一就是允许这样做。 这些类型的借用是不可能使用<code>Futures 0.1</code>，所以我们不能让这个限制存在。</p><p>与其在理论上讨论它，不如让我们来看看一些代码。</p><blockquote><p>我们将使用目前 Rust 中使用的状态机的优化版本。 更深入的解释见 Tyler Mandry 的文章: <a href="https://tmandry.gitlab.io/blog/posts/optimizing-await-1/" target="_blank" rel="noreferrer">Rust 如何优化async/await</a></p></blockquote><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> generator </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">move</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> to_borrow </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> borrowed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">yield</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;{}</span><span style="color:#C3E88D;"> world!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>我们将手工编写一些版本的状态机，这些状态机表示生成器定义的状态机。</p><p>在每个示例中，我们都是“手动”逐步完成每个步骤，因此它看起来非常陌生。 我们可以添加一些语法糖，比如为我们的生成器实现 Iterator trait，这样我们就可以这样做:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Some</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">val</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> generator</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">next</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> val</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这是一个相当微不足道的改变，但是这一章已经变得很长了。我们继续前进的时候，请牢牢记住这点。</p><p>现在，我们的重写状态机在这个示例中看起来是什么样子的？</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#![</span><span style="color:#A6ACCD;">allow</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">unused_variables</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#C792EA;">enum</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Y</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">R</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Y</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">Complete</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">R</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">trait</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Generator</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Yield</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Return</span><span style="color:#89DDFF;">&gt;;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">enum</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Enter</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Yield1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        to_borrow</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        borrowed</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;"> // uh, what lifetime should this have?</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Exit</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> Self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Enter</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Generator</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Yield</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Return</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // lets us get ownership over current state</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">match</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">mem</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">replace</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Exit</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Enter</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> to_borrow </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> borrowed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> // &lt;--- NB!</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> res </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">self </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">self </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Exit</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Complete</span><span style="color:#89DDFF;">(())</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Exit</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">panic!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Can&#39;t advance an exited generator!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p>如果你试图编译这个，你会得到一个错误。</p><p>字符串的生命周期是什么。 这和Self的生命周期是不一样的。 它不是静态的。 事实证明，我们不可能用Rusts语法来描述这个生命周期，这意味着，为了使这个工作成功，我们必须让编译器知道，我们自己正确地控制了它。</p><p>这意味着必须借助unsafe。</p><p>让我们尝试编写一个使用unsafe的实现。 正如您将看到的，我们最终将使用一个自引用结构, 也就是将引用保存在自身中的结构体。</p><p>正如您所注意到的，这个编译器编译得很好！</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#![</span><span style="color:#A6ACCD;">allow</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">unused_variables</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#C792EA;">enum</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Y</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">R</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Y</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">Complete</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">R</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">trait</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Generator</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Yield</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Return</span><span style="color:#89DDFF;">&gt;;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">enum</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Enter</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Yield1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        to_borrow</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        borrowed</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> String</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;"> // NB! This is now a raw pointer!</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Exit</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> Self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Enter</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Generator</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Yield</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Return</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">match</span><span style="color:#A6ACCD;"> self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Enter</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> to_borrow </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> borrowed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> res </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">self </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">ptr</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">null</span><span style="color:#89DDFF;">()};</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">                // NB! And we set the pointer to reference the to_borrow string here</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">borrowed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> to_borrow</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">borrowed</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">..}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#FFCB6B;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{&amp;**</span><span style="color:#A6ACCD;">borrowed</span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;{}</span><span style="color:#C3E88D;"> world</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">self </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Exit</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Complete</span><span style="color:#89DDFF;">(())</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Exit</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">panic!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Can&#39;t advance an exited generator!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>请记住，我们的例子是我们生成的生成器，它的原始文件像这样:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> gen </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">move</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> to_borrow </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> borrowed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">yield</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;{}</span><span style="color:#C3E88D;"> world!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>下面是我们如何运行这个状态机的示例，正如您所看到的，它完成了我们所期望的任务。 但这仍然存在一个巨大的问题:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">pub</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> gen </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> gen2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">n</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> gen</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Got value </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> n</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">n</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> gen2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Got value </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> n</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Complete</span><span style="color:#89DDFF;">(())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> gen</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#C792EA;">enum</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Y</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">R</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Y</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">Complete</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">R</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">trait</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Generator</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Yield</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Return</span><span style="color:#89DDFF;">&gt;;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">enum</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Enter</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Yield1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        to_borrow</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        borrowed</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> String</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Exit</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> Self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Enter</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Generator</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Yield</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Return</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">match</span><span style="color:#A6ACCD;"> self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Enter</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> to_borrow </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> borrowed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> res </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">self </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">ptr</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">null</span><span style="color:#89DDFF;">()};</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">                // We set the self-reference here</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">borrowed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> to_borrow</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">borrowed</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">..}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#FFCB6B;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{&amp;**</span><span style="color:#A6ACCD;">borrowed</span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;{}</span><span style="color:#C3E88D;"> world</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">self </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Exit</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Complete</span><span style="color:#89DDFF;">(())</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Exit</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">panic!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Can&#39;t advance an exited generator!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>问题在于，如果在Safe Rust代码中,我们这样做:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#![</span><span style="color:#A6ACCD;">feature</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">never_type</span><span style="color:#89DDFF;">)]</span><span style="color:#676E95;font-style:italic;"> // Force nightly compiler to be used in playground</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// by betting on it&#39;s true that this type is named after it&#39;s stabilization date...</span></span>
<span class="line"><span style="color:#F78C6C;">pub</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> gen </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> gen2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">n</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> gen</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Got value </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> n</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">mem</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">swap</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> gen</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> gen2</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;font-style:italic;"> // &lt;--- Big problem!</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">n</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> gen2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Got value </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> n</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // This would now start gen2 since we swapped them.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Complete</span><span style="color:#89DDFF;">(())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> gen</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#C792EA;">enum</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Y</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">R</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Y</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">Complete</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">R</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">trait</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Generator</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Yield</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Return</span><span style="color:#89DDFF;">&gt;;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">enum</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Enter</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Yield1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        to_borrow</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        borrowed</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> String</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Exit</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> Self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Enter</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Generator</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Yield</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Return</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">match</span><span style="color:#A6ACCD;"> self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Enter</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> to_borrow </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> borrowed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> res </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">self </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">ptr</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">null</span><span style="color:#89DDFF;">()};</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">                // We set the self-reference here</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">borrowed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> to_borrow</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">borrowed</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">..}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#FFCB6B;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{&amp;**</span><span style="color:#A6ACCD;">borrowed</span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;{}</span><span style="color:#C3E88D;"> world</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">self </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Exit</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Complete</span><span style="color:#89DDFF;">(())</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Exit</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">panic!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Can&#39;t advance an exited generator!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div><p>运行代码并比较结果。你看到问题了吗？</p><p>等等? “Hello”怎么了? 为什么我们的代码出错了？</p><p>事实证明，虽然上面的例子编译得很好，但是我们在使用安全Rust时将这个API的使用者暴露在可能的内存未定义行为和其他内存错误中。 这是个大问题！</p><p>实际上，我已经强制上面的代码使用编译器的夜间版本。 如果您在playground上运行上面的示例，您将看到它在当前稳定状态(1.42.0)上运行时没有panic，但在当前夜间状态(1.44.0)上panic。 太可怕了！</p><p>我们将在下一章用一个稍微简单一点的例子来解释这里发生了什么，我们将使用 Pin 来修复我们的生成器，所以不用担心，您将看到到底出了什么问题，看看 Pin 如何能够帮助我们在一秒钟内安全地处理自引用类型。</p><p>在我们详细解释这个问题之前，让我们通过了解生成器和 async 关键字之间的关系来结束本章。</p><h3 id="异步和生成器" tabindex="-1">异步和生成器 <a class="header-anchor" href="#异步和生成器" aria-label="Permalink to &quot;异步和生成器&quot;">​</a></h3><p>Futures 在Rust中被实现为状态机，就像生成器是状态机一样。</p><p>您可能已经注意到异步块中使用的语法和生成器中使用的语法的相似之处:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> gen </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">move</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> to_borrow </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> borrowed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">yield</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;{}</span><span style="color:#C3E88D;"> world!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>比较一下异步块的类似例子:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> fut </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> to_borrow </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> borrowed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">SomeResource</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">some_task</span><span style="color:#89DDFF;">().</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;{}</span><span style="color:#C3E88D;"> world!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>不同之处在于，Futures 的状态与 Generator 的状态不同。</p><p>异步块将返回一个 Future 而不是 Generator，但是 Future 的工作方式和 Generator 的内部工作方式是相似的。</p><p>我们不调用<code>Generator::resume</code>，而是调用 <code>Future::poll</code>，并且不返回 generated 或 Complete，而是返回 Pending 或 Ready。 Future中的每一个await就像生成器中的一个yield。</p><p>你看到他们现在是怎么联系起来的了吗？</p><p>这就是为什么理解了生成器如何工作以及他需要面对的挑战,也就理解了Future如何工作以及它需要面对的挑战。</p><p>跨yield/await的借用就是这样.</p><h3 id="奖励部分-正在使用的自引用生成器" tabindex="-1">奖励部分-正在使用的自引用生成器 <a class="header-anchor" href="#奖励部分-正在使用的自引用生成器" aria-label="Permalink to &quot;奖励部分-正在使用的自引用生成器&quot;">​</a></h3><p>感谢<a href="https://github.com/rust-lang/rust/pull/45337/files" target="_blank" rel="noreferrer"> PR#45337 </a>,你可以在nightly版本中使用static关键字运行上面的例子. 你可以试试:</p><blockquote><p>要注意的是，API可能会发生改变。 在我撰写本书时，生成器API有一个更改，添加了对“ resume”参数的支持，以便传递到生成器闭包中。 可以关注<a href="https://github.com/rust-lang/rfcs/blob/master/text/2033-experimental-coroutines.md" target="_blank" rel="noreferrer">RFC#033</a>的相关<a href="https://github.com/rust-lang/rust/issues/43122" target="_blank" rel="noreferrer">问题#4312</a>的进展。</p></blockquote><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#![</span><span style="color:#A6ACCD;">feature</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">generators</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> generator_trait</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">ops</span><span style="color:#89DDFF;">::{</span><span style="color:#FFCB6B;">Generator</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> GeneratorState</span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">pub</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> gen1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> to_borrow </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> borrowed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">yield</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;{}</span><span style="color:#C3E88D;"> world!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> gen2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> to_borrow </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> borrowed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">yield</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;{}</span><span style="color:#C3E88D;"> world!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> pinned1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Box</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">pin</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">gen1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> pinned2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Box</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">pin</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">gen2</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">n</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pinned1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_mut</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">(())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Gen1 got value </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> n</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">n</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pinned2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_mut</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">(())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Gen2 got value </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> n</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> _ </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pinned1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_mut</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">(());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> _ </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pinned2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_mut</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">(());</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h2 id="六-pin" tabindex="-1">六 Pin <a class="header-anchor" href="#六-pin" aria-label="Permalink to &quot;六 Pin&quot;">​</a></h2><h3 id="概述-3" tabindex="-1">概述 <a class="header-anchor" href="#概述-3" aria-label="Permalink to &quot;概述&quot;">​</a></h3><blockquote><p>译者注: Pin是在使用Future时一个非常重要的概念,我的理解是: 通过使用Pin,让用户无法安全的获取到<code>&amp;mut T</code>,进而无法进行上述例子中的swap. 如果你觉得你的和这个struct没有自引用的问题,你可以自己实现UnPin.</p></blockquote><ol><li>了解如何使用Pin以及当你自己实现<code>Future</code>的时候为什么需要Pin</li><li>理解如何让自引用类型被安全的使用</li><li>理解跨&#39;await`借用是如何实现的</li><li>制定一套实用的规则来帮助你使用Pin</li></ol><p>Pin是在<a href="https://github.com/rust-lang/rfcs/blob/master/text/2349-pin.md" target="_blank" rel="noreferrer">RFC#2349</a>中被提出的.</p><p>让我们直接了当的说吧,Pin是这一系列概念中很难一开始就搞明白的,但是一旦你理解了其心智模型,就会觉得非常容易理解.</p><h3 id="定义" tabindex="-1">定义 <a class="header-anchor" href="#定义" aria-label="Permalink to &quot;定义&quot;">​</a></h3><p>Pin只与指针有关,在Rust中引用也是指针.</p><p>Pin有<code>Pin</code>类型和<code>Unpin</code>标记组成(UnPin是Rust中为数不多的几个auto trait). Pin存在的目的就是为了让那些实现了<code>!UnPin</code>的类型遵守特定的规则.</p><p>是的，你是对的，这里是双重否定<code>!Unpin</code> 的意思是“not-un-pin”。</p><blockquote><p>这个命名方案是 Rusts 的安全特性之一，它故意测试您是否因为太累而无法安全地使用这个标记来实现类型。 如果你因为<code>UnPin</code>开始感到困惑，或者甚至生气，那么你就应该这样做！ 是时候放下工作，以全新的心态重新开始明天的生活了，这是一个好兆头。</p></blockquote><p>更严肃地说，我认为有必要提到，选择这些名字是有正当理由的。 命名并不容易，我曾经考虑过在这本书中重命名 <code>Unpin</code> 和<code>!UnPin</code> ,使他们更容易理解。</p><p>然而，一位经验丰富的Rust社区成员让我相信，当简单地给这些标记起不同的名字时，有太多的细微差别和边缘情况需要考虑，而这些很容易被忽略，我相信我们将不得不习惯它们并按原样使用它们。</p><p>如果你愿意，你可以从<a href="https://internals.rust-lang.org/t/naming-pin-anchor-move/6864" target="_blank" rel="noreferrer">内部讨论</a>中读到一些讨论。</p><h3 id="pinning和自引用结构" tabindex="-1">Pinning和自引用结构 <a class="header-anchor" href="#pinning和自引用结构" aria-label="Permalink to &quot;Pinning和自引用结构&quot;">​</a></h3><p>让我们从上一章(生成器那一章)停止的地方开始，通过使用一些比状态机更容易推理的自引用结构，使我们在生成器中看到的使用自引用结构的问题变得简单得多:</p><p>现在我们的例子是这样的:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">pin</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">derive</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Debug</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    a</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    b</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> String</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">txt</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#FFCB6B;">str</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> Self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> a </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">txt</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">Test</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            a</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            b</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">ptr</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">null</span><span style="color:#89DDFF;">(),</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">init</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> self_ref</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> String </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">b </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self_ref</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">a</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#FFCB6B;">str</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">a</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">b</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#FFCB6B;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{&amp;*(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">b</span><span style="color:#89DDFF;">)}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>让我们来回顾一下这个例子，因为我们将在本章的其余部分使用它。</p><p>我们有一个自引用结构体<code>Test</code>。 Test需要创建一个init方法，这个方法很奇怪，但是为了尽可能简短，我们需要这个方法。</p><p>Test 提供了两种方法来获取字段 a 和 b 值的引用。 因为 b 是 a 的参考，所以我们把它存储为一个指针，因为 Rust 的借用规则不允许我们定义这个生命周期。</p><p>现在，让我们用这个例子来详细解释我们遇到的问题:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    test1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">init</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test2</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    test2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">init</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">a: </span><span style="color:#89DDFF;">{}</span><span style="color:#C3E88D;">, b: </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> test1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">a</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> test1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">b</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">a: </span><span style="color:#89DDFF;">{}</span><span style="color:#C3E88D;">, b: </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> test2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">a</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> test2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">b</span><span style="color:#89DDFF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在main函数中,我们首先实例化Test的两个实例,然后输出test1和test2各字段的值,结果如我们所料:</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">a: test1, b: test1</span></span>
<span class="line"><span style="color:#A6ACCD;">a: test2, b: test2</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>让我们看看，如果我们将存储在 test1指向的内存位置的数据与存储在 test2指向的内存位置的数据进行交换，会发生什么情况，反之亦然。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    test1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">init</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test2</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    test2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">init</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">a: </span><span style="color:#89DDFF;">{}</span><span style="color:#C3E88D;">, b: </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> test1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">a</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> test1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">b</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">mem</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">swap</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test2</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">a: </span><span style="color:#89DDFF;">{}</span><span style="color:#C3E88D;">, b: </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> test2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">a</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> test2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">b</span><span style="color:#89DDFF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>我们可能会认为会打印两边test1,比如:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> test1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> b</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> test1</span></span>
<span class="line"><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> test1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> b</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> test1</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>但是实际上我们得到的是:</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">a: test1, b: test1</span></span>
<span class="line"><span style="color:#A6ACCD;">a: test1, b: test2</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>指向 test2.b 的指针仍然指向test1内部的旧位置。 该结构不再是自引用的，它保存指向不同对象中的字段的指针。 这意味着我们不能再依赖test2.b的生存期与test2的生存期绑定在一起。</p><p>如果你仍然不相信，这至少可以说服你:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    test1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">init</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test2</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    test2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">init</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">a: </span><span style="color:#89DDFF;">{}</span><span style="color:#C3E88D;">, b: </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> test1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">a</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> test1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">b</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">mem</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">swap</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test2</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    test1</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">a </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">I&#39;ve totally changed now!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">to_string</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">a: </span><span style="color:#89DDFF;">{}</span><span style="color:#C3E88D;">, b: </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> test2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">a</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> test2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">b</span><span style="color:#89DDFF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>这是不应该发生的。 目前还没有严重的错误，但是您可以想象，使用这些代码很容易创建严重的错误。</p><p>我创建了一个图表来帮助可视化正在发生的事情:</p><p><img alt="" data-src="swap_problem.jpg" loading="lazy" class="lazy"> 图1: 交换前后</p><p>正如你看到的,这不是我们想要的结果. 这很容易导致段错误,也很容易导致其他意想不到的未知行为以及失败.</p><h3 id="固定在栈上" tabindex="-1">固定在栈上 <a class="header-anchor" href="#固定在栈上" aria-label="Permalink to &quot;固定在栈上&quot;">​</a></h3><p>现在，我们可以通过使用<code>Pin</code>来解决这个问题。 让我们来看看我们的例子是什么样的:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">pin</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">marker</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">PhantomPinned</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">derive</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Debug</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    a</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    b</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> String</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    _marker</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">PhantomPinned</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">txt</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#FFCB6B;">str</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> Self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> a </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">txt</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">Test</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            a</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            b</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">ptr</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">null</span><span style="color:#89DDFF;">(),</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">            // This makes our type `!Unpin`</span></span>
<span class="line"><span style="color:#A6ACCD;">            _marker</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">PhantomPinned</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">init</span><span style="color:#89DDFF;">&lt;&#39;</span><span style="color:#FFCB6B;">a</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">&lt;&amp;&#39;</span><span style="color:#FFCB6B;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">&gt;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> self_ptr</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> String </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> this </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get_unchecked_mut</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">        this</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">b </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self_ptr</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">a</span><span style="color:#89DDFF;">&lt;&#39;</span><span style="color:#FFCB6B;">a</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">&lt;&amp;&#39;</span><span style="color:#FFCB6B;">a</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">&gt;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&#39;</span><span style="color:#FFCB6B;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">str</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get_ref</span><span style="color:#89DDFF;">().</span><span style="color:#A6ACCD;">a</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">b</span><span style="color:#89DDFF;">&lt;&#39;</span><span style="color:#FFCB6B;">a</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">&lt;&amp;&#39;</span><span style="color:#FFCB6B;">a</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">&gt;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&#39;</span><span style="color:#FFCB6B;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;*(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">b</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>现在，我们在这里所做的就是固定到一个栈地址。如果我们的类型实现了<code>!UnPin</code>，那么它将总是<code>unsafe</code>。</p><p>我们在这里使用相同的技巧，包括需要 init。 如果我们想要解决这个问题并让用户避免<code>unsafe</code>，我们需要将数据钉在堆上，我们马上就会展示这一点。</p><p>让我们看看如果我们现在运行我们的例子会发生什么:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">pub</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // test1 is safe to move before we initialize it</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // Notice how we shadow `test1` to prevent it from beeing accessed again</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new_unchecked</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">init</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_mut</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test2</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new_unchecked</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test2</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">init</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_mut</span><span style="color:#89DDFF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">a: </span><span style="color:#89DDFF;">{}</span><span style="color:#C3E88D;">, b: </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">a</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_ref</span><span style="color:#89DDFF;">()),</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">b</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_ref</span><span style="color:#89DDFF;">()));</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">a: </span><span style="color:#89DDFF;">{}</span><span style="color:#C3E88D;">, b: </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">a</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_ref</span><span style="color:#89DDFF;">()),</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">b</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_ref</span><span style="color:#89DDFF;">()));</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>现在，如果我们尝试使用上次使我们陷入麻烦的问题，您将得到一个编译错误。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">pub</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new_unchecked</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">init</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_mut</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test2</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new_unchecked</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test2</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">init</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_mut</span><span style="color:#89DDFF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">a: </span><span style="color:#89DDFF;">{}</span><span style="color:#C3E88D;">, b: </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">a</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_ref</span><span style="color:#89DDFF;">()),</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">b</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_ref</span><span style="color:#89DDFF;">()));</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">mem</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">swap</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_mut</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> test2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_mut</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">a: </span><span style="color:#89DDFF;">{}</span><span style="color:#C3E88D;">, b: </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">a</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_ref</span><span style="color:#89DDFF;">()),</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">b</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_ref</span><span style="color:#89DDFF;">()));</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>正如您从运行代码所得到的错误中看到的那样，类型系统阻止我们交换固定指针。</p><blockquote><p>需要注意的是，栈pinning总是依赖于我们所在的当前栈帧，因此我们不能在一个栈帧中创建一个自引用对象并返回它，因为任何指向“self”的指针都是无效的。 如果你把一个值固定在一个栈上，这也会让你承担很多责任。 一个很容易犯的错误是，忘记对原始变量进行阴影处理，因为这样可以在初始化后drop固定的指针并访问原来的值:</p></blockquote><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test1_pin </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new_unchecked</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">init</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test1_pin</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_mut</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#82AAFF;">drop</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test1_pin</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test2</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">mem</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">swap</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test2</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Not self referential anymore: </span><span style="color:#89DDFF;">{</span><span style="color:#C3E88D;">:?</span><span style="color:#89DDFF;">}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> test1</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">b</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="固定在堆上" tabindex="-1">固定在堆上 <a class="header-anchor" href="#固定在堆上" aria-label="Permalink to &quot;固定在堆上&quot;">​</a></h3><p>为了完整性，让我们删除一些不安全的内容，通过以堆分配为代价来消除<code>init</code>方法。 固定到堆是安全的，这样用户不需要实现任何不安全的代码:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">pin</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">marker</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">PhantomPinned</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">derive</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Debug</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    a</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    b</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> String</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    _marker</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">PhantomPinned</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">txt</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#FFCB6B;">str</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Box</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Self</span><span style="color:#89DDFF;">&gt;&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> a </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">txt</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> t </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            a</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            b</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">ptr</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">null</span><span style="color:#89DDFF;">(),</span></span>
<span class="line"><span style="color:#A6ACCD;">            _marker</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">PhantomPinned</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> boxed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Box</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">pin</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> self_ptr</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> String </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">boxed</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_ref</span><span style="color:#89DDFF;">().</span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> boxed</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_mut</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">get_unchecked_mut</span><span style="color:#89DDFF;">().</span><span style="color:#A6ACCD;">b </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self_ptr </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        boxed</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">a</span><span style="color:#89DDFF;">&lt;&#39;</span><span style="color:#FFCB6B;">a</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">&lt;&amp;&#39;</span><span style="color:#FFCB6B;">a</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">&gt;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&#39;</span><span style="color:#FFCB6B;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">str</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get_ref</span><span style="color:#89DDFF;">().</span><span style="color:#A6ACCD;">a</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">b</span><span style="color:#89DDFF;">&lt;&#39;</span><span style="color:#FFCB6B;">a</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">&lt;&amp;&#39;</span><span style="color:#FFCB6B;">a</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">&gt;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&#39;</span><span style="color:#FFCB6B;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;*(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">b</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">pub</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> test2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test2</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">a: </span><span style="color:#89DDFF;">{}</span><span style="color:#C3E88D;">, b: </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">test1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_ref</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">a</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> test1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_ref</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">b</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">a: </span><span style="color:#89DDFF;">{}</span><span style="color:#C3E88D;">, b: </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">test2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_ref</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">a</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> test2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_ref</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">b</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>事实上就算是<code>!Unpin</code>有意义,固定一个堆分配的值也是安全的。 一旦在堆上分配了数据，它就会有一个稳定的地址。</p><p>作为 API 的用户，我们不需要特别注意并确保自引用指针保持有效。</p><p>也有一些方法能够对固定栈上提供一些安全保证，但是现在我们使用<a href="https://docs.rs/pin-project/" target="_blank" rel="noreferrer">pin_project</a>这个包来实现这一点。</p><h3 id="pinning的一些实用规则" tabindex="-1">Pinning的一些实用规则 <a class="header-anchor" href="#pinning的一些实用规则" aria-label="Permalink to &quot;Pinning的一些实用规则&quot;">​</a></h3><ol><li>针对<code>T:UnPin</code>(这是默认值),<code>Pin&lt;&#39;a,T&gt;</code>完全定价与<code>&amp;&#39;a mut T</code>. 换句话说: <code>UnPin</code>意味着这个类型即使在固定时也可以移动，所以Pin对这个类型没有影响。</li><li>针对<code>T:!UnPin</code>,从<code>Pin&lt; T&gt;</code>获取到<code>&amp;mut T</code>,则必须使用unsafe. 换句话说,<code>!Unpin</code>能够阻止API的使用者移动T,除非他写出unsafe的代码.</li><li>Pinning对于内存分配没有什么特别的作用，比如将其放入某个“只读”内存或任何奇特的内存中。 它只使用类型系统来防止对该值进行某些操作。</li><li>大多数标准库类型实现 Unpin。 这同样适用于你在 Rust 中遇到的大多数“正常”类型。 <code>Future</code>和<code>Generators</code>是两个例外。</li><li>Pin的主要用途就是自引用类型,Rust语言的所有这些调整就是为了允许这个. 这个API中仍然有一些问题需要探讨.</li><li><code>!UnPin</code>这些类型的实现很有可能是不安全的. 在这种类型被钉住后移动它可能会导致程序崩溃。 在撰写本书时，创建和读取自引用结构的字段仍然需要不安全的方法(唯一的方法是创建一个包含指向自身的原始指针的结构)。</li><li>当使用nightly版本时,你可以在一个使用特性标记在一个类型上添加<code>!UnPin</code>. 当使用stable版本时,可以将std: : marker: : PhantomPinned 添加到类型上。</li><li>你既可以固定一个栈上的对象也可以固定一个堆上的对象.</li><li>将一个<code>!UnPin</code>的指向栈上的指针固定需要unsafe.</li><li>将一个<code>!UnPin</code>的指向堆上的指针固定,不需要unsafe,可以直接使用<code>Box::Pin</code>.</li></ol><blockquote><p>不安全的代码并不意味着它真的“unsafe” ，它只是减轻了通常从编译器得到的保证。 一个不安全的实现可能是完全安全的，但是您没有编译器保证的安全网。</p></blockquote><h3 id="映射-结构体的固定" tabindex="-1">映射/结构体的固定 <a class="header-anchor" href="#映射-结构体的固定" aria-label="Permalink to &quot;映射/结构体的固定&quot;">​</a></h3><p>简而言之，投影是一个编程语言术语。 Mystruct.field1是一个投影。 结构体的固定是在每一个字段上使用Pin。 这里有一些注意事项，您通常不会看到，因此我参考相关文档。</p><h3 id="pin和drop" tabindex="-1">Pin和Drop <a class="header-anchor" href="#pin和drop" aria-label="Permalink to &quot;Pin和Drop&quot;">​</a></h3><p>Pin保证从值被固定到被删除的那一刻起一直存在。 而在Drop实现中，您需要一个可变的 self 引用，这意味着在针对固定类型实现 Drop 时必须格外小心。</p><h3 id="把它们放在一起" tabindex="-1">把它们放在一起 <a class="header-anchor" href="#把它们放在一起" aria-label="Permalink to &quot;把它们放在一起&quot;">​</a></h3><p>当我们实现自己的<code>Futures</code>的时候,这正是我们要做的，我们很快就完成了。</p><h3 id="奖励部分-2" tabindex="-1">奖励部分 <a class="header-anchor" href="#奖励部分-2" aria-label="Permalink to &quot;奖励部分&quot;">​</a></h3><p><strong>修复我们实现的自引用生成器以及学习更多的关于Pin的知识.</strong></p><p>但是现在，让我们使用 Pin 来防止这个问题。 我一直在评论，以便更容易地发现和理解我们需要做出的改变。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#![</span><span style="color:#A6ACCD;">feature</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">optin_builtin_traits</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> negative_impls</span><span style="color:#89DDFF;">)]</span><span style="color:#676E95;font-style:italic;"> // needed to implement `!Unpin`</span></span>
<span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">pin</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">pub</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> gen1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> gen2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // Before we pin the pointers, this is safe to do</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // std::mem::swap(&amp;mut gen, &amp;mut gen2);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // constructing a `Pin::new()` on a type which does not implement `Unpin` is</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // unsafe. A value pinned to heap can be constructed while staying in safe</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // Rust so we can use that to avoid unsafe. You can also use crates like</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // `pin_utils` to pin to the stack safely, just remember that they use</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // unsafe under the hood so it&#39;s like using an already-reviewed unsafe</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // implementation.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> pinned1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Box</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">pin</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">gen1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> pinned2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Box</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">pin</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">gen2</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // Uncomment these if you think it&#39;s safe to pin the values to the stack instead </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // (it is in this case). Remember to comment out the two previous lines first.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    //let mut pinned1 = unsafe { Pin::new_unchecked(&amp;mut gen1) };</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    //let mut pinned2 = unsafe { Pin::new_unchecked(&amp;mut gen2) };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">n</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pinned1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_mut</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Gen1 got value </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> n</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">n</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pinned2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_mut</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Gen2 got value </span><span style="color:#89DDFF;">{}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> n</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // This won&#39;t work:</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // std::mem::swap(&amp;mut gen, &amp;mut gen2);</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // This will work but will just swap the pointers so nothing bad happens here:</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // std::mem::swap(&amp;mut pinned1, &amp;mut pinned2);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> _ </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pinned1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_mut</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> _ </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pinned2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_mut</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">enum</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Y</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">R</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Y</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">Complete</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">R</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">trait</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Generator</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Yield</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">&lt;&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">&gt;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Return</span><span style="color:#89DDFF;">&gt;;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">enum</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Enter</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Yield1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        to_borrow</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        borrowed</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> String</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Exit</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> Self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Enter</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// This tells us that the underlying pointer is not safe to move after pinning.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// In this case, only we as implementors &quot;feel&quot; this, however, if someone is</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// relying on our Pinned pointer this will prevent them from moving it. You need</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// to enable the feature flag ` #![feature(optin_builtin_traits)]` and use the</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// nightly compiler to implement `!Unpin`. Normally, you would use</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// `std::marker::PhantomPinned` to indicate that the struct is `!Unpin`.</span></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!</span><span style="color:#FFCB6B;">Unpin</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Generator</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Yield</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">resume</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">&lt;&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">&gt;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Return</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // lets us get ownership over current state</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> this </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get_unchecked_mut</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">match</span><span style="color:#A6ACCD;"> this </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Enter</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> to_borrow </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">String</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> borrowed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> res </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">this </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">ptr</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">null</span><span style="color:#89DDFF;">()};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">                // Trick to actually get a self reference. We can&#39;t reference</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">                // the `String` earlier since these references will point to the</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">                // location in this stack frame which will not be valid anymore</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">                // when this function returns.</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">to_borrow</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> this </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">borrowed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> to_borrow</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Yielded</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Yield1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">borrowed</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">..}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#FFCB6B;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{&amp;**</span><span style="color:#A6ACCD;">borrowed</span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;{}</span><span style="color:#C3E88D;"> world</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> borrowed</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">this </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Exit</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#FFCB6B;">GeneratorState</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Complete</span><span style="color:#89DDFF;">(())</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">GeneratorA</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Exit</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">panic!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Can&#39;t advance an exited generator!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br></div></div><p>现在，正如你所看到的，这个 API 的使用者必须:</p><ol><li>将值装箱，从而在堆上分配它</li><li>使用<code>unafe</code>然后把值固定到栈上。 用户知道如果他们事后移动了这个值，那么他们在就违反了当他们使用unsafe时候做出的承诺,也就是一直持有.</li></ol><p>希望在这之后，你会知道当你在一个异步函数中使用<code>yield</code>或者<code>await</code>关键词时会发生什么，以及如果我们想要安全地跨yield/await借用时。,为什么我们需要<code>Pin</code></p><h2 id="七-实现futures-主要例子" tabindex="-1">七 实现Futures--主要例子 <a class="header-anchor" href="#七-实现futures-主要例子" aria-label="Permalink to &quot;七 实现Futures--主要例子&quot;">​</a></h2><p>我们将用一个伪reactor和一个简单的执行器创建我们自己的<code>Futures</code>，它允许你在浏览器中编辑和运行代码</p><p>我将向您介绍这个示例，但是如果您想更深入的研究它，您可以<a href="https://github.com/cfsamson/examples-futures" target="_blank" rel="noreferrer">克隆存储库</a>并自己处理代码，或者直接从下一章复制代码。</p><p>readme文件中解释了几个分支，其中有两个分支与本章相关。 主分支是我们在这里经过的例子，<code>basic_example_commented</code>分支是这个具有大量注释的例子</p><blockquote><p>如果您希望跟随我们的步骤，可以通过创建一个新的文件夹初始化一个新的 cargo 项目，并在其中运行 cargo init。所有的一切都在main.rs文件中.</p></blockquote><h3 id="实现我们自己的futures" tabindex="-1">实现我们自己的Futures <a class="header-anchor" href="#实现我们自己的futures" aria-label="Permalink to &quot;实现我们自己的Futures&quot;">​</a></h3><p>让我们先从引入依赖开始:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> std</span><span style="color:#89DDFF;">::{</span></span>
<span class="line"><span style="color:#FFCB6B;">    future</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Future</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> pin</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> sync</span><span style="color:#89DDFF;">::{</span><span style="color:#FFCB6B;">mpsc</span><span style="color:#89DDFF;">::{</span><span style="color:#FFCB6B;">channel</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> Sender</span><span style="color:#89DDFF;">},</span><span style="color:#FFCB6B;"> Arc</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> Mutex</span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#FFCB6B;">    task</span><span style="color:#89DDFF;">::{</span><span style="color:#FFCB6B;">Context</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> Poll</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> RawWaker</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> RawWakerVTable</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> Waker</span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#FFCB6B;">    thread</span><span style="color:#89DDFF;">::{</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> JoinHandle</span><span style="color:#89DDFF;">},</span><span style="color:#FFCB6B;"> time</span><span style="color:#89DDFF;">::{</span><span style="color:#FFCB6B;">Duration</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> Instant</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="执行器" tabindex="-1">执行器 <a class="header-anchor" href="#执行器" aria-label="Permalink to &quot;执行器&quot;">​</a></h3><p>执行器的责任是获取一个或多个<code>Future</code>然后运行他们到完成。</p><p>执行器拿到<code>Future</code>后的第一件事就是轮询它.</p><p>轮询后可以发现以下三种情况:</p><ol><li><code>Future</code>返回Ready,然后就可以调度其他任何后续操作.</li><li>这个<code>Future</code>从未被轮询过,所以传入一个<code>Waker</code>,然后将它挂起</li><li>这个<code>Future</code>已经被轮询过,但是返回<code>Pending</code></li></ol><p>Rust通过<code>Waker</code>为Reactor和执行器提供了通信方式. reactor存储这个<code>Waker</code>,然后在<code>Future</code>等待的事件完成的时候调用<code>Waker: : wake ()</code>,这样<code>Future</code>就会被再次轮询.</p><p>我们的执行器会是这个样子:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// Our executor takes any object which implements the `Future` trait</span></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">block_on</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">F</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Future</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> future</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">F</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">F</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Output</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // the first thing we do is to construct a `Waker` which we&#39;ll pass on to</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // the `reactor` so it can wake us up when an event is ready. </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> mywaker </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">MyWaker</span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> thread</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">current</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">});</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> waker </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">waker_into_waker</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">into_raw</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mywaker</span><span style="color:#89DDFF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // The context struct is just a wrapper for a `Waker` object. Maybe in the</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // future this will do more, but right now it&#39;s just a wrapper.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> cx </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Context</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from_waker</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">waker</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // So, since we run this on one thread and run one future to completion</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // we can pin the `Future` to the stack. This is unsafe, but saves an</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // allocation. We could `Box::pin` it too if we wanted. This is however</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // safe since we shadow `future` so it can&#39;t be accessed again and will</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // not move until it&#39;s dropped.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> future </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new_unchecked</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> future</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // We poll in a loop, but it&#39;s not a busy loop. It will only run when</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // an event occurs, or a thread has a &quot;spurious wakeup&quot; (an unexpected wakeup</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // that can happen for no good reason).</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> val </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">loop</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">match</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Future</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">poll</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">pinned</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> cx</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">            // when the Future is ready we&#39;re finished</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">Poll</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Ready</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">val</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">break</span><span style="color:#A6ACCD;"> val</span><span style="color:#89DDFF;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">            // If we get a `pending` future we just go to sleep...</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">Poll</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Pending</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">park</span><span style="color:#89DDFF;">(),</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">    val</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>在本章的所有例子中，我都选择了对代码进行广泛的注释。 我发现沿着这条路走会更容易一些，所以我不会在这里重复自己的话，只关注一些可能需要进一步解释的重要方面。</p><p>现在你已经阅读了这么多关于生成器和 Pin 的内容，这应该很容易理解。 <code>Future</code>是一个状态机，每一个<code>await</code>点也是一个<code>yield</code>点。 我们可以跨越<code>await</code>借用，我们遇到的问题与跨<code>yield</code>借用时完全一样。</p><blockquote><p><code>Context</code>只是 <code>Waker</code> 的包装器, 至少在我写这本书的时候，它仅仅是这样。 在未来，<code>Context</code>对象可能不仅仅是包装一个<code>Waker</code>(译者注,原文是Future,应该有误)，因此这种额外的抽象可以提供一些灵活性。</p></blockquote><p>正如在关于生成器的章节中解释的那样，我们使用Pin来保证允许<code>Future</code>有自引用。</p><h3 id="future的执行" tabindex="-1">Future的执行 <a class="header-anchor" href="#future的执行" aria-label="Permalink to &quot;Future的执行&quot;">​</a></h3><p><code>Future</code>有一个定义良好的接口，这意味着他们可以用于整个生态系统。</p><p>我们可以将这些<code>Future</code>连接起来，这样一旦<code>leaf-future</code>准备好了，我们就可以执行一系列操作，直到任务完成或者我们到达另一个<code>leaf-future</code>，我们将等待并将控制权交给调度程序。</p><p>我们<code>Future</code>的实现是这样的:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// This is the definition of our `Waker`. We use a regular thread-handle here.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// It works but it&#39;s not a good solution. It&#39;s easy to fix though, I&#39;ll explain</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// after this code snippet.</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">derive</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Clone</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MyWaker</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    thread</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Thread</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// This is the definition of our `Future`. It keeps all the information we</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// need. This one holds a reference to our `reactor`, that&#39;s just to make</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// this example as easy as possible. It doesn&#39;t need to hold a reference to</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// the whole reactor, but it needs to be able to register itself with the</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// reactor.</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">derive</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Clone</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#F78C6C;">pub</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Task</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    id</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    reactor</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Mutex</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Reactor</span><span style="color:#89DDFF;">&gt;&gt;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    data</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    is_registered</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">bool</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// These are function definitions we&#39;ll use for our waker. Remember the</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// &quot;Trait Objects&quot; chapter earlier.</span></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mywaker_wake</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#FFCB6B;">MyWaker</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> waker_ptr</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> MyWaker </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> s</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> waker_arc </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from_raw</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">waker_ptr</span><span style="color:#89DDFF;">)};</span></span>
<span class="line"><span style="color:#A6ACCD;">    waker_arc</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unpark</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// Since we use an `Arc` cloning is just increasing the refcount on the smart</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// pointer.</span></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mywaker_clone</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#FFCB6B;">MyWaker</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">RawWaker</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> arc </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from_raw</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">mem</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">forget</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">arc</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">clone</span><span style="color:#89DDFF;">());</span><span style="color:#676E95;font-style:italic;"> // increase ref count</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">RawWaker</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">into_raw</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">arc</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">VTABLE</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// This is actually a &quot;helper funtcion&quot; to create a `Waker` vtable. In contrast</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// to when we created a `Trait Object` from scratch we don&#39;t need to concern</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// ourselves with the actual layout of the `vtable` and only provide a fixed</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// set of functions</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> VTABLE</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">RawWakerVTable</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">RawWakerVTable</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mywaker_clone</span><span style="color:#89DDFF;">(&amp;*(</span><span style="color:#A6ACCD;">s </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MyWaker</span><span style="color:#89DDFF;">)),</span><span style="color:#676E95;font-style:italic;">     // clone</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mywaker_wake</span><span style="color:#89DDFF;">(&amp;*(</span><span style="color:#A6ACCD;">s </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MyWaker</span><span style="color:#89DDFF;">)),</span><span style="color:#676E95;font-style:italic;">      // wake</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mywaker_wake</span><span style="color:#89DDFF;">(*(</span><span style="color:#A6ACCD;">s </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#FFCB6B;">MyWaker</span><span style="color:#89DDFF;">)),</span><span style="color:#676E95;font-style:italic;">      // wake by ref</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">drop</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from_raw</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MyWaker</span><span style="color:#89DDFF;">)),</span><span style="color:#676E95;font-style:italic;">   // decrease refcount</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// Instead of implementing this on the `MyWaker` oject in `impl Mywaker...` we</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// just use this pattern instead since it saves us some lines of code.</span></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">waker_into_waker</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MyWaker</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Waker</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> raw_waker </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">RawWaker</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">VTABLE</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Waker</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from_raw</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">raw_waker</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Task</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">reactor</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Mutex</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Reactor</span><span style="color:#89DDFF;">&gt;&gt;,</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> id</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> Self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">Task</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            id</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            reactor</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            data</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            is_registered</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false,</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// This is our `Future` implementation</span></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Future</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Task</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // The output for our kind of `leaf future` is just an `usize`. For other</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // futures this could be something more interesting like a byte array.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Output</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">poll</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">&lt;&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">&gt;,</span><span style="color:#A6ACCD;"> cx</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Context</span><span style="color:#89DDFF;">&lt;&#39;</span><span style="color:#FFCB6B;">_</span><span style="color:#89DDFF;">&gt;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Poll</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Output</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> r </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">reactor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // we check with the `Reactor` if this future is in its &quot;readylist&quot;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // i.e. if it&#39;s `Ready`</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> r</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">is_ready</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">            // if it is, we return the data. In this case it&#39;s just the ID of</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">            // the task since this is just a very simple example.</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">Poll</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Ready</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">is_registered </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">            // If the future is registered alredy, we just return `Pending`</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">Poll</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Pending</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">            // If we get here, it must be the first time this `Future` is polled</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">            // so we register a task with our `reactor`</span></span>
<span class="line"><span style="color:#A6ACCD;">            r</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">register</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> cx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">waker</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">clone</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">            // oh, we have to drop the lock on our `Mutex` here because we can&#39;t</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">            // have a shared and exclusive borrow at the same time</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">drop</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">r</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">is_registered </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">Poll</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Pending</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br></div></div><p>这大部分都是直截了当的。 令人困惑的部分是我们需要构建 Waker 的奇怪方式，但是由于我们已经从原始部分创建了我们自己的 trait 对象，这看起来很熟悉。 事实上，这更简单。</p><p>我们在这里使用一个Arc来传递一个引用计数的MyWaker的借用。 这是相当正常的，并且使得这个操作变得简单和安全。 克隆一个Waker只是增加一个计数。Drop一个Waker只是简单地减少一个计数.</p><p>在我们这种特定场景下,我们选择不使用<code>Arc</code>. 而使用这种更低层次方式实现的Waker才可以允许我们这么做.</p><p>事实上，如果我们只使用 Arc，那么我们就没有理由费尽心思去创建自己的 vtable 和 RawWaker。 我们可以实现一个普通的trait。</p><p>幸运的是，将来在标准库中也可以实现这个功能。 目前<a href="https://rust-lang-nursery.github.io/futures-api-docs/0.3.0-alpha.13/futures/task/trait.ArcWake.html" target="_blank" rel="noreferrer">这个特性仍然在实验中</a>，但是我猜想在成熟之后，这个特性将会成为标准库的一部分。</p><p>我们选择在这里传入一个整个reactor的引用, 这不正常。 reactor通常是一个全局性的资源，让我们注册感兴趣的事而不需要传入一个引用.</p><blockquote><p><strong>为什么在一个Lib中使用park/unpark是一个坏主意</strong></p><p>他很容易死锁,因为任何人都可以获得执行器所在线程的句柄,然后调用park/unpark.</p></blockquote><blockquote><ol><li>一个future可以在另一个不同的线程上unpark执行器线程</li><li>我们的执行器认为数据准备好了,然后醒来去轮询这个<code>Future</code></li><li>当被轮询时,这个<code>Future</code>还没有准备好,但是恰在此时,<code>Reactor</code>收到事件,调用了<code>Wake()</code>来unpark我们的线程.</li><li>这可能发生在我们再次睡眠之前,因为这些操作完全是并行的.</li><li>我们的reactor已经调用过<code>wake</code>,但是我们的线程仍然在睡眠,因为刚刚调用wake的时候,我们的线程是醒着的.</li><li>我们发生了死锁,然后我们的程序停止工作.</li></ol></blockquote><blockquote><p>有一种情况是，我们的线程可能会出现所谓的虚假唤醒(可能会出乎意料地发生) ，如果我们运气不好，这可能会导致同样的死锁</p></blockquote><p>有几种更好的方案,比如:</p><ul><li>std::sync::CondVar</li><li>crossbeam::sync::Parker</li></ul><h3 id="reactor" tabindex="-1">Reactor <a class="header-anchor" href="#reactor" aria-label="Permalink to &quot;Reactor&quot;">​</a></h3><p>这是最后的冲刺阶段，并不完全与<code>Future</code>相关，但是我们需要它来让我们的例子运行起来。</p><p>由于大多数时候并发只有在与外部世界(或者至少是一些外围设备)进行交互时才有意义，因此我们需要一些东西来抽象这些异步的交互.</p><p>这就是reacotor的工作. 大多数时候你看到的reactor都是用<a href="https://github.com/tokio-rs/mio" target="_blank" rel="noreferrer">Mio</a>这个库. 它早多个平台上提供了非阻塞API和事件通知机制.</p><p>reactor通常会提供类似于TcpStream(或任何其他资源)的东西，只不过您用TcpStream来创建I/O请求,而用reactor来创建Future.</p><p>我们的示例任务是一个计时器，它只生成一个线程，并将其置于休眠状态，休眠时间为我们指定的秒数。 我们在这里创建的reactor将创建一个表示每个计时器的<code>leaf-future</code>。 作为回报，reactor接收到一个唤醒器，一旦任务完成reactor将调用这个唤醒器。</p><p>为了能够在浏览器中运行这里的代码，没有太多真正的I/O，我们可以假装这实际上代表了一些有用的I/O操作。</p><p>我们的reactor看起来像这样:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// This is a &quot;fake&quot; reactor. It does no real I/O, but that also makes our</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// code possible to run in the book and in the playground</span></span>
<span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Reactor</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // we need some way of registering a Task with the reactor. Normally this</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // would be an &quot;interest&quot; in an I/O event</span></span>
<span class="line"><span style="color:#A6ACCD;">    dispatcher</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sender</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Event</span><span style="color:#89DDFF;">&gt;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    handle</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Option</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">JoinHandle</span><span style="color:#89DDFF;">&lt;()&gt;&gt;,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // This is a list of tasks that are ready, which means they should be polled</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // for data.</span></span>
<span class="line"><span style="color:#A6ACCD;">    readylist</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Mutex</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Vec</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">&gt;&gt;&gt;,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// We just have two kind of events. An event called `Timeout`</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// and a `Close` event to close down our reactor.</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">derive</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Debug</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#C792EA;">enum</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Event</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Close</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">Timeout</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Waker</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Reactor</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> Self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // The way we register new events with our reactor is using a regular</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // channel</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tx</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> rx</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">channel</span><span style="color:#89DDFF;">::&lt;</span><span style="color:#FFCB6B;">Event</span><span style="color:#89DDFF;">&gt;();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> readylist </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Mutex</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">vec!</span><span style="color:#89DDFF;">[]));</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> rl_clone </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> readylist</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">clone</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // This `Vec` will hold handles to all the threads we spawn so we can</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // join them later on and finish our programm in a good manner</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> handles </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">vec!</span><span style="color:#89DDFF;">[];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // This will be the &quot;Reactor thread&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> handle </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">spawn</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">move</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> event </span><span style="color:#F78C6C;">in</span><span style="color:#A6ACCD;"> rx </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> rl_clone </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> rl_clone</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">clone</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">match</span><span style="color:#A6ACCD;"> event </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">                    // If we get a close event we break out of the loop we&#39;re in</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#FFCB6B;">Event</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Close</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">break</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#FFCB6B;">Event</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Timeout</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">waker</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> duration</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> id</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">                        // When we get an event we simply spawn a new thread</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">                        // which will simulate some I/O resource...</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> event_handle </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">spawn</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">move</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">                            //... by sleeping for the number of seconds</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">                            // we provided when creating the `Task`.</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Duration</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from_secs</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">duration</span><span style="color:#89DDFF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">                            // When it&#39;s done sleeping we put the ID of this task</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">                            // on the &quot;readylist&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">                            rl_clone</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">map</span><span style="color:#89DDFF;">(|</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> rl</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> rl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">push</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">)).</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">                            // Then we call `wake` which will wake up our</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">                            // executor and start polling the futures</span></span>
<span class="line"><span style="color:#A6ACCD;">                            waker</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">wake</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                        handles</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">push</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">event_handle</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">            // When we exit the Reactor we first join all the handles on</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">            // the child threads we&#39;ve spawned so we catch any panics and</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">            // release any resources.</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> handle </span><span style="color:#F78C6C;">in</span><span style="color:#A6ACCD;"> handles </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                handle</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">Reactor</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            readylist</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            dispatcher</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> tx</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            handle</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Some</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">handle</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">register</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> duration</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> waker</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Waker</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // registering an event is as simple as sending an `Event` through</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // the channel.</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">dispatcher</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">send</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Event</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Timeout</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">waker</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> duration</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">close</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">dispatcher</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">send</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Event</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Close</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // We need a way to check if any event&#39;s are ready. This will simply</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // look through the &quot;readylist&quot; for an event macthing the ID we want to</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // check for.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">is_ready</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> id_to_check</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">bool</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">readylist</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">map</span><span style="color:#89DDFF;">(|</span><span style="color:#A6ACCD;">rl</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> rl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">iter</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">any</span><span style="color:#89DDFF;">(|</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">id </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> id_to_check</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// When our `Reactor` is dropped we join the reactor thread with the thread</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// owning our `Reactor` so we catch any panics and release all resources.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// It&#39;s not needed for this to work, but it really is a best practice to join</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// all threads you spawn.</span></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Drop</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Reactor</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">drop</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">handle</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">take</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">map</span><span style="color:#89DDFF;">(|</span><span style="color:#A6ACCD;">h</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> h</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">()).</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br></div></div><p>虽然代码量很大，但实际上我们只是产生了一个新线程，并让它休眠一段时间，这是我们在创建任务时指定的。</p><p>虽然代码量很大，但实际上我们只是产生了一个新线程，并让它休眠一段时间，这是我们在创建任务时指定的。</p><p>在最后一章中，我们在一个可编辑的窗口中有整整200行，你可以按照自己喜欢的方式进行编辑和修改。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // This is just to make it easier for us to see when our Future was resolved</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> start </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Instant</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">now</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // Many runtimes create a glocal `reactor` we pass it as an argument</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> reactor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Reactor</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // Since we&#39;ll share this between threads we wrap it in a </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // atmically-refcounted- mutex.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> reactor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Mutex</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">reactor</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // We create two tasks:</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // - first parameter is the `reactor`</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // - the second is a timeout in seconds</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // - the third is an `id` to identify the task</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> future1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Task</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">reactor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">clone</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> future2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Task</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">reactor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">clone</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // an `async` block works the same way as an `async fn` in that it compiles</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // our code into a state machine, `yielding` at every `await` point.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> fut1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> val </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> future1</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> dur </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Instant</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">now</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> start</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">as_secs_f32</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Future got </span><span style="color:#89DDFF;">{}</span><span style="color:#C3E88D;"> at time: </span><span style="color:#89DDFF;">{</span><span style="color:#C3E88D;">:.2</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> val</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> dur</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> fut2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> val </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> future2</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> dur </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Instant</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">now</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> start</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">as_secs_f32</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Future got </span><span style="color:#89DDFF;">{}</span><span style="color:#C3E88D;"> at time: </span><span style="color:#89DDFF;">{</span><span style="color:#C3E88D;">:.2</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> val</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> dur</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // Our executor can only run one and one future, this is pretty normal</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // though. You have a set of operations containing many futures that</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // ends up as a single future that drives them all to completion.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> mainfut </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        fut1</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        fut2</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // This executor will block the main thread until the futures is resolved</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">block_on</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mainfut</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // When we&#39;re done, we want to shut down our reactor thread so our program</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // ends nicely.</span></span>
<span class="line"><span style="color:#A6ACCD;">    reactor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">map</span><span style="color:#89DDFF;">(|</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> r</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> r</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">close</span><span style="color:#89DDFF;">()).</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>我添加了一个reactor感兴趣的事件的调试输出，这样我们可以观察到两件事:</p><ol><li><code>Waker</code>这个对象如何像前面我们讨论的trai对象</li><li>事件以何种顺序向reactor注册感兴趣的信息</li></ol><h3 id="async-await和并发async-await" tabindex="-1">Async/Await和并发Async/Await <a class="header-anchor" href="#async-await和并发async-await" aria-label="Permalink to &quot;Async/Await和并发Async/Await&quot;">​</a></h3><p>Async 关键字可以用在 async fn (...)中的函数上，也可以用在 async { ... }中的块上。 两者都可以讲一个函数或者代码块转换成一个<code>Future</code></p><p>这些<code>Future</code>是相当简单的。 想象一下几章前我们的生成器。</p><p>每一个await就像一个yield,只不过不是生成一个值,而是生成Future,然后当轮询的时候返回响应的结果.</p><p>我们的<code>mainfut</code>包含两个<code>non-leaf-future</code>，它将在轮询中调用。<code>non-leaf-future</code>有一个<code>poll</code>方法, 这个方法简单的轮询他自己的内部Future,它内部的Future会被继续轮询,直到<code>leaf-future</code>返回<code>Ready</code>或者<code>Pending</code>.</p><p>就我们现在的例子来看，它并不比常规的同步代码好多少。 对于我们来说，如果需要在同一时间等待多个<code>Future</code>，我们需要<code>spawn</code>它们，以便执行器同时运行它们。</p><p>现在我们的例子返回如下结果:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">Future</span><span style="color:#A6ACCD;"> got </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> at time</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">.</span><span style="color:#F78C6C;">00</span><span style="color:#89DDFF;">.</span></span>
<span class="line"><span style="color:#FFCB6B;">Future</span><span style="color:#A6ACCD;"> got </span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> at time</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">.</span><span style="color:#F78C6C;">00</span><span style="color:#89DDFF;">.</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">Future</span><span style="color:#A6ACCD;"> got </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> at time</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">.</span><span style="color:#F78C6C;">00</span><span style="color:#89DDFF;">.</span></span>
<span class="line"><span style="color:#FFCB6B;">Future</span><span style="color:#A6ACCD;"> got </span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> at time</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">.</span><span style="color:#F78C6C;">00</span><span style="color:#89DDFF;">.</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>请注意，这并不意味着它们需要并行运行。 它们可以并行运行，但没有要求。 请记住，我们正在等待一些外部资源，这样我们就可以在一个线程上发出许多这样的调用，并在事件发生时处理每个事件</p></blockquote><p>现在，我将向您介绍一些更好的资源，以实现一个更好的执行器。 现在你应该已经对<code>Future</code>的概念有了一个很好的理解。</p><p>下一步应该是了解更高级的运行时是如何工作的，以及它们如何实现不同的运行 Futures 的方式。</p><p>如果我是你，我接下来就会读这篇文章，并试着把它应用到我们的例子中去。</p><p>如果我是你，我接下来就会读这篇文章，并试着把它应用到我们的例子中去。</p><p>我希望在阅读完这篇文章后，能够更容易地探索Future和异步，我真的希望你们能够继续深入探索。</p><p>别忘了最后一章的练习。</p><h2 id="八-完整的例子" tabindex="-1">八 完整的例子 <a class="header-anchor" href="#八-完整的例子" aria-label="Permalink to &quot;八 完整的例子&quot;">​</a></h2><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> std</span><span style="color:#89DDFF;">::{</span></span>
<span class="line"><span style="color:#FFCB6B;">    future</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Future</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> pin</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> sync</span><span style="color:#89DDFF;">::{</span><span style="color:#FFCB6B;">mpsc</span><span style="color:#89DDFF;">::{</span><span style="color:#FFCB6B;">channel</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> Sender</span><span style="color:#89DDFF;">},</span><span style="color:#FFCB6B;"> Arc</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> Mutex</span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#FFCB6B;">    task</span><span style="color:#89DDFF;">::{</span><span style="color:#FFCB6B;">Context</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> Poll</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> RawWaker</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> RawWakerVTable</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> Waker</span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#FFCB6B;">    thread</span><span style="color:#89DDFF;">::{</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> JoinHandle</span><span style="color:#89DDFF;">},</span><span style="color:#FFCB6B;"> time</span><span style="color:#89DDFF;">::{</span><span style="color:#FFCB6B;">Duration</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> Instant</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> start </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Instant</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">now</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> reactor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Reactor</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> reactor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Mutex</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">reactor</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> future1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Task</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">reactor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">clone</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> future2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Task</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">reactor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">clone</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> fut1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> val </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> future1</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> dur </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Instant</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">now</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> start</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">as_secs_f32</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Future got </span><span style="color:#89DDFF;">{}</span><span style="color:#C3E88D;"> at time: </span><span style="color:#89DDFF;">{</span><span style="color:#C3E88D;">:.2</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> val</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> dur</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> fut2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> val </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> future2</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> dur </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Instant</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">now</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> start</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">as_secs_f32</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Future got </span><span style="color:#89DDFF;">{}</span><span style="color:#C3E88D;"> at time: </span><span style="color:#89DDFF;">{</span><span style="color:#C3E88D;">:.2</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> val</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> dur</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> mainfut </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        fut1</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        fut2</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">block_on</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mainfut</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    reactor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">map</span><span style="color:#89DDFF;">(|</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> r</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> r</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">close</span><span style="color:#89DDFF;">()).</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// ============================= EXECUTOR ====================================</span></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">block_on</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">F</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Future</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> future</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">F</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">F</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Output</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> mywaker </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">MyWaker</span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> thread</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">current</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">});</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> waker </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">waker_into_waker</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">into_raw</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mywaker</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> cx </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Context</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from_waker</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">waker</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // SAFETY: we shadow `future` so it can&#39;t be accessed again.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> future </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new_unchecked</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> future</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> val </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">loop</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">match</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Future</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">poll</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">future</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">as_mut</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> cx</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">Poll</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Ready</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">val</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">break</span><span style="color:#A6ACCD;"> val</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">Poll</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Pending</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">park</span><span style="color:#89DDFF;">(),</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">    val</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// ====================== FUTURE IMPLEMENTATION ==============================</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">derive</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Clone</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MyWaker</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    thread</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Thread</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">derive</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Clone</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#F78C6C;">pub</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Task</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    id</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    reactor</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Mutex</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Reactor</span><span style="color:#89DDFF;">&gt;&gt;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    data</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    is_registered</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">bool</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mywaker_wake</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#FFCB6B;">MyWaker</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> waker_ptr</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> MyWaker </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> s</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> waker_arc </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from_raw</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">waker_ptr</span><span style="color:#89DDFF;">)};</span></span>
<span class="line"><span style="color:#A6ACCD;">    waker_arc</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unpark</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mywaker_clone</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#FFCB6B;">MyWaker</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">RawWaker</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> arc </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from_raw</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">std</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">mem</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">forget</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">arc</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">clone</span><span style="color:#89DDFF;">());</span><span style="color:#676E95;font-style:italic;"> // increase ref count</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">RawWaker</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">into_raw</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">arc</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">VTABLE</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> VTABLE</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">RawWakerVTable</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">RawWakerVTable</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mywaker_clone</span><span style="color:#89DDFF;">(&amp;*(</span><span style="color:#A6ACCD;">s </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MyWaker</span><span style="color:#89DDFF;">)),</span><span style="color:#676E95;font-style:italic;">     // clone</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mywaker_wake</span><span style="color:#89DDFF;">(&amp;*(</span><span style="color:#A6ACCD;">s </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MyWaker</span><span style="color:#89DDFF;">)),</span><span style="color:#676E95;font-style:italic;">      // wake</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mywaker_wake</span><span style="color:#89DDFF;">(*(</span><span style="color:#A6ACCD;">s </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#FFCB6B;">MyWaker</span><span style="color:#89DDFF;">)),</span><span style="color:#676E95;font-style:italic;">      // wake by ref</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">drop</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from_raw</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MyWaker</span><span style="color:#89DDFF;">)),</span><span style="color:#676E95;font-style:italic;">   // decrease refcount</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">waker_into_waker</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MyWaker</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Waker</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> raw_waker </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">RawWaker</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">VTABLE</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">unsafe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Waker</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from_raw</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">raw_waker</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Task</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">reactor</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Mutex</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Reactor</span><span style="color:#89DDFF;">&gt;&gt;,</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> id</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> Self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">Task</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            id</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            reactor</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            data</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            is_registered</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false,</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Future</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Task</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Output</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">poll</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Pin</span><span style="color:#89DDFF;">&lt;&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> Self</span><span style="color:#89DDFF;">&gt;,</span><span style="color:#A6ACCD;"> cx</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Context</span><span style="color:#89DDFF;">&lt;&#39;</span><span style="color:#FFCB6B;">_</span><span style="color:#89DDFF;">&gt;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Poll</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Self</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Output</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> r </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">reactor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> r</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">is_ready</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">Poll</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Ready</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">is_registered </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">Poll</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Pending</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            r</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">register</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> cx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">waker</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">clone</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">drop</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">r</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">is_registered </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">Poll</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Pending</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// =============================== REACTOR ===================================</span></span>
<span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Reactor</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    dispatcher</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sender</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Event</span><span style="color:#89DDFF;">&gt;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    handle</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Option</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">JoinHandle</span><span style="color:#89DDFF;">&lt;()&gt;&gt;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    readylist</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Mutex</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Vec</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">&gt;&gt;&gt;,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">#[</span><span style="color:#A6ACCD;">derive</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Debug</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#C792EA;">enum</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Event</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Close</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">Timeout</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Waker</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Reactor</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> Self </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tx</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> rx</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">channel</span><span style="color:#89DDFF;">::&lt;</span><span style="color:#FFCB6B;">Event</span><span style="color:#89DDFF;">&gt;();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> readylist </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Arc</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Mutex</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">new</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">vec!</span><span style="color:#89DDFF;">[]));</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> rl_clone </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> readylist</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">clone</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> handles </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">vec!</span><span style="color:#89DDFF;">[];</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> handle </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">spawn</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">move</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">            // This simulates some I/O resource</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> event </span><span style="color:#F78C6C;">in</span><span style="color:#A6ACCD;"> rx </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">println!</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">REACTOR: </span><span style="color:#89DDFF;">{</span><span style="color:#C3E88D;">:?</span><span style="color:#89DDFF;">}&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> event</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> rl_clone </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> rl_clone</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">clone</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">match</span><span style="color:#A6ACCD;"> event </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#FFCB6B;">Event</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Close</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">break</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#FFCB6B;">Event</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Timeout</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">waker</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> duration</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> id</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> event_handle </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">spawn</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">move</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#FFCB6B;">thread</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Duration</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">from_secs</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">duration</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">                            rl_clone</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">map</span><span style="color:#89DDFF;">(|</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> rl</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> rl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">push</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">)).</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                            waker</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">wake</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                        handles</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">push</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">event_handle</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> handle </span><span style="color:#F78C6C;">in</span><span style="color:#A6ACCD;"> handles </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                handle</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">Reactor</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            readylist</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            dispatcher</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> tx</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            handle</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Some</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">handle</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">register</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> duration</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">u64</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> waker</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Waker</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">dispatcher</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">send</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Event</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">Timeout</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">waker</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> duration</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">close</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">dispatcher</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">send</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Event</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Close</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">is_ready</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> id_to_check</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">usize</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">bool</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">readylist</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">map</span><span style="color:#89DDFF;">(|</span><span style="color:#A6ACCD;">rl</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> rl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">iter</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">any</span><span style="color:#89DDFF;">(|</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">id </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> id_to_check</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">impl</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Drop</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Reactor</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">fn</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">drop</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#C792EA;">mut</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">handle</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">take</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">map</span><span style="color:#89DDFF;">(|</span><span style="color:#A6ACCD;">h</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> h</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">()).</span><span style="color:#82AAFF;">unwrap</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br></div></div><h2 id="九-结论和练习" tabindex="-1">九 结论和练习 <a class="header-anchor" href="#九-结论和练习" aria-label="Permalink to &quot;九 结论和练习&quot;">​</a></h2><p>我们的实现采取了一些明显的捷径，可以使用一些改进。 实际上，深入研究代码并自己尝试一些事情是一个很好的学习方式。 如果你想探索更多，这里有一些很好的练习</p><h3 id="编码park" tabindex="-1">编码park <a class="header-anchor" href="#编码park" aria-label="Permalink to &quot;编码park&quot;">​</a></h3><p>使用 Thread: : park 和 Thread: : unpark 的大问题是用户可以从自己的代码访问这些相同的方法。 尝试使用另一种方法来挂起线程并根据我们的命令再次唤醒它。 一些提示:</p><ul><li><a href="https://doc.rust-lang.org/stable/std/sync/struct.Condvar.html" target="_blank" rel="noreferrer">std::sync::CondVar</a></li><li><a href="https://github.com/crossbeam-rs/crossbeam" target="_blank" rel="noreferrer">crossbeam::sync::Parker</a></li></ul><h3 id="编码传递reactor" tabindex="-1">编码传递reactor <a class="header-anchor" href="#编码传递reactor" aria-label="Permalink to &quot;编码传递reactor&quot;">​</a></h3><p>避免包装整个Reactor in a mutex and pass it around 在互斥对象中传递</p><p>首先，保护整个reactor并传递它是过分的。 我们只对同步它包含的部分信息感兴趣。 尝试将其重构出来，只同步访问真正需要的内容。</p><p>我建议您看看<a href="https://github.com/async-rs/async-std/blob/master/src/net/driver/mod.rs" target="_blank" rel="noreferrer">async_std驱动程序</a>是如何实现的，以及<a href="https://github.com/tokio-rs/tokio/blob/master/tokio/src/runtime/basic_scheduler.rs" target="_blank" rel="noreferrer">tokio调度程序</a>是如何实现的，以获得一些灵感。</p><ul><li>你想使用Arc来传递这些信息的引用?</li><li>你是否想创建一个全局的reactor,这样他可以随时随地被访问?</li></ul><h3 id="创建一个更好的执行器" tabindex="-1">创建一个更好的执行器 <a class="header-anchor" href="#创建一个更好的执行器" aria-label="Permalink to &quot;创建一个更好的执行器&quot;">​</a></h3><p>现在我们只支持一个一个Future运行. 大多数运行时都有一个spawn函数,让你能够启动一个future,然后await它. 这样你就可以同时运行多个Future.</p><p>正如我在本书开头所建议的那样，访问<a href="https://stjepang.github.io/2020/01/31/build-your-own-executor.html" target="_blank" rel="noreferrer">stjepan 的博客系列</a>，了解如何实现你自己的执行者，是我将要开始的地方，并从那里开始。</p><h3 id="进一步阅读" tabindex="-1">进一步阅读 <a class="header-anchor" href="#进一步阅读" aria-label="Permalink to &quot;进一步阅读&quot;">​</a></h3><ul><li><p><a href="https://rust-lang.github.io/async-book/01_getting_started/01_chapter.html" target="_blank" rel="noreferrer">The official Asyc book</a></p></li><li><p><a href="https://book.async.rs/" target="_blank" rel="noreferrer"> The async_std book</a></p></li><li><p><a href="https://aturon.github.io/blog/2016/09/07/futures-design/" target="_blank" rel="noreferrer">Aron Turon: Designing futures for Rust</a></p></li><li><p><a href="https://www.infoq.com/presentations/rust-2019/" target="_blank" rel="noreferrer">Steve Klabnik&#39;s presentation: Rust&#39;s journey to Async/Await</a></p></li><li><p><a href="https://tokio.rs/blog/2019-10-scheduler/" target="_blank" rel="noreferrer">The Tokio Blog</a></p></li><li><p><a href="https://stjepang.github.io/" target="_blank" rel="noreferrer">Stjepan&#39;s blog with a series where he implements an Executor</a></p></li><li><p><a href="https://youtu.be/DkMwYxfSYNQ" target="_blank" rel="noreferrer">Jon Gjengset&#39;s video on The Why, What and How of Pinning in Rust</a> 有中英文字幕的<a href="https://www.bilibili.com/video/BV1tK411L7s5/" target="_blank" rel="noreferrer">B站链接</a></p></li><li><p><a href="https://boats.gitlab.io/blog/post/2018-01-25-async-i-self-referential-structs/" target="_blank" rel="noreferrer">Withoutboats blog series about async/await</a></p></li></ul><h2 id="转载说明" tabindex="-1">转载说明 <a class="header-anchor" href="#转载说明" aria-label="Permalink to &quot;转载说明&quot;">​</a></h2><p>本文允许转载,但是请注明出处.作者:stevenbai 本人博客:<a href="https://stevenbai.top/" target="_blank" rel="noreferrer">https://stevenbai.top/</a></p><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p>栈拷贝,指针等问题 <a href="#fnref1" class="footnote-backref">↩︎</a></p></li></ol></section></div></div></main><footer class="VPDocFooter" data-v-c4b0d3cf data-v-face870a><!--[--><!--]--><!----><div class="prev-next" data-v-face870a><div class="pager" data-v-face870a><a class="pager-link prev" href="/rust/Futures_Explained_in_200_lines_of_Rust.html" data-v-face870a><span class="desc" data-v-face870a>Previous page</span><span class="title" data-v-face870a>200行代码讲透Rust Futures</span></a></div><div class="has-prev pager" data-v-face870a><a class="pager-link next" href="/rust/lock-freedom-without-garbage-collection.html" data-v-face870a><span class="desc" data-v-face870a>Next page</span><span class="title" data-v-face870a>Rust无锁编程</span></a></div></div></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"app_security_android_howto_protected_unexported_components.md\":\"49da8f96\",\"app_security_identity_confusion_in_webview-based_mobile_app-in-app_ecosystems.md\":\"c8c23f72\",\"app_security_android_13_dp1_changes_security.md\":\"ee93db26\",\"app_security_android_lce_third_party.md\":\"3a106c21\",\"app_security_android_access_protected_components.md\":\"de9381f2\",\"app_security_index.md\":\"ac4a3f31\",\"app_security_hook_rest_for_work.md\":\"be99bf39\",\"app_security_bilibili_arbitrary_code_execution.md\":\"fe8481e9\",\"app_security_tiktok_arbitrary_code_execution.md\":\"d0b7470d\",\"app_security_tiktok_theft_of_arbitrary.md\":\"075a56af\",\"app_security_white_box_cryptography.md\":\"5c7e50ae\",\"app_security_tiktok_arbitrary_code_execution_download_service.md\":\"514e5d1d\",\"app_security_use_cryptography_in_mobile_appls_the_right_way.md\":\"bd3d61ff\",\"blockchain_block_chain_core_index.md\":\"e6ebc4f1\",\"blockchain_block_chain_core_ecc_signature_random.md\":\"1ad99310\",\"blockchain_btcd_bitcoin script.md\":\"b9be54b5\",\"blockchain_btcd_bloom.md\":\"646e9b64\",\"blockchain_btcd_index.md\":\"62a4572e\",\"blockchain_btcd_mempool.md\":\"d852bae4\",\"blockchain_btcd_database.md\":\"5b5f111c\",\"blockchain_btcd_btcjson.md\":\"f447e956\",\"blockchain_btcd_indexer模块.md\":\"517ac46e\",\"blockchain_btcd_mining.md\":\"571ced99\",\"blockchain_btcd_peer.md\":\"986c5707\",\"blockchain_btcd_mrumap.md\":\"2ca1b2e7\",\"blockchain_btcd_wire_common.md\":\"89f73d7b\",\"blockchain_btcd_一个比特币脚本示例.md\":\"627ef807\",\"blockchain_btcd_rpcclient.md\":\"2313197a\",\"blockchain_block_chain_core_vrf.md\":\"e4a91aac\",\"blockchain_btcd_比特币指令集说明.md\":\"f75cf776\",\"blockchain_btcd_比特币的地址类型.md\":\"1bb3b24c\",\"blockchain_btcd_隔离见证.md\":\"cfcb6915\",\"blockchain_btcd_比特币解锁脚本中的scriptsignature都包含了什么东西.md\":\"8968b05d\",\"blockchain_btcwallet_chain模块.md\":\"d6d2f342\",\"blockchain_btcwallet_btcwallet系列之一-grpc模块.md\":\"f2d23b55\",\"blockchain_btcwallet_readme.md\":\"ae4c0e92\",\"blockchain_btcwallet_index.md\":\"09f0cfa0\",\"blockchain_btcwallet_snacl.md\":\"ed618695\",\"blockchain_btcwallet_hdwallet-bip0032.md\":\"4a93fb82\",\"blockchain_btcwallet_waddrmgr模块.md\":\"62a4bfd9\",\"blockchain_btcwallet_walletdb.md\":\"c4ba2763\",\"blockchain_btcwallet_wallet模块.md\":\"98f32d8f\",\"blockchain_btcwallet_wallet中的数据库设计.md\":\"d0e90dad\",\"blockchain_btcwallet_wtxmgr模块.md\":\"e93ee3d4\",\"blockchain_btcwallet_拓扑排序在比特币tx管理中的使用.md\":\"9e946254\",\"blockchain_ethereum_crosschainatomicexchange.md\":\"b9292e56\",\"blockchain_ethereum_btc跨链设计.md\":\"f9f20f8f\",\"blockchain_ethereum_ethereum_erc20_wrapper.md\":\"448bceef\",\"blockchain_ethereum_how_to_create_channel.md\":\"b67714f1\",\"blockchain_ethereum_golang subprocess tests.md\":\"29e6940d\",\"blockchain_ethereum_index.md\":\"85d51f83\",\"blockchain_ethereum_raiden_graph.md\":\"bb20a0a3\",\"blockchain_ethereum_golang_plugin.md\":\"ab1fad5d\",\"blockchain_ethereum_synapse代码阅读.md\":\"22352390\",\"blockchain_ethereum_solidity_mapping_implementation.md\":\"fbfe9b40\",\"blockchain_ethereum_meshbox配置 openwrt.md\":\"da7dcd77\",\"blockchain_ethereum_thedao.md\":\"db63a6f2\",\"blockchain_ethereum_how_to_use_channel.md\":\"e5ec7097\",\"blockchain_ethereum_区块链问题笔记.md\":\"71e3664f\",\"blockchain_ethereum_区块链计时器.md\":\"1bdf98a0\",\"blockchain_ethereum_从一次盗币事件再谈合约安全问题.md\":\"5ad9a657\",\"blockchain_ethereum_多链工作问题.md\":\"7c1455fe\",\"blockchain_ethereum_如何为 smartraiden 贡献代码.md\":\"9792ca14\",\"blockchain_ethereum_并发和并行的区别.md\":\"49988d7f\",\"blockchain_ethereum_君士坦丁堡分叉引起的安全问题.md\":\"2f224b3b\",\"blockchain_ethereum_异常退出各种情况.md\":\"c22e1865\",\"blockchain_ethereum_安全总结.md\":\"578991fd\",\"blockchain_ethereum_如何使用 smartraiden 以及 lnd 进行跨链原子资产交换.md\":\"cc563363\",\"blockchain_ethereum_如何使用 dlv 调试 smartraiden.md\":\"d2ec78ad\",\"blockchain_ethereum_比特币的txhash为什么会发生改变.md\":\"1f12aaab\",\"blockchain_ethereum_合约注意事项.md\":\"3c14037c\",\"blockchain_ethereum_让photon支持go module.md\":\"ea4be6a4\",\"blockchain_ethereum_以太坊evm笔记.md\":\"07df4141\",\"blockchain_ethereum_闪电网络交易密钥.md\":\"0d8062f9\",\"blockchain_index.md\":\"faec0783\",\"blockchain_ethereum_我对 smartplasma 的理解.md\":\"11fe0db7\",\"blockchain_libra_1.start_in_one_minute.md\":\"109fc4e0\",\"blockchain_ethereum_闪电网络.md\":\"885df916\",\"blockchain_libra_2.protobuf_in_libria.md\":\"2a6b01c9\",\"blockchain_libra_4.client_command_and_libriadb.md\":\"437982d4\",\"blockchain_libra_3.libra_schema.md\":\"bc95036c\",\"blockchain_libra_5.libra_ac.md\":\"c605f14d\",\"blockchain_libra_6.libria_mempool_1.md\":\"03918e7a\",\"blockchain_solidity_memory_layout.md\":\"7c6bc652\",\"blockchain_libra_index.md\":\"0bc4af07\",\"blockchain_libra_7.libra_mempool_2.md\":\"92131850\",\"other_apt安装指定版本软件.md\":\"0ec38d3e\",\"index.md\":\"25da461c\",\"blockchain_libra_9.libria_vrf.md\":\"83871d19\",\"other_crossover source insight 4.0使用.md\":\"867d28a8\",\"other_brew安装指定版本boost.md\":\"5e911538\",\"other_clean_mac.md\":\"b8fea38b\",\"other_dynamic_tracing.md\":\"38e54181\",\"other_capture_with_wireshark_for_android.md\":\"8fd0dd4d\",\"other_git以及github回退.md\":\"d0e26431\",\"other_go_memory_model.md\":\"c7f14c80\",\"other_hugo博客写作.md\":\"de09579b\",\"other_how_to_mine_smt_2022.md\":\"07610bb8\",\"other_index.md\":\"6cde96d7\",\"blockchain_libra_8.libria_mempool_3.md\":\"aef9f61a\",\"other_asynq_introduction.md\":\"acc430e6\",\"other_grpcox.md\":\"4b89c4dc\",\"other_learn_go.md\":\"fff12b4b\",\"blockchain_solidity_solidity_yul.md\":\"e9bf0c8d\",\"other_opcua_cross_compile_for_raspeberry.md\":\"95971a39\",\"other_opc 统一架构学习笔记.md\":\"711bfea3\",\"other_opcua-rust.md\":\"214960cc\",\"other_learningpythonv4.md\":\"7d9b1c0c\",\"other_rcore_os_program.md\":\"14f6252e\",\"other_read_kerenel_use_clion.md\":\"7b1fa474\",\"other_vscode_cnblog_plugin.md\":\"208c9e68\",\"other_typescript_advanced_syntax.md\":\"a7cfb58b\",\"other_不用外部插件启用u盘ntfs写功能.md\":\"8195c963\",\"other_webassembly_two_days_exercise.md\":\"2b8a77f4\",\"other_工作中常用工具入门.md\":\"cf6d352b\",\"other_使用ubuntu搭建时间机器备份服务.md\":\"8852ffe5\",\"other_使用clion调试开发比特币源码.md\":\"51b884c7\",\"other_五个goland进行go开发的小技巧.md\":\"ce68ee58\",\"other_用 go 写 webassembly入门.md\":\"4ad882be\",\"other_windows_hook_thiscall.md\":\"7a5784eb\",\"other_高性能go开发.md\":\"06d41d3d\",\"other_阈值签名.md\":\"f8b6f03f\",\"rust-leetcode_2019-06-01.md\":\"16ae288e\",\"rust-leetcode_2019-06-02.md\":\"6d7dd0ea\",\"rust-leetcode_2019-06-04.md\":\"391987ed\",\"rust-leetcode_2019-06-03.md\":\"855fcb94\",\"rust-leetcode_2019-06-06.md\":\"d4238f5a\",\"rust-leetcode_2019-06-05.md\":\"4314e088\",\"rust-leetcode_2019-06-08.md\":\"d4e473be\",\"rust-leetcode_2019-06-07.md\":\"ab77c500\",\"rust-leetcode_2019-06-10.md\":\"0ddb2268\",\"rust-leetcode_2019-06-11.md\":\"e940550e\",\"rust-leetcode_2019-06-14.md\":\"d5d66e42\",\"rust-leetcode_2019-06-15.md\":\"bd688825\",\"rust-leetcode_2019-06-17.md\":\"01793cf8\",\"rust-leetcode_2019-08-10.md\":\"c528f79e\",\"rust-leetcode_2019-08-12.md\":\"9ff97e95\",\"rust-leetcode_2019-08-11.md\":\"3539cee5\",\"rust-leetcode_2019-08-13.md\":\"cf13edb9\",\"rust-leetcode_2019-06-18.md\":\"cf09cbbc\",\"rust-leetcode_2019-08-04.md\":\"a4964246\",\"rust-leetcode_2019-08-14.md\":\"c88f3170\",\"rust-leetcode_2019-08-15.md\":\"c2ece05f\",\"rust-leetcode_2019-08-16.md\":\"c246e9bd\",\"rust-leetcode_2019-08-17.md\":\"3bc92be3\",\"rust-leetcode_2019-08-18.md\":\"5bf95c31\",\"rust-leetcode_2019-08-19.md\":\"0a6f75cc\",\"rust-leetcode_2019-08-21.md\":\"9b9eaff2\",\"rust-leetcode_2019-08-22.md\":\"429c5a62\",\"rust-leetcode_2019-08-20.md\":\"05507fe2\",\"rust-leetcode_2019-08-23.md\":\"bba90dff\",\"rust-leetcode_2019-08-30.md\":\"3a138724\",\"rust-leetcode_2019-08-29.md\":\"260c7d07\",\"rust-leetcode_2019-08-27.md\":\"5f49a5fc\",\"rust-leetcode_2019-08-26.md\":\"c4a90440\",\"rust-leetcode_2019-09-02.md\":\"e6670dd2\",\"rust-leetcode_2019-08-28.md\":\"973c333c\",\"rust-leetcode_2019-09-04.md\":\"192987cc\",\"rust-leetcode_2019-09-03.md\":\"f05f2709\",\"rust-leetcode_2019-09-05.md\":\"d7f2e4f7\",\"rust-leetcode_2019-09-06.md\":\"6e0a686e\",\"rust-leetcode_2019-09-09.md\":\"2037c60f\",\"rust-leetcode_2019-09-10.md\":\"c4d03f20\",\"rust-leetcode_2019-09-12.md\":\"92140690\",\"rust-leetcode_2019-09-13.md\":\"d0096c07\",\"rust-leetcode_2019-09-11.md\":\"f8c2c422\",\"rust-leetcode_2019-09-18.md\":\"eac9a217\",\"rust-leetcode_2019-09-19.md\":\"18ff1df5\",\"rust-leetcode_2019-09-20.md\":\"0bcd7b92\",\"rust-leetcode_2019-09-16.md\":\"1e444157\",\"rust-leetcode_2019-09-23.md\":\"8c286b5d\",\"rust-leetcode_2019-09-17.md\":\"b7c7f738\",\"rust-leetcode_2019-09-26.md\":\"5e8183c6\",\"rust-leetcode_2019-09-27.md\":\"c4764b3c\",\"rust-leetcode_2019-09-25.md\":\"2c9b2794\",\"rust-leetcode_2019-09-24.md\":\"967a3904\",\"rust-leetcode_2019-09-28.md\":\"ecfbce92\",\"rust-leetcode_2019-10-09.md\":\"4d19e768\",\"rust-leetcode_2019-10-08.md\":\"afe45510\",\"rust-leetcode_2019-10-10.md\":\"f3aa78e3\",\"rust-leetcode_2019-10-11.md\":\"3efda8fc\",\"rust-leetcode_2019-10-15.md\":\"aa22705f\",\"rust-leetcode_2019-10-16.md\":\"416ae06a\",\"rust-leetcode_2019-10-14.md\":\"ad0dffc7\",\"rust-leetcode_2019-10-18.md\":\"ce5c2679\",\"rust-leetcode_2019-10-19.md\":\"21e12fdc\",\"rust-leetcode_2019-10-17.md\":\"8b83b9ea\",\"rust-leetcode_2019-10-22.md\":\"16349681\",\"rust-leetcode_2019-10-23.md\":\"e9f69e86\",\"rust-leetcode_2019-10-24.md\":\"d6dde3e5\",\"rust-leetcode_2019-10-21.md\":\"2c2d2981\",\"rust-leetcode_2019-10-29.md\":\"654b8240\",\"rust-leetcode_2019-10-25.md\":\"6d20d401\",\"rust-leetcode_2019-10-28.md\":\"9d106d9f\",\"rust-leetcode_2019-10-30.md\":\"dd939d6c\",\"rust-leetcode_2019-11-01.md\":\"0f07b88e\",\"rust-leetcode_2019-11-04.md\":\"95c8a91b\",\"rust-leetcode_2019-11-06.md\":\"86b298f6\",\"rust-leetcode_2019-11-05.md\":\"e530a56d\",\"rust-leetcode_2019-11-08.md\":\"ab853ce2\",\"rust-leetcode_2019-11-07.md\":\"fab1be95\",\"rust-leetcode_2019-11-11.md\":\"dd0d9e86\",\"rust-leetcode_2019-11-12.md\":\"a73c6f78\",\"rust-leetcode_2019-11-14.md\":\"2370a1e6\",\"rust-leetcode_2019-11-13.md\":\"e8d34a5a\",\"rust-leetcode_2019-11-20.md\":\"04a0a97b\",\"rust-leetcode_2019-11-19.md\":\"6cc9566c\",\"rust-leetcode_2019-11-21.md\":\"724469d8\",\"rust-leetcode_2019-11-25.md\":\"e822dada\",\"rust-leetcode_2019-11-15.md\":\"903fc37b\",\"rust-leetcode_2019-11-18.md\":\"8f592072\",\"rust-leetcode_2019-11-22.md\":\"e33b446b\",\"rust-leetcode_2019-11-28.md\":\"152beca7\",\"rust-leetcode_2019-11-29.md\":\"6932211a\",\"rust-leetcode_2019-11-27.md\":\"eab62afc\",\"rust-leetcode_2019-12-02.md\":\"44edb5de\",\"rust-leetcode_2019-12-05.md\":\"d0852dd4\",\"rust-leetcode_2019-12-03.md\":\"436b31e8\",\"rust-leetcode_2019-11-26.md\":\"f4856d06\",\"rust-leetcode_2019-12-06.md\":\"68362b11\",\"rust-leetcode_2019-12-04.md\":\"06a1166a\",\"rust-leetcode_2019-12-11.md\":\"5723525d\",\"rust-leetcode_2019-10-31.md\":\"a66fec84\",\"rust-leetcode_2019-12-12.md\":\"f33bdb54\",\"rust-leetcode_2019-12-10.md\":\"7b82d5b0\",\"rust-leetcode_2019-12-09.md\":\"a4ab0a2c\",\"rust-leetcode_2019-12-16.md\":\"80aa7bfb\",\"rust-leetcode_2019-12-17.md\":\"853f45ce\",\"rust-leetcode_2019-12-13.md\":\"502129f0\",\"rust-leetcode_2019-12-19.md\":\"2a7c6a75\",\"rust-leetcode_2019-12-23.md\":\"3a00cc39\",\"rust-leetcode_2019-12-18.md\":\"b90be337\",\"rust-leetcode_2019-12-20.md\":\"f0008c00\",\"rust-leetcode_2019-12-24.md\":\"334209a1\",\"rust-leetcode_2019-12-25.md\":\"8abbd9a3\",\"rust-leetcode_2019-12-27.md\":\"2763b849\",\"rust-leetcode_2019-12-26.md\":\"45ad65bb\",\"rust-leetcode_2020-01-01.md\":\"0f76518a\",\"rust-leetcode_2019-12-30.md\":\"c5be12a2\",\"rust-leetcode_2019-12-31.md\":\"11f814a7\",\"rust-leetcode_2020-01-03.md\":\"9690b22d\",\"rust-leetcode_2020-01-06.md\":\"a7eb9848\",\"rust-leetcode_2020-01-09.md\":\"d789198b\",\"rust-leetcode_2020-01-02.md\":\"536550e1\",\"rust-leetcode_2020-01-07.md\":\"807b50a1\",\"rust-leetcode_2020-01-08.md\":\"f478a510\",\"rust-leetcode_2020-01-13.md\":\"87a7664b\",\"rust-leetcode_2020-01-15.md\":\"6276a9f3\",\"rust-leetcode_2020-01-16.md\":\"affb3aa2\",\"rust-leetcode_2020-01-10.md\":\"9b6381b4\",\"rust-leetcode_2020-01-14.md\":\"18b76fc6\",\"rust-leetcode_2020-01-17.md\":\"1a5287f7\",\"rust-leetcode_2020-01-20.md\":\"05790bbe\",\"rust-leetcode_2020-01-23.md\":\"17c5a68e\",\"rust-leetcode_2020-01-21.md\":\"95214e06\",\"rust-leetcode_2020-01-24.md\":\"3f435bec\",\"rust-leetcode_2020-01-22.md\":\"91b27707\",\"rust-leetcode_2020-02-04.md\":\"2d449627\",\"rust-leetcode_2020-02-03.md\":\"6ca2754a\",\"rust-leetcode_2020-02-05.md\":\"0863ba24\",\"rust-leetcode_2020-02-06.md\":\"d7c50807\",\"rust-leetcode_2020-02-10.md\":\"72d73b67\",\"rust-leetcode_2020-02-07.md\":\"758fd3e3\",\"rust-leetcode_2020-02-12.md\":\"978d6f31\",\"rust-leetcode_2020-02-11.md\":\"c93c5aa8\",\"rust-leetcode_2020-02-14.md\":\"03343223\",\"rust-leetcode_2020-02-18.md\":\"786d1b93\",\"rust-leetcode_2020-02-13.md\":\"31f6fed0\",\"rust-leetcode_2020-02-17.md\":\"ac764dd9\",\"rust-leetcode_2020-02-19.md\":\"2114dc4a\",\"rust-leetcode_2020-02-20.md\":\"8acdea29\",\"rust-leetcode_2020-02-21.md\":\"519af5a5\",\"rust-leetcode_2020-02-25.md\":\"83f68959\",\"rust-leetcode_2020-02-24.md\":\"f7c24a8c\",\"rust-leetcode_2020-02-27.md\":\"4829b572\",\"rust-leetcode_2020-02-26.md\":\"e6525009\",\"rust-leetcode_2020-02-28.md\":\"1270ecc6\",\"rust-leetcode_2020-03-02.md\":\"2ef755bd\",\"rust-leetcode_2020-03-04.md\":\"cdaa575a\",\"rust-leetcode_2020-03-05.md\":\"5b0dfec1\",\"rust-leetcode_2020-03-03.md\":\"503ff63b\",\"rust-leetcode_2020-03-06.md\":\"750b725c\",\"rust-leetcode_2020-03-09.md\":\"8649fc96\",\"rust-leetcode_2020-03-10.md\":\"05846f6e\",\"rust-leetcode_2020-03-12.md\":\"570aed71\",\"rust-leetcode_2020-03-13.md\":\"441297b3\",\"rust-leetcode_2020-03-16.md\":\"31580902\",\"rust-leetcode_2020-03-11.md\":\"0dd755e5\",\"rust-leetcode_2020-03-17.md\":\"d010fda0\",\"rust-leetcode_2020-03-18.md\":\"91235ef5\",\"rust-leetcode_2020-03-23.md\":\"743e86fa\",\"rust-leetcode_2020-03-24.md\":\"3f213197\",\"rust-leetcode_2020-03-19.md\":\"7f204d89\",\"rust-leetcode_2020-03-25.md\":\"f6b58ecd\",\"rust-leetcode_2020-03-26.md\":\"b21299a6\",\"rust-leetcode_2020-03-20.md\":\"a094ab12\",\"rust-leetcode_2020-03-27.md\":\"8e15c8dd\",\"rust-leetcode_2020-03-30.md\":\"f41dcb6e\",\"rust-leetcode_index.md\":\"55d94bcc\",\"rust-leetcode_模板.md\":\"afa1fad3\",\"rust-leetcode_2020-03-31.md\":\"4ff9ecd9\",\"rust-leetcode_2020-07-09.md\":\"811dd29e\",\"rust_futures_explained_in_200_lines_of_rust2.md\":\"c4726410\",\"rust_index.md\":\"401f0a2c\",\"rust_convert_an_integer_to_an_enum.md\":\"2e80b79f\",\"rust_build_your_own_block_on.md\":\"d0352568\",\"rust_ownership101.md\":\"9e28db8e\",\"rust_rnats_1.start.md\":\"9ed06d36\",\"rust_build_your_own_executor.md\":\"98293138\",\"rust_my_note.md\":\"08c67a02\",\"rust_rnats_4.server.md\":\"9e131927\",\"rust_rnats_3.sublist.md\":\"ad28ef87\",\"rust_rnats_index.md\":\"7e7bf395\",\"rust_lock-freedom-without-garbage-collection.md\":\"420ed5ea\",\"rust_rnats_ppt_index.md\":\"058b61fe\",\"rust_rnats_ppt_从零实现消息中间件-client.md\":\"73950b3f\",\"rust_rnats_ppt_从零实现消息中间件-server.client.md\":\"ed1e7150\",\"rust_rnats_5.server.client.md\":\"f4eb09f4\",\"rust_rnats_ppt_从零实现消息中间件-server.md\":\"7a40937b\",\"rust_rnats_2.parser.md\":\"492f5140\",\"rust_futures_explained_in_200_lines_of_rust.md\":\"cee3dc9e\",\"rust_rnats_6.client.md\":\"78c13a92\",\"rust_rust开发工具.md\":\"fb55139f\",\"rust_rust_global_function_pointer.md\":\"492eeb27\",\"rust_rust_atomic.md\":\"e1b68356\",\"rust_rust_async_lock.md\":\"05e9dece\",\"rust_交叉编译rust.md\":\"ed388daa\",\"static_analysis_index.md\":\"011091a8\",\"static_analysis_clang_ast.md\":\"d5187992\",\"static_analysis_llvm_overview.md\":\"122f441d\",\"rust_tokio_async_await 初探.md\":\"3230601c\",\"rust_tokio笔记.md\":\"6d1507eb\",\"web-security_sql_inject_chinese_gbk.md\":\"0c8c1863\",\"static_analysis_using_clang_tidy_for_custom_checkers.md\":\"8b6308f9\",\"web-security_index.md\":\"4f40f0a9\",\"system_armv8v9_arch_csdn.md\":\"b55ab723\",\"web-security_gokart.md\":\"47e32892\",\"static_analysis_mariana-introduction.md\":\"f7e8afa8\",\"static_analysis_llvm_programmers_mannual.md\":\"1d1d1692\",\"rust_futures_explained_in_200_lines_of_rust_with_error_version.md\":\"d72871ec\"}")
__VP_SITE_DATA__ = JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"Steven's Blog\",\"description\":\"steven's Blog\",\"base\":\"/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"repo\":\"nkbai/blog-vitepress\",\"docsDir\":\"docs\",\"docsBranch\":\"master\",\"logo\":\"logo.png\",\"editLinks\":false,\"editLinkText\":\"编辑本文\",\"lastUpdated\":\"上次更新\",\"nav\":[{\"i\":\"web安全相关\",\"l\":\"/web-security/\",\"date\":\"2022-02-03T09:57:03+08:00\",\"text\":\"web安全相关\",\"link\":\"/web-security/\"},{\"i\":\"block chain\",\"l\":\"/blockchain/\",\"date\":\"2022-01-08T01:19:42.000Z\",\"text\":\"block chain\",\"link\":\"/blockchain/\",\"children\":[{\"i\":\"libra\",\"l\":\"/blockchain/libra/\",\"date\":\"2022-01-08T01:19:42.000Z\",\"text\":\"libra\",\"link\":\"/blockchain/libra/\"},{\"i\":\"区块链核心技术\",\"l\":\"/blockchain/block_chain_core/\",\"date\":\"2019-06-16T11:57:03+08:00\",\"text\":\"区块链核心技术\",\"link\":\"/blockchain/block_chain_core/\"},{\"i\":\"btc wallet系列\",\"l\":\"/blockchain/btcwallet/\",\"date\":\"2019-05-23T01:07:52.193125+00:00\",\"text\":\"btc wallet系列\",\"link\":\"/blockchain/btcwallet/\"},{\"i\":\"以太坊\",\"l\":\"/blockchain/ethereum/\",\"date\":\"2019-04-25T09:39:46.982579+00:00\",\"text\":\"以太坊\",\"link\":\"/blockchain/ethereum/\"},{\"i\":\"btcd系列\",\"l\":\"/blockchain/btcd/\",\"date\":\"2018-11-11T10:40:47+00:00\",\"text\":\"btcd系列\",\"link\":\"/blockchain/btcd/\"}]},{\"i\":\"静态分析\",\"l\":\"/static_analysis/\",\"date\":\"2022-01-08T01:19:42.000Z\",\"text\":\"静态分析\",\"link\":\"/static_analysis/\"},{\"i\":\"泛app安全\",\"l\":\"/app_security/\",\"date\":\"2022-01-05T09:57:03+08:00\",\"text\":\"泛app安全\",\"link\":\"/app_security/\"},{\"i\":\"leetcode\",\"l\":\"/rust-leetcode/\",\"date\":\"2020-07-09T03:57:03+08:00\",\"text\":\"leetcode\",\"link\":\"/rust-leetcode/\"},{\"i\":\"rust\",\"l\":\"/rust/\",\"date\":\"2019-04-03T11:57:03+08:00\",\"text\":\"rust\",\"link\":\"/rust/\",\"children\":[{\"i\":\"从零实现消息中间件\",\"l\":\"/rust/rnats/\",\"date\":\"2019-01-30T11:57:03+08:00\",\"text\":\"从零实现消息中间件\",\"link\":\"/rust/rnats/\",\"children\":[{\"i\":\"rnats ppt\",\"l\":\"/rust/rnats/ppt/\",\"date\":\"2020-01-31T09:57:03+08:00\",\"text\":\"rnats ppt\",\"link\":\"/rust/rnats/ppt/\"}]}]},{\"i\":\"other\",\"l\":\"/other/\",\"date\":\"2018-11-20T04:15:04+00:00\",\"text\":\"other\",\"link\":\"/other/\"}],\"sidebar\":{\"/web-security/\":[{\"i\":\"gokart速读笔记\",\"date\":\"2022-07-10T09:57:03+08:00\",\"f\":1,\"text\":\"gokart速读笔记\",\"link\":\"/web-security/gokart.html\"},{\"i\":\"sql注入之GBK编码\",\"date\":\"2022-01-05T09:57:03+08:00\",\"f\":1,\"text\":\"sql注入之GBK编码\",\"link\":\"/web-security/sql_inject_chinese_gbk.html\"}],\"/blockchain/\":[{\"i\":\"libra\",\"l\":\"/blockchain/libra/\",\"date\":\"2022-01-08T01:19:42.000Z\",\"text\":\"libra\",\"link\":\"/blockchain/libra/\",\"children\":[{\"i\":\"9.libra中的vrf\",\"date\":\"2019-07-05T09:55:01+08:00\",\"f\":1,\"text\":\"9.libra中的vrf\",\"link\":\"/blockchain/libra/9.libria_vrf.html\"},{\"i\":\"8.libra的mempool模块解读-3\",\"date\":\"2019-07-04T11:00:34+08:00\",\"f\":1,\"text\":\"8.libra的mempool模块解读-3\",\"link\":\"/blockchain/libra/8.libria_mempool_3.html\"},{\"i\":\"7.libra的mempool模块解读-2\",\"date\":\"2019-07-03T11:00:34+08:00\",\"f\":1,\"text\":\"7.libra的mempool模块解读-2\",\"link\":\"/blockchain/libra/7.libra_mempool_2.html\"},{\"i\":\"6.libra的mempool模块解读-1\",\"date\":\"2019-07-02T11:00:34+08:00\",\"f\":1,\"text\":\"6.libra的mempool模块解读-1\",\"link\":\"/blockchain/libra/6.libria_mempool_1.html\"},{\"i\":\"5.libra的AC模块\",\"date\":\"2019-06-29T11:00:34+08:00\",\"f\":1,\"text\":\"5.libra的AC模块\",\"link\":\"/blockchain/libra/5.libra_ac.html\"},{\"i\":\"4.打通client与libradb模块的任督二脉\",\"date\":\"2019-06-25T11:00:34+08:00\",\"f\":1,\"text\":\"4.打通client与libradb模块的任督二脉\",\"link\":\"/blockchain/libra/4.client_command_and_libriadb.html\"},{\"i\":\"3.Libra中数据存储的Schema\",\"date\":\"2019-06-24T11:00:34+08:00\",\"f\":1,\"text\":\"3.Libra中数据存储的Schema\",\"link\":\"/blockchain/libra/3.Libra_Schema.html\"},{\"i\":\"2.在Libra中学习Protobuf\",\"date\":\"2019-06-23T11:00:34+08:00\",\"f\":1,\"text\":\"2.在Libra中学习Protobuf\",\"link\":\"/blockchain/libra/2.Protobuf_in_libria.html\"},{\"i\":\"1.Libra入门教程-一分钟上手Libra\",\"date\":\"2019-06-16T11:57:03+08:00\",\"f\":1,\"text\":\"1.Libra入门教程-一分钟上手Libra\",\"link\":\"/blockchain/libra/1.start_in_one_minute.html\"}]},{\"i\":\"区块链核心技术\",\"l\":\"/blockchain/block_chain_core/\",\"date\":\"2019-06-16T11:57:03+08:00\",\"text\":\"区块链核心技术\",\"link\":\"/blockchain/block_chain_core/\",\"children\":[{\"i\":\"ECC签名中随机数不随机的危害\",\"date\":\"2020-09-03T08:57:03+08:00\",\"f\":1,\"text\":\"ECC签名中随机数不随机的危害\",\"link\":\"/blockchain/block_chain_core/ecc_signature_random.html\"},{\"i\":\"一篇文章搞懂VRF\",\"date\":\"2019-06-16T11:57:03+08:00\",\"f\":1,\"text\":\"一篇文章搞懂VRF\",\"link\":\"/blockchain/block_chain_core/vrf.html\"}]},{\"i\":\"btc wallet系列\",\"l\":\"/blockchain/btcwallet/\",\"date\":\"2019-05-23T01:07:52.193125+00:00\",\"text\":\"btc wallet系列\",\"link\":\"/blockchain/btcwallet/\",\"children\":[{\"i\":\"wallet模块\",\"date\":\"2019-05-23T01:07:52.193125+00:00\",\"f\":1,\"text\":\"wallet模块\",\"link\":\"/blockchain/btcwallet/wallet模块.html\"},{\"i\":\"chain模块\",\"date\":\"2019-05-20T09:31:26.622780+00:00\",\"f\":1,\"text\":\"chain模块\",\"link\":\"/blockchain/btcwallet/chain模块.html\"},{\"i\":\"hdwallet-bip0032\",\"date\":\"2019-05-20T08:33:25.957776+00:00\",\"f\":1,\"text\":\"hdwallet-bip0032\",\"link\":\"/blockchain/btcwallet/hdwallet-bip0032.html\"},{\"i\":\"wtxmgr模块\",\"date\":\"2019-05-20T03:44:14.946920+00:00\",\"f\":1,\"text\":\"wtxmgr模块\",\"link\":\"/blockchain/btcwallet/wtxmgr模块.html\"},{\"i\":\"wallet中的数据库设计\",\"date\":\"2019-05-19T13:32:33.874224+00:00\",\"f\":1,\"text\":\"wallet中的数据库设计\",\"link\":\"/blockchain/btcwallet/wallet中的数据库设计.html\"},{\"i\":\"拓扑排序在比特币Tx管理中的使用\",\"date\":\"2019-05-19T10:19:16.778288+00:00\",\"f\":1,\"text\":\"拓扑排序在比特币Tx管理中的使用\",\"link\":\"/blockchain/btcwallet/拓扑排序在比特币Tx管理中的使用.html\"},{\"i\":\"btcWallet系列之一-grpc模块\",\"date\":\"2019-05-19T01:46:15.071002+00:00\",\"f\":1,\"text\":\"btcWallet系列之一-grpc模块\",\"link\":\"/blockchain/btcwallet/btcWallet系列之一-grpc模块.html\"},{\"i\":\"waddrmgr模块\",\"date\":\"2019-05-18T13:57:08.732484+00:00\",\"f\":1,\"text\":\"waddrmgr模块\",\"link\":\"/blockchain/btcwallet/waddrmgr模块.html\"},{\"i\":\"walletdb\",\"date\":\"2019-05-16T07:04:54.904453+00:00\",\"f\":1,\"text\":\"walletdb\",\"link\":\"/blockchain/btcwallet/walletdb.html\"},{\"i\":\"snacl\",\"date\":\"2019-05-15T14:52:36.337642+00:00\",\"f\":1,\"text\":\"snacl\",\"link\":\"/blockchain/btcwallet/snacl.html\"},{\"i\":\"readme\",\"date\":\"2019-05-15T03:36:47.708470+00:00\",\"f\":1,\"text\":\"readme\",\"link\":\"/blockchain/btcwallet/readme.html\"}]},{\"i\":\"以太坊\",\"l\":\"/blockchain/ethereum/\",\"date\":\"2019-04-25T09:39:46.982579+00:00\",\"text\":\"以太坊\",\"link\":\"/blockchain/ethereum/\",\"children\":[{\"i\":\"并发和并行的区别\",\"date\":\"2019-05-26T00:02:51.864476+00:00\",\"f\":1,\"text\":\"并发和并行的区别\",\"link\":\"/blockchain/ethereum/并发和并行的区别.html\"},{\"i\":\"以太坊evm笔记\",\"date\":\"2019-04-26T06:58:56.834075+00:00\",\"f\":1,\"text\":\"以太坊evm笔记\",\"link\":\"/blockchain/ethereum/以太坊evm笔记.html\"},{\"i\":\"合约注意事项\",\"date\":\"2019-04-25T09:39:46.982579+00:00\",\"f\":1,\"text\":\"合约注意事项\",\"link\":\"/blockchain/ethereum/合约注意事项.html\"},{\"i\":\"btc跨链设计\",\"date\":\"2019-04-15T04:08:31.082275+00:00\",\"f\":1,\"text\":\"btc跨链设计\",\"link\":\"/blockchain/ethereum/btc跨链设计.html\"},{\"i\":\"安全总结\",\"date\":\"2019-03-05T05:05:12.827962+00:00\",\"f\":1,\"text\":\"安全总结\",\"link\":\"/blockchain/ethereum/安全总结.html\"},{\"i\":\"比特币的TxHash为什么会发生改变\",\"date\":\"2019-02-11T09:26:27.497615+00:00\",\"f\":1,\"text\":\"比特币的TxHash为什么会发生改变\",\"link\":\"/blockchain/ethereum/比特币的TxHash为什么会发生改变.html\"},{\"i\":\"how_to_create_channel\",\"date\":\"2019-01-22T01:49:06+00:00\",\"f\":1,\"text\":\"how_to_create_channel\",\"link\":\"/blockchain/ethereum/how_to_create_channel.html\"},{\"i\":\"君士坦丁堡分叉引起的安全问题\",\"date\":\"2019-01-18T14:42:10+00:00\",\"f\":1,\"text\":\"君士坦丁堡分叉引起的安全问题\",\"link\":\"/blockchain/ethereum/君士坦丁堡分叉引起的安全问题.html\"},{\"i\":\"区块链问题笔记\",\"date\":\"2018-12-01T10:37:18+00:00\",\"f\":1,\"text\":\"区块链问题笔记\",\"link\":\"/blockchain/ethereum/区块链问题笔记.html\"},{\"i\":\"从一次盗币事件再谈合约安全问题\",\"date\":\"2018-11-15T08:55:51+00:00\",\"f\":1,\"text\":\"从一次盗币事件再谈合约安全问题\",\"link\":\"/blockchain/ethereum/从一次盗币事件再谈合约安全问题.html\"},{\"i\":\"让photon支持go module\",\"date\":\"2018-11-07T12:35:46+00:00\",\"f\":1,\"text\":\"让photon支持go module\",\"link\":\"/blockchain/ethereum/让photon支持go module.html\"},{\"i\":\"meshbox配置 OpenWrt\",\"date\":\"2018-11-06T07:03:18+00:00\",\"f\":1,\"text\":\"meshbox配置 OpenWrt\",\"link\":\"/blockchain/ethereum/meshbox配置 OpenWrt.html\"},{\"i\":\"synapse代码阅读\",\"date\":\"2018-10-22T13:09:09+00:00\",\"f\":1,\"text\":\"synapse代码阅读\",\"link\":\"/blockchain/ethereum/synapse代码阅读.html\"},{\"i\":\"golang_plugin\",\"date\":\"2018-10-14T05:05:37+00:00\",\"f\":1,\"text\":\"golang_plugin\",\"link\":\"/blockchain/ethereum/golang_plugin.html\"},{\"i\":\"多链工作问题\",\"date\":\"2018-10-14T03:08:50+00:00\",\"f\":1,\"text\":\"多链工作问题\",\"link\":\"/blockchain/ethereum/多链工作问题.html\"},{\"i\":\"我对 smartplasma 的理解\",\"date\":\"2018-09-19T06:08:37+00:00\",\"f\":1,\"text\":\"我对 smartplasma 的理解\",\"link\":\"/blockchain/ethereum/我对 smartplasma 的理解.html\"},{\"i\":\"CrossChainAtomicExchange\",\"date\":\"2018-09-14T03:02:02+00:00\",\"f\":1,\"text\":\"CrossChainAtomicExchange\",\"link\":\"/blockchain/ethereum/CrossChainAtomicExchange.html\"},{\"i\":\"如何为 smartraiden 贡献代码\",\"date\":\"2018-09-13T00:45:47+00:00\",\"f\":1,\"text\":\"如何为 smartraiden 贡献代码\",\"link\":\"/blockchain/ethereum/如何为 smartraiden 贡献代码.html\"},{\"i\":\"闪电网络\",\"date\":\"2018-09-12T06:16:20+00:00\",\"f\":1,\"text\":\"闪电网络\",\"link\":\"/blockchain/ethereum/闪电网络.html\"},{\"i\":\"如何使用 smartraiden 以及 lnd 进行跨链原子资产交换\",\"date\":\"2018-08-30T13:01:43+00:00\",\"f\":1,\"text\":\"如何使用 smartraiden 以及 lnd 进行跨链原子资产交换\",\"link\":\"/blockchain/ethereum/如何使用 smartraiden 以及 lnd 进行跨链原子资产交换.html\"},{\"i\":\"raiden_graph\",\"date\":\"2018-08-27T02:48:47+00:00\",\"f\":1,\"text\":\"raiden_graph\",\"link\":\"/blockchain/ethereum/raiden_graph.html\"},{\"i\":\"区块链计时器\",\"date\":\"2018-08-27T02:48:47+00:00\",\"f\":1,\"text\":\"区块链计时器\",\"link\":\"/blockchain/ethereum/区块链计时器.html\"},{\"i\":\"如何使用 dlv 调试 smartraiden\",\"date\":\"2018-08-27T02:48:47+00:00\",\"f\":1,\"text\":\"如何使用 dlv 调试 smartraiden\",\"link\":\"/blockchain/ethereum/如何使用 dlv 调试 smartraiden.html\"},{\"i\":\"异常退出各种情况\",\"date\":\"2018-08-27T02:48:47+00:00\",\"f\":1,\"text\":\"异常退出各种情况\",\"link\":\"/blockchain/ethereum/异常退出各种情况.html\"},{\"i\":\"闪电网络交易密钥\",\"date\":\"2018-08-25T04:21:13+00:00\",\"f\":1,\"text\":\"闪电网络交易密钥\",\"link\":\"/blockchain/ethereum/闪电网络交易密钥.html\"},{\"i\":\"solidity_mapping_implementation\",\"date\":\"2018-08-18T06:02:04+00:00\",\"f\":1,\"text\":\"solidity_mapping_implementation\",\"link\":\"/blockchain/ethereum/solidity_mapping_implementation.html\"},{\"i\":\" 将以太坊封装为 ERC20 TOKEN\",\"date\":\"2018-05-02T11:06:23+08:00\",\"f\":1,\"text\":\" 将以太坊封装为 ERC20 TOKEN\",\"link\":\"/blockchain/ethereum/ethereum_erc20_wrapper.html\"},{\"i\":\"golang Subprocess tests\",\"date\":\"2018-04-30T11:06:23+08:00\",\"f\":1,\"text\":\"golang Subprocess tests\",\"link\":\"/blockchain/ethereum/golang subprocess tests.html\"},{\"i\":\"如何使用 Channel\",\"date\":\"2018-04-27T11:06:23+08:00\",\"f\":1,\"text\":\"如何使用 Channel\",\"link\":\"/blockchain/ethereum/how_to_use_channel.html\"},{\"i\":\"TheDao 简化版解释\",\"date\":\"2018-04-25T11:06:23+08:00\",\"f\":1,\"text\":\"TheDao 简化版解释\",\"link\":\"/blockchain/ethereum/thedao.html\"}]},{\"i\":\"btcd系列\",\"l\":\"/blockchain/btcd/\",\"date\":\"2018-11-11T10:40:47+00:00\",\"text\":\"btcd系列\",\"link\":\"/blockchain/btcd/\",\"children\":[{\"i\":\"隔离见证\",\"date\":\"2019-05-23T01:01:56.214754+00:00\",\"f\":1,\"text\":\"隔离见证\",\"link\":\"/blockchain/btcd/隔离见证.html\"},{\"i\":\"比特币的地址类型\",\"date\":\"2019-05-22T23:47:24.337957+00:00\",\"f\":1,\"text\":\"比特币的地址类型\",\"link\":\"/blockchain/btcd/比特币的地址类型.html\"},{\"i\":\"indexer模块\",\"date\":\"2019-04-18T03:46:43.173088+00:00\",\"f\":1,\"text\":\"indexer模块\",\"link\":\"/blockchain/btcd/indexer模块.html\"},{\"i\":\"btcjson\",\"date\":\"2018-12-26T03:19:02+00:00\",\"f\":1,\"text\":\"btcjson\",\"link\":\"/blockchain/btcd/btcjson.html\"},{\"i\":\"mempool\",\"date\":\"2018-12-21T03:53:45+00:00\",\"f\":1,\"text\":\"mempool\",\"link\":\"/blockchain/btcd/mempool.html\"},{\"i\":\"peer\",\"date\":\"2018-11-30T04:24:21+00:00\",\"f\":1,\"text\":\"peer\",\"link\":\"/blockchain/btcd/peer.html\"},{\"i\":\"database\",\"date\":\"2018-11-30T03:54:04+00:00\",\"f\":1,\"text\":\"database\",\"link\":\"/blockchain/btcd/database.html\"},{\"i\":\"rpcclient\",\"date\":\"2018-11-29T03:57:26+00:00\",\"f\":1,\"text\":\"rpcclient\",\"link\":\"/blockchain/btcd/rpcclient.html\"},{\"i\":\"mining\",\"date\":\"2018-11-26T02:01:09+00:00\",\"f\":1,\"text\":\"mining\",\"link\":\"/blockchain/btcd/mining.html\"},{\"i\":\"mruMap\",\"date\":\"2018-11-21T06:21:40+00:00\",\"f\":1,\"text\":\"mruMap\",\"link\":\"/blockchain/btcd/mruMap.html\"},{\"i\":\"bitcoin script\",\"date\":\"2018-11-21T06:12:53+00:00\",\"f\":1,\"text\":\"bitcoin script\",\"link\":\"/blockchain/btcd/bitcoin script.html\"},{\"i\":\"比特币解锁脚本中的ScriptSignature都包含了什么东西\",\"date\":\"2018-11-13T10:46:41+00:00\",\"f\":1,\"text\":\"比特币解锁脚本中的ScriptSignature都包含了什么东西\",\"link\":\"/blockchain/btcd/比特币解锁脚本中的ScriptSignature都包含了什么东西.html\"},{\"i\":\"wire_common\",\"date\":\"2018-11-12T11:07:31+00:00\",\"f\":1,\"text\":\"wire_common\",\"link\":\"/blockchain/btcd/wire_common.html\"},{\"i\":\"bloom\",\"date\":\"2018-11-11T10:40:47+00:00\",\"f\":1,\"text\":\"bloom\",\"link\":\"/blockchain/btcd/bloom.html\"},{\"i\":\"比特币指令集说明\",\"date\":\"2018-08-23T01:33:10+00:00\",\"f\":1,\"text\":\"比特币指令集说明\",\"link\":\"/blockchain/btcd/比特币指令集说明.html\"},{\"i\":\"一个比特币脚本示例\",\"date\":\"2018-08-18T06:02:04+00:00\",\"f\":1,\"text\":\"一个比特币脚本示例\",\"link\":\"/blockchain/btcd/一个比特币脚本示例.html\"}]}],\"/static_analysis/\":[{\"i\":\"using clang-tidy for customized checkers\",\"date\":\"2023-04-14T11:57:03+08:00\",\"f\":1,\"text\":\"using clang-tidy for customized checkers\",\"link\":\"/static_analysis/using_clang_tidy_for_custom_checkers.html\"},{\"i\":\"llvm clang ast\",\"date\":\"2023-04-08T11:57:03+08:00\",\"f\":1,\"text\":\"llvm clang ast\",\"link\":\"/static_analysis/clang_ast.html\"},{\"i\":\"llvm 二次开发基础知识\",\"date\":\"2023-03-23T11:57:03+08:00\",\"f\":1,\"text\":\"llvm 二次开发基础知识\",\"link\":\"/static_analysis/llvm_programmers_mannual.html\"},{\"i\":\"llvm overview\",\"date\":\"2023-03-17T11:57:03+08:00\",\"f\":1,\"text\":\"llvm overview\",\"link\":\"/static_analysis/llvm_overview.html\"},{\"i\":\"mariana安卓静态分析工具简介\",\"date\":\"2021-11-14T11:57:03+08:00\",\"f\":1,\"text\":\"mariana安卓静态分析工具简介\",\"link\":\"/static_analysis/mariana-introduction.html\"}],\"/app_security/\":[{\"i\":\"小程序通用越权漏洞分析\",\"date\":\"2022-08-21T21:57:03+08:00\",\"f\":1,\"text\":\"小程序通用越权漏洞分析\",\"link\":\"/app_security/Identity_Confusion_in_WebView-based_Mobile_App-in-app_Ecosystems.html\"},{\"i\":\"白盒密码学简介\",\"date\":\"2022-07-28T08:57:03+08:00\",\"f\":1,\"text\":\"白盒密码学简介\",\"link\":\"/app_security/white_box_cryptography.html\"},{\"i\":\"如何在Mac中Hook:改造Rest以适应工作需求\",\"date\":\"2022-02-16T21:57:03+08:00\",\"f\":1,\"text\":\"如何在Mac中Hook:改造Rest以适应工作需求\",\"link\":\"/app_security/hook_rest_for_work.html\"},{\"i\":\"B站持久任意代码执行漏洞\",\"date\":\"2022-01-20T21:57:03+08:00\",\"f\":1,\"text\":\"B站持久任意代码执行漏洞\",\"link\":\"/app_security/bilibili_arbitrary_code_execution.html\"},{\"i\":\"移动App加密的三条军规\",\"date\":\"2022-01-17T21:57:03+08:00\",\"f\":1,\"text\":\"移动App加密的三条军规\",\"link\":\"/app_security/use_cryptography_in_mobile_appls_the_right_way.html\"},{\"i\":\"另一个Tiktok持久任意代码执行漏洞\",\"date\":\"2022-01-16T09:57:03+08:00\",\"f\":1,\"text\":\"另一个Tiktok持久任意代码执行漏洞\",\"link\":\"/app_security/tiktok_arbitrary_code_execution_download_service.html\"},{\"i\":\"Tiktok持久任意代码执行漏洞\",\"date\":\"2022-01-14T21:57:03+08:00\",\"f\":1,\"text\":\"Tiktok持久任意代码执行漏洞\",\"link\":\"/app_security/tiktok_arbitrary_code_execution.html\"},{\"i\":\"Tiktok存在任意文件读取问题\",\"date\":\"2022-01-13T21:57:03+08:00\",\"f\":1,\"text\":\"Tiktok存在任意文件读取问题\",\"link\":\"/app_security/tiktok_theft_of_arbitrary.html\"},{\"i\":\"如何保护导出组件\",\"date\":\"2022-01-11T21:57:03+08:00\",\"f\":1,\"text\":\"如何保护导出组件\",\"link\":\"/app_security/android_howto_protected_unexported_components.html\"},{\"i\":\"为什么要保护未导出组件\",\"date\":\"2022-01-06T21:57:03+08:00\",\"f\":1,\"text\":\"为什么要保护未导出组件\",\"link\":\"/app_security/android_access_protected_components.html\"},{\"i\":\"android第三方包上下文任意代码执行\",\"date\":\"2022-01-05T21:57:03+08:00\",\"f\":1,\"text\":\"android第三方包上下文任意代码执行\",\"link\":\"/app_security/android_lce_third_party.html\"}],\"/rust-leetcode/\":[{\"i\":\"面试题 17.13. 恢复空格\",\"date\":\"2020-07-09T03:57:03+08:00\",\"f\":1,\"text\":\"面试题 17.13. 恢复空格\",\"link\":\"/rust-leetcode/2020-07-09.html\"},{\"i\":\"1353. 最多可以参加的会议数目\",\"date\":\"2020-03-31T03:57:03+08:00\",\"f\":1,\"text\":\"1353. 最多可以参加的会议数目\",\"link\":\"/rust-leetcode/2020-03-31.html\"},{\"i\":\"307. 区域和检索 - 数组可修改\",\"date\":\"2020-03-30T03:57:03+08:00\",\"f\":1,\"text\":\"307. 区域和检索 - 数组可修改\",\"link\":\"/rust-leetcode/2020-03-30.html\"},{\"i\":\"205. 同构字符串\",\"date\":\"2020-03-27T03:57:03+08:00\",\"f\":1,\"text\":\"205. 同构字符串\",\"link\":\"/rust-leetcode/2020-03-27.html\"},{\"i\":\"70. 爬楼梯\",\"date\":\"2020-03-26T03:57:03+08:00\",\"f\":1,\"text\":\"70. 爬楼梯\",\"link\":\"/rust-leetcode/2020-03-26.html\"},{\"i\":\"299. 猜数字游戏\",\"date\":\"2020-03-25T03:57:03+08:00\",\"f\":1,\"text\":\"299. 猜数字游戏\",\"link\":\"/rust-leetcode/2020-03-25.html\"},{\"i\":\"219. 存在重复元素 II\",\"date\":\"2020-03-24T03:57:03+08:00\",\"f\":1,\"text\":\"219. 存在重复元素 II\",\"link\":\"/rust-leetcode/2020-03-24.html\"},{\"i\":\"202. 快乐数\",\"date\":\"2020-03-23T03:57:03+08:00\",\"f\":1,\"text\":\"202. 快乐数\",\"link\":\"/rust-leetcode/2020-03-23.html\"},{\"i\":\"面试题 17.07. 婴儿名字\",\"date\":\"2020-03-20T03:57:03+08:00\",\"f\":1,\"text\":\"面试题 17.07. 婴儿名字\",\"link\":\"/rust-leetcode/2020-03-20.html\"},{\"i\":\"959. 由斜杠划分区域\",\"date\":\"2020-03-19T03:57:03+08:00\",\"f\":1,\"text\":\"959. 由斜杠划分区域\",\"link\":\"/rust-leetcode/2020-03-19.html\"},{\"i\":\"1202. 交换字符串中的元素\",\"date\":\"2020-03-18T03:57:03+08:00\",\"f\":1,\"text\":\"1202. 交换字符串中的元素\",\"link\":\"/rust-leetcode/2020-03-18.html\"},{\"i\":\"990. 等式方程的可满足性\",\"date\":\"2020-03-17T03:57:03+08:00\",\"f\":1,\"text\":\"990. 等式方程的可满足性\",\"link\":\"/rust-leetcode/2020-03-17.html\"},{\"i\":\"952. 按公因数计算最大组件大小\",\"date\":\"2020-03-16T03:57:03+08:00\",\"f\":1,\"text\":\"952. 按公因数计算最大组件大小\",\"link\":\"/rust-leetcode/2020-03-16.html\"},{\"i\":\"1319. 连通网络的操作次数\",\"date\":\"2020-03-13T03:57:03+08:00\",\"f\":1,\"text\":\"1319. 连通网络的操作次数\",\"link\":\"/rust-leetcode/2020-03-13.html\"},{\"i\":\"721. 账户合并\",\"date\":\"2020-03-12T03:57:03+08:00\",\"f\":1,\"text\":\"721. 账户合并\",\"link\":\"/rust-leetcode/2020-03-12.html\"},{\"i\":\"399. 除法求值-2\",\"date\":\"2020-03-11T03:57:03+08:00\",\"f\":1,\"text\":\"399. 除法求值-2\",\"link\":\"/rust-leetcode/2020-03-11.html\"},{\"i\":\"399. 除法求值\",\"date\":\"2020-03-10T03:57:03+08:00\",\"f\":1,\"text\":\"399. 除法求值\",\"link\":\"/rust-leetcode/2020-03-10.html\"},{\"i\":\"547. 朋友圈\",\"date\":\"2020-03-09T03:57:03+08:00\",\"f\":1,\"text\":\"547. 朋友圈\",\"link\":\"/rust-leetcode/2020-03-09.html\"},{\"i\":\"1297. 子串的最大出现次数-2\",\"date\":\"2020-03-06T03:57:03+08:00\",\"f\":1,\"text\":\"1297. 子串的最大出现次数-2\",\"link\":\"/rust-leetcode/2020-03-06.html\"},{\"i\":\"1297. 子串的最大出现次数\",\"date\":\"2020-03-05T03:57:03+08:00\",\"f\":1,\"text\":\"1297. 子串的最大出现次数\",\"link\":\"/rust-leetcode/2020-03-05.html\"},{\"i\":\"1143. 最长公共子序列\",\"date\":\"2020-03-04T03:57:03+08:00\",\"f\":1,\"text\":\"1143. 最长公共子序列\",\"link\":\"/rust-leetcode/2020-03-04.html\"},{\"i\":\"684. 冗余连接\",\"date\":\"2020-03-03T03:57:03+08:00\",\"f\":1,\"text\":\"684. 冗余连接\",\"link\":\"/rust-leetcode/2020-03-03.html\"},{\"i\":\"210. 课程表2\",\"date\":\"2020-03-02T03:57:03+08:00\",\"f\":1,\"text\":\"210. 课程表2\",\"link\":\"/rust-leetcode/2020-03-02.html\"},{\"i\":\"207. 课程表\",\"date\":\"2020-02-28T03:57:03+08:00\",\"f\":1,\"text\":\"207. 课程表\",\"link\":\"/rust-leetcode/2020-02-28.html\"},{\"i\":\"80. 删除排序数组中的重复项 II\",\"date\":\"2020-02-27T03:57:03+08:00\",\"f\":1,\"text\":\"80. 删除排序数组中的重复项 II\",\"link\":\"/rust-leetcode/2020-02-27.html\"},{\"i\":\"287. 寻找重复数\",\"date\":\"2020-02-26T03:57:03+08:00\",\"f\":1,\"text\":\"287. 寻找重复数\",\"link\":\"/rust-leetcode/2020-02-26.html\"},{\"i\":\"897. 递增顺序查找树\",\"date\":\"2020-02-25T03:57:03+08:00\",\"f\":1,\"text\":\"897. 递增顺序查找树\",\"link\":\"/rust-leetcode/2020-02-25.html\"},{\"i\":\"97. 交错字符串-2\",\"date\":\"2020-02-24T03:57:03+08:00\",\"f\":1,\"text\":\"97. 交错字符串-2\",\"link\":\"/rust-leetcode/2020-02-24.html\"},{\"i\":\"97. 交错字符串\",\"date\":\"2020-02-21T03:57:03+08:00\",\"f\":1,\"text\":\"97. 交错字符串\",\"link\":\"/rust-leetcode/2020-02-21.html\"},{\"i\":\"39. 组合总和\",\"date\":\"2020-02-20T03:57:03+08:00\",\"f\":1,\"text\":\"39. 组合总和\",\"link\":\"/rust-leetcode/2020-02-20.html\"},{\"i\":\"128. 最长连续序列\",\"date\":\"2020-02-19T03:57:03+08:00\",\"f\":1,\"text\":\"128. 最长连续序列\",\"link\":\"/rust-leetcode/2020-02-19.html\"},{\"i\":\"365. 水壶问题\",\"date\":\"2020-02-18T03:57:03+08:00\",\"f\":1,\"text\":\"365. 水壶问题\",\"link\":\"/rust-leetcode/2020-02-18.html\"},{\"i\":\"365. 水壶问题\",\"date\":\"2020-02-17T03:57:03+08:00\",\"f\":1,\"text\":\"365. 水壶问题\",\"link\":\"/rust-leetcode/2020-02-17.html\"},{\"i\":\"22. 括号生成\",\"date\":\"2020-02-14T03:57:03+08:00\",\"f\":1,\"text\":\"22. 括号生成\",\"link\":\"/rust-leetcode/2020-02-14.html\"},{\"i\":\"494. 目标和\",\"date\":\"2020-02-13T03:57:03+08:00\",\"f\":1,\"text\":\"494. 目标和\",\"link\":\"/rust-leetcode/2020-02-13.html\"},{\"i\":\"209. 长度最小的子数组\",\"date\":\"2020-02-12T03:57:03+08:00\",\"f\":1,\"text\":\"209. 长度最小的子数组\",\"link\":\"/rust-leetcode/2020-02-12.html\"},{\"i\":\"673. 最长递增子序列的个数\",\"date\":\"2020-02-11T03:57:03+08:00\",\"f\":1,\"text\":\"673. 最长递增子序列的个数\",\"link\":\"/rust-leetcode/2020-02-11.html\"},{\"i\":\"134. 加油站\",\"date\":\"2020-02-10T03:57:03+08:00\",\"f\":1,\"text\":\"134. 加油站\",\"link\":\"/rust-leetcode/2020-02-10.html\"},{\"i\":\"55. 跳跃游戏\",\"date\":\"2020-02-07T03:57:03+08:00\",\"f\":1,\"text\":\"55. 跳跃游戏\",\"link\":\"/rust-leetcode/2020-02-07.html\"},{\"i\":\"130. 被围绕的区域\",\"date\":\"2020-02-06T03:57:03+08:00\",\"f\":1,\"text\":\"130. 被围绕的区域\",\"link\":\"/rust-leetcode/2020-02-06.html\"},{\"i\":\"386. 字典序排数\",\"date\":\"2020-02-05T03:57:03+08:00\",\"f\":1,\"text\":\"386. 字典序排数\",\"link\":\"/rust-leetcode/2020-02-05.html\"},{\"i\":\"343. 整数拆分\",\"date\":\"2020-02-04T03:57:03+08:00\",\"f\":1,\"text\":\"343. 整数拆分\",\"link\":\"/rust-leetcode/2020-02-04.html\"},{\"i\":\"55. 跳跃游戏-2\",\"date\":\"2020-02-03T03:57:03+08:00\",\"f\":1,\"text\":\"55. 跳跃游戏-2\",\"link\":\"/rust-leetcode/2020-02-03.html\"},{\"i\":\"714. 买卖股票的最佳时机含手续费\",\"date\":\"2020-01-24T03:57:03+08:00\",\"f\":1,\"text\":\"714. 买卖股票的最佳时机含手续费\",\"link\":\"/rust-leetcode/2020-01-24.html\"},{\"i\":\"309. 最佳买卖股票时机含冷冻期\",\"date\":\"2020-01-23T03:57:03+08:00\",\"f\":1,\"text\":\"309. 最佳买卖股票时机含冷冻期\",\"link\":\"/rust-leetcode/2020-01-23.html\"},{\"i\":\"123. 买卖股票的最佳时机 III\",\"date\":\"2020-01-22T03:57:03+08:00\",\"f\":1,\"text\":\"123. 买卖股票的最佳时机 III\",\"link\":\"/rust-leetcode/2020-01-22.html\"},{\"i\":\"188. 买卖股票的最佳时机 IV-3\",\"date\":\"2020-01-21T03:57:03+08:00\",\"f\":1,\"text\":\"188. 买卖股票的最佳时机 IV-3\",\"link\":\"/rust-leetcode/2020-01-21.html\"},{\"i\":\"188. 买卖股票的最佳时机 IV-2\",\"date\":\"2020-01-20T03:57:03+08:00\",\"f\":1,\"text\":\"188. 买卖股票的最佳时机 IV-2\",\"link\":\"/rust-leetcode/2020-01-20.html\"},{\"i\":\"188. 买卖股票的最佳时机 IV\",\"date\":\"2020-01-17T03:57:03+08:00\",\"f\":1,\"text\":\"188. 买卖股票的最佳时机 IV\",\"link\":\"/rust-leetcode/2020-01-17.html\"},{\"i\":\"122. 买卖股票的最佳时机 II-2\",\"date\":\"2020-01-16T03:57:03+08:00\",\"f\":1,\"text\":\"122. 买卖股票的最佳时机 II-2\",\"link\":\"/rust-leetcode/2020-01-16.html\"},{\"i\":\"122. 买卖股票的最佳时机 II\",\"date\":\"2020-01-15T03:57:03+08:00\",\"f\":1,\"text\":\"122. 买卖股票的最佳时机 II\",\"link\":\"/rust-leetcode/2020-01-15.html\"},{\"i\":\"687. 最长同值路径\",\"date\":\"2020-01-14T03:57:03+08:00\",\"f\":1,\"text\":\"687. 最长同值路径\",\"link\":\"/rust-leetcode/2020-01-14.html\"},{\"i\":\"523. 连续的子数组和\",\"date\":\"2020-01-13T03:57:03+08:00\",\"f\":1,\"text\":\"523. 连续的子数组和\",\"link\":\"/rust-leetcode/2020-01-13.html\"},{\"i\":\"488. 祖玛游戏\",\"date\":\"2020-01-10T03:57:03+08:00\",\"f\":1,\"text\":\"488. 祖玛游戏\",\"link\":\"/rust-leetcode/2020-01-10.html\"},{\"i\":\"476. 数字的补数\",\"date\":\"2020-01-09T03:57:03+08:00\",\"f\":1,\"text\":\"476. 数字的补数\",\"link\":\"/rust-leetcode/2020-01-09.html\"},{\"i\":\"200. 岛屿数量\",\"date\":\"2020-01-08T03:57:03+08:00\",\"f\":1,\"text\":\"200. 岛屿数量\",\"link\":\"/rust-leetcode/2020-01-08.html\"},{\"i\":\"200. 岛屿数量\",\"date\":\"2020-01-07T03:57:03+08:00\",\"f\":1,\"text\":\"200. 岛屿数量\",\"link\":\"/rust-leetcode/2020-01-07.html\"},{\"i\":\"78. 子集\",\"date\":\"2020-01-06T03:57:03+08:00\",\"f\":1,\"text\":\"78. 子集\",\"link\":\"/rust-leetcode/2020-01-06.html\"},{\"i\":\"452. 用最少数量的箭引爆气球\",\"date\":\"2020-01-03T03:57:03+08:00\",\"f\":1,\"text\":\"452. 用最少数量的箭引爆气球\",\"link\":\"/rust-leetcode/2020-01-03.html\"},{\"i\":\"135. 分发糖果\",\"date\":\"2020-01-02T03:57:03+08:00\",\"f\":1,\"text\":\"135. 分发糖果\",\"link\":\"/rust-leetcode/2020-01-02.html\"},{\"i\":\"143. 重排链表\",\"date\":\"2020-01-01T03:57:03+08:00\",\"f\":1,\"text\":\"143. 重排链表\",\"link\":\"/rust-leetcode/2020-01-01.html\"},{\"i\":\"79. 单词搜索\",\"date\":\"2019-12-30T03:57:03+08:00\",\"f\":1,\"text\":\"79. 单词搜索\",\"link\":\"/rust-leetcode/2019-12-30.html\"},{\"i\":\"31. 下一个排列\",\"date\":\"2019-12-30T03:57:03+08:00\",\"f\":1,\"text\":\"31. 下一个排列\",\"link\":\"/rust-leetcode/2019-12-31.html\"},{\"i\":\"42. 接雨水-2\",\"date\":\"2019-12-27T03:57:03+08:00\",\"f\":1,\"text\":\"42. 接雨水-2\",\"link\":\"/rust-leetcode/2019-12-27.html\"},{\"i\":\"42. 接雨水\",\"date\":\"2019-12-26T03:57:03+08:00\",\"f\":1,\"text\":\"42. 接雨水\",\"link\":\"/rust-leetcode/2019-12-26.html\"},{\"i\":\"215. 数组中的第K个最大元素\",\"date\":\"2019-12-25T03:57:03+08:00\",\"f\":1,\"text\":\"215. 数组中的第K个最大元素\",\"link\":\"/rust-leetcode/2019-12-25.html\"},{\"i\":\"288. 单词的唯一缩写\",\"date\":\"2019-12-24T03:57:03+08:00\",\"f\":1,\"text\":\"288. 单词的唯一缩写\",\"link\":\"/rust-leetcode/2019-12-24.html\"},{\"i\":\"53. 最大子序和\",\"date\":\"2019-12-23T03:57:03+08:00\",\"f\":1,\"text\":\"53. 最大子序和\",\"link\":\"/rust-leetcode/2019-12-23.html\"},{\"i\":\"84. 柱状图中最大的矩形-2\",\"date\":\"2019-12-20T03:57:03+08:00\",\"f\":1,\"text\":\"84. 柱状图中最大的矩形-2\",\"link\":\"/rust-leetcode/2019-12-20.html\"},{\"i\":\"1052. 爱生气的书店老板\",\"date\":\"2019-12-19T03:57:03+08:00\",\"f\":1,\"text\":\"1052. 爱生气的书店老板\",\"link\":\"/rust-leetcode/2019-12-19.html\"},{\"i\":\"51. N皇后\",\"date\":\"2019-12-18T03:57:03+08:00\",\"f\":1,\"text\":\"51. N皇后\",\"link\":\"/rust-leetcode/2019-12-18.html\"},{\"i\":\"121. 买卖股票的最佳时机\",\"date\":\"2019-12-17T03:57:03+08:00\",\"f\":1,\"text\":\"121. 买卖股票的最佳时机\",\"link\":\"/rust-leetcode/2019-12-17.html\"},{\"i\":\"84. 柱状图中最大的矩形\",\"date\":\"2019-12-16T03:57:03+08:00\",\"f\":1,\"text\":\"84. 柱状图中最大的矩形\",\"link\":\"/rust-leetcode/2019-12-16.html\"},{\"i\":\"632. 最小区间\",\"date\":\"2019-12-13T03:57:03+08:00\",\"f\":1,\"text\":\"632. 最小区间\",\"link\":\"/rust-leetcode/2019-12-13.html\"},{\"i\":\"560. 和为K的子数组-2\",\"date\":\"2019-12-12T03:57:03+08:00\",\"f\":1,\"text\":\"560. 和为K的子数组-2\",\"link\":\"/rust-leetcode/2019-12-12.html\"},{\"i\":\"560. 和为K的子数组\",\"date\":\"2019-12-11T03:57:03+08:00\",\"f\":1,\"text\":\"560. 和为K的子数组\",\"link\":\"/rust-leetcode/2019-12-11.html\"},{\"i\":\"554. 砖墙\",\"date\":\"2019-12-10T03:57:03+08:00\",\"f\":1,\"text\":\"554. 砖墙\",\"link\":\"/rust-leetcode/2019-12-10.html\"},{\"i\":\"535. TinyURL 的加密与解密\",\"date\":\"2019-12-09T03:57:03+08:00\",\"f\":1,\"text\":\"535. TinyURL 的加密与解密\",\"link\":\"/rust-leetcode/2019-12-09.html\"},{\"i\":\"525. 连续数组\",\"date\":\"2019-12-06T03:57:03+08:00\",\"f\":1,\"text\":\"525. 连续数组\",\"link\":\"/rust-leetcode/2019-12-06.html\"},{\"i\":\"454. 四数相加 II\",\"date\":\"2019-12-05T03:57:03+08:00\",\"f\":1,\"text\":\"454. 四数相加 II\",\"link\":\"/rust-leetcode/2019-12-05.html\"},{\"i\":\"438. 找到字符串中所有字母异位词\",\"date\":\"2019-12-04T03:57:03+08:00\",\"f\":1,\"text\":\"438. 找到字符串中所有字母异位词\",\"link\":\"/rust-leetcode/2019-12-04.html\"},{\"i\":\"30. 串联所有单词的子串\",\"date\":\"2019-12-03T03:57:03+08:00\",\"f\":1,\"text\":\"30. 串联所有单词的子串\",\"link\":\"/rust-leetcode/2019-12-03.html\"},{\"i\":\"463. 岛屿的周长\",\"date\":\"2019-12-02T03:57:03+08:00\",\"f\":1,\"text\":\"463. 岛屿的周长\",\"link\":\"/rust-leetcode/2019-12-02.html\"},{\"i\":\"409. 最长回文串\",\"date\":\"2019-11-29T03:57:03+08:00\",\"f\":1,\"text\":\"409. 最长回文串\",\"link\":\"/rust-leetcode/2019-11-29.html\"},{\"i\":\"389. 找不同\",\"date\":\"2019-11-28T03:57:03+08:00\",\"f\":1,\"text\":\"389. 找不同\",\"link\":\"/rust-leetcode/2019-11-28.html\"},{\"i\":\"290. 单词规律\",\"date\":\"2019-11-27T03:57:03+08:00\",\"f\":1,\"text\":\"290. 单词规律\",\"link\":\"/rust-leetcode/2019-11-27.html\"},{\"i\":\"149. 直线上最多的点数\",\"date\":\"2019-11-26T03:57:03+08:00\",\"f\":1,\"text\":\"149. 直线上最多的点数\",\"link\":\"/rust-leetcode/2019-11-26.html\"},{\"i\":\"1. 两数之和\",\"date\":\"2019-11-25T03:57:03+08:00\",\"f\":1,\"text\":\"1. 两数之和\",\"link\":\"/rust-leetcode/2019-11-25.html\"},{\"i\":\"30. 串联所有单词的子串\",\"date\":\"2019-11-22T03:57:03+08:00\",\"f\":1,\"text\":\"30. 串联所有单词的子串\",\"link\":\"/rust-leetcode/2019-11-22.html\"},{\"i\":\"36. 有效的数独\",\"date\":\"2019-11-21T03:57:03+08:00\",\"f\":1,\"text\":\"36. 有效的数独\",\"link\":\"/rust-leetcode/2019-11-21.html\"},{\"i\":\"49. 字母异位词分组\",\"date\":\"2019-11-20T03:57:03+08:00\",\"f\":1,\"text\":\"49. 字母异位词分组\",\"link\":\"/rust-leetcode/2019-11-20.html\"},{\"i\":\"232. 用栈实现队列\",\"date\":\"2019-11-19T03:57:03+08:00\",\"f\":1,\"text\":\"232. 用栈实现队列\",\"link\":\"/rust-leetcode/2019-11-19.html\"},{\"i\":\"155. 最小栈\",\"date\":\"2019-11-18T03:57:03+08:00\",\"f\":1,\"text\":\"155. 最小栈\",\"link\":\"/rust-leetcode/2019-11-18.html\"},{\"i\":\"220. 存在重复元素 III\",\"date\":\"2019-11-15T03:57:03+08:00\",\"f\":1,\"text\":\"220. 存在重复元素 III\",\"link\":\"/rust-leetcode/2019-11-15.html\"},{\"i\":\"173. 二叉搜索树迭代器\",\"date\":\"2019-11-14T03:57:03+08:00\",\"f\":1,\"text\":\"173. 二叉搜索树迭代器\",\"link\":\"/rust-leetcode/2019-11-14.html\"},{\"i\":\"1145. 二叉树着色游戏\",\"date\":\"2019-11-13T03:57:03+08:00\",\"f\":1,\"text\":\"1145. 二叉树着色游戏\",\"link\":\"/rust-leetcode/2019-11-13.html\"},{\"i\":\"1130. 叶值的最小代价生成树\",\"date\":\"2019-11-12T03:57:03+08:00\",\"f\":1,\"text\":\"1130. 叶值的最小代价生成树\",\"link\":\"/rust-leetcode/2019-11-12.html\"},{\"i\":\"1123. 最深叶节点的最近公共祖先\",\"date\":\"2019-11-11T03:57:03+08:00\",\"f\":1,\"text\":\"1123. 最深叶节点的最近公共祖先\",\"link\":\"/rust-leetcode/2019-11-11.html\"},{\"i\":\"1110. 删点成林\",\"date\":\"2019-11-08T03:57:03+08:00\",\"f\":1,\"text\":\"1110. 删点成林\",\"link\":\"/rust-leetcode/2019-11-08.html\"},{\"i\":\"1104. 二叉树寻路\",\"date\":\"2019-11-07T03:57:03+08:00\",\"f\":1,\"text\":\"1104. 二叉树寻路\",\"link\":\"/rust-leetcode/2019-11-07.html\"},{\"i\":\"1026. 节点与其祖先之间的最大差值\",\"date\":\"2019-11-06T03:57:03+08:00\",\"f\":1,\"text\":\"1026. 节点与其祖先之间的最大差值\",\"link\":\"/rust-leetcode/2019-11-06.html\"},{\"i\":\"1028. 从先序遍历还原二叉树\",\"date\":\"2019-11-05T03:57:03+08:00\",\"f\":1,\"text\":\"1028. 从先序遍历还原二叉树\",\"link\":\"/rust-leetcode/2019-11-05.html\"},{\"i\":\"987. 二叉树的垂序遍历\",\"date\":\"2019-11-04T03:57:03+08:00\",\"f\":1,\"text\":\"987. 二叉树的垂序遍历\",\"link\":\"/rust-leetcode/2019-11-04.html\"},{\"i\":\"958. 二叉树的完全性检验\",\"date\":\"2019-11-01T03:57:03+08:00\",\"f\":1,\"text\":\"958. 二叉树的完全性检验\",\"link\":\"/rust-leetcode/2019-11-01.html\"},{\"i\":\"662. 二叉树最大宽度\",\"date\":\"2019-10-31T03:57:03+08:00\",\"f\":1,\"text\":\"662. 二叉树最大宽度\",\"link\":\"/rust-leetcode/2019-10-31.html\"},{\"i\":\"865. 具有所有最深结点的最小子树-一遍遍历解法\",\"date\":\"2019-10-30T03:57:03+08:00\",\"f\":1,\"text\":\"865. 具有所有最深结点的最小子树-一遍遍历解法\",\"link\":\"/rust-leetcode/2019-10-30.html\"},{\"i\":\"865. 具有所有最深结点的最小子树\",\"date\":\"2019-10-29T03:57:03+08:00\",\"f\":1,\"text\":\"865. 具有所有最深结点的最小子树\",\"link\":\"/rust-leetcode/2019-10-29.html\"},{\"i\":\"1008. 先序遍历构造二叉树\",\"date\":\"2019-10-28T03:57:03+08:00\",\"f\":1,\"text\":\"1008. 先序遍历构造二叉树\",\"link\":\"/rust-leetcode/2019-10-28.html\"},{\"i\":\"919. 完全二叉树插入器\",\"date\":\"2019-10-25T03:57:03+08:00\",\"f\":1,\"text\":\"919. 完全二叉树插入器\",\"link\":\"/rust-leetcode/2019-10-25.html\"},{\"i\":\"889. 根据前序和后序遍历构造二叉树\",\"date\":\"2019-10-24T03:57:03+08:00\",\"f\":1,\"text\":\"889. 根据前序和后序遍历构造二叉树\",\"link\":\"/rust-leetcode/2019-10-24.html\"},{\"i\":\"872. 叶子相似的树\",\"date\":\"2019-10-23T03:57:03+08:00\",\"f\":1,\"text\":\"872. 叶子相似的树\",\"link\":\"/rust-leetcode/2019-10-23.html\"},{\"i\":\"889. 根据前序和后序遍历构造二叉树\",\"date\":\"2019-10-22T03:57:03+08:00\",\"f\":1,\"text\":\"889. 根据前序和后序遍历构造二叉树\",\"link\":\"/rust-leetcode/2019-10-22.html\"},{\"i\":\"863. 二叉树中所有距离为 K 的结点\",\"date\":\"2019-10-21T03:57:03+08:00\",\"f\":1,\"text\":\"863. 二叉树中所有距离为 K 的结点\",\"link\":\"/rust-leetcode/2019-10-21.html\"},{\"i\":\"814. 二叉树剪枝\",\"date\":\"2019-10-19T03:57:03+08:00\",\"f\":1,\"text\":\"814. 二叉树剪枝\",\"link\":\"/rust-leetcode/2019-10-19.html\"},{\"i\":\"701. 二叉搜索树中的插入操作\",\"date\":\"2019-10-18T03:57:03+08:00\",\"f\":1,\"text\":\"701. 二叉搜索树中的插入操作\",\"link\":\"/rust-leetcode/2019-10-18.html\"},{\"i\":\"655. 输出二叉树\",\"date\":\"2019-10-17T03:57:03+08:00\",\"f\":1,\"text\":\"655. 输出二叉树\",\"link\":\"/rust-leetcode/2019-10-17.html\"},{\"i\":\"654. 最大二叉树\",\"date\":\"2019-10-16T03:57:03+08:00\",\"f\":1,\"text\":\"654. 最大二叉树\",\"link\":\"/rust-leetcode/2019-10-16.html\"},{\"i\":\"623. 在二叉树中增加一行\",\"date\":\"2019-10-15T03:57:03+08:00\",\"f\":1,\"text\":\"623. 在二叉树中增加一行\",\"link\":\"/rust-leetcode/2019-10-14.html\"},{\"i\":\"652. 寻找重复的子树\",\"date\":\"2019-10-15T03:57:03+08:00\",\"f\":1,\"text\":\"652. 寻找重复的子树\",\"link\":\"/rust-leetcode/2019-10-15.html\"},{\"i\":\"572. 另一个树的子树\",\"date\":\"2019-10-11T03:57:03+08:00\",\"f\":1,\"text\":\"572. 另一个树的子树\",\"link\":\"/rust-leetcode/2019-10-11.html\"},{\"i\":\"543. 二叉树的直径\\\"\",\"date\":\"2019-10-10T03:57:03+08:00\",\"f\":1,\"text\":\"543. 二叉树的直径\\\"\",\"link\":\"/rust-leetcode/2019-10-10.html\"},{\"i\":\"538. 把二叉搜索树转换为累加树\",\"date\":\"2019-10-09T03:57:03+08:00\",\"f\":1,\"text\":\"538. 把二叉搜索树转换为累加树\",\"link\":\"/rust-leetcode/2019-10-09.html\"},{\"i\":\"538. 把二叉搜索树转换为累加树\",\"date\":\"2019-10-08T03:57:03+08:00\",\"f\":1,\"text\":\"538. 把二叉搜索树转换为累加树\",\"link\":\"/rust-leetcode/2019-10-08.html\"},{\"i\":\"530. 二叉搜索树的最小绝对差\",\"date\":\"2019-09-28T03:57:03+08:00\",\"f\":1,\"text\":\"530. 二叉搜索树的最小绝对差\",\"link\":\"/rust-leetcode/2019-09-28.html\"},{\"i\":\"515. 在每个树行中找最大值\",\"date\":\"2019-09-27T03:57:03+08:00\",\"f\":1,\"text\":\"515. 在每个树行中找最大值\",\"link\":\"/rust-leetcode/2019-09-27.html\"},{\"i\":\"513. 找树左下角的值\",\"date\":\"2019-09-26T03:57:03+08:00\",\"f\":1,\"text\":\"513. 找树左下角的值\",\"link\":\"/rust-leetcode/2019-09-26.html\"},{\"i\":\"337. 打家劫舍 III\",\"date\":\"2019-09-25T03:57:03+08:00\",\"f\":1,\"text\":\"337. 打家劫舍 III\",\"link\":\"/rust-leetcode/2019-09-25.html\"},{\"i\":\"297. 二叉树的序列化与反序列化\",\"date\":\"2019-09-24T03:57:03+08:00\",\"f\":1,\"text\":\"297. 二叉树的序列化与反序列化\",\"link\":\"/rust-leetcode/2019-09-24.html\"},{\"i\":\"257. 二叉树的所有路径\",\"date\":\"2019-09-23T03:57:03+08:00\",\"f\":1,\"text\":\"257. 二叉树的所有路径\",\"link\":\"/rust-leetcode/2019-09-23.html\"},{\"i\":\"230. 二叉搜索树中第K小的元素\",\"date\":\"2019-09-20T03:57:03+08:00\",\"f\":1,\"text\":\"230. 二叉搜索树中第K小的元素\",\"link\":\"/rust-leetcode/2019-09-20.html\"},{\"i\":\"226. 翻转二叉树\",\"date\":\"2019-09-19T03:57:03+08:00\",\"f\":1,\"text\":\"226. 翻转二叉树\",\"link\":\"/rust-leetcode/2019-09-19.html\"},{\"i\":\"199. 二叉树的右视图\",\"date\":\"2019-09-18T03:57:03+08:00\",\"f\":1,\"text\":\"199. 二叉树的右视图\",\"link\":\"/rust-leetcode/2019-09-18.html\"},{\"i\":\"124. 二叉树中的最大路径和-等效,但是更清晰\",\"date\":\"2019-09-17T03:57:03+08:00\",\"f\":1,\"text\":\"124. 二叉树中的最大路径和-等效,但是更清晰\",\"link\":\"/rust-leetcode/2019-09-17.html\"},{\"i\":\"124. 二叉树中的最大路径和-逻辑混乱的方法\",\"date\":\"2019-09-16T03:57:03+08:00\",\"f\":1,\"text\":\"124. 二叉树中的最大路径和-逻辑混乱的方法\",\"link\":\"/rust-leetcode/2019-09-16.html\"},{\"i\":\"129. 求根到叶子节点数字之和\",\"date\":\"2019-09-13T03:57:03+08:00\",\"f\":1,\"text\":\"129. 求根到叶子节点数字之和\",\"link\":\"/rust-leetcode/2019-09-13.html\"},{\"i\":\"144. 二叉树的前序遍历\",\"date\":\"2019-09-12T03:57:03+08:00\",\"f\":1,\"text\":\"144. 二叉树的前序遍历\",\"link\":\"/rust-leetcode/2019-09-12.html\"},{\"i\":\"113. 路径总和 II\",\"date\":\"2019-09-11T03:57:03+08:00\",\"f\":1,\"text\":\"113. 路径总和 II\",\"link\":\"/rust-leetcode/2019-09-11.html\"},{\"i\":\"112. 路径总和\",\"date\":\"2019-09-10T03:57:03+08:00\",\"f\":1,\"text\":\"112. 路径总和\",\"link\":\"/rust-leetcode/2019-09-10.html\"},{\"i\":\"111. 二叉树的最小深度\",\"date\":\"2019-09-09T03:57:03+08:00\",\"f\":1,\"text\":\"111. 二叉树的最小深度\",\"link\":\"/rust-leetcode/2019-09-09.html\"},{\"i\":\"110. 平衡二叉树\",\"date\":\"2019-09-06T03:57:03+08:00\",\"f\":1,\"text\":\"110. 平衡二叉树\",\"link\":\"/rust-leetcode/2019-09-06.html\"},{\"i\":\"108. 将有序数组转换为二叉搜索树\",\"date\":\"2019-09-05T03:57:03+08:00\",\"f\":1,\"text\":\"108. 将有序数组转换为二叉搜索树\",\"link\":\"/rust-leetcode/2019-09-05.html\"},{\"i\":\"101. 对称二叉树\",\"date\":\"2019-09-04T03:57:03+08:00\",\"f\":1,\"text\":\"101. 对称二叉树\",\"link\":\"/rust-leetcode/2019-09-04.html\"},{\"i\":\"100. 相同的树\",\"date\":\"2019-09-03T03:57:03+08:00\",\"f\":1,\"text\":\"100. 相同的树\",\"link\":\"/rust-leetcode/2019-09-03.html\"},{\"i\":\"99. 恢复二叉搜索树\",\"date\":\"2019-09-02T03:57:03+08:00\",\"f\":1,\"text\":\"99. 恢复二叉搜索树\",\"link\":\"/rust-leetcode/2019-09-02.html\"},{\"i\":\"107. 二叉树的层次遍历 II\",\"date\":\"2019-08-30T03:57:03+08:00\",\"f\":1,\"text\":\"107. 二叉树的层次遍历 II\",\"link\":\"/rust-leetcode/2019-08-30.html\"},{\"i\":\"104. 二叉树的最大深度\",\"date\":\"2019-08-29T03:57:03+08:00\",\"f\":1,\"text\":\"104. 二叉树的最大深度\",\"link\":\"/rust-leetcode/2019-08-29.html\"},{\"i\":\"103. 二叉树的锯齿形层次遍历\",\"date\":\"2019-08-28T03:57:03+08:00\",\"f\":1,\"text\":\"103. 二叉树的锯齿形层次遍历\",\"link\":\"/rust-leetcode/2019-08-28.html\"},{\"i\":\"102. 二叉树的层次遍历\",\"date\":\"2019-08-27T03:57:03+08:00\",\"f\":1,\"text\":\"102. 二叉树的层次遍历\",\"link\":\"/rust-leetcode/2019-08-27.html\"},{\"i\":\"641. 设计循环双端队列\",\"date\":\"2019-08-26T03:57:03+08:00\",\"f\":1,\"text\":\"641. 设计循环双端队列\",\"link\":\"/rust-leetcode/2019-08-26.html\"},{\"i\":\"29. 两数相除\",\"date\":\"2019-08-23T03:57:03+08:00\",\"f\":1,\"text\":\"29. 两数相除\",\"link\":\"/rust-leetcode/2019-08-23.html\"},{\"i\":\"925. 长按键入\",\"date\":\"2019-08-22T03:57:03+08:00\",\"f\":1,\"text\":\"925. 长按键入\",\"link\":\"/rust-leetcode/2019-08-22.html\"},{\"i\":\"713. 乘积小于K的子数组\",\"date\":\"2019-08-21T03:57:03+08:00\",\"f\":1,\"text\":\"713. 乘积小于K的子数组\",\"link\":\"/rust-leetcode/2019-08-21.html\"},{\"i\":\"146. LRU缓存机制-O(1)\",\"date\":\"2019-08-20T03:57:03+08:00\",\"f\":1,\"text\":\"146. LRU缓存机制-O(1)\",\"link\":\"/rust-leetcode/2019-08-20.html\"},{\"i\":\"146. LRU缓存机制\",\"date\":\"2019-08-19T03:57:03+08:00\",\"f\":1,\"text\":\"146. LRU缓存机制\",\"link\":\"/rust-leetcode/2019-08-19.html\"},{\"i\":\"402. 移掉K位数字\",\"date\":\"2019-08-18T03:57:03+08:00\",\"f\":1,\"text\":\"402. 移掉K位数字\",\"link\":\"/rust-leetcode/2019-08-18.html\"},{\"i\":\"106. 从中序与后序遍历序列构造二叉树\",\"date\":\"2019-08-17T03:57:03+08:00\",\"f\":1,\"text\":\"106. 从中序与后序遍历序列构造二叉树\",\"link\":\"/rust-leetcode/2019-08-17.html\"},{\"i\":\"105. 从前序与中序遍历序列构造二叉树\",\"date\":\"2019-08-16T03:57:03+08:00\",\"f\":1,\"text\":\"105. 从前序与中序遍历序列构造二叉树\",\"link\":\"/rust-leetcode/2019-08-16.html\"},{\"i\":\"114. 二叉树展开为链表\",\"date\":\"2019-08-15T03:57:03+08:00\",\"f\":1,\"text\":\"114. 二叉树展开为链表\",\"link\":\"/rust-leetcode/2019-08-15.html\"},{\"i\":\"120. 三角形最小路径和\",\"date\":\"2019-08-14T03:57:03+08:00\",\"f\":1,\"text\":\"120. 三角形最小路径和\",\"link\":\"/rust-leetcode/2019-08-14.html\"},{\"i\":\"704. 二分查找\",\"date\":\"2019-08-13T03:57:03+08:00\",\"f\":1,\"text\":\"704. 二分查找\",\"link\":\"/rust-leetcode/2019-08-13.html\"},{\"i\":\"145. 二叉树的后序遍历\",\"date\":\"2019-08-12T11:57:03+08:00\",\"f\":1,\"text\":\"145. 二叉树的后序遍历\",\"link\":\"/rust-leetcode/2019-08-12.html\"},{\"i\":\"94. 二叉树的中序遍历-非递归方式\",\"date\":\"2019-08-11T11:57:03+08:00\",\"f\":1,\"text\":\"94. 二叉树的中序遍历-非递归方式\",\"link\":\"/rust-leetcode/2019-08-11.html\"},{\"i\":\"94. 二叉树的中序遍历\",\"date\":\"2019-08-10T11:57:03+08:00\",\"f\":1,\"text\":\"94. 二叉树的中序遍历\",\"link\":\"/rust-leetcode/2019-08-10.html\"},{\"i\":\"60. 第k个排列\",\"date\":\"2019-08-04T09:57:03+08:00\",\"f\":1,\"text\":\"60. 第k个排列\",\"link\":\"/rust-leetcode/2019-08-04.html\"},{\"i\":\"32. 最长有效括号\",\"date\":\"2019-06-18T11:57:03+08:00\",\"f\":1,\"text\":\"32. 最长有效括号\",\"link\":\"/rust-leetcode/2019-06-18.html\"},{\"i\":\"98. 验证二叉搜索树\",\"date\":\"2019-06-17T11:57:03+08:00\",\"f\":1,\"text\":\"98. 验证二叉搜索树\",\"link\":\"/rust-leetcode/2019-06-17.html\"},{\"i\":\"222. 完全二叉树的节点个数\",\"date\":\"2019-06-15T11:57:03+08:00\",\"f\":1,\"text\":\"222. 完全二叉树的节点个数\",\"link\":\"/rust-leetcode/2019-06-15.html\"},{\"i\":\"380. 常数时间插入、删除和获取随机元素\",\"date\":\"2019-06-14T11:57:03+08:00\",\"f\":1,\"text\":\"380. 常数时间插入、删除和获取随机元素\",\"link\":\"/rust-leetcode/2019-06-14.html\"},{\"i\":\"47. 全排列 II\",\"date\":\"2019-06-11T11:57:03+08:00\",\"f\":1,\"text\":\"47. 全排列 II\",\"link\":\"/rust-leetcode/2019-06-11.html\"},{\"i\":\"71. 简化路径\",\"date\":\"2019-06-10T11:57:03+08:00\",\"f\":1,\"text\":\"71. 简化路径\",\"link\":\"/rust-leetcode/2019-06-10.html\"},{\"i\":\"91. 解码方法\",\"date\":\"2019-06-08T11:57:03+08:00\",\"f\":1,\"text\":\"91. 解码方法\",\"link\":\"/rust-leetcode/2019-06-08.html\"},{\"i\":\"622. 设计循环队列\",\"date\":\"2019-06-07T11:57:03+08:00\",\"f\":1,\"text\":\"622. 设计循环队列\",\"link\":\"/rust-leetcode/2019-06-07.html\"},{\"i\":\"96. 不同的二叉搜索树\",\"date\":\"2019-06-06T11:57:03+08:00\",\"f\":1,\"text\":\"96. 不同的二叉搜索树\",\"link\":\"/rust-leetcode/2019-06-06.html\"},{\"i\":\"字形变换\",\"date\":\"2019-06-06T03:57:03+08:00\",\"f\":1,\"text\":\"字形变换\",\"link\":\"/rust-leetcode/模板.html\"},{\"i\":\"5. 最长回文子串-另一种解法\",\"date\":\"2019-06-05T11:57:03+08:00\",\"f\":1,\"text\":\"5. 最长回文子串-另一种解法\",\"link\":\"/rust-leetcode/2019-06-05.html\"},{\"i\":\"5. 最长回文子串\",\"date\":\"2019-06-04T11:57:03+08:00\",\"f\":1,\"text\":\"5. 最长回文子串\",\"link\":\"/rust-leetcode/2019-06-04.html\"},{\"i\":\"109. 有序链表转换二叉搜索树\",\"date\":\"2019-06-03T11:57:03+08:00\",\"f\":1,\"text\":\"109. 有序链表转换二叉搜索树\",\"link\":\"/rust-leetcode/2019-06-03.html\"},{\"i\":\"6. Z 字形变换\",\"date\":\"2019-06-02T11:57:03+08:00\",\"f\":1,\"text\":\"6. Z 字形变换\",\"link\":\"/rust-leetcode/2019-06-02.html\"},{\"i\":\"2. 两数相加\",\"date\":\"2019-06-01T11:57:03+08:00\",\"f\":1,\"text\":\"2. 两数相加\",\"link\":\"/rust-leetcode/2019-06-01.html\"}],\"/rust/\":[{\"i\":\"rust中函数指针作为全局变量使用\",\"date\":\"2022-08-01T05:29:51+00:00\",\"f\":1,\"text\":\"rust中函数指针作为全局变量使用\",\"link\":\"/rust/rust_global_function_pointer.html\"},{\"i\":\"我对rust atomic的理解\",\"date\":\"2022-01-04T21:57:03+08:00\",\"f\":1,\"text\":\"我对rust atomic的理解\",\"link\":\"/rust/rust_atomic.html\"},{\"i\":\"Rust异步编程中我们应该用那种锁?\",\"date\":\"2020-12-31T11:57:03+08:00\",\"f\":1,\"text\":\"Rust异步编程中我们应该用那种锁?\",\"link\":\"/rust/rust_async_lock.html\"},{\"i\":\"Rust中enum和整数的互相转换\",\"date\":\"2020-12-03T07:57:03+08:00\",\"f\":1,\"text\":\"Rust中enum和整数的互相转换\",\"link\":\"/rust/convert_an_integer_to_an_enum.html\"},{\"i\":\"200行代码讲透Rust Futures的问题\",\"date\":\"2020-04-13T11:57:03+08:00\",\"f\":1,\"text\":\"200行代码讲透Rust Futures的问题\",\"link\":\"/rust/Futures_Explained_in_200_lines_of_Rust2.html\"},{\"i\":\"从头实现Rust异步执行器\",\"date\":\"2020-04-13T11:57:03+08:00\",\"f\":1,\"text\":\"从头实现Rust异步执行器\",\"link\":\"/rust/build_your_own_executor.html\"},{\"i\":\"从头实现Rust异步block_on\",\"date\":\"2020-04-12T11:57:03+08:00\",\"f\":1,\"text\":\"从头实现Rust异步block_on\",\"link\":\"/rust/build_your_own_block_on.html\"},{\"i\":\"200行代码讲透Rust Futures\",\"date\":\"2020-04-09T11:57:03+08:00\",\"f\":1,\"text\":\"200行代码讲透Rust Futures\",\"link\":\"/rust/Futures_Explained_in_200_lines_of_Rust.html\"},{\"i\":\"200行代码讲透Rust Futures-有bug版本\",\"date\":\"2020-04-09T11:57:03+08:00\",\"f\":1,\"text\":\"200行代码讲透Rust Futures-有bug版本\",\"link\":\"/rust/Futures_Explained_in_200_lines_of_Rust_with_error_version.html\"},{\"i\":\"Rust无锁编程\",\"date\":\"2020-03-16T11:57:03+08:00\",\"f\":1,\"text\":\"Rust无锁编程\",\"link\":\"/rust/lock-freedom-without-garbage-collection.html\"},{\"i\":\"rust开发工具 clion\",\"date\":\"2020-01-12T11:57:03+08:00\",\"f\":1,\"text\":\"rust开发工具 clion\",\"link\":\"/rust/rust开发工具.html\"},{\"i\":\"tokio async&await 初探\",\"date\":\"2019-12-05T03:57:03+08:00\",\"f\":1,\"text\":\"tokio async&await 初探\",\"link\":\"/rust/tokio_async_await 初探.html\"},{\"i\":\"在ubuntu 18.04上交叉编译rust 程序\",\"date\":\"2019-10-30T11:57:03+08:00\",\"f\":1,\"text\":\"在ubuntu 18.04上交叉编译rust 程序\",\"link\":\"/rust/交叉编译rust.html\"},{\"i\":\"tokio笔记.md\",\"date\":\"2019-07-03T11:57:03+08:00\",\"f\":1,\"text\":\"tokio笔记.md\",\"link\":\"/rust/tokio笔记.html\"},{\"i\":\"Ownership 101\",\"date\":\"2019-05-01T11:57:03+08:00\",\"f\":1,\"text\":\"Ownership 101\",\"link\":\"/rust/ownership101.html\"},{\"i\":\"rust学习笔记\",\"date\":\"2019-04-03T11:57:03+08:00\",\"f\":1,\"text\":\"rust学习笔记\",\"link\":\"/rust/my_note.html\"},{\"i\":\"从零实现消息中间件\",\"l\":\"/rust/rnats/\",\"date\":\"2019-01-30T11:57:03+08:00\",\"text\":\"从零实现消息中间件\",\"link\":\"/rust/rnats/\",\"children\":[{\"i\":\"从零实现消息中间件-client\",\"date\":\"2020-02-20T09:57:03+08:00\",\"f\":1,\"text\":\"从零实现消息中间件-client\",\"link\":\"/rust/rnats/6.client.html\"},{\"i\":\"从零实现消息中间件-server\",\"date\":\"2020-02-06T09:57:03+08:00\",\"f\":1,\"text\":\"从零实现消息中间件-server\",\"link\":\"/rust/rnats/4.server.html\"},{\"i\":\"从零实现消息中间件-sublist\",\"date\":\"2020-02-05T09:57:03+08:00\",\"f\":1,\"text\":\"从零实现消息中间件-sublist\",\"link\":\"/rust/rnats/3.sublist.html\"},{\"i\":\"从零实现消息中间件\",\"date\":\"2020-01-31T09:57:03+08:00\",\"f\":1,\"text\":\"从零实现消息中间件\",\"link\":\"/rust/rnats/1.start.html\"},{\"i\":\"从零实现消息中间件-parser\",\"date\":\"2020-01-31T09:57:03+08:00\",\"f\":1,\"text\":\"从零实现消息中间件-parser\",\"link\":\"/rust/rnats/2.parser.html\"},{\"i\":\"从零实现消息中间件-server.client\",\"date\":\"2020-01-31T09:57:03+08:00\",\"f\":1,\"text\":\"从零实现消息中间件-server.client\",\"link\":\"/rust/rnats/5.server.client.html\"},{\"i\":\"rnats ppt\",\"l\":\"/rust/rnats/ppt/\",\"date\":\"2020-01-31T09:57:03+08:00\",\"text\":\"rnats ppt\",\"link\":\"/rust/rnats/ppt/\",\"children\":[{\"i\":\"从零实现消息中间件-client\",\"date\":\"2020-01-31T09:57:03+08:00\",\"f\":1,\"text\":\"从零实现消息中间件-client\",\"link\":\"/rust/rnats/ppt/从零实现消息中间件-client.html\"},{\"i\":\"从零实现消息中间件-server.client\",\"date\":\"2020-01-31T09:57:03+08:00\",\"f\":1,\"text\":\"从零实现消息中间件-server.client\",\"link\":\"/rust/rnats/ppt/从零实现消息中间件-server.client.html\"},{\"i\":\"从零实现消息中间件-server\",\"date\":\"2020-01-31T09:57:03+08:00\",\"f\":1,\"text\":\"从零实现消息中间件-server\",\"link\":\"/rust/rnats/ppt/从零实现消息中间件-server.html\"}]}]}],\"/other/\":[{\"i\":\"rcore实验记录\",\"date\":\"2022-07-31T11:06:23+08:00\",\"f\":1,\"text\":\"rcore实验记录\",\"link\":\"/other/rcore_os_program.html\"},{\"i\":\"go语言的内存模型\",\"date\":\"2022-05-30T11:06:23+08:00\",\"f\":1,\"text\":\"go语言的内存模型\",\"link\":\"/other/go_memory_model.html\"},{\"i\":\"移植一个c项目到WebAssembly的体验\",\"date\":\"2022-03-28T11:06:23+08:00\",\"f\":1,\"text\":\"移植一个c项目到WebAssembly的体验\",\"link\":\"/other/webassembly_two_days_exercise.html\"},{\"i\":\"一个实用的分布式Go任务处理库\",\"date\":\"2022-01-29T05:29:51+00:00\",\"f\":1,\"text\":\"一个实用的分布式Go任务处理库\",\"link\":\"/other/asynq_introduction.html\"},{\"i\":\"opc 统一架构学习笔记\",\"date\":\"2022-01-08T01:19:42.000Z\",\"f\":1,\"text\":\"opc 统一架构学习笔记\",\"link\":\"/other/opc 统一架构学习笔记.html\"},{\"i\":\"opcua_cross_compile_for_raspeberry\",\"date\":\"2022-01-08T01:19:42.000Z\",\"f\":1,\"text\":\"opcua_cross_compile_for_raspeberry\",\"link\":\"/other/opcua_cross_compile_for_raspeberry.html\"},{\"i\":\"工具列表\",\"date\":\"2022-01-08T01:19:42.000Z\",\"f\":1,\"text\":\"工具列表\",\"link\":\"/other/工作中常用工具入门.html\"},{\"i\":\"typescript的一些高级语法\",\"date\":\"2022-01-010T21:57:03+08:00\",\"f\":1,\"text\":\"typescript的一些高级语法\",\"link\":\"/other/typescript_advanced_syntax.html\"},{\"i\":\"opcua Rust版本学习-client\",\"date\":\"2020-10-20T09:48:12+00:00\",\"f\":1,\"text\":\"opcua Rust版本学习-client\",\"link\":\"/other/opcua-rust.html\"},{\"i\":\"Windows下Hook C++ DLL\",\"date\":\"2020-10-15T11:06:23+08:00\",\"f\":1,\"text\":\"Windows下Hook C++ DLL\",\"link\":\"/other/windows_hook_thiscall.html\"},{\"i\":\"抛弃过时的SourceInsight 使用clion阅读linux内核代码\",\"date\":\"2020-08-25T07:06:23+08:00\",\"f\":1,\"text\":\"抛弃过时的SourceInsight 使用clion阅读linux内核代码\",\"link\":\"/other/read_kerenel_use_clion.html\"},{\"i\":\"grpcox教程\",\"date\":\"2020-08-22T11:06:23+08:00\",\"f\":1,\"text\":\"grpcox教程\",\"link\":\"/other/grpcox.html\"},{\"i\":\"ubuntu apt 安装指定版本的软件\",\"date\":\"2020-07-01T05:29:51+00:00\",\"f\":1,\"text\":\"ubuntu apt 安装指定版本的软件\",\"link\":\"/other/apt安装指定版本软件.html\"},{\"i\":\"高性能系统中使用go的注意事项\",\"date\":\"2019-12-25T07:06:23+08:00\",\"f\":1,\"text\":\"高性能系统中使用go的注意事项\",\"link\":\"/other/高性能go开发.html\"},{\"i\":\"hugo 博客写作技巧\",\"date\":\"2019-07-30T11:06:23+08:00\",\"f\":1,\"text\":\"hugo 博客写作技巧\",\"link\":\"/other/hugo博客写作.html\"},{\"i\":\"git以及github回退到指定版本\",\"date\":\"2019-06-30T11:06:23+08:00\",\"f\":1,\"text\":\"git以及github回退到指定版本\",\"link\":\"/other/git以及github回退.html\"},{\"i\":\"如何在mac上使用wireshark对安卓设备进行抓包\",\"date\":\"2019-06-28T07:06:23+08:00\",\"f\":1,\"text\":\"如何在mac上使用wireshark对安卓设备进行抓包\",\"link\":\"/other/capture_with_wireshark_for_android.html\"},{\"i\":\"使用clion调试开发比特币源码\",\"date\":\"2019-06-28T07:06:23+08:00\",\"f\":1,\"text\":\"使用clion调试开发比特币源码\",\"link\":\"/other/使用clion调试开发比特币源码.html\"},{\"i\":\"crossOver source insight 4.0使用\",\"date\":\"2019-05-10T02:23:17.437575+00:00\",\"f\":1,\"text\":\"crossOver source insight 4.0使用\",\"link\":\"/other/crossOver source insight 4.0使用.html\"},{\"i\":\"五个goland进行go开发的小技巧\",\"date\":\"2019-05-09T00:59:35.138044+00:00\",\"f\":1,\"text\":\"五个goland进行go开发的小技巧\",\"link\":\"/other/五个goland进行go开发的小技巧.html\"},{\"i\":\"brew安装指定版本boost\",\"date\":\"2019-03-22T05:29:51+00:00\",\"f\":1,\"text\":\"brew安装指定版本boost\",\"link\":\"/other/brew安装指定版本boost.html\"},{\"i\":\"不用外部插件启用u盘ntfs写功能\",\"date\":\"2018-11-23T06:01:02+00:00\",\"f\":1,\"text\":\"不用外部插件启用u盘ntfs写功能\",\"link\":\"/other/不用外部插件启用u盘ntfs写功能.html\"},{\"i\":\"使用ubuntu搭建时间机器备份服务\",\"date\":\"2018-11-20T04:15:04+00:00\",\"f\":1,\"text\":\"使用ubuntu搭建时间机器备份服务\",\"link\":\"/other/使用ubuntu搭建时间机器备份服务.html\"},{\"i\":\"learningPythonV4\",\"date\":\"2018-10-08T09:48:12+00:00\",\"f\":1,\"text\":\"learningPythonV4\",\"link\":\"/other/learningPythonV4.html\"},{\"i\":\"用 go 写 WebAssembly入门\",\"date\":\"2018-09-07T01:14:10+00:00\",\"f\":1,\"text\":\"用 go 写 WebAssembly入门\",\"link\":\"/other/用 go 写 WebAssembly入门.html\"},{\"i\":\"阈值签名笔记\",\"date\":\"2018-09-07T01:14:10+00:00\",\"f\":1,\"text\":\"阈值签名笔记\",\"link\":\"/other/阈值签名.html\"},{\"i\":\"一条命令深度清理你的mac\",\"date\":\"2018-05-01T11:06:23+08:00\",\"f\":1,\"text\":\"一条命令深度清理你的mac\",\"link\":\"/other/clean_mac.html\"},{\"i\":\"go 笔记\",\"date\":\"2018-04-28T11:06:23+08:00\",\"f\":1,\"text\":\"go 笔记\",\"link\":\"/other/learn_go.html\"},{\"i\":\"修改vscode caipeiyu.writeCnblog ,简化博客发布\",\"date\":\"2018-04-26T11:06:23+08:00\",\"f\":1,\"text\":\"修改vscode caipeiyu.writeCnblog ,简化博客发布\",\"link\":\"/other/vscode_cnblog_plugin.html\"}]}},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}")</script>
    
  </body>
</html>