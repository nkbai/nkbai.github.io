<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>200行代码讲透Rust Futures | Steven's Blog</title>
    <meta name="description" content="steven's Blog">
    <link rel="stylesheet" href="/assets/style.c57e31ec.css">
    <link rel="modulepreload" href="/assets/Home.bca0b827.js">
    <link rel="modulepreload" href="/assets/viewer.6bf00c48.js">
    <link rel="modulepreload" href="/assets/echarts.b33419de.js">
    <link rel="modulepreload" href="/assets/flowchart.31c8d424.js">
    <link rel="modulepreload" href="/assets/mermaid.409d2902.js">
    <link rel="modulepreload" href="/assets/runner.7dc2dd49.js">
    <link rel="modulepreload" href="/assets/app.9c6df70b.js">
    <link rel="modulepreload" href="/assets/rust_Futures_Explained_in_200_lines_of_Rust.md.417ca294.lean.js">
    <link rel="modulepreload" href="/assets/app.9c6df70b.js">
    <link rel="icon" href="/logo.png">
    <meta name="twitter:title" content="200行代码讲透Rust Futures | Steven&#39;s Blog">
    <meta property="og:title" content="200行代码讲透Rust Futures | Steven&#39;s Blog">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="Steven&#39;s Blog, back to home" data-v-675d8756 data-v-4a583abe><img class="logo" src="/logo.png" alt="Logo" data-v-4a583abe> Steven&#39;s Blog</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-15acbf05><!--[--><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/about.html" data-v-b8818f8c>about <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/blockchain/" data-v-b8818f8c>block chain <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/rust-leetcode/" data-v-b8818f8c>leetcode <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/other/" data-v-b8818f8c>other <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item active" href="/rust/" data-v-b8818f8c>rust <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/static_analysis/" data-v-b8818f8c>静态分析 <!----></a></div></div><!--]--><!----><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item isExternal" href="https://github.com/nkbai/Blog" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-15acbf05><!--[--><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/about.html" data-v-b8818f8c>about <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/blockchain/" data-v-b8818f8c>block chain <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/rust-leetcode/" data-v-b8818f8c>leetcode <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/other/" data-v-b8818f8c>other <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item active" href="/rust/" data-v-b8818f8c>rust <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/static_analysis/" data-v-b8818f8c>静态分析 <!----></a></div></div><!--]--><!----><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item isExternal" href="https://github.com/nkbai/Blog" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><a class="sidebar-link-item active" href="/rust/Futures_Explained_in_200_lines_of_Rust.html">200行代码讲透Rust Futures</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#一-引言">一 引言</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#这本书涵盖的内容">这本书涵盖的内容</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#阅读练习和进一步阅读">阅读练习和进一步阅读</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#感谢">感谢</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#二-背景资料">二 背景资料</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#线程">线程</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#绿色线程-green-threads">绿色线程(Green threads)</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#基于回调的方法">基于回调的方法</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#从回调到承诺-promises">从回调到承诺 (promises)</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#三-rust中的futures">三 Rust中的Futures</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#概述">概述</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#futures">Futures</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#leaf-futures">Leaf futures</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#non-leaf-futures">Non-leaf-futures</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#运行时-runtimes">运行时(Runtimes)</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#rust-的标准库做了什么">Rust 的标准库做了什么</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#i-o密集型-vs-cpu密集型任务">I/O密集型 VS CPU密集型任务</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#奖励部分">奖励部分</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#四-唤醒器和上下文-waker-and-context">四 唤醒器和上下文(Waker and Context)</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#概述-1">概述</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#唤醒器">唤醒器</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#理解唤醒器">理解唤醒器</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#rust中的胖指针">Rust中的胖指针</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#奖励部分-1">奖励部分</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#五-生成器和async-await">五 生成器和async/await</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#概述-2">概述</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#为什么要学习生成器">为什么要学习生成器</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#组合子-combinators">组合子(Combinators)</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#无栈协程-生成器">无栈协程/生成器</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#生成器是如何工作的">生成器是如何工作的</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#异步和生成器">异步和生成器</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#奖励部分-正在使用的自引用生成器">奖励部分-正在使用的自引用生成器</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#六-pin">六 Pin</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#概述-3">概述</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#定义">定义</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#pinning和自引用结构">Pinning和自引用结构</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#固定在栈上">固定在栈上</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#固定在堆上">固定在堆上</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#pinning的一些实用规则">Pinning的一些实用规则</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#映射-结构体的固定">映射/结构体的固定</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#pin和drop">Pin和Drop</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#把它们放在一起">把它们放在一起</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#奖励部分-2">奖励部分</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#七-实现futures-主要例子">七 实现Futures--主要例子</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#实现我们自己的futures">实现我们自己的Futures</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#执行器">执行器</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#实现future">实现Future</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#reactor">Reactor</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#async-await和并发async-await">Async/Await和并发Async/Await</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#奖励部分-暂停线程的更好办法">奖励部分-暂停线程的更好办法</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#八-完整的例子">八 完整的例子</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#九-结论和练习">九 结论和练习</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#编码park">编码park</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#编码传递reactor">编码传递reactor</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#创建一个更好的执行器">创建一个更好的执行器</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#进一步阅读">进一步阅读</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#转载说明">转载说明</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/Futures_Explained_in_200_lines_of_Rust_with_error_version.html">200行代码讲透Rust Futures-有bug版本</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/Futures_Explained_in_200_lines_of_Rust2.html">200行代码讲透Rust Futures的问题</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/ownership101.html">Ownership 101</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/convert_an_integer_to_an_enum.html">Rust中enum和整数的互相转换</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rust_async_lock.html">Rust异步编程中我们应该用那种锁?</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/lock-freedom-without-garbage-collection.html">Rust无锁编程</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/my_note.html">rust学习笔记</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rust开发工具.html">rust开发工具 clion</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/tokio_async_await 初探.html">tokio async&amp;await 初探</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/tokio笔记.html">tokio笔记.md</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/build_your_own_block_on.html">从头实现Rust异步block_on</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/build_your_own_executor.html">从头实现Rust异步执行器</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/">从零实现消息中间件</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/ppt/">rnats ppt</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/ppt/从零实现消息中间件-client.html">从零实现消息中间件-client</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/ppt/从零实现消息中间件-server.html">从零实现消息中间件-server</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/ppt/从零实现消息中间件-server.client.html">从零实现消息中间件-server.client</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/1.start.html">从零实现消息中间件</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/6.client.html">从零实现消息中间件-client</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/2.parser.html">从零实现消息中间件-parser</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/4.server.html">从零实现消息中间件-server</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/5.server.client.html">从零实现消息中间件-server.client</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rnats/3.sublist.html">从零实现消息中间件-sublist</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/交叉编译rust.html">在ubuntu 18.04上交叉编译rust 程序</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/rust/rust_atomic.html">我对rust atomic的理解</a><!----></li><!--]--></ul><!--[--><!--]--></aside><!-- TODO: make this button accessible --><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><p><a href="https://cfsamson.github.io/books-futures-explained/introduction.html" target="_blank" rel="noopener noreferrer">原文地址 Futures Explained in 200 Lines of Rust</a></p><h2 id="一-引言"><a class="header-anchor" href="#一-引言" aria-hidden="true">#</a> 一 引言</h2><p>这本书的目的是用一个例子驱动的方法来解释Rust中的Futures，探索为什么他们被设计成这样，以及他们如何工作。 我们还将介绍在编程中处理并发性时的一些替代方案。</p><p>理解这本书中描述的细节， 不需要使用Rust中的 futures或async/await。 这是为那些好奇的人准备的，他们想知道这一切是如何运作的。</p><h3 id="这本书涵盖的内容"><a class="header-anchor" href="#这本书涵盖的内容" aria-hidden="true">#</a> 这本书涵盖的内容</h3><p>这本书将试图解释你可能想知道的一切，包括不同类型的执行器(executor)和运行时(runtime)的主题。 我们将在本书中实现一个非常简单的运行时，介绍一些概念，但这已经足够开始了。</p><p><a href="https://github.com/stjepang" target="_blank" rel="noopener noreferrer">Stjepan Glavina</a> 发表了一系列关于异步运行时和执行器的优秀文章，如果谣言属实，那么在不久的将来他会发表更多的文章。</p><p>你应该做的是先读这本书，然后继续阅读 <a href="https://stjepang.github.io/" target="_blank" rel="noopener noreferrer">stejpang 的文章</a>，了解更多关于运行时以及它们是如何工作的，特别是:</p><ol><li><a href="https://stjepang.github.io/2020/01/25/build-your-own-block-on.html" target="_blank" rel="noopener noreferrer">构建自的block_on</a></li><li><a href="https://stjepang.github.io/2020/01/31/build-your-own-executor.html" target="_blank" rel="noopener noreferrer">构建自己的executor</a></li></ol><p>我将自己限制在一个200行的主示例(因此才有了这个标题)中，以限制范围并介绍一个可以轻松进一步研究的示例。</p><p>然而，有很多东西需要消化，这并不像我所说的那么简单，但是我们会一步一步来，所以喝杯茶，放松一下。</p><blockquote><p>这本书是在开放的，并欢迎贡献。 你可以在<a href="https://github.com/cfsamson/books-futures-explained" target="_blank" rel="noopener noreferrer">这里找到这本书</a>。 最后的例子，你可以<a href="https://github.com/cfsamson/examples-futures" target="_blank" rel="noopener noreferrer">克隆或复制</a>可以在这里找到。 任何建议或改进可以归档为一个公关或在问题追踪的书。 一如既往，我们欢迎各种各样的反馈。</p></blockquote><h3 id="阅读练习和进一步阅读"><a class="header-anchor" href="#阅读练习和进一步阅读" aria-hidden="true">#</a> 阅读练习和进一步阅读</h3><p>在<a href="#%E7%BB%93%E8%AE%BA%E5%92%8C%E7%BB%83%E4%B9%A0">最后一章</a>)中，我冒昧地提出了一些小练习，如果你想进一步探索的话。</p><p>这本书也是我在 Rust 中写的关于并发编程的第四本书。 如果你喜欢它，你可能也想看看其他的:</p><ul><li><a href="https://cfsamson.gitbook.io/green-threads-explained-in-200-lines-of-rust/" target="_blank" rel="noopener noreferrer">Green Threads Explained in 200 lines of rust</a></li><li><a href="https://cfsamson.github.io/book-exploring-async-basics/" target="_blank" rel="noopener noreferrer">The Node Experiment - Exploring Async Basics with Rust 节点实验——用Rust探索异步基础</a></li><li><a href="https://cfsamsonbooks.gitbook.io/epoll-kqueue-iocp-explained/" target="_blank" rel="noopener noreferrer">Epoll, Kqueue and IOCP Explained with Rust 用 Rust 解释 Epoll，Kqueue 和 IOCP</a></li></ul><h3 id="感谢"><a class="header-anchor" href="#感谢" aria-hidden="true">#</a> 感谢</h3><p>我想借此机会感谢 mio，tokio，async std，Futures，libc，crossbeam 背后的人们，他们支撑着这个异步生态系统，却很少在我眼中得到足够的赞扬。</p><p>特别感谢 jonhoo，他对我这本书的初稿给予了一些有价值的反馈。 他还没有读完最终的成品，但是我们应该向他表示感谢。</p><h2 id="二-背景资料"><a class="header-anchor" href="#二-背景资料" aria-hidden="true">#</a> 二 背景资料</h2><p>在我们深入研究 Futures in Rust 的细节之前，让我们快速了解一下处理并发编程的各种方法，以及每种方法的优缺点。</p><p>同时当涉及到并发性时,我们也会解释为什么这么做，这将使我们更容易深入理解Futures.</p><blockquote><p>为了好玩，我在大多数示例中添加了一小段可运行代码。 如果你像我一样，事情会变得更有趣，也许你会看到一些你从未见过的东西。</p></blockquote><h3 id="线程"><a class="header-anchor" href="#线程" aria-hidden="true">#</a> 线程</h3><p>现在，实现这一点的一个方法就是让操作系统为我们处理好一切。 我们只需为每个要完成的任务生成一个新的操作系统线程，并像通常那样编写代码。</p><p>我们用来处理并发性的运行时就是操作系统本身。</p><p>优点:</p><ul><li>简单</li><li>易用</li><li>在任务之间切换相当快</li><li>不需要付出即可得到并行支持</li></ul><p>缺点:</p><ul><li>操作系统级线程的堆栈相当大。 如果同时有许多任务等待(就像在负载很重的 web 服务器中那样) ，那么内存将很快耗尽</li><li>这涉及到很多系统调用。当任务数量很高时，这可能会非常昂贵</li><li>操作系统有很多事情需要处理。 它可能不会像你希望的那样快速地切换回线程</li><li>某些系统可能不支持线程</li></ul><p><strong>在 Rust 中使用操作系统线程看起来像这样:</strong></p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>thread<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;So we start the program here!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> t1 <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;We create tasks which gets run when they&#39;re finished!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> t2 <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;We can even chain callbacks...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> t3 <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;...like this!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t3<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;While our tasks are executing we can do other stuff here.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>操作系统线程肯定有一些相当大的优势。 这也是为什么所有这些讨论“异步”和并发性把线程摆在首位？</p><p>首先。 为了使计算机有效率，它们需要多任务处理。 一旦你开始深入研究(比如<a href="https://os.phil-opp.com/async-await/" target="_blank" rel="noopener noreferrer">操作系统是如何工作的</a>) ，你就会发现并发无处不在。 这是我们做任何事情的基础。</p><p>其次，我们有网络。</p><p>Webservers 是关于I/O和处理小任务(请求)的。 当小任务的数量很大时，由于它们所需的内存和创建新线程所涉及的开销，就不适合今天的操作系统线程。</p><p>如果负载是可变的，那么问题就更大了，这意味着程序在任何时间点的当前任务数量都是不可预测的。 这就是为什么今天你会看到如此多的异步web框架和数据库驱动程序。</p><p>然而有大量的问题,标准的线程通常是正确的解决方案。 因此在使用异步库之前，请三思而后行。</p><p>现在，让我们来看看多任务处理的其他选项。 它们都有一个共同点，那就是它们实现了一种多任务处理的方式，即拥有一个“用户界面”运行时:</p><h3 id="绿色线程-green-threads"><a class="header-anchor" href="#绿色线程-green-threads" aria-hidden="true">#</a> 绿色线程(Green threads)</h3><p>绿色线程使用与操作系统相同的机制，为每个任务创建一个线程，设置一个堆栈，保存 CPU 状态，并通过“上下文切换”从一个任务(线程)跳转到另一个任务(线程)。</p><p>我们将控制权交给调度程序(在这样的系统中，调度程序是运行时的核心部分) ，然后调度程序继续运行不同的任务。</p><p>Rust曾经支持绿色线程，但他们它达到1.0之前被删除了， 执行状态存储在每个栈中，因此在这样的解决方案中不需要<code>async</code>,<code>await</code>,<code>Futures</code> 或者<code>Pin</code>。</p><p>典型的流程是这样的:</p><ol><li>运行一些非阻塞代码</li><li>对某些外部资源进行阻塞调用</li><li>跳转到main”线程，该线程调度一个不同的线程来运行，并“跳转”到该栈中</li><li>在新线程上运行一些非阻塞代码，直到新的阻塞调用或任务完成</li><li>“跳转”回到“main&quot;线程 ，调度一个新线程，这个新线程的状态已经是<code>Ready</code>,然后跳转到该线程</li></ol><p>这些“跳转”被称为上下文切换，当你阅读这篇文章的时候，你的操作系统每秒钟都会做很多次。</p><p>优点:</p><ol><li>栈大小可能需要增长,解决这个问题不容易,并且会有成本.<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></li><li>它不是一个零成本抽象(这也是Rust早期有绿色线程,后来删除的原因之一)</li><li>如果您想要支持许多不同的平台，就很难正确实现</li></ol><p>一个绿色线程的例子可以是这样的:</p><blockquote><p>下面的例子是一个改编的例子，来自我之前写的一本<a href="https://cfsamson.gitbook.io/green-threads-explained-in-200-lines-of-rust/" target="_blank" rel="noopener noreferrer">200行Rust说清绿色线程</a>的 gitbook。 如果你想知道发生了什么，你会发现书中详细地解释了一切。 下面的代码非常不安全，只是为了展示一个真实的例子。 这绝不是为了展示“最佳实践”。 这样我们就能达成共识了。</p></blockquote><div class="language-rust line-numbers-mode"><pre><code> <span class="token attribute attr-name">#![feature(asm, naked_functions)]</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>ptr<span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">DEFAULT_STACK_SIZE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">MAX_THREADS</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token constant">RUNTIME</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Runtime</span> <span class="token punctuation">{</span>
    threads<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Thread</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    current<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

  <span class="token attribute attr-name">#[derive(PartialEq, Eq, Debug)]</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">{</span>
    <span class="token class-name">Available</span><span class="token punctuation">,</span>
    <span class="token class-name">Running</span><span class="token punctuation">,</span>
    <span class="token class-name">Ready</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Thread</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    stack<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    ctx<span class="token punctuation">:</span> <span class="token class-name">ThreadContext</span><span class="token punctuation">,</span>
    state<span class="token punctuation">:</span> <span class="token class-name">State</span><span class="token punctuation">,</span>
    task<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

 <span class="token attribute attr-name">#[derive(Debug, Default)]</span>
 <span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">ThreadContext</span> <span class="token punctuation">{</span>
    rsp<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    r15<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    r14<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    r13<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    r12<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    rbx<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    rbp<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    thread_ptr<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
            id<span class="token punctuation">,</span>
            stack<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0_u8</span><span class="token punctuation">;</span> <span class="token constant">DEFAULT_STACK_SIZE</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            ctx<span class="token punctuation">:</span> <span class="token class-name">ThreadContext</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            state<span class="token punctuation">:</span> <span class="token class-name">State</span><span class="token punctuation">::</span><span class="token class-name">Available</span><span class="token punctuation">,</span>
            task<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Runtime</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> base_thread <span class="token operator">=</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
            id<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            stack<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0_u8</span><span class="token punctuation">;</span> <span class="token constant">DEFAULT_STACK_SIZE</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            ctx<span class="token punctuation">:</span> <span class="token class-name">ThreadContext</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            state<span class="token punctuation">:</span> <span class="token class-name">State</span><span class="token punctuation">::</span><span class="token class-name">Running</span><span class="token punctuation">,</span>
            task<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> threads <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>base_thread<span class="token punctuation">]</span><span class="token punctuation">;</span>
        threads<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>thread_ptr <span class="token operator">=</span> <span class="token operator">&amp;</span>threads<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">Thread</span> <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> available_threads<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Thread</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token constant">MAX_THREADS</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>i<span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">Thread</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threads<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> available_threads<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Runtime</span> <span class="token punctuation">{</span>
            threads<span class="token punctuation">,</span>
            current<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> r_ptr<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">Runtime</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
            <span class="token constant">RUNTIME</span> <span class="token operator">=</span> r_ptr <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">!</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">t_yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token namespace">std<span class="token punctuation">::</span>process<span class="token punctuation">::</span></span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">t_return</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>current <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>threads<span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>current<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">State</span><span class="token punctuation">::</span><span class="token class-name">Available</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">t_yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">t_yield</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> pos <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>current<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token keyword">self</span><span class="token punctuation">.</span>threads<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">!=</span> <span class="token class-name">State</span><span class="token punctuation">::</span><span class="token class-name">Ready</span> <span class="token punctuation">{</span>
            pos <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> pos <span class="token operator">==</span> <span class="token keyword">self</span><span class="token punctuation">.</span>threads<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> pos <span class="token operator">==</span> <span class="token keyword">self</span><span class="token punctuation">.</span>current <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>threads<span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>current<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">!=</span> <span class="token class-name">State</span><span class="token punctuation">::</span><span class="token class-name">Available</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>threads<span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>current<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">State</span><span class="token punctuation">::</span><span class="token class-name">Ready</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>threads<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">State</span><span class="token punctuation">::</span><span class="token class-name">Running</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> old_pos <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>current<span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>current <span class="token operator">=</span> pos<span class="token punctuation">;</span>

        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
            <span class="token function">switch</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span>threads<span class="token punctuation">[</span>old_pos<span class="token punctuation">]</span><span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>threads<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">.</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">spawn</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">Fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">&#39;static</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>f<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> rt_ptr <span class="token operator">=</span> <span class="token constant">RUNTIME</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> <span class="token class-name">Runtime</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> available <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>rt_ptr<span class="token punctuation">)</span>
                <span class="token punctuation">.</span>threads
                <span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>t<span class="token closure-punctuation punctuation">|</span></span> t<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token class-name">State</span><span class="token punctuation">::</span><span class="token class-name">Available</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;no available thread.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                
            <span class="token keyword">let</span> size <span class="token operator">=</span> available<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> s_ptr <span class="token operator">=</span> available<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">as_mut_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            available<span class="token punctuation">.</span>task <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            available<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>thread_ptr <span class="token operator">=</span> available <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">Thread</span> <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">;</span>
            <span class="token namespace">ptr<span class="token punctuation">::</span></span><span class="token function">write</span><span class="token punctuation">(</span>s_ptr<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">(</span>size <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">isize</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> guard <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token namespace">ptr<span class="token punctuation">::</span></span><span class="token function">write</span><span class="token punctuation">(</span>s_ptr<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">(</span>size <span class="token operator">-</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">isize</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> call <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            available<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>rsp <span class="token operator">=</span> s_ptr<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">(</span>size <span class="token operator">-</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">isize</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">;</span>
            available<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">State</span><span class="token punctuation">::</span><span class="token class-name">Ready</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">call</span><span class="token punctuation">(</span>thread<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> thread <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token operator">*</span><span class="token punctuation">(</span>thread <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">Thread</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>thread<span class="token punctuation">.</span>task <span class="token punctuation">{</span>
        <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

 <span class="token attribute attr-name">#[naked]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">guard</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> rt_ptr <span class="token operator">=</span> <span class="token constant">RUNTIME</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> <span class="token class-name">Runtime</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> rt <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span>rt_ptr<span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;THREAD {} FINISHED.&quot;</span><span class="token punctuation">,</span> rt<span class="token punctuation">.</span>threads<span class="token punctuation">[</span>rt<span class="token punctuation">.</span>current<span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rt<span class="token punctuation">.</span><span class="token function">t_return</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">yield_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> rt_ptr <span class="token operator">=</span> <span class="token constant">RUNTIME</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> <span class="token class-name">Runtime</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>rt_ptr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">t_yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

 <span class="token attribute attr-name">#[naked]</span>
 <span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function-definition function">switch</span><span class="token punctuation">(</span>old<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> <span class="token class-name">ThreadContext</span><span class="token punctuation">,</span> new<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">ThreadContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token macro property">asm!</span><span class="token punctuation">(</span><span class="token string">&quot;
        mov     %rsp, 0x00($0)
        mov     %r15, 0x08($0)
        mov     %r14, 0x10($0)
        mov     %r13, 0x18($0)
        mov     %r12, 0x20($0)
        mov     %rbx, 0x28($0)
        mov     %rbp, 0x30($0)

        mov     0x00($1), %rsp
        mov     0x08($1), %r15
        mov     0x10($1), %r14
        mov     0x18($1), %r13
        mov     0x20($1), %r12
        mov     0x28($1), %rbx
        mov     0x30($1), %rbp
        mov     0x38($1), %rdi
        ret
        &quot;</span>
    <span class="token punctuation">:</span>
    <span class="token punctuation">:</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">(</span>old<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">(</span>new<span class="token punctuation">)</span>
    <span class="token punctuation">:</span>
    <span class="token punctuation">:</span> <span class="token string">&quot;alignstack&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token attribute attr-name">#[cfg(not(windows))]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> runtime <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    runtime<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Runtime</span><span class="token punctuation">::</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;I haven&#39;t implemented a timer in this example.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">yield_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Finally, notice how the tasks are executed concurrently.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Runtime</span><span class="token punctuation">::</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;But we can still nest tasks...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Runtime</span><span class="token punctuation">::</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;...like this!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    runtime<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token attribute attr-name">#[cfg(windows)]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> runtime <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    runtime<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Runtime</span><span class="token punctuation">::</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;I haven&#39;t implemented a timer in this example.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">yield_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Finally, notice how the tasks are executed concurrently.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Runtime</span><span class="token punctuation">::</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;But we can still nest tasks...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Runtime</span><span class="token punctuation">::</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;...like this!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    runtime<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br></div></div><p>还在坚持阅读本书？ 很好。 如果上面的代码很难理解，不要感到沮丧。 如果不是我自己写的，我可能也会有同样的感觉。 你随时可以回去读,稍后我还会解释。</p><h3 id="基于回调的方法"><a class="header-anchor" href="#基于回调的方法" aria-hidden="true">#</a> 基于回调的方法</h3><p>你可能已经知道我们接下来要谈论Javascript，我想大多数人都知道。</p><blockquote><p>如果你接触过 Javascript 回调会让你更早患上 PTSD，那么现在闭上眼睛，向下滚动2-3秒。 你会在那里找到一个链接，带你到安全的地方。</p></blockquote><p>基于回调的方法背后的整个思想就是保存一个指向一组指令的指针，这些指令我们希望以后在以后需要的时候运行。 针对Rust，这将是一个闭包。 在下面的示例中，我们将此信息保存在<code>HashMap</code>中，但这并不是唯一的选项。</p><p>不涉及线程作为实现并发性的主要方法的基本思想是其余方法的共同点。 包括我们很快就会讲到的 Rust 今天使用的那个。</p><p>优点:</p><ol><li>大多数语言中易于实现</li><li>没有上下文切换</li><li>相对较低的内存开销(在大多数情况下)</li></ol><p>缺点:</p><ol><li>每个任务都必须保存它以后需要的状态，内存使用量将随着一系列计算中回调的数量线性增长</li><li>很难理解，很多人已经知道这就是“回调地狱”</li><li>这是一种非常不同的编写程序的方式，需要大量的重写才能从“正常”的程序流转变为使用“基于回调”的程序流</li><li>在 Rust 使用这种方法时，任务之间的状态共享是一个难题，因为它的所有权模型</li></ol><p>一个极其简单的基于回调方法的例子是:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">fn</span> <span class="token function-definition function">program_main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;So we start the program here!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_timeout</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;We create tasks with a callback that runs once the task finished!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_timeout</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;We can even chain sub-tasks...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">set_timeout</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;...like this!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;While our tasks are executing we can do other stuff instead of waiting.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token constant">RT</span><span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>rt<span class="token closure-punctuation punctuation">|</span></span> rt<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>program_main<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>mpsc<span class="token punctuation">::</span></span><span class="token punctuation">{</span>channel<span class="token punctuation">,</span> <span class="token class-name">Receiver</span><span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">cell<span class="token punctuation">::</span></span><span class="token class-name">RefCell</span><span class="token punctuation">,</span> <span class="token namespace">collections<span class="token punctuation">::</span></span><span class="token class-name">HashMap</span><span class="token punctuation">,</span> thread<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">thread_local!</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token constant">RT</span><span class="token punctuation">:</span> <span class="token class-name">Runtime</span> <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Runtime</span> <span class="token punctuation">{</span>
    callbacks<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    next_id<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    evt_sender<span class="token punctuation">:</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    evt_reciever<span class="token punctuation">:</span> <span class="token class-name">Receiver</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">set_timeout</span><span class="token punctuation">(</span>ms<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> cb<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">&#39;static</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token constant">RT</span><span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>rt<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> id <span class="token operator">=</span> <span class="token operator">*</span>rt<span class="token punctuation">.</span>next_id<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>rt<span class="token punctuation">.</span>next_id<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        rt<span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> evt_sender <span class="token operator">=</span> rt<span class="token punctuation">.</span>evt_sender<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            evt_sender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Runtime</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>evt_sender<span class="token punctuation">,</span> evt_reciever<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Runtime</span> <span class="token punctuation">{</span>
            callbacks<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            next_id<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            evt_sender<span class="token punctuation">,</span>
            evt_reciever<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> program<span class="token punctuation">:</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">program</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> evt_id <span class="token keyword">in</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>evt_reciever <span class="token punctuation">{</span>
            <span class="token keyword">let</span> cb <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>evt_id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><p>我们保持这种超级简单的方法，您可能想知道这种方法和使用 OS 线程直接将回调传递给 OS 线程的方法之间有什么区别。 不同之处在于，回调是在同一个线程上运行的。 这个例子中,我们创建的 OS 线程基本上只是用作计时器，但可以表示任何类型的我们将不得不等待的资源。</p><h3 id="从回调到承诺-promises"><a class="header-anchor" href="#从回调到承诺-promises" aria-hidden="true">#</a> 从回调到承诺 (promises)</h3><p>你现在可能会想，我们什么时候才能谈论未来？</p><p>好吧，我们就快到了。你看，<code>promises</code>、<code>futures</code>和其他延迟计算的名称经常被交替使用。</p><p>它们之间有形式上的区别，但是我们在这里不会涉及，但是值得解释一下<code>promises</code>，因为它们被广泛使用在 Javascript 中，并且与 Rusts Futures 有很多共同之处。</p><p>首先，许多语言都有<code>promises</code>的概念，但我将在下面的例子中使用来自 Javascript 的概念。</p><p>承诺是解决回调带来的复杂性的一种方法。</p><p>比如,下面的例子:</p><div class="language-js line-numbers-mode"><pre><code><span class="token function">setTimer</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimer</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimer</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;I&#39;m the last one&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>可以替换为promise:</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">timer</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">return</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">return</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>&quot;<span class="token constant">I</span>&#39;m the last one<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>深入原理可以看到变化更为显著。 您可以看到，promises 返回的状态机可以处于以下三种状态之一: <code>pending</code>、 <code>fulfilled</code> 或 <code>rejected</code>。</p><p>当我们在上面的例子中调用<code>timer (200)</code>时，我们得到一个状态<code>pending</code>的承诺。</p><p>由于承诺被重写为状态机，它们还提供了一种更好的语法，允许我们像下面这样编写最后一个示例:</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;I&#39;m the last one&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>可以将 run 函数视为一个由几个子任务组成的可执行任务。 在每个<code>await</code>点上，它都将控制权交给调度程序(在本例中是众所周知的 Javascript 事件循环)。</p><p>一旦其中一个子任务将状态更改为<code>fulfilled</code>或<code>rejected</code>，则计划继续执行下一步。</p><p>从语法上讲，Rusts Futures 0.1很像上面的承诺示例，Rusts Futures 0.3很像我们上一个示例中的 async / await。</p><p>这也是与 Rusts Futures 相似的地方。 我们这样做的原因是通过上面的介绍,更加深刻的理解Rust的Futures。</p><blockquote><p>为了避免以后的混淆: 有一点你应该知道。 Java script的承诺是立即执行(early evaluated)的。 这意味着一旦它被创建，它就开始运行一个任务。 与此相反,Rust的Futures是延迟执行(lazy evaluated)。 除非轮询(poll)一次,否则什么事都不会发生。</p></blockquote><h2 id="三-rust中的futures"><a class="header-anchor" href="#三-rust中的futures" aria-hidden="true">#</a> 三 Rust中的Futures</h2><h3 id="概述"><a class="header-anchor" href="#概述" aria-hidden="true">#</a> 概述</h3><ol><li>Rust中并发性的高级介绍</li><li>了解 Rust 在使用异步代码时能提供什么，不能提供什么</li><li>了解为什么我们需要 Rust 的运行时库</li><li>理解“leaf-future”和“non-leaf-future”的区别</li><li>了解如何处理 CPU 密集型任务</li></ol><h3 id="futures"><a class="header-anchor" href="#futures" aria-hidden="true">#</a> Futures</h3><p>什么是<code>Future</code>? <code>Future</code>是一些将在未来完成的操作。 Rust中的异步实现基于轮询,每个异步任务分成三个阶段:</p><ol><li>轮询阶段(The Poll phase). 一个<code>Future</code>被轮询后,会开始执行,直到被阻塞. 我们经常把轮询一个Future这部分称之为执行器(executor)</li><li>等待阶段. 事件源(通常称为reactor)注册等待一个事件发生，并确保当该事件准备好时唤醒相应的<code>Future</code></li><li>唤醒阶段. 事件发生,相应的<code>Future</code>被唤醒。 现在轮到执行器(executor),就是第一步中的那个执行器，调度<code>Future</code>再次被轮询，并向前走一步，直到它完成或达到一个阻塞点，不能再向前走, 如此往复,直到最终完成.</li></ol><p>当我们谈论<code>Future</code>的时候，我发现在早期区分<code>non-leaf-future</code>和<code>leaf-future</code>是很有用的，因为实际上它们彼此很不一样。</p><h3 id="leaf-futures"><a class="header-anchor" href="#leaf-futures" aria-hidden="true">#</a> Leaf futures</h3><p>由运行时创建<code>leaf futures</code>，它就像套接字一样,代表着一种资源.</p><div class="language-rust line-numbers-mode"><pre><code><span class="token comment">// stream is a **leaf-future**</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> stream <span class="token operator">=</span> <span class="token namespace">tokio<span class="token punctuation">::</span>net<span class="token punctuation">::</span></span><span class="token class-name">TcpStream</span><span class="token punctuation">::</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:3000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>对这些资源的操作，比如套接字上的 Read 操作，将是非阻塞的，并返回一个我们称之为<code>leaf-future</code>的Future.之所以称之为<code>leaf-future</code>,是因为这是我们实际上正在等待的Future.</p><p>除非你正在编写一个运行时，否则你不太可能自己实现一个<code>leaf-future</code>，但是我们将在本书中详细介绍它们是如何构造的。</p><p>您也不太可能将 <code>leaf-future</code> 传递给运行时，然后单独运行它直到完成，这一点您可以通过阅读下一段来理解。</p><h3 id="non-leaf-futures"><a class="header-anchor" href="#non-leaf-futures" aria-hidden="true">#</a> Non-leaf-futures</h3><p>Non-leaf-futures指的是那些我们用<code>async</code>关键字创建的Future.</p><p>异步程序的大部分是Non-leaf-futures，这是一种可暂停的计算。 这是一个重要的区别，因为这些<code>Future</code>代表一组操作。 通常，这样的任务由<code>await</code> 一系列<code>leaf-future</code>组成.</p><div class="language-rust line-numbers-mode"><pre><code><span class="token comment">// Non-leaf-future</span>
<span class="token keyword">let</span> non_leaf <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> stream <span class="token operator">=</span> <span class="token class-name">TcpStream</span><span class="token punctuation">::</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:3000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// &lt;- yield</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;connected!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">b&quot;hello world\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span> <span class="token comment">// &lt;- yield</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;message sent!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这些任务的关键是，它们能够将控制权交给运行时的调度程序，然后在稍后停止的地方继续执行。 与<code>leaf-future</code>相比，这些Future本身并不代表I/O资源。 当我们对这些Future进行轮询时, 有可能会运行一段时间或者因为等待相关资源而让度给调度器,然后等待相关资源ready的时候唤醒自己.</p><h3 id="运行时-runtimes"><a class="header-anchor" href="#运行时-runtimes" aria-hidden="true">#</a> 运行时(Runtimes)</h3><p>像 c # ，JavaScript，Java，GO 和许多其他语言都有一个处理并发的运行时。 所以如果你来自这些语言中的一种，这对你来说可能会有点奇怪。</p><p>Rust 与这些语言的不同之处在于 Rust 没有处理并发性的运行时，因此您需要使用一个为您提供此功能的库。</p><p>很多复杂性归因于 Futures 实际上是来源于运行时的复杂性，创建一个有效的运行时是困难的。 学习如何正确使用一个也需要相当多的努力，但是你会看到这些类型的运行时之间有几个相似之处，所以学习一个可以使学习下一个更容易。</p><p>Rust 和其他语言的区别在于，在选择运行时时，您必须进行主动选择。大多数情况下，在其他语言中，你只会使用提供给你的那一种。</p><p>异步运行时可以分为两部分:</p><ol><li>执行器(The Executor)</li><li>reactor (The Reactor)</li></ol><p>当 Rusts Futures 被设计出来的时候，有一个愿望，那就是将通知<code>Future</code>它可以做更多工作的工作与<code>Future</code>实际做工作分开。</p><p>你可以认为前者是reactor的工作，后者是执行器的工作。 运行时的这两个部分使用 <code>Waker</code>进行交互。</p><p>写这篇文章的时候，未来最受欢迎的两个运行时是:</p><ol><li><a href="https://github.com/async-rs/async-std" target="_blank" rel="noopener noreferrer">async-std</a></li><li><a href="https://github.com/tokio-rs/tokio" target="_blank" rel="noopener noreferrer">Tokio</a></li></ol><h3 id="rust-的标准库做了什么"><a class="header-anchor" href="#rust-的标准库做了什么" aria-hidden="true">#</a> Rust 的标准库做了什么</h3><ol><li>一个公共接口，<code>Future trait</code></li><li>一个符合人体工程学的方法创建任务, 可以通过async和await关键字进行暂停和恢复<code>Future</code></li><li><code>Waker</code>接口, 可以唤醒暂停的<code>Future</code></li></ol><p>这就是Rust标准库所做的。 正如你所看到的，不包括异步I/O的定义,这些异步任务是如何被创建的,如何运行的。</p><h3 id="i-o密集型-vs-cpu密集型任务"><a class="header-anchor" href="#i-o密集型-vs-cpu密集型任务" aria-hidden="true">#</a> I/O密集型 VS CPU密集型任务</h3><p>正如你们现在所知道的，你们通常所写的是<code>Non-leaf-futures</code>。 让我们以 pseudo-rust 为例来看一下这个异步块:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">let</span> non_leaf <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> stream <span class="token operator">=</span> <span class="token class-name">TcpStream</span><span class="token punctuation">::</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:3000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- yield</span>
    
    <span class="token comment">// request a large dataset</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>get_dataset_request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- yield</span>
    
    <span class="token comment">// wait for the dataset</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> response <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    stream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> response<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- yield</span>

    <span class="token comment">// do some CPU-intensive analysis on the dataset</span>
    <span class="token keyword">let</span> report <span class="token operator">=</span> <span class="token namespace">analyzer<span class="token punctuation">::</span></span><span class="token function">analyze_data</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// send the results back</span>
    stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>report<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- yield</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>现在，正如您将看到的，当我们介绍 Futures 的工作原理时，两个<code>yield</code>之间的代码与我们的执行器在同一个线程上运行。</p><p>这意味着当我们分析器处理数据集时，执行器忙于计算而不是处理新的请求。</p><p>幸运的是，有几种方法可以解决这个问题，这并不困难，但是你必须意识到:</p><ol><li>我们可以创建一个新的<code>leaf future</code>，它将我们的任务发送到另一个线程，并在任务完成时解析。 我们可以像等待其他Future一样等待这个<code>leaf-future</code>。</li><li>运行时可以有某种类型的管理程序来监视不同的任务占用多少时间，并将执行器本身移动到不同的线程，这样即使我们的分析程序任务阻塞了原始的执行程序线程，它也可以继续运行。</li><li>您可以自己创建一个与运行时兼容的<code>reactor</code>，以您认为合适的任何方式进行分析，并返回一个可以等待的未来。</li></ol><p>现在，#1是通常的处理方式，但是一些执行器也实现了#2。 2的问题是，如果你切换运行时，你需要确保它也支持这种监督，否则你最终会阻塞执行者。</p><p>方式#3更多的是理论上的重要性，通常您会很乐意将任务发送到多数运行时提供的线程池。</p><p>大多数执行器都可以使用诸如 spawn blocking 之类的方法来完成#1。</p><p>这些方法将任务发送到运行时创建的线程池，在该线程池中，您可以执行 cpu 密集型任务，也可以执行运行时不支持的“阻塞”任务。</p><p>现在，有了这些知识，你已经在一个很好的方式来理解<code>Future</code>，但我们不会停止，有很多细节需要讨论。</p><p>休息一下或喝杯咖啡，准备好我们进入下一章的深度探索。</p><h3 id="奖励部分"><a class="header-anchor" href="#奖励部分" aria-hidden="true">#</a> 奖励部分</h3><p>如果你发现并发和异步编程的概念一般来说令人困惑，我知道你是从哪里来的，我已经写了一些资源，试图给出一个高层次的概述，这将使之后更容易学习 Rusts Futures:</p><ul><li><a href="https://cfsamson.github.io/book-exploring-async-basics/1_concurrent_vs_parallel.html" target="_blank" rel="noopener noreferrer">Async Basics - The difference between concurrency and parallelism 异步基础-并发和并行之间的区别</a></li><li><a href="https://cfsamson.github.io/book-exploring-async-basics/2_async_history.html" target="_blank" rel="noopener noreferrer">Async Basics - Async history 异步基础-异步历史</a></li><li><a href="https://cfsamson.github.io/book-exploring-async-basics/5_strategies_for_handling_io.html" target="_blank" rel="noopener noreferrer">Async Basics - Strategies for handling I/O 异步基础-处理 i / o 的策略</a></li><li><a href="https://cfsamson.github.io/book-exploring-async-basics/6_epoll_kqueue_iocp.html" target="_blank" rel="noopener noreferrer">Async Basics - Epoll, Kqueue and IOCP 异步基础-Epoll，Kqueue 和 IOCP</a></li></ul><p>通过研究<code>Future</code>来学习这些概念会让它变得比实际需要难得多，所以如果你有点不确定的话，继续读这些章节。</p><p>你回来的时候我就在这儿。</p><p>如果你觉得你已经掌握了基本知识，那么让我们开始行动吧！</p><h2 id="四-唤醒器和上下文-waker-and-context"><a class="header-anchor" href="#四-唤醒器和上下文-waker-and-context" aria-hidden="true">#</a> 四 唤醒器和上下文(Waker and Context)</h2><h3 id="概述-1"><a class="header-anchor" href="#概述-1" aria-hidden="true">#</a> 概述</h3><ol><li>了解 Waker 对象是如何构造的</li><li>了解运行时如何知道<code>leaf-future</code>何时可以恢复</li><li>了解动态分发的基础知识和trait对象</li></ol><p><code>Waker</code>类型在<a href="https://github.com/rust-lang/rfcs/blob/master/text/2592-futures.md#waking-up" target="_blank" rel="noopener noreferrer">RFC#2592</a>中介绍.</p><h3 id="唤醒器"><a class="header-anchor" href="#唤醒器" aria-hidden="true">#</a> 唤醒器</h3><p><code>Waker</code>类型允许在运行时的reactor 部分和执行器部分之间进行松散耦合。</p><p>通过使用不与<code>Future</code>执行绑定的唤醒机制，运行时实现者可以提出有趣的新唤醒机制。 例如，可以生成一个线程来执行一些工作，这些工作结束时通知<code>Future</code>，这完全独立于当前的运行时。</p><p>如果没有唤醒程序，执行程序将是通知正在运行的任务的唯一方式，而使用唤醒程序，我们将得到一个松散耦合，其中很容易使用新的<code>leaf-future</code>来扩展生态系统。</p><blockquote><p>如果你想了解更多关于 Waker 类型背后的原因，我可以推荐<a href="https://boats.gitlab.io/blog/post/wakers-i/" target="_blank" rel="noopener noreferrer">Withoutboats articles series about them</a>。</p></blockquote><h3 id="理解唤醒器"><a class="header-anchor" href="#理解唤醒器" aria-hidden="true">#</a> 理解唤醒器</h3><p>在实现我们自己的<code>Future</code>时，我们遇到的最令人困惑的事情之一就是我们如何实现一个唤醒器。 创建一个 Waker 需要创建一个 vtable，这个vtable允许我们使用动态方式调用我们真实的Waker实现.</p><blockquote><p>如果你想知道更多关于Rust中的动态分发，我可以推荐 Adam Schwalm 写的一篇文章 <a href="https://alschwalm.com/blog/static/2017/03/07/exploring-dynamic-dispatch-in-rust/" target="_blank" rel="noopener noreferrer">Exploring Dynamic Dispatch in Rust</a>.</p></blockquote><p>让我们更详细地解释一下。</p><h3 id="rust中的胖指针"><a class="header-anchor" href="#rust中的胖指针" aria-hidden="true">#</a> Rust中的胖指针</h3><p>为了更好地理解我们如何在 Rust 中实现 Waker，我们需要退后一步并讨论一些基本原理。 让我们首先看看 Rust 中一些不同指针类型的大小。</p><p>运行以下代码:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">trait</span> <span class="token class-name">SomeTrait</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;======== The size of different pointers in Rust: ========&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;dyn Trait:-----{}&quot;</span><span class="token punctuation">,</span> <span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">dyn</span> <span class="token class-name">SomeTrait</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;[&amp;dyn Trait]:--{}&quot;</span><span class="token punctuation">,</span> <span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token keyword">dyn</span> <span class="token class-name">SomeTrait</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Box&lt;Trait&gt;:-----{}&quot;</span><span class="token punctuation">,</span> <span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">SomeTrait</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;i32:-----------{}&quot;</span><span class="token punctuation">,</span> <span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">i32</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;[i32]:---------{}&quot;</span><span class="token punctuation">,</span> <span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">i32</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Box&lt;i32&gt;:-------{}&quot;</span><span class="token punctuation">,</span> <span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;Box&lt;i32&gt;:------{}&quot;</span><span class="token punctuation">,</span> <span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;[&amp;dyn Trait;4]:-{}&quot;</span><span class="token punctuation">,</span> <span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token keyword">dyn</span> <span class="token class-name">SomeTrait</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;[i32;4]:--------{}&quot;</span><span class="token punctuation">,</span> <span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">i32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>从运行后的输出中可以看到，引用的大小是不同的。 许多是8字节(在64位系统中是指针大小) ，但有些是16字节。</p><p>16字节大小的指针被称为“胖指针” ，因为它们携带额外的信息。</p><p>例如 <code>&amp;[i32]</code>:</p><ul><li>前8个字节是指向数组中第一个元素的实际指针(或 slice 引用的数组的一部分)</li><li>第二个8字节是切片的长度</li></ul><p>例如 <code>&amp;dyn SomeTrait</code>:</p><p>这就是我们将要关注的胖指针的类型。<code>&amp;dyn SomeTrait</code> 是一个trait的引用，或者 Rust称之为一个trait对象。</p><p>指向 trait 对象的指针布局如下:</p><ul><li>前8个字节指向trait 对象的data</li><li>后八个字节指向trait对象的 vtable</li></ul><p>这样做的好处是，我们可以引用一个对象，除了它实现了 trait 定义的方法之外，我们对这个对象一无所知。 为了达到这个目的，我们使用动态分发。</p><p>让我们用代码而不是文字来解释这一点，通过这些部分来实现我们自己的 trait 对象:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token comment">// A reference to a trait object is a fat pointer: (data_ptr, vtable_ptr)</span>
<span class="token keyword">trait</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">i32</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">sub</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">i32</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">mul</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">i32</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// This will represent our home brewn fat pointer to a trait object</span>
   <span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">FatPointer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/// A reference is a pointer to an instantiated `Data` instance</span>
    data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token keyword">mut</span> <span class="token class-name">Data</span><span class="token punctuation">,</span>
    <span class="token comment">/// Since we need to pass in literal values like length and alignment it&#39;s</span>
    <span class="token comment">/// easiest for us to convert pointers to usize-integers instead of the other way around.</span>
    vtable<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// This is the data in our trait object. It&#39;s just two numbers we want to operate on.</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Data</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    b<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// ====== function definitions ======</span>
<span class="token keyword">fn</span> <span class="token function-definition function">add</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Data</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">i32</span> <span class="token punctuation">{</span>
    s<span class="token punctuation">.</span>a <span class="token operator">+</span> s<span class="token punctuation">.</span>b
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function-definition function">sub</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Data</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">i32</span> <span class="token punctuation">{</span>
    s<span class="token punctuation">.</span>a <span class="token operator">-</span> s<span class="token punctuation">.</span>b
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function-definition function">mul</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Data</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">i32</span> <span class="token punctuation">{</span>
    s<span class="token punctuation">.</span>a <span class="token operator">*</span> s<span class="token punctuation">.</span>b
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> data <span class="token operator">=</span> <span class="token class-name">Data</span> <span class="token punctuation">{</span>a<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// vtable is like special purpose array of pointer-length types with a fixed</span>
    <span class="token comment">// format where the three first values has a special meaning like the</span>
    <span class="token comment">// length of the array is encoded in the array itself as the second value.</span>
    <span class="token keyword">let</span> vtable <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
        <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment">// pointer to `Drop` (which we&#39;re not implementing here)</span>
        <span class="token number">6</span><span class="token punctuation">,</span>            <span class="token comment">// lenght of vtable</span>
        <span class="token number">8</span><span class="token punctuation">,</span>            <span class="token comment">// alignment</span>

        <span class="token comment">// we need to make sure we add these in the same order as defined in the Trait.</span>
        add <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token comment">// function pointer - try changing the order of `add`</span>
        sub <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token comment">// function pointer - and `sub` to see what happens</span>
        mul <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token comment">// function pointer</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> fat_pointer <span class="token operator">=</span> <span class="token class-name">FatPointer</span> <span class="token punctuation">{</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> data<span class="token punctuation">,</span> vtable<span class="token punctuation">:</span> vtable<span class="token punctuation">.</span><span class="token function">as_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> test <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">transmute</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">FatPointer</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">dyn</span> <span class="token class-name">Test</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>fat_pointer<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// And voalá, it&#39;s now a trait object we can call methods on</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Add: 3 + 2 = {}&quot;</span><span class="token punctuation">,</span> test<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Sub: 3 - 2 = {}&quot;</span><span class="token punctuation">,</span> test<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Mul: 3 * 2 = {}&quot;</span><span class="token punctuation">,</span> test<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>稍后，当我们实现我们自己的 Waker 时，我们实际上会像这里一样建立一个 vtable。 我们创造它的方式略有不同，但是现在你知道了规则特征对象是如何工作的，你可能会认识到我们在做什么，这使得它不那么神秘。</p><h3 id="奖励部分-1"><a class="header-anchor" href="#奖励部分-1" aria-hidden="true">#</a> 奖励部分</h3><p>您可能想知道为什么Waker是这样实现的，而不仅仅是作为一个普通的trait.</p><p>原因在于灵活性。 以这里的方式实现 Waker，可以很灵活地选择要使用的内存管理方案。</p><p>“正常”的方法是使用 Arc 来使用引用计数来跟踪 Waker 对象何时可以被删除。 但是，这不是唯一的方法，您还可以使用纯粹的全局函数和状态，或者任何其他您希望的方法。</p><p>这在表中为运行时实现者留下了许多选项。</p><h2 id="五-生成器和async-await"><a class="header-anchor" href="#五-生成器和async-await" aria-hidden="true">#</a> 五 生成器和async/await</h2><h3 id="概述-2"><a class="header-anchor" href="#概述-2" aria-hidden="true">#</a> 概述</h3><ol><li>理解 async / await 语法在底层是如何工作的</li><li>亲眼目睹(See first hand)我们为什么需要Pin</li><li>理解是什么让 Rusts 异步模型的内存效率非常高</li></ol><p>生成器的动机可以在 <a href="https://github.com/rust-lang/rfcs/blob/master/text/2033-experimental-coroutines.md" target="_blank" rel="noopener noreferrer">RFC#2033</a>中找到。 它写得非常好，我建议您通读它(它谈论async/await的内容和谈论生成器的内容一样多)。</p><h3 id="为什么要学习生成器"><a class="header-anchor" href="#为什么要学习生成器" aria-hidden="true">#</a> 为什么要学习生成器</h3><p>generators/yield和 async/await 非常相似，一旦理解了其中一个，就应该能够理解另一个。</p><p>对我来说，使用Generators而不是 Futures 来提供可运行的和简短的示例要容易得多，这需要我们现在引入很多概念，稍后我们将介绍这些概念，以便展示示例。</p><p>Async/await 的工作方式类似于生成器，但它不返回生成器，而是返回一个实现 Future trait 的特殊对象。</p><p>一个小小的好处是，在本章的最后，你将有一个很好的关于生成器和 async / await 的介绍。</p><p>基本上，在设计 Rust 如何处理并发时，主要讨论了三个选项:</p><ol><li>Green Thread.</li><li>使用组合符(Using combinators.)</li><li>Generator, 没有专门的栈</li></ol><p>我们在背景信息中覆盖了绿色线程，所以我们不会在这里重复。 我们将集中在各种各样的无堆栈协同程序,这也就是Rust正在使用的.</p><h3 id="组合子-combinators"><a class="header-anchor" href="#组合子-combinators" aria-hidden="true">#</a> 组合子(Combinators)</h3><p>在<code>Futures 0.1</code>中使用组合子.如果你曾经是用过Javascript中的<code>Promises</code>,那么你已经比较熟悉combinators了. 在Rust中,他们看起来如下:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">let</span> future <span class="token operator">=</span> <span class="token class-name">Connection</span><span class="token punctuation">::</span><span class="token function">connect</span><span class="token punctuation">(</span>conn_str<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and_then</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>conn<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
    conn<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&quot;somerequest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>row<span class="token closure-punctuation punctuation">|</span></span><span class="token punctuation">{</span>
        <span class="token class-name">SomeStruct</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">SomeStruct</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> rows<span class="token punctuation">:</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">SomeStruct</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">SomeLibraryError</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">block_on</span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>使用这个技巧主要有三个缺点:</p><ol><li>错误消息可能会冗长并且难懂</li><li>不是最佳的内存使用(浪费内存)</li><li>Rust中不允许跨组合子借用.</li></ol><p>其中第三点是这种方式的主要缺点.</p><p>不允许跨组合子借用，结果是非常不符合人体工程学的.为了完成某些任务，需要额外的内存分配或者复制，这很低效。</p><p>内存占用高的原因是，这基本上是一种基于回调的方法，其中每个闭包存储计算所需的所有数据。 这意味着，随着我们将它们链接起来，存储所需状态所需的内存会随着每一步的增加而增加。</p><h3 id="无栈协程-生成器"><a class="header-anchor" href="#无栈协程-生成器" aria-hidden="true">#</a> 无栈协程/生成器</h3><p>这就是今天 Rust 使用的模型，它有几个显著的优点:</p><ol><li>使用 async/await 作为关键字，可以很容易地将普通的Rust代码转换为无堆栈的协程(甚至可以使用宏来完成)</li><li>不需要上下文切换与保存恢复CPU状态</li><li>不需要处理的动态栈分配</li><li>内存效率高</li><li>允许我们块暂停点(suspension)借用 <strong>这是啥意思啊</strong></li></ol><p>与Futures 0.1不一样，使用async/ await 我们可以这样做:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">myfn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> text <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;Hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> borrowed <span class="token operator">=</span> <span class="token operator">&amp;</span>text<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    somefuture<span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> borrowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Rust中的异步使用生成器实现. 因此为了理解异步是如何工作的，我们首先需要理解生成器。 在Rust中，生成器被实现为状态机。</p><p>一个计算链的内存占用是由占用空间最大的那个步骤定义的。</p><p>这意味着在计算链中添加步骤可能根本不需要增加任何内存，这也是为什么Futures和 Async 在 Rust 中的开销很小的原因之一。</p><h3 id="生成器是如何工作的"><a class="header-anchor" href="#生成器是如何工作的" aria-hidden="true">#</a> 生成器是如何工作的</h3><p>在今天的 Nightly Rust 中，你可以使用关键词 yield。 在闭包中使用这个关键字，将其转换为生成器。 在介绍Pin之前，闭包是这样的:</p><div class="language-rust line-numbers-mode"><pre><code> <span class="token attribute attr-name">#![feature(generators, generator_trait)]</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>ops<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Generator</span><span class="token punctuation">,</span> <span class="token class-name">GeneratorState</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> a<span class="token punctuation">:</span> <span class="token keyword">i32</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> gen <span class="token operator">=</span> <span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">yield</span> a <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;world!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Yielded</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Got value {}&quot;</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>早些时候，在人们对 Pin 的设计达成共识之前，编译完代码看起来类似于这样:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> gen <span class="token operator">=</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Yielded</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Got value {}&quot;</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// If you&#39;ve ever wondered why the parameters are called Y and R the naming from</span>
<span class="token comment">// the original rfc most likely holds the answer</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">GeneratorState</span><span class="token operator">&lt;</span><span class="token class-name">Y</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Yielded</span><span class="token punctuation">(</span><span class="token class-name">Y</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// originally called `Yield(Y)`</span>
    <span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// originally called `Return(R)`</span>
<span class="token punctuation">}</span>

<span class="token keyword">trait</span> <span class="token class-name">Generator</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Yield</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Return</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">resume</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">GeneratorState</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Yield</span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Return</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">enum</span> <span class="token type-definition class-name">GeneratorA</span> <span class="token punctuation">{</span>
    <span class="token class-name">Enter</span><span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Yield1</span><span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Exit</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">GeneratorA</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">start</span><span class="token punctuation">(</span>a1<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Enter</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Generator</span> <span class="token keyword">for</span> <span class="token class-name">GeneratorA</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Yield</span> <span class="token operator">=</span> <span class="token keyword">i32</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Return</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">resume</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">GeneratorState</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Yield</span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Return</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// lets us get ownership over current state</span>
        <span class="token keyword">match</span> <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Exit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Enter</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

          <span class="token comment">/*----code before yield----*/</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> a <span class="token operator">=</span> a1 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>

                <span class="token operator">*</span><span class="token keyword">self</span> <span class="token operator">=</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Yield1</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Yielded</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Yield1</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">/*-----code after yield-----*/</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;world!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token operator">*</span><span class="token keyword">self</span> <span class="token operator">=</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Exit</span><span class="token punctuation">;</span>
                <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Exit</span> <span class="token operator">=&gt;</span> <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;Can&#39;t advance an exited generator!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><p>关键词yield首先在<a href="https://github.com/rust-lang/rfcs/pull/1823" target="_blank" rel="noopener noreferrer">RFC#1823</a>和 <a href="https://github.com/rust-lang/rfcs/pull/1832" target="_blank" rel="noopener noreferrer">RFC#1832</a>中讨论。</p><p>既然您知道了现实中的 yield 关键字会将代码重写为状态机，那么您还将了解await 如何工作的,他们非常相似.</p><p>上述简单的状态机中有一些限制,当跨yield发生借用的时候会发生什么呢?</p><p>我们可以禁止这样做，但async/await 语法的主要设计目标之一就是允许这样做。 这些类型的借用是不可能使用<code>Futures 0.1</code>，所以我们不能让这个限制存在。</p><p>与其在理论上讨论它，不如让我们来看看一些代码。</p><blockquote><p>我们将使用目前 Rust 中使用的状态机的优化版本。 更深入的解释见 Tyler Mandry 的文章: <a href="https://tmandry.gitlab.io/blog/posts/optimizing-await-1/" target="_blank" rel="noopener noreferrer">Rust 如何优化async/await</a></p></blockquote><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">let</span> <span class="token keyword">mut</span> generator <span class="token operator">=</span> <span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> to_borrow <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> borrowed <span class="token operator">=</span> <span class="token operator">&amp;</span>to_borrow<span class="token punctuation">;</span>
        <span class="token keyword">yield</span> borrowed<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{} world!&quot;</span><span class="token punctuation">,</span> borrowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>我们将手工编写一些版本的状态机，这些状态机表示生成器定义的状态机。</p><p>在每个示例中，我们都是“手动”逐步完成每个步骤，因此它看起来非常陌生。 我们可以添加一些语法糖，比如为我们的生成器实现 Iterator trait，这样我们就可以这样做:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=</span> generator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这是一个相当微不足道的改变，但是这一章已经变得很长了。我们继续前进的时候，请牢牢记住这点。</p><p>现在，我们的重写状态机在这个示例中看起来是什么样子的？</p><div class="language-rust line-numbers-mode"><pre><code>
 <span class="token attribute attr-name">#![allow(unused_variables)]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">GeneratorState</span><span class="token operator">&lt;</span><span class="token class-name">Y</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Yielded</span><span class="token punctuation">(</span><span class="token class-name">Y</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">trait</span> <span class="token class-name">Generator</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Yield</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Return</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">resume</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">GeneratorState</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Yield</span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Return</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">enum</span> <span class="token type-definition class-name">GeneratorA</span> <span class="token punctuation">{</span>
    <span class="token class-name">Enter</span><span class="token punctuation">,</span>
    <span class="token class-name">Yield1</span> <span class="token punctuation">{</span>
        to_borrow<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
        borrowed<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token comment">// uh, what lifetime should this have?</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token class-name">Exit</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">GeneratorA</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Enter</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Generator</span> <span class="token keyword">for</span> <span class="token class-name">GeneratorA</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Yield</span> <span class="token operator">=</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Return</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">resume</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">GeneratorState</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Yield</span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Return</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// lets us get ownership over current state</span>
        <span class="token keyword">match</span> <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Exit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Enter</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> to_borrow <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> borrowed <span class="token operator">=</span> <span class="token operator">&amp;</span>to_borrow<span class="token punctuation">;</span> <span class="token comment">// &lt;--- NB!</span>
                <span class="token keyword">let</span> res <span class="token operator">=</span> borrowed<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token operator">*</span><span class="token keyword">self</span> <span class="token operator">=</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Yield1</span> <span class="token punctuation">{</span>to_borrow<span class="token punctuation">,</span> borrowed<span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Yielded</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Yield1</span> <span class="token punctuation">{</span>to_borrow<span class="token punctuation">,</span> borrowed<span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Hello {}&quot;</span><span class="token punctuation">,</span> borrowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">*</span><span class="token keyword">self</span> <span class="token operator">=</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Exit</span><span class="token punctuation">;</span>
                <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Exit</span> <span class="token operator">=&gt;</span> <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;Can&#39;t advance an exited generator!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p>如果你试图编译这个，你会得到一个错误。</p><p>字符串的生命周期是什么。 这和Self的生命周期是不一样的。 它不是静态的。 事实证明，我们不可能用Rusts语法来描述这个生命周期，这意味着，为了使这个工作成功，我们必须让编译器知道，我们自己正确地控制了它。</p><p>这意味着必须借助unsafe。</p><p>让我们尝试编写一个使用unsafe的实现。 正如您将看到的，我们最终将使用一个自引用结构, 也就是将引用保存在自身中的结构体。</p><p>正如您所注意到的，这个编译器编译得很好！</p><div class="language-rust line-numbers-mode"><pre><code>
 <span class="token attribute attr-name">#![allow(unused_variables)]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">GeneratorState</span><span class="token operator">&lt;</span><span class="token class-name">Y</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Yielded</span><span class="token punctuation">(</span><span class="token class-name">Y</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
    <span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">}</span>

<span class="token keyword">trait</span> <span class="token class-name">Generator</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Yield</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Return</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">resume</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">GeneratorState</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Yield</span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Return</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">enum</span> <span class="token type-definition class-name">GeneratorA</span> <span class="token punctuation">{</span>
    <span class="token class-name">Enter</span><span class="token punctuation">,</span>
    <span class="token class-name">Yield1</span> <span class="token punctuation">{</span>
        to_borrow<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
        borrowed<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token comment">// NB! This is now a raw pointer!</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token class-name">Exit</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">GeneratorA</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Enter</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> <span class="token class-name">Generator</span> <span class="token keyword">for</span> <span class="token class-name">GeneratorA</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Yield</span> <span class="token operator">=</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Return</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">resume</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">GeneratorState</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Yield</span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Return</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">match</span> <span class="token keyword">self</span> <span class="token punctuation">{</span>
            <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Enter</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> to_borrow <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> borrowed <span class="token operator">=</span> <span class="token operator">&amp;</span>to_borrow<span class="token punctuation">;</span>
                <span class="token keyword">let</span> res <span class="token operator">=</span> borrowed<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">*</span><span class="token keyword">self</span> <span class="token operator">=</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Yield1</span> <span class="token punctuation">{</span>to_borrow<span class="token punctuation">,</span> borrowed<span class="token punctuation">:</span> <span class="token namespace">std<span class="token punctuation">::</span>ptr<span class="token punctuation">::</span></span><span class="token function">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                
                <span class="token comment">// NB! And we set the pointer to reference the to_borrow string here</span>
                <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Yield1</span> <span class="token punctuation">{</span>to_borrow<span class="token punctuation">,</span> borrowed<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">self</span> <span class="token punctuation">{</span>
                    <span class="token operator">*</span>borrowed <span class="token operator">=</span> to_borrow<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
               
                <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Yielded</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Yield1</span> <span class="token punctuation">{</span>borrowed<span class="token punctuation">,</span> <span class="token punctuation">..</span><span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> borrowed<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">String</span> <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span><span class="token operator">&amp;</span><span class="token operator">*</span><span class="token operator">*</span>borrowed<span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{} world&quot;</span><span class="token punctuation">,</span> borrowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">*</span><span class="token keyword">self</span> <span class="token operator">=</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Exit</span><span class="token punctuation">;</span>
                <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Exit</span> <span class="token operator">=&gt;</span> <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;Can&#39;t advance an exited generator!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>请记住，我们的例子是我们生成的生成器，它的原始文件像这样:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">let</span> <span class="token keyword">mut</span> gen <span class="token operator">=</span> <span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> to_borrow <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> borrowed <span class="token operator">=</span> <span class="token operator">&amp;</span>to_borrow<span class="token punctuation">;</span>
        <span class="token keyword">yield</span> borrowed<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{} world!&quot;</span><span class="token punctuation">,</span> borrowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>下面是我们如何运行这个状态机的示例，正如您所看到的，它完成了我们所期望的任务。 但这仍然存在一个巨大的问题:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> gen <span class="token operator">=</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> gen2 <span class="token operator">=</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Yielded</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Got value {}&quot;</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Yielded</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=</span> gen2<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Got value {}&quot;</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">GeneratorState</span><span class="token operator">&lt;</span><span class="token class-name">Y</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Yielded</span><span class="token punctuation">(</span><span class="token class-name">Y</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
    <span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">}</span>

<span class="token keyword">trait</span> <span class="token class-name">Generator</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Yield</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Return</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">resume</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">GeneratorState</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Yield</span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Return</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">enum</span> <span class="token type-definition class-name">GeneratorA</span> <span class="token punctuation">{</span>
    <span class="token class-name">Enter</span><span class="token punctuation">,</span>
    <span class="token class-name">Yield1</span> <span class="token punctuation">{</span>
        to_borrow<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
        borrowed<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token class-name">Exit</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">GeneratorA</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Enter</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> <span class="token class-name">Generator</span> <span class="token keyword">for</span> <span class="token class-name">GeneratorA</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Yield</span> <span class="token operator">=</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Return</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">resume</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">GeneratorState</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Yield</span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Return</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">match</span> <span class="token keyword">self</span> <span class="token punctuation">{</span>
            <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Enter</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> to_borrow <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> borrowed <span class="token operator">=</span> <span class="token operator">&amp;</span>to_borrow<span class="token punctuation">;</span>
                <span class="token keyword">let</span> res <span class="token operator">=</span> borrowed<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">*</span><span class="token keyword">self</span> <span class="token operator">=</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Yield1</span> <span class="token punctuation">{</span>to_borrow<span class="token punctuation">,</span> borrowed<span class="token punctuation">:</span> <span class="token namespace">std<span class="token punctuation">::</span>ptr<span class="token punctuation">::</span></span><span class="token function">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                
                <span class="token comment">// We set the self-reference here</span>
                <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Yield1</span> <span class="token punctuation">{</span>to_borrow<span class="token punctuation">,</span> borrowed<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">self</span> <span class="token punctuation">{</span>
                    <span class="token operator">*</span>borrowed <span class="token operator">=</span> to_borrow<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
               
                <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Yielded</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Yield1</span> <span class="token punctuation">{</span>borrowed<span class="token punctuation">,</span> <span class="token punctuation">..</span><span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> borrowed<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">String</span> <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span><span class="token operator">&amp;</span><span class="token operator">*</span><span class="token operator">*</span>borrowed<span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{} world&quot;</span><span class="token punctuation">,</span> borrowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">*</span><span class="token keyword">self</span> <span class="token operator">=</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Exit</span><span class="token punctuation">;</span>
                <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Exit</span> <span class="token operator">=&gt;</span> <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;Can&#39;t advance an exited generator!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>问题在于，如果在Safe Rust代码中,我们这样做:</p><div class="language-rust line-numbers-mode"><pre><code> <span class="token attribute attr-name">#![feature(never_type)]</span> <span class="token comment">// Force nightly compiler to be used in playground</span>
<span class="token comment">// by betting on it&#39;s true that this type is named after it&#39;s stabilization date...</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> gen <span class="token operator">=</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> gen2 <span class="token operator">=</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Yielded</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Got value {}&quot;</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">swap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> gen<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> gen2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;--- Big problem!</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Yielded</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=</span> gen2<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Got value {}&quot;</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// This would now start gen2 since we swapped them.</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">GeneratorState</span><span class="token operator">&lt;</span><span class="token class-name">Y</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Yielded</span><span class="token punctuation">(</span><span class="token class-name">Y</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
    <span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">}</span>

<span class="token keyword">trait</span> <span class="token class-name">Generator</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Yield</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Return</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">resume</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">GeneratorState</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Yield</span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Return</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">enum</span> <span class="token type-definition class-name">GeneratorA</span> <span class="token punctuation">{</span>
    <span class="token class-name">Enter</span><span class="token punctuation">,</span>
    <span class="token class-name">Yield1</span> <span class="token punctuation">{</span>
        to_borrow<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
        borrowed<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token class-name">Exit</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">GeneratorA</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Enter</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> <span class="token class-name">Generator</span> <span class="token keyword">for</span> <span class="token class-name">GeneratorA</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Yield</span> <span class="token operator">=</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Return</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">resume</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">GeneratorState</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Yield</span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Return</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">match</span> <span class="token keyword">self</span> <span class="token punctuation">{</span>
            <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Enter</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> to_borrow <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> borrowed <span class="token operator">=</span> <span class="token operator">&amp;</span>to_borrow<span class="token punctuation">;</span>
                <span class="token keyword">let</span> res <span class="token operator">=</span> borrowed<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">*</span><span class="token keyword">self</span> <span class="token operator">=</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Yield1</span> <span class="token punctuation">{</span>to_borrow<span class="token punctuation">,</span> borrowed<span class="token punctuation">:</span> <span class="token namespace">std<span class="token punctuation">::</span>ptr<span class="token punctuation">::</span></span><span class="token function">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                
                <span class="token comment">// We set the self-reference here</span>
                <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Yield1</span> <span class="token punctuation">{</span>to_borrow<span class="token punctuation">,</span> borrowed<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">self</span> <span class="token punctuation">{</span>
                    <span class="token operator">*</span>borrowed <span class="token operator">=</span> to_borrow<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
               
                <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Yielded</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Yield1</span> <span class="token punctuation">{</span>borrowed<span class="token punctuation">,</span> <span class="token punctuation">..</span><span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> borrowed<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">String</span> <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span><span class="token operator">&amp;</span><span class="token operator">*</span><span class="token operator">*</span>borrowed<span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{} world&quot;</span><span class="token punctuation">,</span> borrowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">*</span><span class="token keyword">self</span> <span class="token operator">=</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Exit</span><span class="token punctuation">;</span>
                <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Exit</span> <span class="token operator">=&gt;</span> <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;Can&#39;t advance an exited generator!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div><p>运行代码并比较结果。你看到问题了吗？</p><p>等等? “Hello”怎么了? 为什么我们的代码出错了？</p><p>事实证明，虽然上面的例子编译得很好，但是我们在使用安全Rust时将这个API的使用者暴露在可能的内存未定义行为和其他内存错误中。 这是个大问题！</p><p>实际上，我已经强制上面的代码使用编译器的夜间版本。 如果您在playground上运行上面的示例，您将看到它在当前稳定状态(1.42.0)上运行时没有panic，但在当前夜间状态(1.44.0)上panic。 太可怕了！</p><p>我们将在下一章用一个稍微简单一点的例子来解释这里发生了什么，我们将使用 Pin 来修复我们的生成器，所以不用担心，您将看到到底出了什么问题，看看 Pin 如何能够帮助我们在一秒钟内安全地处理自引用类型。</p><p>在我们详细解释这个问题之前，让我们通过了解生成器和 async 关键字之间的关系来结束本章。</p><h3 id="异步和生成器"><a class="header-anchor" href="#异步和生成器" aria-hidden="true">#</a> 异步和生成器</h3><p>Futures 在Rust中被实现为状态机，就像生成器是状态机一样。</p><p>您可能已经注意到异步块中使用的语法和生成器中使用的语法的相似之处:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">let</span> <span class="token keyword">mut</span> gen <span class="token operator">=</span> <span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> to_borrow <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> borrowed <span class="token operator">=</span> <span class="token operator">&amp;</span>to_borrow<span class="token punctuation">;</span>
        <span class="token keyword">yield</span> borrowed<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{} world!&quot;</span><span class="token punctuation">,</span> borrowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>比较一下异步块的类似例子:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">let</span> <span class="token keyword">mut</span> fut <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> to_borrow <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> borrowed <span class="token operator">=</span> <span class="token operator">&amp;</span>to_borrow<span class="token punctuation">;</span>
        <span class="token class-name">SomeResource</span><span class="token punctuation">::</span><span class="token function">some_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{} world!&quot;</span><span class="token punctuation">,</span> borrowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>不同之处在于，Futures 的状态与 Generator 的状态不同。</p><p>异步块将返回一个 Future 而不是 Generator，但是 Future 的工作方式和 Generator 的内部工作方式是相似的。</p><p>我们不调用<code>Generator::resume</code>，而是调用 <code>Future::poll</code>，并且不返回 generated 或 Complete，而是返回 Pending 或 Ready。 Future中的每一个await就像生成器中的一个yield。</p><p>你看到他们现在是怎么联系起来的了吗？</p><p>这就是为什么理解了生成器如何工作以及他需要面对的挑战,也就理解了Future如何工作以及它需要面对的挑战。</p><p>跨yield/await的借用就是这样.</p><h3 id="奖励部分-正在使用的自引用生成器"><a class="header-anchor" href="#奖励部分-正在使用的自引用生成器" aria-hidden="true">#</a> 奖励部分-正在使用的自引用生成器</h3><p>感谢<a href="https://github.com/rust-lang/rust/pull/45337/files" target="_blank" rel="noopener noreferrer"> PR#45337 </a>,你可以在nightly版本中使用static关键字运行上面的例子. 你可以试试:</p><blockquote><p>要注意的是，API可能会发生改变。 在我撰写本书时，生成器API有一个更改，添加了对“ resume”参数的支持，以便传递到生成器闭包中。 可以关注<a href="https://github.com/rust-lang/rfcs/blob/master/text/2033-experimental-coroutines.md" target="_blank" rel="noopener noreferrer">RFC#033</a>的相关<a href="https://github.com/rust-lang/rust/issues/43122" target="_blank" rel="noopener noreferrer">问题#4312</a>的进展。</p></blockquote><div class="language-rust line-numbers-mode"><pre><code> <span class="token attribute attr-name">#![feature(generators, generator_trait)]</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>ops<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Generator</span><span class="token punctuation">,</span> <span class="token class-name">GeneratorState</span><span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> gen1 <span class="token operator">=</span> <span class="token keyword">static</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> to_borrow <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> borrowed <span class="token operator">=</span> <span class="token operator">&amp;</span>to_borrow<span class="token punctuation">;</span>
        <span class="token keyword">yield</span> borrowed<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{} world!&quot;</span><span class="token punctuation">,</span> borrowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token keyword">let</span> gen2 <span class="token operator">=</span> <span class="token keyword">static</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> to_borrow <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> borrowed <span class="token operator">=</span> <span class="token operator">&amp;</span>to_borrow<span class="token punctuation">;</span>
        <span class="token keyword">yield</span> borrowed<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{} world!&quot;</span><span class="token punctuation">,</span> borrowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> pinned1 <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">pin</span><span class="token punctuation">(</span>gen1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> pinned2 <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">pin</span><span class="token punctuation">(</span>gen2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Yielded</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=</span> pinned1<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Gen1 got value {}&quot;</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Yielded</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=</span> pinned2<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Gen2 got value {}&quot;</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> _ <span class="token operator">=</span> pinned1<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> _ <span class="token operator">=</span> pinned2<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h2 id="六-pin"><a class="header-anchor" href="#六-pin" aria-hidden="true">#</a> 六 Pin</h2><h3 id="概述-3"><a class="header-anchor" href="#概述-3" aria-hidden="true">#</a> 概述</h3><blockquote><p>译者注: Pin是在使用Future时一个非常重要的概念,我的理解是: 通过使用Pin,让用户无法安全的获取到<code>&amp;mut T</code>,进而无法进行上述例子中的swap. 如果你觉得你的和这个struct没有自引用的问题,你可以自己实现UnPin.</p></blockquote><ol><li>了解如何使用Pin以及当你自己实现<code>Future</code>的时候为什么需要Pin</li><li>理解如何让自引用类型被安全的使用</li><li>理解跨&#39;await`借用是如何实现的</li><li>制定一套实用的规则来帮助你使用Pin</li></ol><p>Pin是在<a href="https://github.com/rust-lang/rfcs/blob/master/text/2349-pin.md" target="_blank" rel="noopener noreferrer">RFC#2349</a>中被提出的.</p><p>让我们直接了当的说吧,Pin是这一系列概念中很难一开始就搞明白的,但是一旦你理解了其心智模型,就会觉得非常容易理解.</p><h3 id="定义"><a class="header-anchor" href="#定义" aria-hidden="true">#</a> 定义</h3><p>Pin只与指针有关,在Rust中引用也是指针.</p><p>Pin有<code>Pin</code>类型和<code>Unpin</code>标记组成(UnPin是Rust中为数不多的几个auto trait). Pin存在的目的就是为了让那些实现了<code>!UnPin</code>的类型遵守特定的规则.</p><p>是的，你是对的，这里是双重否定<code>!Unpin</code> 的意思是“not-un-pin”。</p><blockquote><p>这个命名方案是 Rusts 的安全特性之一，它故意测试您是否因为太累而无法安全地使用这个标记来实现类型。 如果你因为<code>UnPin</code>开始感到困惑，或者甚至生气，那么你就应该这样做！ 是时候放下工作，以全新的心态重新开始明天的生活了，这是一个好兆头。</p></blockquote><p>更严肃地说，我认为有必要提到，选择这些名字是有正当理由的。 命名并不容易，我曾经考虑过在这本书中重命名 <code>Unpin</code> 和<code>!UnPin</code> ,使他们更容易理解。</p><p>然而，一位经验丰富的Rust社区成员让我相信，当简单地给这些标记起不同的名字时，有太多的细微差别和边缘情况需要考虑，而这些很容易被忽略，我相信我们将不得不习惯它们并按原样使用它们。</p><p>如果你愿意，你可以从<a href="https://internals.rust-lang.org/t/naming-pin-anchor-move/6864" target="_blank" rel="noopener noreferrer">内部讨论</a>中读到一些讨论。</p><h3 id="pinning和自引用结构"><a class="header-anchor" href="#pinning和自引用结构" aria-hidden="true">#</a> Pinning和自引用结构</h3><p>让我们从上一章(生成器那一章)停止的地方开始，通过使用一些比状态机更容易推理的自引用结构，使我们在生成器中看到的使用自引用结构的问题变得简单得多:</p><p>现在我们的例子是这样的:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>pin<span class="token punctuation">::</span></span><span class="token class-name">Pin</span><span class="token punctuation">;</span>

  <span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Test</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    b<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>txt<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>txt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Test</span> <span class="token punctuation">{</span>
            a<span class="token punctuation">,</span>
            b<span class="token punctuation">:</span> <span class="token namespace">std<span class="token punctuation">::</span>ptr<span class="token punctuation">::</span></span><span class="token function">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> self_ref<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">String</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>a<span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>b <span class="token operator">=</span> self_ref<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">fn</span> <span class="token function-definition function">a</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>a
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">fn</span> <span class="token function-definition function">b</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token class-name">String</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span><span class="token operator">&amp;</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>让我们来回顾一下这个例子，因为我们将在本章的其余部分使用它。</p><p>我们有一个自引用结构体<code>Test</code>。 Test需要创建一个init方法，这个方法很奇怪，但是为了尽可能简短，我们需要这个方法。</p><p>Test 提供了两种方法来获取字段 a 和 b 值的引用。 因为 b 是 a 的参考，所以我们把它存储为一个指针，因为 Rust 的借用规则不允许我们定义这个生命周期。</p><p>现在，让我们用这个例子来详细解释我们遇到的问题:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> test1 <span class="token operator">=</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;test1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    test1<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> test2 <span class="token operator">=</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;test2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    test2<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;a: {}, b: {}&quot;</span><span class="token punctuation">,</span> test1<span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> test1<span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;a: {}, b: {}&quot;</span><span class="token punctuation">,</span> test2<span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> test2<span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在main函数中,我们首先实例化Test的两个实例,然后输出test1和test2各字段的值,结果如我们所料:</p><div class="language-"><pre><code>a: test1, b: test1
a: test2, b: test2
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>让我们看看，如果我们将存储在 test1指向的内存位置的数据与存储在 test2指向的内存位置的数据进行交换，会发生什么情况，反之亦然。</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> test1 <span class="token operator">=</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;test1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    test1<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> test2 <span class="token operator">=</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;test2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    test2<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;a: {}, b: {}&quot;</span><span class="token punctuation">,</span> test1<span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> test1<span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">swap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> test1<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> test2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;a: {}, b: {}&quot;</span><span class="token punctuation">,</span> test2<span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> test2<span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>我们可能会认为会打印两边test1,比如:</p><div class="language-rust line-numbers-mode"><pre><code>a<span class="token punctuation">:</span> test1<span class="token punctuation">,</span> b<span class="token punctuation">:</span> test1
a<span class="token punctuation">:</span> test1<span class="token punctuation">,</span> b<span class="token punctuation">:</span> test1
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>但是实际上我们得到的是:</p><div class="language-"><pre><code>a: test1, b: test1
a: test1, b: test2
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>指向 test2.b 的指针仍然指向test1内部的旧位置。 该结构不再是自引用的，它保存指向不同对象中的字段的指针。 这意味着我们不能再依赖test2.b的生存期与test2的生存期绑定在一起。</p><p>如果你仍然不相信，这至少可以说服你:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> test1 <span class="token operator">=</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;test1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    test1<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> test2 <span class="token operator">=</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;test2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    test2<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;a: {}, b: {}&quot;</span><span class="token punctuation">,</span> test1<span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> test1<span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">swap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> test1<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> test2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    test1<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token string">&quot;I&#39;ve totally changed now!&quot;</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;a: {}, b: {}&quot;</span><span class="token punctuation">,</span> test2<span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> test2<span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>这是不应该发生的。 目前还没有严重的错误，但是您可以想象，使用这些代码很容易创建严重的错误。</p><p>我创建了一个图表来帮助可视化正在发生的事情:</p><p><img alt="" data-src="swap_problem.jpg" loading="lazy" class="lazy"> 图1: 交换前后</p><p>正如你看到的,这不是我们想要的结果. 这很容易导致段错误,也很容易导致其他意想不到的未知行为以及失败.</p><h3 id="固定在栈上"><a class="header-anchor" href="#固定在栈上" aria-hidden="true">#</a> 固定在栈上</h3><p>现在，我们可以通过使用<code>Pin</code>来解决这个问题。 让我们来看看我们的例子是什么样的:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>pin<span class="token punctuation">::</span></span><span class="token class-name">Pin</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>marker<span class="token punctuation">::</span></span><span class="token class-name">PhantomPinned</span><span class="token punctuation">;</span>

 <span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Test</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    b<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    _marker<span class="token punctuation">:</span> <span class="token class-name">PhantomPinned</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>


<span class="token keyword">impl</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>txt<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>txt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Test</span> <span class="token punctuation">{</span>
            a<span class="token punctuation">,</span>
            b<span class="token punctuation">:</span> <span class="token namespace">std<span class="token punctuation">::</span>ptr<span class="token punctuation">::</span></span><span class="token function">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// This makes our type `!Unpin`</span>
            _marker<span class="token punctuation">:</span> <span class="token class-name">PhantomPinned</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> <span class="token class-name">Pin</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token keyword">mut</span> <span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> self_ptr<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">String</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>a<span class="token punctuation">;</span>
        <span class="token keyword">let</span> this <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">get_unchecked_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        this<span class="token punctuation">.</span>b <span class="token operator">=</span> self_ptr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">a</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> <span class="token class-name">Pin</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token keyword">str</span> <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">get_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>a
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">b</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> <span class="token class-name">Pin</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>b<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>现在，我们在这里所做的就是固定到一个栈地址。如果我们的类型实现了<code>!UnPin</code>，那么它将总是<code>unsafe</code>。</p><p>我们在这里使用相同的技巧，包括需要 init。 如果我们想要解决这个问题并让用户避免<code>unsafe</code>，我们需要将数据钉在堆上，我们马上就会展示这一点。</p><p>让我们看看如果我们现在运行我们的例子会发生什么:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// test1 is safe to move before we initialize it</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> test1 <span class="token operator">=</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;test1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Notice how we shadow `test1` to prevent it from beeing accessed again</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> test1 <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">Pin</span><span class="token punctuation">::</span><span class="token function">new_unchecked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> test1<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span>test1<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     
    <span class="token keyword">let</span> <span class="token keyword">mut</span> test2 <span class="token operator">=</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;test2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> test2 <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">Pin</span><span class="token punctuation">::</span><span class="token function">new_unchecked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> test2<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span>test2<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;a: {}, b: {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">a</span><span class="token punctuation">(</span>test1<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">b</span><span class="token punctuation">(</span>test1<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;a: {}, b: {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">a</span><span class="token punctuation">(</span>test2<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">b</span><span class="token punctuation">(</span>test2<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>现在，如果我们尝试使用上次使我们陷入麻烦的问题，您将得到一个编译错误。</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> test1 <span class="token operator">=</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;test1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> test1 <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">Pin</span><span class="token punctuation">::</span><span class="token function">new_unchecked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> test1<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span>test1<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     
    <span class="token keyword">let</span> <span class="token keyword">mut</span> test2 <span class="token operator">=</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;test2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> test2 <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">Pin</span><span class="token punctuation">::</span><span class="token function">new_unchecked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> test2<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span>test2<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;a: {}, b: {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">a</span><span class="token punctuation">(</span>test1<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">b</span><span class="token punctuation">(</span>test1<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">swap</span><span class="token punctuation">(</span>test1<span class="token punctuation">.</span><span class="token function">get_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> test2<span class="token punctuation">.</span><span class="token function">get_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;a: {}, b: {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">a</span><span class="token punctuation">(</span>test2<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">b</span><span class="token punctuation">(</span>test2<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>正如您从运行代码所得到的错误中看到的那样，类型系统阻止我们交换固定指针。</p><blockquote><p>需要注意的是，栈pinning总是依赖于我们所在的当前栈帧，因此我们不能在一个栈帧中创建一个自引用对象并返回它，因为任何指向“self”的指针都是无效的。 如果你把一个值固定在一个栈上，这也会让你承担很多责任。 一个很容易犯的错误是，忘记对原始变量进行阴影处理，因为这样可以在初始化后drop固定的指针并访问原来的值:</p></blockquote><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">let</span> <span class="token keyword">mut</span> test1 <span class="token operator">=</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;test1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">let</span> <span class="token keyword">mut</span> test1_pin <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">Pin</span><span class="token punctuation">::</span><span class="token function">new_unchecked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> test1<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
   <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span>test1_pin<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">drop</span><span class="token punctuation">(</span>test1_pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
   <span class="token keyword">let</span> <span class="token keyword">mut</span> test2 <span class="token operator">=</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;test2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">swap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> test1<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> test2<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Not self referential anymore: {:?}&quot;</span><span class="token punctuation">,</span> test1<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="固定在堆上"><a class="header-anchor" href="#固定在堆上" aria-hidden="true">#</a> 固定在堆上</h3><p>为了完整性，让我们删除一些不安全的内容，通过以堆分配为代价来消除<code>init</code>方法。 固定到堆是安全的，这样用户不需要实现任何不安全的代码:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>pin<span class="token punctuation">::</span></span><span class="token class-name">Pin</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>marker<span class="token punctuation">::</span></span><span class="token class-name">PhantomPinned</span><span class="token punctuation">;</span>

 <span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Test</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    b<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    _marker<span class="token punctuation">:</span> <span class="token class-name">PhantomPinned</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>txt<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Pin</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>txt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> t <span class="token operator">=</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
            a<span class="token punctuation">,</span>
            b<span class="token punctuation">:</span> <span class="token namespace">std<span class="token punctuation">::</span>ptr<span class="token punctuation">::</span></span><span class="token function">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            _marker<span class="token punctuation">:</span> <span class="token class-name">PhantomPinned</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> boxed <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">pin</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> self_ptr<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">String</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>boxed<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>a<span class="token punctuation">;</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> boxed<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get_unchecked_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>b <span class="token operator">=</span> self_ptr <span class="token punctuation">}</span><span class="token punctuation">;</span>

        boxed
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">a</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> <span class="token class-name">Pin</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token keyword">str</span> <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">get_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>a
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">b</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> <span class="token class-name">Pin</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>b<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> test1 <span class="token operator">=</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;test1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> test2 <span class="token operator">=</span> <span class="token class-name">Test</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;test2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;a: {}, b: {}&quot;</span><span class="token punctuation">,</span>test1<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> test1<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;a: {}, b: {}&quot;</span><span class="token punctuation">,</span>test2<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> test2<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>事实上就算是<code>!Unpin</code>有意义,固定一个堆分配的值也是安全的。 一旦在堆上分配了数据，它就会有一个稳定的地址。</p><p>作为 API 的用户，我们不需要特别注意并确保自引用指针保持有效。</p><p>也有一些方法能够对固定栈上提供一些安全保证，但是现在我们使用<a href="https://docs.rs/pin-project/" target="_blank" rel="noopener noreferrer">pin_project</a>这个包来实现这一点。</p><h3 id="pinning的一些实用规则"><a class="header-anchor" href="#pinning的一些实用规则" aria-hidden="true">#</a> Pinning的一些实用规则</h3><ol><li>针对<code>T:UnPin</code>(这是默认值),<code>Pin&lt;&#39;a,T&gt;</code>完全定价与<code>&amp;&#39;a mut T</code>. 换句话说: <code>UnPin</code>意味着这个类型即使在固定时也可以移动，所以Pin对这个类型没有影响。</li><li>针对<code>T:!UnPin</code>,从<code>Pin&lt; T&gt;</code>获取到<code>&amp;mut T</code>,则必须使用unsafe. 换句话说,<code>!Unpin</code>能够阻止API的使用者移动T,除非他写出unsafe的代码.</li><li>Pinning对于内存分配没有什么特别的作用，比如将其放入某个“只读”内存或任何奇特的内存中。 它只使用类型系统来防止对该值进行某些操作。</li><li>大多数标准库类型实现 Unpin。 这同样适用于你在 Rust 中遇到的大多数“正常”类型。 <code>Future</code>和<code>Generators</code>是两个例外。</li><li>Pin的主要用途就是自引用类型,Rust语言的所有这些调整就是为了允许这个. 这个API中仍然有一些问题需要探讨.</li><li><code>!UnPin</code>这些类型的实现很有可能是不安全的. 在这种类型被钉住后移动它可能会导致程序崩溃。 在撰写本书时，创建和读取自引用结构的字段仍然需要不安全的方法(唯一的方法是创建一个包含指向自身的原始指针的结构)。</li><li>当使用nightly版本时,你可以在一个使用特性标记在一个类型上添加<code>!UnPin</code>. 当使用stable版本时,可以将std: : marker: : PhantomPinned 添加到类型上。</li><li>你既可以固定一个栈上的对象也可以固定一个堆上的对象.</li><li>将一个<code>!UnPin</code>的指向栈上的指针固定需要unsafe.</li><li>将一个<code>!UnPin</code>的指向堆上的指针固定,不需要unsafe,可以直接使用<code>Box::Pin</code>.</li></ol><blockquote><p>不安全的代码并不意味着它真的“unsafe” ，它只是减轻了通常从编译器得到的保证。 一个不安全的实现可能是完全安全的，但是您没有编译器保证的安全网。</p></blockquote><h3 id="映射-结构体的固定"><a class="header-anchor" href="#映射-结构体的固定" aria-hidden="true">#</a> 映射/结构体的固定</h3><p>简而言之，投影是一个编程语言术语。 Mystruct.field1是一个投影。 结构体的固定是在每一个字段上使用Pin。 这里有一些注意事项，您通常不会看到，因此我参考相关文档。</p><h3 id="pin和drop"><a class="header-anchor" href="#pin和drop" aria-hidden="true">#</a> Pin和Drop</h3><p>Pin保证从值被固定到被删除的那一刻起一直存在。 而在Drop实现中，您需要一个可变的 self 引用，这意味着在针对固定类型实现 Drop 时必须格外小心。</p><h3 id="把它们放在一起"><a class="header-anchor" href="#把它们放在一起" aria-hidden="true">#</a> 把它们放在一起</h3><p>当我们实现自己的<code>Futures</code>的时候,这正是我们要做的，我们很快就完成了。</p><h3 id="奖励部分-2"><a class="header-anchor" href="#奖励部分-2" aria-hidden="true">#</a> 奖励部分</h3><p><strong>修复我们实现的自引用生成器以及学习更多的关于Pin的知识.</strong></p><p>但是现在，让我们使用 Pin 来防止这个问题。 我一直在评论，以便更容易地发现和理解我们需要做出的改变。</p><div class="language-rust line-numbers-mode"><pre><code> <span class="token attribute attr-name">#![feature(optin_builtin_traits, negative_impls)]</span> <span class="token comment">// needed to implement `!Unpin`</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>pin<span class="token punctuation">::</span></span><span class="token class-name">Pin</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> gen1 <span class="token operator">=</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> gen2 <span class="token operator">=</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Before we pin the pointers, this is safe to do</span>
    <span class="token comment">// std::mem::swap(&amp;mut gen, &amp;mut gen2);</span>

    <span class="token comment">// constructing a `Pin::new()` on a type which does not implement `Unpin` is</span>
    <span class="token comment">// unsafe. A value pinned to heap can be constructed while staying in safe</span>
    <span class="token comment">// Rust so we can use that to avoid unsafe. You can also use crates like</span>
    <span class="token comment">// `pin_utils` to pin to the stack safely, just remember that they use</span>
    <span class="token comment">// unsafe under the hood so it&#39;s like using an already-reviewed unsafe</span>
    <span class="token comment">// implementation.</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> pinned1 <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">pin</span><span class="token punctuation">(</span>gen1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> pinned2 <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">pin</span><span class="token punctuation">(</span>gen2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Uncomment these if you think it&#39;s safe to pin the values to the stack instead </span>
    <span class="token comment">// (it is in this case). Remember to comment out the two previous lines first.</span>
    <span class="token comment">//let mut pinned1 = unsafe { Pin::new_unchecked(&amp;mut gen1) };</span>
    <span class="token comment">//let mut pinned2 = unsafe { Pin::new_unchecked(&amp;mut gen2) };</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Yielded</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=</span> pinned1<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Gen1 got value {}&quot;</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Yielded</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=</span> pinned2<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Gen2 got value {}&quot;</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// This won&#39;t work:</span>
    <span class="token comment">// std::mem::swap(&amp;mut gen, &amp;mut gen2);</span>
    <span class="token comment">// This will work but will just swap the pointers so nothing bad happens here:</span>
    <span class="token comment">// std::mem::swap(&amp;mut pinned1, &amp;mut pinned2);</span>

    <span class="token keyword">let</span> _ <span class="token operator">=</span> pinned1<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> _ <span class="token operator">=</span> pinned2<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">enum</span> <span class="token type-definition class-name">GeneratorState</span><span class="token operator">&lt;</span><span class="token class-name">Y</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Yielded</span><span class="token punctuation">(</span><span class="token class-name">Y</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
    <span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">}</span>

<span class="token keyword">trait</span> <span class="token class-name">Generator</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Yield</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Return</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">resume</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> <span class="token class-name">Pin</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">GeneratorState</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Yield</span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Return</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">enum</span> <span class="token type-definition class-name">GeneratorA</span> <span class="token punctuation">{</span>
    <span class="token class-name">Enter</span><span class="token punctuation">,</span>
    <span class="token class-name">Yield1</span> <span class="token punctuation">{</span>
        to_borrow<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
        borrowed<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token class-name">Exit</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">GeneratorA</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Enter</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// This tells us that the underlying pointer is not safe to move after pinning.</span>
<span class="token comment">// In this case, only we as implementors &quot;feel&quot; this, however, if someone is</span>
<span class="token comment">// relying on our Pinned pointer this will prevent them from moving it. You need</span>
<span class="token comment">// to enable the feature flag ` #![feature(optin_builtin_traits)]` and use the</span>
<span class="token comment">// nightly compiler to implement `!Unpin`. Normally, you would use</span>
<span class="token comment">// `std::marker::PhantomPinned` to indicate that the struct is `!Unpin`.</span>
<span class="token keyword">impl</span> <span class="token operator">!</span><span class="token class-name">Unpin</span> <span class="token keyword">for</span> <span class="token class-name">GeneratorA</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Generator</span> <span class="token keyword">for</span> <span class="token class-name">GeneratorA</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Yield</span> <span class="token operator">=</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Return</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">resume</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> <span class="token class-name">Pin</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">GeneratorState</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Yield</span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Return</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// lets us get ownership over current state</span>
        <span class="token keyword">let</span> this <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">get_unchecked_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">match</span> this <span class="token punctuation">{</span>
            <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Enter</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> to_borrow <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> borrowed <span class="token operator">=</span> <span class="token operator">&amp;</span>to_borrow<span class="token punctuation">;</span>
                <span class="token keyword">let</span> res <span class="token operator">=</span> borrowed<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">*</span>this <span class="token operator">=</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Yield1</span> <span class="token punctuation">{</span>to_borrow<span class="token punctuation">,</span> borrowed<span class="token punctuation">:</span> <span class="token namespace">std<span class="token punctuation">::</span>ptr<span class="token punctuation">::</span></span><span class="token function">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

                <span class="token comment">// Trick to actually get a self reference. We can&#39;t reference</span>
                <span class="token comment">// the `String` earlier since these references will point to the</span>
                <span class="token comment">// location in this stack frame which will not be valid anymore</span>
                <span class="token comment">// when this function returns.</span>
                <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Yield1</span> <span class="token punctuation">{</span>to_borrow<span class="token punctuation">,</span> borrowed<span class="token punctuation">}</span> <span class="token operator">=</span> this <span class="token punctuation">{</span>
                    <span class="token operator">*</span>borrowed <span class="token operator">=</span> to_borrow<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Yielded</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Yield1</span> <span class="token punctuation">{</span>borrowed<span class="token punctuation">,</span> <span class="token punctuation">..</span><span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> borrowed<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">String</span> <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span><span class="token operator">&amp;</span><span class="token operator">*</span><span class="token operator">*</span>borrowed<span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{} world&quot;</span><span class="token punctuation">,</span> borrowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">*</span>this <span class="token operator">=</span> <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Exit</span><span class="token punctuation">;</span>
                <span class="token class-name">GeneratorState</span><span class="token punctuation">::</span><span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">GeneratorA</span><span class="token punctuation">::</span><span class="token class-name">Exit</span> <span class="token operator">=&gt;</span> <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;Can&#39;t advance an exited generator!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br></div></div><p>现在，正如你所看到的，这个 API 的使用者必须:</p><ol><li>将值装箱，从而在堆上分配它</li><li>使用<code>unafe</code>然后把值固定到栈上。 用户知道如果他们事后移动了这个值，那么他们在就违反了当他们使用unsafe时候做出的承诺,也就是一直持有.</li></ol><p>希望在这之后，你会知道当你在一个异步函数中使用<code>yield</code>或者<code>await</code>关键词时会发生什么，以及如果我们想要安全地跨yield/await借用时。,为什么我们需要<code>Pin</code></p><h2 id="七-实现futures-主要例子"><a class="header-anchor" href="#七-实现futures-主要例子" aria-hidden="true">#</a> 七 实现Futures--主要例子</h2><p>我们将用一个伪reactor和一个简单的执行器创建我们自己的<code>Futures</code>，它允许你在浏览器中编辑和运行代码</p><p>我将向您介绍这个示例，但是如果您想更深入的研究它，您可以<a href="https://github.com/cfsamson/examples-futures" target="_blank" rel="noopener noreferrer">克隆存储库</a>并自己处理代码，或者直接从下一章复制代码。</p><p>readme文件中解释了几个分支，其中有两个分支与本章相关。 主分支是我们在这里经过的例子，<code>basic_example_commented</code>分支是这个具有大量注释的例子</p><blockquote><p>如果您希望跟随我们的步骤，可以通过创建一个新的文件夹初始化一个新的 cargo 项目，并在其中运行 cargo init。所有的一切都在main.rs文件中.</p></blockquote><h3 id="实现我们自己的futures"><a class="header-anchor" href="#实现我们自己的futures" aria-hidden="true">#</a> 实现我们自己的Futures</h3><p>让我们先从引入依赖开始:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token namespace">future<span class="token punctuation">::</span></span><span class="token class-name">Future</span><span class="token punctuation">,</span> <span class="token namespace">pin<span class="token punctuation">::</span></span><span class="token class-name">Pin</span><span class="token punctuation">,</span> <span class="token namespace">sync<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">mpsc<span class="token punctuation">::</span></span><span class="token punctuation">{</span>channel<span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Arc</span><span class="token punctuation">,</span> <span class="token class-name">Mutex</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token namespace">task<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Context</span><span class="token punctuation">,</span> <span class="token class-name">Poll</span><span class="token punctuation">,</span> <span class="token class-name">RawWaker</span><span class="token punctuation">,</span> <span class="token class-name">RawWakerVTable</span><span class="token punctuation">,</span> <span class="token class-name">Waker</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token class-name">JoinHandle</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token namespace">time<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Duration</span><span class="token punctuation">,</span> <span class="token class-name">Instant</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="执行器"><a class="header-anchor" href="#执行器" aria-hidden="true">#</a> 执行器</h3><p>执行器的责任是获取一个或多个<code>Future</code>然后运行他们到完成。</p><p>执行器拿到<code>Future</code>后的第一件事就是轮询它.</p><p>轮询后可以发现以下三种情况:</p><ol><li><code>Future</code>返回Ready,然后就可以调度其他任何后续操作.</li><li>这个<code>Future</code>从未被轮询过,所以传入一个<code>Waker</code>,然后将它挂起</li><li>这个<code>Future</code>已经被轮询过,但是返回<code>Pending</code></li></ol><p>Rust通过<code>Waker</code>为Reactor和执行器提供了通信方式. reactor存储这个<code>Waker</code>,然后在<code>Future</code>等待的事件完成的时候调用<code>Waker: : wake ()</code>,这样<code>Future</code>就会被再次轮询.</p><p>我们的执行器会是这个样子:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token comment">// Our executor takes any object which implements the `Future` trait</span>
<span class="token keyword">fn</span> <span class="token function-definition function">block_on</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">mut</span> future<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">F</span><span class="token punctuation">::</span><span class="token class-name">Output</span> <span class="token punctuation">{</span>

    <span class="token comment">// the first thing we do is to construct a `Waker` which we&#39;ll pass on to</span>
    <span class="token comment">// the `reactor` so it can wake us up when an event is ready. </span>
    <span class="token keyword">let</span> mywaker <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">MyWaker</span><span class="token punctuation">{</span> thread<span class="token punctuation">:</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">let</span> waker <span class="token operator">=</span> <span class="token function">waker_into_waker</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">into_raw</span><span class="token punctuation">(</span>mywaker<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// The context struct is just a wrapper for a `Waker` object. Maybe in the</span>
    <span class="token comment">// future this will do more, but right now it&#39;s just a wrapper.</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> cx <span class="token operator">=</span> <span class="token class-name">Context</span><span class="token punctuation">::</span><span class="token function">from_waker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>waker<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// So, since we run this on one thread and run one future to completion</span>
    <span class="token comment">// we can pin the `Future` to the stack. This is unsafe, but saves an</span>
    <span class="token comment">// allocation. We could `Box::pin` it too if we wanted. This is however</span>
    <span class="token comment">// safe since we shadow `future` so it can&#39;t be accessed again and will</span>
    <span class="token comment">// not move until it&#39;s dropped.</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> future <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">Pin</span><span class="token punctuation">::</span><span class="token function">new_unchecked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> future<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// We poll in a loop, but it&#39;s not a busy loop. It will only run when</span>
    <span class="token comment">// an event occurs, or a thread has a &quot;spurious wakeup&quot; (an unexpected wakeup</span>
    <span class="token comment">// that can happen for no good reason).</span>
    <span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        
        <span class="token keyword">match</span> <span class="token class-name">Future</span><span class="token punctuation">::</span><span class="token function">poll</span><span class="token punctuation">(</span>pinned<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> cx<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// when the Future is ready we&#39;re finished</span>
            <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Ready</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">break</span> val<span class="token punctuation">,</span>

            <span class="token comment">// If we get a `pending` future we just go to sleep...</span>
            <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Pending</span> <span class="token operator">=&gt;</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    val
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>在本章的所有例子中，我都选择了对代码进行广泛的注释。 我发现沿着这条路走会更容易一些，所以我不会在这里重复自己的话，只关注一些可能需要进一步解释的重要方面。</p><p>现在你已经阅读了这么多关于生成器和 Pin 的内容，这应该很容易理解。 <code>Future</code>是一个状态机，每一个<code>await</code>点也是一个<code>yield</code>点。 我们可以跨越<code>await</code>借用，我们遇到的问题与跨<code>yield</code>借用时完全一样。</p><blockquote><p><code>Context</code>只是 <code>Waker</code> 的包装器, 至少在我写这本书的时候，它仅仅是这样。 在未来，<code>Context</code>对象可能不仅仅是包装一个<code>Waker</code>(译者注,原文是Future,应该有误)，因此这种额外的抽象可以提供一些灵活性。</p></blockquote><p>正如在关于生成器的章节中解释的那样，我们使用Pin来保证允许<code>Future</code>有自引用。</p><h3 id="实现future"><a class="header-anchor" href="#实现future" aria-hidden="true">#</a> 实现Future</h3><p><code>Future</code>有一个定义良好的接口，这意味着他们可以用于整个生态系统。</p><p>我们可以将这些<code>Future</code>连接起来，这样一旦<code>leaf-future</code>准备好了，我们就可以执行一系列操作，直到任务完成或者我们到达另一个<code>leaf-future</code>，我们将等待并将控制权交给调度程序。</p><p>我们<code>Future</code>的实现是这样的:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token comment">// This is the definition of our `Waker`. We use a regular thread-handle here.</span>
<span class="token comment">// It works but it&#39;s not a good solution. It&#39;s easy to fix though, I&#39;ll explain</span>
<span class="token comment">// after this code snippet.</span>
<span class="token attribute attr-name">#[derive(Clone)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">MyWaker</span> <span class="token punctuation">{</span>
    thread<span class="token punctuation">:</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token class-name">Thread</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// This is the definition of our `Future`. It keeps all the information we</span>
<span class="token comment">// need. This one holds a reference to our `reactor`, that&#39;s just to make</span>
<span class="token comment">// this example as easy as possible. It doesn&#39;t need to hold a reference to</span>
<span class="token comment">// the whole reactor, but it needs to be able to register itself with the</span>
<span class="token comment">// reactor.</span>
<span class="token attribute attr-name">#[derive(Clone)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Task</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    reactor<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Reactor</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// These are function definitions we&#39;ll use for our waker. Remember the</span>
<span class="token comment">// &quot;Trait Objects&quot; chapter earlier.</span>
<span class="token keyword">fn</span> <span class="token function-definition function">mywaker_wake</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">MyWaker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> waker_ptr<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">MyWaker</span> <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token keyword">let</span> waker_arc <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">from_raw</span><span class="token punctuation">(</span>waker_ptr<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    waker_arc<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Since we use an `Arc` cloning is just increasing the refcount on the smart</span>
<span class="token comment">// pointer.</span>
<span class="token keyword">fn</span> <span class="token function-definition function">mywaker_clone</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">MyWaker</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">RawWaker</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> arc <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">from_raw</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">forget</span><span class="token punctuation">(</span>arc<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// increase ref count</span>
    <span class="token class-name">RawWaker</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">into_raw</span><span class="token punctuation">(</span>arc<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token constant">VTABLE</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// This is actually a &quot;helper funtcion&quot; to create a `Waker` vtable. In contrast</span>
<span class="token comment">// to when we created a `Trait Object` from scratch we don&#39;t need to concern</span>
<span class="token comment">// ourselves with the actual layout of the `vtable` and only provide a fixed</span>
<span class="token comment">// set of functions</span>
<span class="token keyword">const</span> <span class="token constant">VTABLE</span><span class="token punctuation">:</span> <span class="token class-name">RawWakerVTable</span> <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
    <span class="token class-name">RawWakerVTable</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
        <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>s<span class="token closure-punctuation punctuation">|</span></span> <span class="token function">mywaker_clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token operator">*</span><span class="token punctuation">(</span>s <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">MyWaker</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment">// clone</span>
        <span class="token operator">|</span>s<span class="token operator">|</span> <span class="token function">mywaker_wake</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token operator">*</span><span class="token punctuation">(</span>s <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">MyWaker</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment">// wake</span>
        <span class="token operator">|</span>s<span class="token operator">|</span> <span class="token function">mywaker_wake</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>s <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token operator">&amp;</span><span class="token class-name">MyWaker</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment">// wake by ref</span>
        <span class="token operator">|</span>s<span class="token operator">|</span> <span class="token function">drop</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">from_raw</span><span class="token punctuation">(</span>s <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">MyWaker</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// decrease refcount</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Instead of implementing this on the `MyWaker` object in `impl Mywaker...` we</span>
<span class="token comment">// just use this pattern instead since it saves us some lines of code.</span>
<span class="token keyword">fn</span> <span class="token function-definition function">waker_into_waker</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">MyWaker</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Waker</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> raw_waker <span class="token operator">=</span> <span class="token class-name">RawWaker</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>s <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token constant">VTABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">Waker</span><span class="token punctuation">::</span><span class="token function">from_raw</span><span class="token punctuation">(</span>raw_waker<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Task</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>reactor<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Reactor</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token class-name">Task</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> reactor<span class="token punctuation">,</span> data <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// This is our `Future` implementation</span>
<span class="token keyword">impl</span> <span class="token class-name">Future</span> <span class="token keyword">for</span> <span class="token class-name">Task</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>

    <span class="token comment">// Poll is the what drives the state machine forward and it&#39;s the only</span>
    <span class="token comment">// method we&#39;ll need to call to drive futures to completion.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">poll</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> <span class="token class-name">Pin</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> cx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;_</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Poll</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>

        <span class="token comment">// We need to get access the reactor in our `poll` method so we acquire</span>
        <span class="token comment">// a lock on that.</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> r <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>reactor<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// First we check if the task is marked as ready</span>
        <span class="token keyword">if</span> r<span class="token punctuation">.</span><span class="token function">is_ready</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// If it&#39;s ready we set its state to `Finished`</span>
            <span class="token operator">*</span>r<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">get_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token class-name">TaskState</span><span class="token punctuation">::</span><span class="token class-name">Finished</span><span class="token punctuation">;</span>
            <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Ready</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span>
        
        <span class="token comment">// If it isn&#39;t finished we check the map we have stored in our Reactor</span>
        <span class="token comment">// over id&#39;s we have registered and see if it&#39;s there</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> r<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">contains_key</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// This is important. The docs says that on multiple calls to poll,</span>
            <span class="token comment">// only the Waker from the Context passed to the most recent call</span>
            <span class="token comment">// should be scheduled to receive a wakeup. That&#39;s why we insert</span>
            <span class="token comment">// this waker into the map (which will return the old one which will</span>
            <span class="token comment">// get dropped) before we return `Pending`.</span>
            r<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token class-name">TaskState</span><span class="token punctuation">::</span><span class="token class-name">NotReady</span><span class="token punctuation">(</span>cx<span class="token punctuation">.</span><span class="token function">waker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Pending</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

            <span class="token comment">// If it&#39;s not ready, and not in the map it&#39;s a new task so we</span>
            <span class="token comment">// register that with the Reactor and return `Pending`</span>
            r<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> cx<span class="token punctuation">.</span><span class="token function">waker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Pending</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Note that we&#39;re holding a lock on the `Mutex` which protects the</span>
        <span class="token comment">// Reactor all the way until the end of this scope. This means that</span>
        <span class="token comment">// even if our task were to complete immidiately, it will not be</span>
        <span class="token comment">// able to call `wake` while we&#39;re in our `Poll` method.</span>

        <span class="token comment">// Since we can make this guarantee, it&#39;s now the Executors job to</span>
        <span class="token comment">// handle this possible race condition where `Wake` is called after</span>
        <span class="token comment">// `poll` but before our thread goes to sleep.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br></div></div><p>这大部分都是直截了当的。 令人困惑的部分是我们需要构建 Waker 的奇怪方式，但是由于我们已经从原始部分创建了我们自己的 trait 对象，这看起来很熟悉。 事实上，这更简单。</p><p>我们在这里使用一个Arc来传递一个引用计数的MyWaker的借用。 这是相当正常的，并且使得这个操作变得简单和安全。 克隆一个Waker只是增加一个计数。Drop一个Waker只是简单地减少一个计数.</p><p>在我们这种特定场景下,我们选择不使用<code>Arc</code>. 而使用这种更低层次方式实现的Waker才可以允许我们这么做.</p><p>事实上，如果我们只使用 Arc，那么我们就没有理由费尽心思去创建自己的 vtable 和 RawWaker。 我们可以实现一个普通的trait。</p><p>幸运的是，将来在标准库中也可以实现这个功能。 目前<a href="https://rust-lang-nursery.github.io/futures-api-docs/0.3.0-alpha.13/futures/task/trait.ArcWake.html" target="_blank" rel="noopener noreferrer">这个特性仍然在实验中</a>，但是我猜想在成熟之后，这个特性将会成为标准库的一部分。</p><p>我们选择在这里传入一个整个reactor的引用, 这不正常。 reactor通常是一个全局性的资源，让我们注册感兴趣的事而不需要传入一个引用.</p><blockquote><p><strong>为什么在一个Lib中使用park/unpark是一个坏主意</strong></p><p>他很容易死锁,因为任何人都可以获得执行器所在线程的句柄,然后调用park/unpark.</p></blockquote><blockquote><ol><li>一个future可以在另一个不同的线程上unpark执行器线程</li><li>我们的执行器认为数据准备好了,然后醒来去轮询这个<code>Future</code></li><li>当被轮询时,这个<code>Future</code>还没有准备好,但是恰在此时,<code>Reactor</code>收到事件,调用了<code>Wake()</code>来unpark我们的线程.</li><li>这可能发生在我们再次睡眠之前,因为这些操作完全是并行的.</li><li>我们的reactor已经调用过<code>wake</code>,但是我们的线程仍然在睡眠,因为刚刚调用wake的时候,我们的线程是醒着的.</li><li>我们发生了死锁,然后我们的程序停止工作.</li></ol></blockquote><blockquote><p>有一种情况是，我们的线程可能会出现所谓的虚假唤醒(可能会出乎意料地发生) ，如果我们运气不好，这可能会导致同样的死锁</p></blockquote><p>有几种更好的方案,比如:</p><ul><li>std::sync::CondVar</li><li>crossbeam::sync::Parker</li></ul><h3 id="reactor"><a class="header-anchor" href="#reactor" aria-hidden="true">#</a> Reactor</h3><p>这是最后的冲刺阶段，并不完全与<code>Future</code>相关，但是我们需要它来让我们的例子运行起来。</p><p>由于大多数时候并发只有在与外部世界(或者至少是一些外围设备)进行交互时才有意义，因此我们需要一些东西来抽象这些异步的交互.</p><p>这就是reacotor的工作. 大多数时候你看到的reactor都是用<a href="https://github.com/tokio-rs/mio" target="_blank" rel="noopener noreferrer">Mio</a>这个库. 它早多个平台上提供了非阻塞API和事件通知机制.</p><p>reactor通常会提供类似于TcpStream(或任何其他资源)的东西，只不过您用TcpStream来创建I/O请求,而用reactor来创建Future.</p><p>我们的示例任务是一个计时器，它只生成一个线程，并将其置于休眠状态，休眠时间为我们指定的秒数。 我们在这里创建的reactor将创建一个表示每个计时器的<code>leaf-future</code>。 作为回报，reactor接收到一个唤醒器，一旦任务完成reactor将调用这个唤醒器。</p><p>为了能够在浏览器中运行这里的代码，没有太多真正的I/O，我们可以假装这实际上代表了一些有用的I/O操作。</p><p>我们的reactor看起来像这样:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token comment">// This is a &quot;fake&quot; reactor. It does no real I/O, but that also makes our</span>
<span class="token comment">// code possible to run in the book and in the playground</span>
<span class="token comment">// The different states a task can have in this Reactor</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">TaskState</span> <span class="token punctuation">{</span>
    <span class="token class-name">Ready</span><span class="token punctuation">,</span>
    <span class="token class-name">NotReady</span><span class="token punctuation">(</span><span class="token class-name">Waker</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Finished</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// This is a &quot;fake&quot; reactor. It does no real I/O, but that also makes our</span>
<span class="token comment">// code possible to run in the book and in the playground</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Reactor</span> <span class="token punctuation">{</span>

    <span class="token comment">// we need some way of registering a Task with the reactor. Normally this</span>
    <span class="token comment">// would be an &quot;interest&quot; in an I/O event</span>
    dispatcher<span class="token punctuation">:</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">Event</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    handle<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">JoinHandle</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>

    <span class="token comment">// This is a list of tasks</span>
    tasks<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token class-name">TaskState</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// This represents the Events we can send to our reactor thread. In this</span>
<span class="token comment">// example it&#39;s only a Timeout or a Close event.</span>
<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">Event</span> <span class="token punctuation">{</span>
    <span class="token class-name">Close</span><span class="token punctuation">,</span>
    <span class="token class-name">Timeout</span><span class="token punctuation">(</span><span class="token keyword">u64</span><span class="token punctuation">,</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Reactor</span> <span class="token punctuation">{</span>

    <span class="token comment">// We choose to return an atomic reference counted, mutex protected, heap</span>
    <span class="token comment">// allocated `Reactor`. Just to make it easy to explain... No, the reason</span>
    <span class="token comment">// we do this is:</span>
    <span class="token comment">//</span>
    <span class="token comment">// 1. We know that only thread-safe reactors will be created.</span>
    <span class="token comment">// 2. By heap allocating it we can obtain a reference to a stable address</span>
    <span class="token comment">// that&#39;s not dependent on the stack frame of the function that called `new`</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>tx<span class="token punctuation">,</span> rx<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Event</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> reactor <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Reactor</span> <span class="token punctuation">{</span>
            dispatcher<span class="token punctuation">:</span> tx<span class="token punctuation">,</span>
            handle<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            tasks<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Notice that we&#39;ll need to use `weak` reference here. If we don&#39;t,</span>
        <span class="token comment">// our `Reactor` will not get `dropped` when our main thread is finished</span>
        <span class="token comment">// since we&#39;re holding internal references to it.</span>

        <span class="token comment">// Since we&#39;re collecting all `JoinHandles` from the threads we spawn</span>
        <span class="token comment">// and make sure to join them we know that `Reactor` will be alive</span>
        <span class="token comment">// longer than any reference held by the threads we spawn here.</span>
        <span class="token keyword">let</span> reactor_clone <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">downgrade</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>reactor<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// This will be our Reactor-thread. The Reactor-thread will in our case</span>
        <span class="token comment">// just spawn new threads which will serve as timers for us.</span>
        <span class="token keyword">let</span> handle <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> handles <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token comment">// This simulates some I/O resource</span>
            <span class="token keyword">for</span> event <span class="token keyword">in</span> rx <span class="token punctuation">{</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;REACTOR: {:?}&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> reactor <span class="token operator">=</span> reactor_clone<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">match</span> event <span class="token punctuation">{</span>
                    <span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">Close</span> <span class="token operator">=&gt;</span> <span class="token keyword">break</span><span class="token punctuation">,</span>
                    <span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">Timeout</span><span class="token punctuation">(</span>duration<span class="token punctuation">,</span> id<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

                        <span class="token comment">// We spawn a new thread that will serve as a timer</span>
                        <span class="token comment">// and will call `wake` on the correct `Waker` once</span>
                        <span class="token comment">// it&#39;s done.</span>
                        <span class="token keyword">let</span> event_handle <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                            <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">let</span> reactor <span class="token operator">=</span> reactor<span class="token punctuation">.</span><span class="token function">upgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            reactor<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token keyword">mut</span> r<span class="token closure-punctuation punctuation">|</span></span> r<span class="token punctuation">.</span><span class="token function">wake</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        handles<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>event_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// This is important for us since we need to know that these</span>
            <span class="token comment">// threads don&#39;t live longer than our Reactor-thread. Our</span>
            <span class="token comment">// Reactor-thread will be joined when `Reactor` gets dropped.</span>
            handles<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>handle<span class="token closure-punctuation punctuation">|</span></span> handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reactor<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token keyword">mut</span> r<span class="token closure-punctuation punctuation">|</span></span> r<span class="token punctuation">.</span>handle <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reactor
    <span class="token punctuation">}</span>

    <span class="token comment">// The wake function will call wake on the waker for the task with the</span>
    <span class="token comment">// corresponding id.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">wake</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">get_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>state<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>

            <span class="token comment">// No matter what state the task was in we can safely set it</span>
            <span class="token comment">// to ready at this point. This lets us get ownership over the</span>
            <span class="token comment">// the data that was there before we replaced it.</span>
            <span class="token keyword">match</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">replace</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token class-name">TaskState</span><span class="token punctuation">::</span><span class="token class-name">Ready</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">TaskState</span><span class="token punctuation">::</span><span class="token class-name">NotReady</span><span class="token punctuation">(</span>waker<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> waker<span class="token punctuation">.</span><span class="token function">wake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">TaskState</span><span class="token punctuation">::</span><span class="token class-name">Finished</span> <span class="token operator">=&gt;</span> <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;Called &#39;wake&#39; twice on task: {}&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">,</span>
                _ <span class="token operator">=&gt;</span> <span class="token macro property">unreachable!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Register a new task with the reactor. In this particular example</span>
    <span class="token comment">// we panic if a task with the same id get&#39;s registered twice </span>
    <span class="token keyword">fn</span> <span class="token function-definition function">register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> duration<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> waker<span class="token punctuation">:</span> <span class="token class-name">Waker</span><span class="token punctuation">,</span> id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token class-name">TaskState</span><span class="token punctuation">::</span><span class="token class-name">NotReady</span><span class="token punctuation">(</span>waker<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_some</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;Tried to insert a task with id: &#39;{}&#39;, twice!&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dispatcher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">Timeout</span><span class="token punctuation">(</span>duration<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// We send a close event to the reactor so it closes down our reactor-thread</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dispatcher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">Close</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// We simply checks if a task with this id is in the state `TaskState::Ready`</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">is_ready</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>state<span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">match</span> state <span class="token punctuation">{</span>
            <span class="token class-name">TaskState</span><span class="token punctuation">::</span><span class="token class-name">Ready</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            _ <span class="token operator">=&gt;</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap_or</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Drop</span> <span class="token keyword">for</span> <span class="token class-name">Reactor</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">drop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>handle<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>h<span class="token closure-punctuation punctuation">|</span></span> h<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br></div></div><p>虽然代码量很大，但实际上我们只是产生了一个新线程，并让它休眠一段时间，这是我们在创建任务时指定的。</p><p>虽然代码量很大，但实际上我们只是产生了一个新线程，并让它休眠一段时间，这是我们在创建任务时指定的。</p><p>在最后一章中，我们在一个可编辑的窗口中有整整200行，你可以按照自己喜欢的方式进行编辑和修改。</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This is just to make it easier for us to see when our Future was resolved</span>
    <span class="token keyword">let</span> start <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Many runtimes create a glocal `reactor` we pass it as an argument</span>
    <span class="token keyword">let</span> reactor <span class="token operator">=</span> <span class="token class-name">Reactor</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Since we&#39;ll share this between threads we wrap it in a </span>
    <span class="token comment">// atmically-refcounted- mutex.</span>
    <span class="token keyword">let</span> reactor <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>reactor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// We create two tasks:</span>
    <span class="token comment">// - first parameter is the `reactor`</span>
    <span class="token comment">// - the second is a timeout in seconds</span>
    <span class="token comment">// - the third is an `id` to identify the task</span>
    <span class="token keyword">let</span> future1 <span class="token operator">=</span> <span class="token class-name">Task</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>reactor<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> future2 <span class="token operator">=</span> <span class="token class-name">Task</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>reactor<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// an `async` block works the same way as an `async fn` in that it compiles</span>
    <span class="token comment">// our code into a state machine, `yielding` at every `await` point.</span>
    <span class="token keyword">let</span> fut1 <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> val <span class="token operator">=</span> future1<span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> dur <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Instant</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as_secs_f32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Future got {} at time: {:.2}.&quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">,</span> dur<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> fut2 <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> val <span class="token operator">=</span> future2<span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> dur <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Instant</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as_secs_f32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Future got {} at time: {:.2}.&quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">,</span> dur<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// Our executor can only run one and one future, this is pretty normal</span>
    <span class="token comment">// though. You have a set of operations containing many futures that</span>
    <span class="token comment">// ends up as a single future that drives them all to completion.</span>
    <span class="token keyword">let</span> mainfut <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
        fut1<span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        fut2<span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// This executor will block the main thread until the futures is resolved</span>
    <span class="token function">block_on</span><span class="token punctuation">(</span>mainfut<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// When we&#39;re done, we want to shut down our reactor thread so our program</span>
    <span class="token comment">// ends nicely.</span>
    reactor<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token keyword">mut</span> r<span class="token closure-punctuation punctuation">|</span></span> r<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>我添加了一个reactor感兴趣的事件的调试输出，这样我们可以观察到两件事:</p><ol><li><code>Waker</code>这个对象如何像前面我们讨论的trai对象</li><li>事件以何种顺序向reactor注册感兴趣的信息</li></ol><h3 id="async-await和并发async-await"><a class="header-anchor" href="#async-await和并发async-await" aria-hidden="true">#</a> Async/Await和并发Async/Await</h3><p>Async 关键字可以用在 async fn (...)中的函数上，也可以用在 async { ... }中的块上。 两者都可以讲一个函数或者代码块转换成一个<code>Future</code></p><p>这些<code>Future</code>是相当简单的。 想象一下几章前我们的生成器。</p><p>每一个await就像一个yield,只不过不是生成一个值,而是生成Future,然后当轮询的时候返回响应的结果.</p><p>我们的<code>mainfut</code>包含两个<code>non-leaf-future</code>，它将在轮询中调用。<code>non-leaf-future</code>有一个<code>poll</code>方法, 这个方法简单的轮询他自己的内部Future,它内部的Future会被继续轮询,直到<code>leaf-future</code>返回<code>Ready</code>或者<code>Pending</code>.</p><p>就我们现在的例子来看，它并不比常规的同步代码好多少。 对于我们来说，如果需要在同一时间等待多个<code>Future</code>，我们需要<code>spawn</code>它们，以便执行器同时运行它们。</p><p>现在我们的例子返回如下结果:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token class-name">Future</span> got <span class="token number">1</span> at time<span class="token punctuation">:</span> <span class="token number">1.00</span><span class="token punctuation">.</span>
<span class="token class-name">Future</span> got <span class="token number">2</span> at time<span class="token punctuation">:</span> <span class="token number">3.00</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-rust line-numbers-mode"><pre><code><span class="token class-name">Future</span> got <span class="token number">1</span> at time<span class="token punctuation">:</span> <span class="token number">1.00</span><span class="token punctuation">.</span>
<span class="token class-name">Future</span> got <span class="token number">2</span> at time<span class="token punctuation">:</span> <span class="token number">2.00</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>请注意，这并不意味着它们需要并行运行。 它们可以并行运行，但没有要求。 请记住，我们正在等待一些外部资源，这样我们就可以在一个线程上发出许多这样的调用，并在事件发生时处理每个事件</p></blockquote><p>现在，我将向您介绍一些更好的资源，以实现一个更好的执行器。 现在你应该已经对<code>Future</code>的概念有了一个很好的理解。</p><p>下一步应该是了解更高级的运行时是如何工作的，以及它们如何实现不同的运行 Futures 的方式。</p><p>如果我是你，我接下来就会读这篇文章，并试着把它应用到我们的例子中去。</p><p>我希望在阅读完这篇文章后，能够更容易地探索Future和异步，我真的希望你们能够继续深入探索。</p><p>别忘了最后一章的练习。</p><h3 id="奖励部分-暂停线程的更好办法"><a class="header-anchor" href="#奖励部分-暂停线程的更好办法" aria-hidden="true">#</a> 奖励部分-暂停线程的更好办法</h3><p>正如我们在本章前面解释的那样，仅仅调用<code>thread::sleep</code> 并不足以实现一个合适的反应器。 你也可以使用类似<a href="https://docs.rs/crossbeam/0.7.3/crossbeam/sync/struct.Parker.html" target="_blank" rel="noopener noreferrer">crossbeam::sync::Parker</a>中的Parker 这样的工具.</p><p>因为我们自己创建一个这样的Parker也不需要很多行代码，所以我们将展示如何通过使用 Condvar 和 Mutex 来解决这个问题。</p><p>我们自己的Parker:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token attribute attr-name">#[derive(Default)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Parker</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Condvar</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Parker</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">park</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// We aquire a lock to the Mutex which protects our flag indicating if we</span>
        <span class="token comment">// should resume execution or not.</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> resumable <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// We put this in a loop since there is a chance we&#39;ll get woken, but</span>
            <span class="token comment">// our flag hasn&#39;t changed. If that happens, we simply go back to sleep.</span>
            <span class="token keyword">while</span> <span class="token operator">!</span><span class="token operator">*</span>resumable <span class="token punctuation">{</span>

                <span class="token comment">// We sleep until someone notifies us</span>
                resumable <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>resumable<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token comment">// We immidiately set the condition to false, so that next time we call `park` we&#39;ll</span>
        <span class="token comment">// go right to sleep.</span>
        <span class="token operator">*</span>resumable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">unpark</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// We simply acquire a lock to our flag and sets the condition to `runnable` when we</span>
        <span class="token comment">// get it.</span>
        <span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token comment">// We notify our `Condvar` so it wakes up and resumes.</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>在 Rust 中的 Condvar 被设计为与互斥对象一起工作。 通常，您会认为在我们进入休眠之前,<code>self.0.lock().unwrap()</code>不会释放锁, 这意味着我们的<code>unpark</code>永远获取不到锁,我们会陷入死锁。</p><p>使用<code>Condvar</code>我们可以避免这种情况，因为<code>Condvar</code>会消耗我们的锁，所以它会在我们睡觉的时候释放。 当我们再次恢复时，我们的<code>Condvar</code>会重新持有锁，这样我们就可以继续操作它。 这意味着我们需要对我们的执行器做一些非常细微的改变，比如:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token keyword">fn</span> <span class="token function-definition function">block_on</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">mut</span> future<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">F</span><span class="token punctuation">::</span><span class="token class-name">Output</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> parker <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Parker</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;--- NB!</span>
    <span class="token keyword">let</span> mywaker <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">MyWaker</span> <span class="token punctuation">{</span> parker<span class="token punctuation">:</span> parker<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token macro property">NB!</span>
    <span class="token keyword">let</span> waker <span class="token operator">=</span> <span class="token function">mywaker_into_waker</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">into_raw</span><span class="token punctuation">(</span>mywaker<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> cx <span class="token operator">=</span> <span class="token class-name">Context</span><span class="token punctuation">::</span><span class="token function">from_waker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>waker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// SAFETY: we shadow `future` so it can&#39;t be accessed again.</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> future <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">Pin</span><span class="token punctuation">::</span><span class="token function">new_unchecked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> future<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> 
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token class-name">Future</span><span class="token punctuation">::</span><span class="token function">poll</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> cx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Ready</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">break</span> val<span class="token punctuation">,</span>
            <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Pending</span> <span class="token operator">=&gt;</span> parker<span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// &lt;--- NB!</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>我们需要像这样改变我们的唤醒器:</p><div class="language-rust line-numbers-mode"><pre><code><span class="token attribute attr-name">#[derive(Clone)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">MyWaker</span> <span class="token punctuation">{</span>
    parker<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Parker</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">mywaker_wake</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">MyWaker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> waker_arc <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">from_raw</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    waker_arc<span class="token punctuation">.</span>parker<span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>你可以查看由park/unpark引起的<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=b2343661fe3d271c91c6977ab8e681d0" target="_blank" rel="noopener noreferrer">微妙问题的连接</a>. 你可以在<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=bebef0f8a8ce6a9d0d32442cc8381595" target="_blank" rel="noopener noreferrer">这里</a>查看我们最终的版本如何避免了这个问题.</p></blockquote><h2 id="八-完整的例子"><a class="header-anchor" href="#八-完整的例子" aria-hidden="true">#</a> 八 完整的例子</h2><div class="language-rust line-numbers-mode"><pre><code> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> start <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> reactor <span class="token operator">=</span> <span class="token class-name">Reactor</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> fut1 <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token class-name">Task</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>reactor<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Got {} at time: {:.2}.&quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">,</span> start<span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as_secs_f32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> fut2 <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token class-name">Task</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>reactor<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Got {} at time: {:.2}.&quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">,</span> start<span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as_secs_f32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> mainfut <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
        fut1<span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        fut2<span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">block_on</span><span class="token punctuation">(</span>mainfut<span class="token punctuation">)</span><span class="token punctuation">;</span>
    reactor<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token keyword">mut</span> r<span class="token closure-punctuation punctuation">|</span></span> r<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token namespace">future<span class="token punctuation">::</span></span><span class="token class-name">Future</span><span class="token punctuation">,</span> <span class="token namespace">sync<span class="token punctuation">::</span></span><span class="token punctuation">{</span> <span class="token namespace">mpsc<span class="token punctuation">::</span></span><span class="token punctuation">{</span>channel<span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Arc</span><span class="token punctuation">,</span> <span class="token class-name">Mutex</span><span class="token punctuation">,</span> <span class="token class-name">Condvar</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token namespace">task<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Context</span><span class="token punctuation">,</span> <span class="token class-name">Poll</span><span class="token punctuation">,</span> <span class="token class-name">RawWaker</span><span class="token punctuation">,</span> <span class="token class-name">RawWakerVTable</span><span class="token punctuation">,</span> <span class="token class-name">Waker</span><span class="token punctuation">}</span><span class="token punctuation">,</span> mem<span class="token punctuation">,</span> <span class="token namespace">pin<span class="token punctuation">::</span></span><span class="token class-name">Pin</span><span class="token punctuation">,</span>
    <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token class-name">JoinHandle</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token namespace">time<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Duration</span><span class="token punctuation">,</span> <span class="token class-name">Instant</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token namespace">collections<span class="token punctuation">::</span></span><span class="token class-name">HashMap</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// ============================= EXECUTOR ====================================</span>
<span class="token attribute attr-name">#[derive(Default)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Parker</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Condvar</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Parker</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">park</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> resumable <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token operator">!</span><span class="token operator">*</span>resumable <span class="token punctuation">{</span>
                resumable <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>resumable<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token operator">*</span>resumable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">unpark</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">block_on</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">mut</span> future<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">F</span><span class="token punctuation">::</span><span class="token class-name">Output</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> parker <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Parker</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> mywaker <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">MyWaker</span> <span class="token punctuation">{</span> parker<span class="token punctuation">:</span> parker<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> waker <span class="token operator">=</span> <span class="token function">mywaker_into_waker</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">into_raw</span><span class="token punctuation">(</span>mywaker<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> cx <span class="token operator">=</span> <span class="token class-name">Context</span><span class="token punctuation">::</span><span class="token function">from_waker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>waker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// SAFETY: we shadow `future` so it can&#39;t be accessed again.</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> future <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">Pin</span><span class="token punctuation">::</span><span class="token function">new_unchecked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> future<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> 
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token class-name">Future</span><span class="token punctuation">::</span><span class="token function">poll</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> cx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Ready</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">break</span> val<span class="token punctuation">,</span>
            <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Pending</span> <span class="token operator">=&gt;</span> parker<span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// ====================== FUTURE IMPLEMENTATION ==============================</span>
<span class="token attribute attr-name">#[derive(Clone)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">MyWaker</span> <span class="token punctuation">{</span>
    parker<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Parker</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[derive(Clone)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Task</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    reactor<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Reactor</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">mywaker_wake</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">MyWaker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> waker_arc <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">from_raw</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    waker_arc<span class="token punctuation">.</span>parker<span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">mywaker_clone</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">MyWaker</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">RawWaker</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> arc <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">from_raw</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">forget</span><span class="token punctuation">(</span>arc<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// increase ref count</span>
    <span class="token class-name">RawWaker</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">into_raw</span><span class="token punctuation">(</span>arc<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token constant">VTABLE</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token constant">VTABLE</span><span class="token punctuation">:</span> <span class="token class-name">RawWakerVTable</span> <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
    <span class="token class-name">RawWakerVTable</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
        <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>s<span class="token closure-punctuation punctuation">|</span></span> <span class="token function">mywaker_clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token operator">*</span><span class="token punctuation">(</span>s <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">MyWaker</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// clone</span>
        <span class="token operator">|</span>s<span class="token operator">|</span> <span class="token function">mywaker_wake</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token operator">*</span><span class="token punctuation">(</span>s <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">MyWaker</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// wake</span>
        <span class="token operator">|</span>s<span class="token operator">|</span> <span class="token function">mywaker_wake</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>s <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token operator">&amp;</span><span class="token class-name">MyWaker</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// wake by ref</span>
        <span class="token operator">|</span>s<span class="token operator">|</span> <span class="token function">drop</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">from_raw</span><span class="token punctuation">(</span>s <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">MyWaker</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// decrease refcount</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">mywaker_into_waker</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">MyWaker</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Waker</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> raw_waker <span class="token operator">=</span> <span class="token class-name">RawWaker</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>s <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token constant">VTABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">Waker</span><span class="token punctuation">::</span><span class="token function">from_raw</span><span class="token punctuation">(</span>raw_waker<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Task</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>reactor<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Reactor</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token class-name">Task</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> reactor<span class="token punctuation">,</span> data <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Future</span> <span class="token keyword">for</span> <span class="token class-name">Task</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">poll</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> <span class="token class-name">Pin</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> cx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;_</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Poll</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> r <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>reactor<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> r<span class="token punctuation">.</span><span class="token function">is_ready</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">*</span>r<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">get_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token class-name">TaskState</span><span class="token punctuation">::</span><span class="token class-name">Finished</span><span class="token punctuation">;</span>
            <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Ready</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> r<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">contains_key</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token class-name">TaskState</span><span class="token punctuation">::</span><span class="token class-name">NotReady</span><span class="token punctuation">(</span>cx<span class="token punctuation">.</span><span class="token function">waker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Pending</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> cx<span class="token punctuation">.</span><span class="token function">waker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Pending</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// =============================== REACTOR ===================================</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">TaskState</span> <span class="token punctuation">{</span>
    <span class="token class-name">Ready</span><span class="token punctuation">,</span>
    <span class="token class-name">NotReady</span><span class="token punctuation">(</span><span class="token class-name">Waker</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Finished</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Reactor</span> <span class="token punctuation">{</span>
    dispatcher<span class="token punctuation">:</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">Event</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    handle<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">JoinHandle</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    tasks<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token class-name">TaskState</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">Event</span> <span class="token punctuation">{</span>
    <span class="token class-name">Close</span><span class="token punctuation">,</span>
    <span class="token class-name">Timeout</span><span class="token punctuation">(</span><span class="token keyword">u64</span><span class="token punctuation">,</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Reactor</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>tx<span class="token punctuation">,</span> rx<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Event</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> reactor <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Reactor</span> <span class="token punctuation">{</span>
            dispatcher<span class="token punctuation">:</span> tx<span class="token punctuation">,</span>
            handle<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            tasks<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">let</span> reactor_clone <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">downgrade</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>reactor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> handle <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> handles <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> event <span class="token keyword">in</span> rx <span class="token punctuation">{</span>
                <span class="token keyword">let</span> reactor <span class="token operator">=</span> reactor_clone<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">match</span> event <span class="token punctuation">{</span>
                    <span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">Close</span> <span class="token operator">=&gt;</span> <span class="token keyword">break</span><span class="token punctuation">,</span>
                    <span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">Timeout</span><span class="token punctuation">(</span>duration<span class="token punctuation">,</span> id<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">let</span> event_handle <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                            <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">let</span> reactor <span class="token operator">=</span> reactor<span class="token punctuation">.</span><span class="token function">upgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            reactor<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token keyword">mut</span> r<span class="token closure-punctuation punctuation">|</span></span> r<span class="token punctuation">.</span><span class="token function">wake</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        handles<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>event_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            handles<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>handle<span class="token closure-punctuation punctuation">|</span></span> handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reactor<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token keyword">mut</span> r<span class="token closure-punctuation punctuation">|</span></span> r<span class="token punctuation">.</span>handle <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reactor
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">wake</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">get_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">match</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">replace</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token class-name">TaskState</span><span class="token punctuation">::</span><span class="token class-name">Ready</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">TaskState</span><span class="token punctuation">::</span><span class="token class-name">NotReady</span><span class="token punctuation">(</span>waker<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> waker<span class="token punctuation">.</span><span class="token function">wake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">TaskState</span><span class="token punctuation">::</span><span class="token class-name">Finished</span> <span class="token operator">=&gt;</span> <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;Called &#39;wake&#39; twice on task: {}&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">,</span>
            _ <span class="token operator">=&gt;</span> <span class="token macro property">unreachable!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> duration<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> waker<span class="token punctuation">:</span> <span class="token class-name">Waker</span><span class="token punctuation">,</span> id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token class-name">TaskState</span><span class="token punctuation">::</span><span class="token class-name">NotReady</span><span class="token punctuation">(</span>waker<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_some</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;Tried to insert a task with id: &#39;{}&#39;, twice!&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dispatcher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">Timeout</span><span class="token punctuation">(</span>duration<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dispatcher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">Close</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">is_ready</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>state<span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">match</span> state <span class="token punctuation">{</span>
            <span class="token class-name">TaskState</span><span class="token punctuation">::</span><span class="token class-name">Ready</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            _ <span class="token operator">=&gt;</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap_or</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Drop</span> <span class="token keyword">for</span> <span class="token class-name">Reactor</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">drop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>handle<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>h<span class="token closure-punctuation punctuation">|</span></span> h<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br></div></div><h2 id="九-结论和练习"><a class="header-anchor" href="#九-结论和练习" aria-hidden="true">#</a> 九 结论和练习</h2><p>我们的实现采取了一些明显的捷径，可以使用一些改进。 实际上，深入研究代码并自己尝试一些事情是一个很好的学习方式。 如果你想探索更多，这里有一些很好的练习</p><h3 id="编码park"><a class="header-anchor" href="#编码park" aria-hidden="true">#</a> 编码park</h3><p>使用 Thread: : park 和 Thread: : unpark 的大问题是用户可以从自己的代码访问这些相同的方法。 尝试使用另一种方法来挂起线程并根据我们的命令再次唤醒它。 一些提示:</p><ul><li><a href="https://doc.rust-lang.org/stable/std/sync/struct.Condvar.html" target="_blank" rel="noopener noreferrer">std::sync::CondVar</a></li><li><a href="https://github.com/crossbeam-rs/crossbeam" target="_blank" rel="noopener noreferrer">crossbeam::sync::Parker</a></li></ul><h3 id="编码传递reactor"><a class="header-anchor" href="#编码传递reactor" aria-hidden="true">#</a> 编码传递reactor</h3><p>避免包装整个Reactor in a mutex and pass it around 在互斥对象中传递</p><p>首先，保护整个reactor并传递它是过分的。 我们只对同步它包含的部分信息感兴趣。 尝试将其重构出来，只同步访问真正需要的内容。</p><p>我建议您看看<a href="https://github.com/async-rs/async-std/blob/master/src/net/driver/mod.rs" target="_blank" rel="noopener noreferrer">async_std驱动程序</a>是如何实现的，以及<a href="https://github.com/tokio-rs/tokio/blob/master/tokio/src/runtime/basic_scheduler.rs" target="_blank" rel="noopener noreferrer">tokio调度程序</a>是如何实现的，以获得一些灵感。</p><ul><li>你想使用Arc来传递这些信息的引用?</li><li>你是否想创建一个全局的reactor,这样他可以随时随地被访问?</li></ul><h3 id="创建一个更好的执行器"><a class="header-anchor" href="#创建一个更好的执行器" aria-hidden="true">#</a> 创建一个更好的执行器</h3><p>现在我们只支持一个一个Future运行. 大多数运行时都有一个spawn函数,让你能够启动一个future,然后await它. 这样你就可以同时运行多个Future.</p><p>正如我在本书开头所建议的那样，访问<a href="https://stjepang.github.io/2020/01/31/build-your-own-executor.html" target="_blank" rel="noopener noreferrer">stjepan 的博客系列</a>，了解如何实现你自己的执行者，是我将要开始的地方，并从那里开始。</p><h3 id="进一步阅读"><a class="header-anchor" href="#进一步阅读" aria-hidden="true">#</a> 进一步阅读</h3><ul><li><p><a href="https://rust-lang.github.io/async-book/01_getting_started/01_chapter.html" target="_blank" rel="noopener noreferrer">The official Asyc book</a></p></li><li><p><a href="https://book.async.rs/" target="_blank" rel="noopener noreferrer"> The async_std book</a></p></li><li><p><a href="https://aturon.github.io/blog/2016/09/07/futures-design/" target="_blank" rel="noopener noreferrer">Aron Turon: Designing futures for Rust</a></p></li><li><p><a href="https://www.infoq.com/presentations/rust-2019/" target="_blank" rel="noopener noreferrer">Steve Klabnik&#39;s presentation: Rust&#39;s journey to Async/Await</a></p></li><li><p><a href="https://tokio.rs/blog/2019-10-scheduler/" target="_blank" rel="noopener noreferrer">The Tokio Blog</a></p></li><li><p><a href="https://stjepang.github.io/" target="_blank" rel="noopener noreferrer">Stjepan&#39;s blog with a series where he implements an Executor</a></p></li><li><p><a href="https://youtu.be/DkMwYxfSYNQ" target="_blank" rel="noopener noreferrer">Jon Gjengset&#39;s video on The Why, What and How of Pinning in Rust</a> 有中英文字幕的<a href="https://www.bilibili.com/video/BV1tK411L7s5/" target="_blank" rel="noopener noreferrer">B站链接</a></p></li><li><p><a href="https://boats.gitlab.io/blog/post/2018-01-25-async-i-self-referential-structs/" target="_blank" rel="noopener noreferrer">Withoutboats blog series about async/await</a></p></li></ul><h2 id="转载说明"><a class="header-anchor" href="#转载说明" aria-hidden="true">#</a> 转载说明</h2><p>本文允许转载,但是请注明出处.作者:stevenbai 本人博客:<a href="https://stevenbai.top/" target="_blank" rel="noopener noreferrer">https://stevenbai.top/</a></p><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p>栈拷贝,指针等问题 <a href="#fnref1" class="footnote-backref">↩︎</a></p></li></ol></section></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-fb8d84c6><div class="edit" data-v-fb8d84c6><div class="edit-link" data-v-fb8d84c6 data-v-1ed99556><a class="link" href="https://github.com/nkbai/Blog/edit/master/docs/rust/Futures_Explained_in_200_lines_of_Rust.md" target="_blank" rel="noopener noreferrer" data-v-1ed99556>编辑本文 <svg class="icon outbound icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-1ed99556><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="updated" data-v-fb8d84c6><p class="last-updated" data-v-fb8d84c6 data-v-5797b537><span class="prefix" data-v-5797b537>上次更新:</span><span class="datetime" data-v-5797b537></span></p></div></footer><div class="next-and-prev-link" data-v-7eddb2c4 data-v-38ede35f><div class="container" data-v-38ede35f><div class="prev" data-v-38ede35f><!----></div><div class="next" data-v-38ede35f><a class="link" href="/rust/Futures_Explained_in_200_lines_of_Rust_with_error_version" data-v-38ede35f><span class="text" data-v-38ede35f>200行代码讲透Rust Futures-有bug版本</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-38ede35f><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"404.md\":\"4a7f18c8\",\"about.md\":\"251647af\",\"index.md\":\"b7958aeb\",\"blockchain_index.md\":\"35dfa97c\",\"other_apt安装指定版本软件.md\":\"ae597aef\",\"other_brew安装指定版本boost.md\":\"e8ca622c\",\"other_capture_with_wireshark_for_android.md\":\"4a37bab7\",\"other_clean_mac.md\":\"2dc28996\",\"other_crossover source insight 4.0使用.md\":\"3dc267ac\",\"other_git以及github回退.md\":\"c888f4a1\",\"other_grpcox.md\":\"a9e74b29\",\"other_hugo博客写作.md\":\"54b6f3c3\",\"other_index.md\":\"c9abdc73\",\"other_learn_go.md\":\"892dfd88\",\"other_learningpythonv4.md\":\"54f7e8a1\",\"other_opc 统一架构学习笔记.md\":\"a8c726aa\",\"other_opcua-rust.md\":\"5d9ce677\",\"other_opcua_cross_compile_for_raspeberry.md\":\"932e2c7d\",\"other_read_kerenel_use_clion.md\":\"afc405a5\",\"other_vscode_cnblog_plugin.md\":\"ce84c44f\",\"other_windows_hook_thiscall.md\":\"f4490c21\",\"other_不用外部插件启用u盘ntfs写功能.md\":\"18f443a2\",\"other_五个goland进行go开发的小技巧.md\":\"134897e9\",\"other_使用clion调试开发比特币源码.md\":\"403981f0\",\"other_使用ubuntu搭建时间机器备份服务.md\":\"7ddbbb4b\",\"other_工作中常用工具入门.md\":\"223feca6\",\"other_用 go 写 webassembly入门.md\":\"310b271e\",\"other_阈值签名.md\":\"1d626bd7\",\"other_高性能go开发.md\":\"abb40760\",\"static_analysis_index.md\":\"b03237dd\",\"static_analysis_mariana-introduction.md\":\"4cd4e398\",\"rust_futures_explained_in_200_lines_of_rust.md\":\"417ca294\",\"rust_futures_explained_in_200_lines_of_rust2.md\":\"fea8d0eb\",\"rust_futures_explained_in_200_lines_of_rust_with_error_version.md\":\"03ac030a\",\"rust_build_your_own_block_on.md\":\"02a9c94f\",\"rust_build_your_own_executor.md\":\"e652662e\",\"rust_convert_an_integer_to_an_enum.md\":\"764eee4b\",\"rust_index.md\":\"c17683a8\",\"rust_lock-freedom-without-garbage-collection.md\":\"3acb3166\",\"rust_my_note.md\":\"bb4de1c3\",\"rust_ownership101.md\":\"bbba50d7\",\"rust_rust_async_lock.md\":\"a756773a\",\"rust_rust_atomic.md\":\"91eac5dd\",\"rust_rust开发工具.md\":\"15bfeaf2\",\"rust_tokio_async_await 初探.md\":\"08ea7e36\",\"rust_tokio笔记.md\":\"68b9f136\",\"rust_交叉编译rust.md\":\"50ebace2\",\"rust-leetcode_2019-06-01.md\":\"723b298c\",\"rust-leetcode_2019-06-02.md\":\"6f372932\",\"rust-leetcode_2019-06-03.md\":\"77fa618a\",\"rust-leetcode_2019-06-04.md\":\"7d19de73\",\"rust-leetcode_2019-06-05.md\":\"be733b58\",\"rust-leetcode_2019-06-06.md\":\"5fabc935\",\"rust-leetcode_2019-06-07.md\":\"626b5190\",\"rust-leetcode_2019-06-08.md\":\"0f62962f\",\"rust-leetcode_2019-06-10.md\":\"28ff9425\",\"rust-leetcode_2019-06-11.md\":\"5c0af55c\",\"rust-leetcode_2019-06-14.md\":\"b56f321c\",\"rust-leetcode_2019-06-15.md\":\"a0cb6423\",\"rust-leetcode_2019-06-17.md\":\"fad8d176\",\"rust-leetcode_2019-06-18.md\":\"faa3a8c1\",\"rust-leetcode_2019-08-04.md\":\"8be344a5\",\"rust-leetcode_2019-08-10.md\":\"0d221bb6\",\"rust-leetcode_2019-08-11.md\":\"87150c7b\",\"rust-leetcode_2019-08-12.md\":\"5449f6dc\",\"rust-leetcode_2019-08-13.md\":\"b2dd91f0\",\"rust-leetcode_2019-08-14.md\":\"775d2e1e\",\"rust-leetcode_2019-08-15.md\":\"f50331e2\",\"rust-leetcode_2019-08-16.md\":\"a75dfa34\",\"rust-leetcode_2019-08-17.md\":\"6a49adb8\",\"rust-leetcode_2019-08-18.md\":\"c03c32dd\",\"rust-leetcode_2019-08-19.md\":\"dd6cac60\",\"rust-leetcode_2019-08-20.md\":\"4212ff2a\",\"rust-leetcode_2019-08-21.md\":\"600bf41b\",\"rust-leetcode_2019-08-22.md\":\"e001ef71\",\"rust-leetcode_2019-08-23.md\":\"590f6aca\",\"rust-leetcode_2019-08-26.md\":\"cb3cffb2\",\"rust-leetcode_2019-08-27.md\":\"5a361f79\",\"rust-leetcode_2019-08-28.md\":\"89f10999\",\"rust-leetcode_2019-08-29.md\":\"836666d9\",\"rust-leetcode_2019-08-30.md\":\"6790f119\",\"rust-leetcode_2019-09-02.md\":\"6eb992e9\",\"rust-leetcode_2019-09-03.md\":\"5f2e7257\",\"rust-leetcode_2019-09-04.md\":\"a569eaa0\",\"rust-leetcode_2019-09-05.md\":\"a91a610d\",\"rust-leetcode_2019-09-06.md\":\"1e24d4e1\",\"rust-leetcode_2019-09-09.md\":\"d823079f\",\"rust-leetcode_2019-09-10.md\":\"674a43c0\",\"rust-leetcode_2019-09-11.md\":\"739300a2\",\"rust-leetcode_2019-09-12.md\":\"6dfc19c5\",\"rust-leetcode_2019-09-13.md\":\"db0a7ad9\",\"rust-leetcode_2019-09-16.md\":\"0f1ea001\",\"rust-leetcode_2019-09-17.md\":\"36414f58\",\"rust-leetcode_2019-09-18.md\":\"e555fc9d\",\"rust-leetcode_2019-09-19.md\":\"1c10d6d9\",\"rust-leetcode_2019-09-20.md\":\"999dc185\",\"rust-leetcode_2019-09-23.md\":\"88d33c17\",\"rust-leetcode_2019-09-24.md\":\"52925949\",\"rust-leetcode_2019-09-25.md\":\"8908969c\",\"rust-leetcode_2019-09-26.md\":\"f69d38fc\",\"rust-leetcode_2019-09-27.md\":\"b9b288eb\",\"rust-leetcode_2019-09-28.md\":\"4b52bce6\",\"rust-leetcode_2019-10-08.md\":\"536a428c\",\"rust-leetcode_2019-10-09.md\":\"83f95a4c\",\"rust-leetcode_2019-10-10.md\":\"2cb08ae7\",\"rust-leetcode_2019-10-11.md\":\"8a57a64a\",\"rust-leetcode_2019-10-14.md\":\"9362e258\",\"rust-leetcode_2019-10-15.md\":\"41ed5bc2\",\"rust-leetcode_2019-10-16.md\":\"c3dff2d3\",\"rust-leetcode_2019-10-17.md\":\"062c6eb3\",\"rust-leetcode_2019-10-18.md\":\"5320ebda\",\"rust-leetcode_2019-10-19.md\":\"e6c561e7\",\"rust-leetcode_2019-10-21.md\":\"fe27d2a8\",\"rust-leetcode_2019-10-22.md\":\"dfc867bc\",\"rust-leetcode_2019-10-23.md\":\"de735bda\",\"rust-leetcode_2019-10-24.md\":\"cb8f1cf7\",\"rust-leetcode_2019-10-25.md\":\"77227705\",\"rust-leetcode_2019-10-28.md\":\"712fc06e\",\"rust-leetcode_2019-10-29.md\":\"155d5af3\",\"rust-leetcode_2019-10-30.md\":\"e7695fbb\",\"rust-leetcode_2019-10-31.md\":\"c6ec36be\",\"rust-leetcode_2019-11-01.md\":\"bedee0dc\",\"rust-leetcode_2019-11-04.md\":\"62f52f8c\",\"rust-leetcode_2019-11-05.md\":\"25475cbb\",\"rust-leetcode_2019-11-06.md\":\"71c182c0\",\"rust-leetcode_2019-11-07.md\":\"f8aeae1a\",\"rust-leetcode_2019-11-08.md\":\"fcadba1c\",\"rust-leetcode_2019-11-11.md\":\"26b02f97\",\"rust-leetcode_2019-11-12.md\":\"f0749ae0\",\"rust-leetcode_2019-11-13.md\":\"f15c7543\",\"rust-leetcode_2019-11-14.md\":\"9add0c73\",\"rust-leetcode_2019-11-15.md\":\"2e293cbd\",\"rust-leetcode_2019-11-18.md\":\"b246a1ed\",\"rust-leetcode_2019-11-19.md\":\"80c29614\",\"rust-leetcode_2019-11-20.md\":\"68d53177\",\"rust-leetcode_2019-11-21.md\":\"d503d1e4\",\"rust-leetcode_2019-11-22.md\":\"92ee4f60\",\"rust-leetcode_2019-11-25.md\":\"105da0b8\",\"rust-leetcode_2019-11-26.md\":\"eb268eb3\",\"rust-leetcode_2019-11-27.md\":\"db417a56\",\"rust-leetcode_2019-11-28.md\":\"502d5d96\",\"rust-leetcode_2019-11-29.md\":\"e15e94de\",\"rust-leetcode_2019-12-02.md\":\"32b0faf4\",\"rust-leetcode_2019-12-03.md\":\"83305d11\",\"rust-leetcode_2019-12-04.md\":\"e427e7fc\",\"rust-leetcode_2019-12-05.md\":\"1bf8c45c\",\"rust-leetcode_2019-12-06.md\":\"4e182108\",\"rust-leetcode_2019-12-09.md\":\"90dcb642\",\"rust-leetcode_2019-12-10.md\":\"1569814e\",\"rust-leetcode_2019-12-11.md\":\"4ad6695d\",\"rust-leetcode_2019-12-12.md\":\"ee955920\",\"rust-leetcode_2019-12-13.md\":\"2f876a1c\",\"rust-leetcode_2019-12-16.md\":\"ca65a995\",\"rust-leetcode_2019-12-17.md\":\"a289784c\",\"rust-leetcode_2019-12-18.md\":\"bce416b8\",\"rust-leetcode_2019-12-19.md\":\"d41e5a17\",\"rust-leetcode_2019-12-20.md\":\"b848b2a5\",\"rust-leetcode_2019-12-23.md\":\"0b12ed94\",\"rust-leetcode_2019-12-24.md\":\"aeee125c\",\"rust-leetcode_2019-12-25.md\":\"680d0009\",\"rust-leetcode_2019-12-26.md\":\"9f3249b2\",\"rust-leetcode_2019-12-27.md\":\"e4f4889f\",\"rust-leetcode_2019-12-30.md\":\"cd08d770\",\"rust-leetcode_2019-12-31.md\":\"e1b8089f\",\"rust-leetcode_2020-01-01.md\":\"38810a4f\",\"rust-leetcode_2020-01-02.md\":\"ec851ba4\",\"rust-leetcode_2020-01-03.md\":\"be1c7f1d\",\"rust-leetcode_2020-01-06.md\":\"da31c769\",\"rust-leetcode_2020-01-07.md\":\"9a00c3e7\",\"rust-leetcode_2020-01-08.md\":\"10edd52f\",\"rust-leetcode_2020-01-09.md\":\"0d38e9eb\",\"rust-leetcode_2020-01-10.md\":\"dc27e44b\",\"rust-leetcode_2020-01-13.md\":\"1cbafdf0\",\"rust-leetcode_2020-01-14.md\":\"512ec722\",\"rust-leetcode_2020-01-15.md\":\"f0c47d9d\",\"rust-leetcode_2020-01-16.md\":\"8277fe96\",\"rust-leetcode_2020-01-17.md\":\"055ab264\",\"rust-leetcode_2020-01-20.md\":\"f6e5f515\",\"rust-leetcode_2020-01-21.md\":\"631ce4cf\",\"rust-leetcode_2020-01-22.md\":\"9a61296c\",\"rust-leetcode_2020-01-23.md\":\"8b950745\",\"rust-leetcode_2020-01-24.md\":\"9f6a628e\",\"rust-leetcode_2020-02-03.md\":\"b8da0aae\",\"rust-leetcode_2020-02-04.md\":\"99f1407d\",\"rust-leetcode_2020-02-05.md\":\"eb87de3f\",\"rust-leetcode_2020-02-06.md\":\"95831a75\",\"rust-leetcode_2020-02-07.md\":\"bb43daff\",\"rust-leetcode_2020-02-10.md\":\"9ca85644\",\"rust-leetcode_2020-02-11.md\":\"14e963b4\",\"rust-leetcode_2020-02-12.md\":\"d4bfe602\",\"rust-leetcode_2020-02-13.md\":\"0f0e57d9\",\"rust-leetcode_2020-02-14.md\":\"dea213de\",\"rust-leetcode_2020-02-17.md\":\"ae7a7c45\",\"rust-leetcode_2020-02-18.md\":\"1da2495b\",\"rust-leetcode_2020-02-19.md\":\"47d6727a\",\"rust-leetcode_2020-02-20.md\":\"38db2a57\",\"rust-leetcode_2020-02-21.md\":\"197b6222\",\"rust-leetcode_2020-02-24.md\":\"f9f42dee\",\"rust-leetcode_2020-02-25.md\":\"aad70c7b\",\"rust-leetcode_2020-02-26.md\":\"6404a4fa\",\"rust-leetcode_2020-02-27.md\":\"6c94c3b9\",\"rust-leetcode_2020-02-28.md\":\"e5a291c2\",\"rust-leetcode_2020-03-02.md\":\"81b636c9\",\"rust-leetcode_2020-03-03.md\":\"7e641dd0\",\"rust-leetcode_2020-03-04.md\":\"1021d0f6\",\"rust-leetcode_2020-03-05.md\":\"88de6bda\",\"rust-leetcode_2020-03-06.md\":\"a3abf44d\",\"rust-leetcode_2020-03-09.md\":\"e6712047\",\"rust-leetcode_2020-03-10.md\":\"61bad4b3\",\"rust-leetcode_2020-03-11.md\":\"286b81fd\",\"rust-leetcode_2020-03-12.md\":\"32600588\",\"rust-leetcode_2020-03-13.md\":\"2738af2d\",\"rust-leetcode_2020-03-16.md\":\"a8b40bea\",\"rust-leetcode_2020-03-17.md\":\"fe1ccad1\",\"rust-leetcode_2020-03-18.md\":\"d279cab9\",\"rust-leetcode_2020-03-19.md\":\"a235a947\",\"rust-leetcode_2020-03-20.md\":\"dc02f06a\",\"rust-leetcode_2020-03-23.md\":\"aef972d4\",\"rust-leetcode_2020-03-24.md\":\"a49b7ac4\",\"rust-leetcode_2020-03-25.md\":\"a6f9669f\",\"rust-leetcode_2020-03-26.md\":\"ed3fa67f\",\"rust-leetcode_2020-03-27.md\":\"152a7457\",\"rust-leetcode_2020-03-30.md\":\"657cf9c0\",\"rust-leetcode_2020-03-31.md\":\"41a9772f\",\"rust-leetcode_2020-07-09.md\":\"c283c27f\",\"rust-leetcode_index.md\":\"4f0bdbf4\",\"rust-leetcode_模板.md\":\"54a41b3d\",\"blockchain_block_chain_core_ecc_signature_random.md\":\"9c6da7e6\",\"blockchain_block_chain_core_index.md\":\"7c343adf\",\"blockchain_block_chain_core_vrf.md\":\"24b24eed\",\"blockchain_btcd_[9476013]比特币指令集说明.md\":\"ee42b3d4\",\"blockchain_btcd_[9476189]一个比特币脚本示例.md\":\"9614d3c9\",\"blockchain_btcd_[9485733]bitcoin script.md\":\"4f189d69\",\"blockchain_btcd_[9491455]比特币的地址类型.md\":\"edf28eba\",\"blockchain_btcd_bloom.md\":\"bb4eb453\",\"blockchain_btcd_btcjson.md\":\"ea909765\",\"blockchain_btcd_database.md\":\"32dc40d6\",\"blockchain_btcd_index.md\":\"8cde60a7\",\"blockchain_btcd_indexer模块.md\":\"21c5ed2b\",\"blockchain_btcd_mempool.md\":\"2e368543\",\"blockchain_btcd_mining.md\":\"ad590e95\",\"blockchain_btcd_mrumap.md\":\"ac948137\",\"blockchain_btcd_peer.md\":\"6b6cfffb\",\"blockchain_btcd_rpcclient.md\":\"5528562c\",\"blockchain_btcd_wire_common.md\":\"4d177184\",\"blockchain_btcd_比特币解锁脚本中的scriptsignature都包含了什么东西.md\":\"c1b1e7d6\",\"blockchain_btcd_隔离见证.md\":\"f5344241\",\"blockchain_btcwallet_btcwallet系列之一-grpc模块.md\":\"9a64070f\",\"blockchain_btcwallet_chain模块.md\":\"da4261df\",\"blockchain_btcwallet_hdwallet-bip0032.md\":\"af4ad974\",\"blockchain_btcwallet_index.md\":\"93f4e6f7\",\"blockchain_btcwallet_readme.md\":\"5ad7cf34\",\"blockchain_btcwallet_snacl.md\":\"caa8f5bf\",\"blockchain_btcwallet_waddrmgr模块.md\":\"43b53f82\",\"blockchain_btcwallet_walletdb.md\":\"3e0c7dbe\",\"blockchain_btcwallet_wallet中的数据库设计.md\":\"685f8100\",\"blockchain_btcwallet_wallet模块.md\":\"bb3d038e\",\"blockchain_btcwallet_wtxmgr模块.md\":\"0edd17c4\",\"blockchain_btcwallet_拓扑排序在比特币tx管理中的使用.md\":\"83058059\",\"blockchain_ethereum_crosschainatomicexchange.md\":\"f33c71c7\",\"blockchain_ethereum_[9232585]合约注意事项.md\":\"c015745a\",\"blockchain_ethereum_[9249722]solidity_mapping_implementation.md\":\"d77012f4\",\"blockchain_ethereum_[9420361]raiden_graph.md\":\"316815bf\",\"blockchain_ethereum_[9619946]如何为 smartraiden 贡献代码.md\":\"58fc9e4a\",\"blockchain_ethereum_btc跨链设计.md\":\"24dfe70c\",\"blockchain_ethereum_ethereum_erc20_wrapper.md\":\"51b6d8f0\",\"blockchain_ethereum_golang subprocess tests.md\":\"2fe2f6e2\",\"blockchain_ethereum_golang_plugin.md\":\"1abb5260\",\"blockchain_ethereum_how_to_create_channel.md\":\"fd6f4310\",\"blockchain_ethereum_how_to_use_channel.md\":\"3bca9a00\",\"blockchain_ethereum_index.md\":\"cf6904ec\",\"blockchain_ethereum_meshbox配置 openwrt.md\":\"33bba3a0\",\"blockchain_ethereum_synapse代码阅读.md\":\"f4bdabc3\",\"blockchain_ethereum_thedao.md\":\"f021d2b9\",\"blockchain_ethereum_从一次盗币事件再谈合约安全问题.md\":\"cab9ee0a\",\"blockchain_ethereum_以太坊evm笔记.md\":\"4d3fe3a7\",\"blockchain_ethereum_区块链计时器.md\":\"ac0410d7\",\"blockchain_ethereum_区块链问题笔记.md\":\"7f81f35b\",\"blockchain_ethereum_君士坦丁堡分叉引起的安全问题.md\":\"2bfa0046\",\"blockchain_ethereum_多链工作问题.md\":\"2ea5f6f2\",\"blockchain_ethereum_如何使用 dlv 调试 smartraiden.md\":\"22ce3d62\",\"blockchain_ethereum_如何使用 smartraiden 以及 lnd 进行跨链原子资产交换.md\":\"5c578baa\",\"blockchain_ethereum_安全总结.md\":\"0ac2051f\",\"blockchain_ethereum_并发和并行的区别.md\":\"1773184f\",\"blockchain_ethereum_异常退出各种情况.md\":\"0c9a790d\",\"blockchain_ethereum_我对 smartplasma 的理解.md\":\"adef393c\",\"blockchain_ethereum_比特币的txhash为什么会发生改变.md\":\"3093d958\",\"blockchain_ethereum_让photon支持go module.md\":\"2963200d\",\"blockchain_ethereum_闪电网络.md\":\"6ec4ef82\",\"blockchain_ethereum_闪电网络交易密钥.md\":\"3a178674\",\"blockchain_libra_1.start_in_one_minute.md\":\"13473073\",\"blockchain_libra_2.protobuf_in_libria.md\":\"bc69791f\",\"blockchain_libra_3.libra_schema.md\":\"5b592bfd\",\"blockchain_libra_4.client_command_and_libriadb.md\":\"5bbc5743\",\"blockchain_libra_5.libra_ac.md\":\"2e868b3c\",\"blockchain_libra_6.libria_mempool_1.md\":\"4055f0c0\",\"blockchain_libra_7.libra_mempool_2.md\":\"b190ef65\",\"blockchain_libra_8.libria_mempool_3.md\":\"e825d847\",\"blockchain_libra_9.libria_vrf.md\":\"5d53eb87\",\"blockchain_libra_index.md\":\"cd98eda7\",\"rust_rnats_1.start.md\":\"69d1ec6a\",\"rust_rnats_2.parser.md\":\"4be6c32b\",\"rust_rnats_3.sublist.md\":\"23781e6c\",\"rust_rnats_4.server.md\":\"23c6b93e\",\"rust_rnats_5.server.client.md\":\"ae206226\",\"rust_rnats_6.client.md\":\"36efed67\",\"rust_rnats_index.md\":\"8b0072ee\",\"rust_rnats_ppt_index.md\":\"44546fd3\",\"rust_rnats_ppt_从零实现消息中间件-client.md\":\"22b66cc9\",\"rust_rnats_ppt_从零实现消息中间件-server.client.md\":\"d4918cb9\",\"rust_rnats_ppt_从零实现消息中间件-server.md\":\"1ec8936e\"}")</script>
    <script type="module" async src="/assets/app.9c6df70b.js"></script>
  </body>
</html>